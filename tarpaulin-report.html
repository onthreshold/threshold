<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <style>html, body {
  margin: 0;
  padding: 0;
}

.app {
  margin: 10px;
  padding: 0;
}

.files-list {
  margin: 10px 0 0;
  width: 100%;
  border-collapse: collapse;
}
.files-list__head {
  border: 1px solid #999;
}
.files-list__head > tr > th {
  padding: 10px;
  border: 1px solid #999;
  text-align: left;
  font-weight: normal;
  background: #ddd;
}
.files-list__body {
}
.files-list__file {
  cursor: pointer;
}
.files-list__file:hover {
  background: #ccf;
}
.files-list__file > td {
  padding: 10px;
  border: 1px solid #999;
}
.files-list__file > td:first-child::before {
  content: '\01F4C4';
  margin-right: 1em;
}
.files-list__file_low {
  background: #fcc;
}
.files-list__file_medium {
  background: #ffc;
}
.files-list__file_high {
  background: #cfc;
}
.files-list__file_folder > td:first-child::before {
  content: '\01F4C1';
  margin-right: 1em;
}

.file-header {
  border: 1px solid #999;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  background: white;
}

.file-header__back {
  margin: 10px;
  cursor: pointer;
  flex-shrink: 0;
  flex-grow: 0;
  text-decoration: underline;
  color: #338;
}

.file-header__name {
  margin: 10px;
  flex-shrink: 2;
  flex-grow: 2;
}

.file-header__stat {
  margin: 10px;
  flex-shrink: 0;
  flex-grow: 0;
}

.file-content {
  margin: 10px 0 0;
  border: 1px solid #999;
  padding: 10px;
  counter-reset: line;
  display: flex;
  flex-direction: column;
}

.code-line::before {
    content: counter(line);
    margin-right: 10px;
}
.code-line {
  margin: 0;
  padding: 0.3em;
  height: 1em;
  counter-increment: line;
}
.code-line_covered {
  background: #cfc;
}
.code-line_uncovered {
  background: #fcc;
}
</style>
</head>
<body>
    <div id="root"></div>
    <script>
        var data = {"files":[{"path":["/","home","vidyootsenthil","TheValut-nameTBD","bin","esplora-client","src","main.rs"],"content":"use async_trait::async_trait;\nuse bitcoin::{consensus, Address, Network, Transaction};\nuse esplora_client::{AsyncClient, Builder};\nuse std::str::FromStr;\nuse tokio::sync::broadcast;\nuse tokio::time::{sleep, Duration};\n\n#[derive(Debug)]\npub enum NodeError {\n    Error(String),\n}\n\n#[async_trait]\npub trait WindowedConfirmedTransactionProvider {\n    // Must only return transactions that are confirmed in the given range [min_height, max_height].\n    // All returned transactions must have at least six confirmations (\u003c current_chain_tip_height - 6).\n    async fn get_confirmed_transactions(\n        \u0026self,\n        address: Address,\n        min_height: u32,\n        max_height: u32,\n    ) -\u003e Result\u003cVec\u003cTransaction\u003e, NodeError\u003e;\n\n    // Must poll for new transactions and send them to the given channel.\n    async fn poll_new_transactions(\u0026self, address: Address);\n}\n\npub struct EsploraApiClient {\n    client: AsyncClient,\n    tx_channel: broadcast::Sender\u003cTransaction\u003e,\n}\n\nimpl EsploraApiClient {\n    pub fn new(client: AsyncClient, capacity: usize) -\u003e Self {\n        Self {\n            client,\n            tx_channel: broadcast::channel(capacity).0,\n        }\n    }\n}\n\n#[async_trait]\nimpl WindowedConfirmedTransactionProvider for EsploraApiClient {\n    async fn get_confirmed_transactions(\n        \u0026self,\n        address: Address,\n        min_height: u32,\n        max_height: u32,\n    ) -\u003e Result\u003cVec\u003cTransaction\u003e, NodeError\u003e {\n        let blockchain_height = self.client.get_height().await.map_err(|e| {\n            NodeError::Error(format!(\"Cannot retrieve height of blockchain: {}\", e))\n        })?;\n\n        let new_max_height = max_height.min(blockchain_height - 6);\n\n        let mut confirmed_txs = Vec::new();\n        let mut last_seen_txid = None;\n\n        loop {\n            let address_txs = self\n                .client\n                .scripthash_txs(\u0026address.script_pubkey(), last_seen_txid)\n                .await\n                .map_err(|e| {\n                    NodeError::Error(format!(\"Cannot retrieve transactions for address: {}\", e))\n                })?;\n\n            if address_txs.is_empty() {\n                break;\n            }\n\n            let mut found_confirmed = false;\n            let last_tx_height = address_txs.last().and_then(|tx| tx.status.block_height);\n\n            for tx in address_txs {\n                if let Some(block_height) = tx.status.block_height {\n                    if block_height \u003e= min_height \u0026\u0026 block_height \u003c= new_max_height {\n                        if let Ok(full_tx) = self.client.get_tx(\u0026tx.txid).await {\n                            if let Ok(bitcoin_tx) =\n                                consensus::deserialize(\u0026consensus::serialize(\u0026full_tx.unwrap()))\n                            {\n                                confirmed_txs.push(bitcoin_tx);\n                                found_confirmed = true;\n                            }\n                        }\n                    }\n                }\n                last_seen_txid = Some(tx.txid);\n            }\n\n            if !found_confirmed \u0026\u0026 last_tx_height.is_some_and(|height| height \u003c min_height) {\n                break;\n            }\n        }\n\n        Ok(confirmed_txs)\n    }\n\n    async fn poll_new_transactions(\u0026self, address: Address) {\n        let mut last_confirmed_height = match self.client.get_height().await {\n            Ok(height) =\u003e height - 6,\n            Err(e) =\u003e {\n                eprintln!(\"Cannot retrieve height of blockchain: {}\", e);\n                return;\n            }\n        };\n\n        println!(\n            \"Polling for new transactions for address {}, starting from confirmed height {}\",\n            address, last_confirmed_height\n        );\n\n        loop {\n            sleep(Duration::from_secs(60)).await;\n\n            let current_height = match self.client.get_height().await {\n                Ok(height) =\u003e height,\n                Err(e) =\u003e {\n                    eprintln!(\"Cannot retrieve height of blockchain: {}\", e);\n                    continue;\n                }\n            };\n\n            let new_confirmed_height = current_height - 6;\n\n            if new_confirmed_height \u003e last_confirmed_height {\n                println!(\n                    \"New confirmed block found. From height {} to {}\",\n                    last_confirmed_height + 1,\n                    new_confirmed_height\n                );\n\n                let new_txs = match self\n                    .get_confirmed_transactions(\n                        address.clone(),\n                        last_confirmed_height + 1,\n                        new_confirmed_height,\n                    )\n                    .await\n                {\n                    Ok(txs) =\u003e txs,\n                    Err(e) =\u003e {\n                        eprintln!(\"Error getting confirmed transactions: {:?}\", e);\n                        continue;\n                    }\n                };\n\n                for tx in new_txs {\n                    println!(\"Found new confirmed transaction: {}\", tx.compute_txid());\n                    match self.tx_channel.send(tx) {\n                        Ok(_) =\u003e (),\n                        Err(e) =\u003e {\n                            eprintln!(\"Error sending transaction to channel: {:?}\", e);\n                        }\n                    }\n                }\n\n                last_confirmed_height = new_confirmed_height;\n            }\n        }\n    }\n}\n\n#[tokio::main]\nasync fn main() {\n    let client = EsploraApiClient::new(\n        Builder::new(\"https://blockstream.info/api\")\n            .build_async()\n            .unwrap(),\n        100,\n    );\n\n    let address = Address::from_str(\"bc1qezwz3yt46nsgzcwlg0dsw680nryjpq5u8pvzts\")\n        .unwrap()\n        .require_network(Network::Bitcoin)\n        .unwrap();\n\n    let transactions = client\n        .get_confirmed_transactions(address.clone(), 899900, 900000)\n        .await\n        .unwrap();\n    println!(\"Found {} transactions.\", transactions.len());\n    for tx in transactions {\n        println!(\"Transaction ID: {}\", tx.compute_txid());\n    }\n\n    client.poll_new_transactions(address).await;\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[tokio::test]\n    async fn test_get_confirmed_transactions() {\n        let client = EsploraApiClient::new(\n            Builder::new(\"https://blockstream.info/api\")\n                .build_async()\n                .unwrap(),\n            100,\n        );\n        let address = Address::from_str(\"bc1qezwz3yt46nsgzcwlg0dsw680nryjpq5u8pvzts\")\n            .unwrap()\n            .require_network(Network::Bitcoin)\n            .unwrap();\n        let transactions = client\n            .get_confirmed_transactions(address.clone(), 899900, 899930)\n            .await\n            .unwrap();\n\n        let correct_txs = vec![\n            \"99c024e891c3110297513a1bc8c6f36948b36461096e664be72c3ac96e958c5c\",\n            \"1d0249929acaf31c2c6b6e6f9c72f44bd663a426cb146afe0b7bbaa66e0bc0df\",\n            \"fdcd9cf8d660e359a6ab2993d649276fca60be01c2b4327f95ad2527cbe3db08\",\n            \"3fd280c3ccc13f0f88433f0ce95aeebacc249565c8e8b671005302de0616babe\",\n            \"a8705186a9d6b5063484a8029b0e2c4064e3e2723ea61ea10b6bc38d0abbc77a\",\n        ];\n\n        assert_eq!(transactions.len(), correct_txs.len());\n\n        for tx in transactions {\n            assert!(correct_txs.contains(\u0026tx.compute_txid().to_string().as_str()));\n        }\n    }\n}\n","traces":[{"line":34,"address":[],"length":0,"stats":{"Line":1}},{"line":37,"address":[],"length":0,"stats":{"Line":1}},{"line":50,"address":[],"length":0,"stats":{"Line":3}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":4}},{"line":61,"address":[],"length":0,"stats":{"Line":2}},{"line":62,"address":[],"length":0,"stats":{"Line":2}},{"line":63,"address":[],"length":0,"stats":{"Line":2}},{"line":64,"address":[],"length":0,"stats":{"Line":2}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":2}},{"line":73,"address":[],"length":0,"stats":{"Line":4}},{"line":75,"address":[],"length":0,"stats":{"Line":102}},{"line":76,"address":[],"length":0,"stats":{"Line":100}},{"line":77,"address":[],"length":0,"stats":{"Line":10}},{"line":78,"address":[],"length":0,"stats":{"Line":10}},{"line":79,"address":[],"length":0,"stats":{"Line":5}},{"line":88,"address":[],"length":0,"stats":{"Line":50}},{"line":91,"address":[],"length":0,"stats":{"Line":5}},{"line":92,"address":[],"length":0,"stats":{"Line":1}},{"line":96,"address":[],"length":0,"stats":{"Line":1}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}}],"covered":19,"coverable":73},{"path":["/","home","vidyootsenthil","TheValut-nameTBD","experiments","cli","src","errors.rs"],"content":"use derive_more::Display;\n\n#[derive(Debug, Display)]\npub enum KeygenError {\n    #[display(\"Password mismatch\")]\n    PasswordMismatch,\n\n    #[display(\"Failed to create directory.\")]\n    DirectoryCreation(String),\n\n    #[display(\"Io error: {}\", _0)]\n    Io(std::io::Error),\n\n    #[display(\"Failed to encode key.\")]\n    KeyEncoding(String),\n\n    #[display(\"Failed to encrypt key.\")]\n    Encryption(String),\n\n    #[display(\"Failed to create directory.\")]\n    KeyFileNotFound(String),\n}\n\n#[derive(Debug)]\n#[allow(dead_code, clippy::enum_variant_names, clippy::large_enum_variant)]\npub enum CliError {\n    KeygenError(KeygenError),\n    RpcError(tonic::Status),\n    NodeError,\n}\n\nimpl From\u003cKeygenError\u003e for CliError {\n    fn from(error: KeygenError) -\u003e Self {\n        CliError::KeygenError(error)\n    }\n}\n","traces":[{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":2},{"path":["/","home","vidyootsenthil","TheValut-nameTBD","experiments","cli","src","main.rs"],"content":"mod errors;\nmod rpc_client;\n\nuse aes_gcm::{\n    aead::{Aead, KeyInit},\n    Aes256Gcm, Key, Nonce,\n};\nuse argon2::{\n    password_hash::{\n        rand_core::{OsRng, RngCore},\n        SaltString,\n    },\n    Argon2,\n};\nuse base64::{engine::general_purpose::STANDARD as BASE64, Engine as _};\nuse clap::{Parser, Subcommand};\nuse directories::ProjectDirs;\nuse libp2p::identity::Keypair;\nuse rpc_client::{\n    rpc_create_deposit_intent, rpc_send_direct_message, rpc_spend, rpc_start_signing,\n};\nuse std::{fs, path::PathBuf};\n\nuse node::{start_node::start_node, Config, EncryptionParams, KeyData, PeerData};\n\nuse crate::errors::{CliError, KeygenError};\n\nfn get_key_file_path() -\u003e Result\u003cPathBuf, KeygenError\u003e {\n    let proj_dirs = ProjectDirs::from(\"\", \"\", \"TheVault\").ok_or_else(|| {\n        KeygenError::DirectoryCreation(\"Failed to determine project directory\".into())\n    })?;\n\n    let config_dir = proj_dirs.config_dir();\n    fs::create_dir_all(config_dir).map_err(|e| KeygenError::DirectoryCreation(e.to_string()))?;\n\n    Ok(config_dir.join(\"config.json\"))\n}\n\nfn get_log_file_path() -\u003e Result\u003cPathBuf, KeygenError\u003e {\n    let proj_dirs = ProjectDirs::from(\"\", \"\", \"TheVault\").ok_or_else(|| {\n        KeygenError::DirectoryCreation(\"Failed to determine project directory\".into())\n    })?;\n\n    let log_dir = proj_dirs.config_dir();\n    let path = log_dir.join(\"node.log\");\n    Ok(path)\n}\n\nfn generate_key(password: \u0026str, salt: \u0026SaltString) -\u003e Result\u003cVec\u003cu8\u003e, KeygenError\u003e {\n    let argon2 = Argon2::default();\n    let password_bytes = password.as_bytes();\n    let mut key = vec![0u8; 32];\n\n    argon2\n        .hash_password_into(password_bytes, salt.as_str().as_bytes(), \u0026mut key)\n        .map_err(|e| KeygenError::Encryption(e.to_string()))?;\n    Ok(key)\n}\n\nfn encrypt_private_key(\n    keypair: \u0026Keypair,\n    password: \u0026str,\n) -\u003e Result\u003c(String, EncryptionParams), KeygenError\u003e {\n    let salt = SaltString::generate(\u0026mut OsRng);\n    let key = generate_key(password, \u0026salt)?;\n\n    let mut nonce_bytes = [0u8; 12];\n    OsRng.fill_bytes(\u0026mut nonce_bytes);\n    let nonce = Nonce::from_slice(\u0026nonce_bytes);\n\n    let private_key_bytes = keypair\n        .to_protobuf_encoding()\n        .map_err(|e| KeygenError::KeyEncoding(e.to_string()))?;\n\n    let cipher = Aes256Gcm::new(Key::\u003cAes256Gcm\u003e::from_slice(\u0026key));\n\n    let ciphertext = cipher\n        .encrypt(nonce, private_key_bytes.as_ref())\n        .map_err(|e| KeygenError::Encryption(e.to_string()))?;\n\n    let params = EncryptionParams {\n        kdf: \"argon2id\".to_string(),\n        salt_b64: salt.to_string(),\n        iv_b64: BASE64.encode(nonce_bytes),\n    };\n\n    Ok((BASE64.encode(ciphertext), params))\n}\n\nfn get_password() -\u003e Result\u003cString, KeygenError\u003e {\n    let password = rpassword::prompt_password(\"Enter password: \").map_err(KeygenError::Io)?;\n\n    let confirm = rpassword::prompt_password(\"Confirm password: \").map_err(KeygenError::Io)?;\n\n    if password != confirm {\n        return Err(KeygenError::PasswordMismatch);\n    }\n\n    Ok(password)\n}\n\n#[derive(Parser)]\n#[command(name = \"keygen\")]\n#[command(about = \"Generate public and private key pairs for the Vault.\")]\n#[command(version = \"0.0.1\")]\nstruct Cli {\n    #[command(subcommand)]\n    command: Commands,\n}\n\n#[derive(Subcommand)]\nenum Commands {\n    /// Generate a new keypair and save it to a file set by the --output flag\n    Setup {\n        #[arg(short, long)]\n        output: Option\u003cString\u003e,\n        #[arg(short, long)]\n        allowed_peers: Option\u003cVec\u003cString\u003e\u003e,\n    },\n    /// Run the node and connect to the network\n    Run {\n        #[arg(short, long)]\n        config: Option\u003cString\u003e,\n        #[arg(short, long)]\n        grpc_port: Option\u003cu16\u003e,\n        #[arg(short, long)]\n        log_file: Option\u003cString\u003e,\n        #[arg(short = 'n', long)]\n        max_signers: Option\u003cu16\u003e,\n        #[arg(short = 't', long)]\n        min_signers: Option\u003cu16\u003e,\n    },\n    Spend {\n        amount: u64,\n        #[arg(short, long)]\n        endpoint: Option\u003cString\u003e,\n    },\n    StartSigning {\n        hex_message: String,\n        #[arg(short, long)]\n        endpoint: Option\u003cString\u003e,\n    },\n    SendDirectMessage {\n        peer_id: String,\n        message: String,\n        #[arg(short, long)]\n        endpoint: Option\u003cString\u003e,\n    },\n    Deposit {\n        peer_id: String,\n        amount: u64,\n        #[arg(short, long)]\n        endpoint: Option\u003cString\u003e,\n    },\n}\n\n#[tokio::main]\n#[allow(clippy::result_large_err)]\nasync fn main() -\u003e Result\u003c(), CliError\u003e {\n    let cli = Cli::parse();\n\n    match cli.command {\n        Commands::Setup {\n            output,\n            allowed_peers,\n        } =\u003e {\n            setup_config(output, allowed_peers).map_err(|e| {\n                println!(\"Keygen Error: {}\", e);\n                CliError::KeygenError(e)\n            })?;\n        }\n        Commands::Run {\n            config,\n            grpc_port,\n            log_file,\n            max_signers,\n            min_signers,\n        } =\u003e {\n            start_node_cli(config, grpc_port, log_file, max_signers, min_signers)\n                .await\n                .map_err(|_| CliError::NodeError)?;\n        }\n        Commands::Spend { amount, endpoint } =\u003e {\n            rpc_spend(endpoint, amount)\n                .await\n                .map_err(CliError::RpcError)?;\n        }\n        Commands::StartSigning {\n            hex_message,\n            endpoint,\n        } =\u003e {\n            rpc_start_signing(endpoint, hex_message)\n                .await\n                .map_err(CliError::RpcError)?;\n        }\n        Commands::SendDirectMessage {\n            peer_id,\n            message,\n            endpoint,\n        } =\u003e {\n            rpc_send_direct_message(endpoint, peer_id, message)\n                .await\n                .map_err(CliError::RpcError)?;\n        }\n        Commands::Deposit {\n            peer_id,\n            amount,\n            endpoint,\n        } =\u003e {\n            rpc_create_deposit_intent(endpoint, peer_id, amount)\n                .await\n                .map_err(CliError::RpcError)?;\n        }\n    };\n\n    Ok(())\n}\n\nfn setup_config(\n    output: Option\u003cString\u003e,\n    allowed_peers: Option\u003cVec\u003cString\u003e\u003e,\n) -\u003e Result\u003c(), KeygenError\u003e {\n    let keypair = Keypair::generate_ed25519();\n    let public_key_b58 = keypair.public().to_peer_id().to_base58();\n\n    let user_password = get_password()?;\n\n    let (encrypted_private_key, encryption_params) = encrypt_private_key(\u0026keypair, \u0026user_password)?;\n\n    let key_data = KeyData {\n        public_key_b58: public_key_b58.clone(),\n        encrypted_private_key_b64: encrypted_private_key,\n        encryption_params,\n    };\n\n    let allowed_peer_ids = allowed_peers.unwrap_or_default();\n\n    let allowed_peer_data = allowed_peer_ids\n        .iter()\n        .map(|peer_id| PeerData {\n            public_key: peer_id.to_string(),\n            name: peer_id.to_string(),\n        })\n        .collect();\n\n    let config = Config {\n        allowed_peers: allowed_peer_data,\n        key_data,\n        dkg_keys: None,\n        log_file_path: Some(get_log_file_path()?),\n    };\n\n    let json = serde_json::to_string_pretty(\u0026config)\n        .map_err(|e| KeygenError::Io(std::io::Error::other(e)))?;\n\n    let key_file_path = if let Some(output) = output {\n        let path = PathBuf::from(output);\n        if path.is_dir() {\n            return Err(KeygenError::KeyFileNotFound(format!(\n                \"The path {} is a directory\",\n                path.display()\n            )));\n        } else {\n            path\n        }\n    } else {\n        get_key_file_path()?\n    };\n\n    fs::write(\u0026key_file_path, json).map_err(KeygenError::Io)?;\n\n    println!(\n        \"Key data has been saved to {} with the peer id {}. To modify the allowed peers, edit the config file.\",\n        key_file_path.display(),\n        public_key_b58\n    );\n\n    Ok(())\n}\n\nasync fn start_node_cli(\n    config_filepath: Option\u003cString\u003e,\n    grpc_port: Option\u003cu16\u003e,\n    log_file: Option\u003cString\u003e,\n    max_signers: Option\u003cu16\u003e,\n    min_signers: Option\u003cu16\u003e,\n) -\u003e Result\u003c(), Box\u003cdyn std::error::Error\u003e\u003e {\n    start_node(\n        max_signers,\n        min_signers,\n        config_filepath,\n        grpc_port,\n        log_file.map(PathBuf::from),\n    )\n    .await?;\n    Ok(())\n}\n\n#[cfg(test)]\nmod tests;\n","traces":[{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":6}},{"line":50,"address":[],"length":0,"stats":{"Line":6}},{"line":51,"address":[],"length":0,"stats":{"Line":6}},{"line":52,"address":[],"length":0,"stats":{"Line":6}},{"line":54,"address":[],"length":0,"stats":{"Line":6}},{"line":55,"address":[],"length":0,"stats":{"Line":6}},{"line":56,"address":[],"length":0,"stats":{"Line":12}},{"line":57,"address":[],"length":0,"stats":{"Line":6}},{"line":60,"address":[],"length":0,"stats":{"Line":4}},{"line":64,"address":[],"length":0,"stats":{"Line":4}},{"line":65,"address":[],"length":0,"stats":{"Line":8}},{"line":71,"address":[],"length":0,"stats":{"Line":4}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":4}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":236,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":250,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":260,"address":[],"length":0,"stats":{"Line":0}},{"line":261,"address":[],"length":0,"stats":{"Line":0}},{"line":264,"address":[],"length":0,"stats":{"Line":0}},{"line":267,"address":[],"length":0,"stats":{"Line":0}},{"line":270,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":0}},{"line":273,"address":[],"length":0,"stats":{"Line":0}},{"line":274,"address":[],"length":0,"stats":{"Line":0}},{"line":275,"address":[],"length":0,"stats":{"Line":0}},{"line":278,"address":[],"length":0,"stats":{"Line":0}},{"line":281,"address":[],"length":0,"stats":{"Line":0}},{"line":289,"address":[],"length":0,"stats":{"Line":0}},{"line":290,"address":[],"length":0,"stats":{"Line":0}},{"line":291,"address":[],"length":0,"stats":{"Line":0}},{"line":292,"address":[],"length":0,"stats":{"Line":0}},{"line":293,"address":[],"length":0,"stats":{"Line":0}},{"line":295,"address":[],"length":0,"stats":{"Line":0}},{"line":296,"address":[],"length":0,"stats":{"Line":0}}],"covered":13,"coverable":116},{"path":["/","home","vidyootsenthil","TheValut-nameTBD","experiments","cli","src","rpc_client.rs"],"content":"use node::grpc::grpc_handler::node_proto::{\n    self, node_control_client::NodeControlClient, CreateDepositIntentResponse,\n    SendDirectMessageResponse, SpendFundsResponse, StartSigningResponse,\n};\nuse tonic::Status;\n\npub async fn rpc_spend(\n    endpoint: Option\u003cString\u003e,\n    amount: u64,\n) -\u003e Result\u003cSpendFundsResponse, Status\u003e {\n    println!(\"Spending {} satoshis\", amount);\n\n    let mut client =\n        NodeControlClient::connect(endpoint.unwrap_or(\"http://[::1]:50051\".to_string()))\n            .await\n            .expect(\"Failed to connect\");\n\n    let spendfunds_response = client\n        .spend_funds(tonic::Request::new(node_proto::SpendFundsRequest {\n            amount_satoshis: amount,\n        }))\n        .await?;\n\n    println!(\"Spent {:?} satoshis\", spendfunds_response);\n\n    Ok(spendfunds_response.into_inner())\n}\n\npub async fn rpc_start_signing(\n    endpoint: Option\u003cString\u003e,\n    hex_message: String,\n) -\u003e Result\u003cStartSigningResponse, Status\u003e {\n    println!(\"Starting signing session for message: {}\", hex_message);\n\n    let mut client =\n        NodeControlClient::connect(endpoint.unwrap_or(\"http://[::1]:50051\".to_string()))\n            .await\n            .expect(\"Failed to connect\");\n\n    let start_signing_response = client\n        .start_signing(tonic::Request::new(node_proto::StartSigningRequest {\n            hex_message,\n        }))\n        .await?;\n\n    Ok(start_signing_response.into_inner())\n}\n\npub async fn rpc_send_direct_message(\n    endpoint: Option\u003cString\u003e,\n    peer_id: String,\n    message: String,\n) -\u003e Result\u003cSendDirectMessageResponse, Status\u003e {\n    println!(\"Sending direct message to {}: {}\", peer_id, message);\n\n    let mut client =\n        NodeControlClient::connect(endpoint.unwrap_or(\"http://[::1]:50051\".to_string()))\n            .await\n            .expect(\"Failed to connect\");\n\n    let send_direct_message_response = client\n        .send_direct_message(tonic::Request::new(node_proto::SendDirectMessageRequest {\n            peer_id,\n            message,\n        }))\n        .await?;\n\n    Ok(send_direct_message_response.into_inner())\n}\n\npub async fn rpc_create_deposit_intent(\n    endpoint: Option\u003cString\u003e,\n    peer_id: String,\n    amount: u64,\n) -\u003e Result\u003cCreateDepositIntentResponse, Status\u003e {\n    println!(\"Creating deposit intent for user {}: {}\", peer_id, amount);\n\n    let mut client =\n        NodeControlClient::connect(endpoint.unwrap_or(\"http://[::1]:50051\".to_string()))\n            .await\n            .expect(\"Failed to connect\");\n\n    let create_deposit_intent_response = client\n        .create_deposit_intent(tonic::Request::new(\n            node_proto::CreateDepositIntentRequest {\n                user_id: peer_id,\n                amount_satoshis: amount,\n            },\n        ))\n        .await?;\n\n    Ok(create_deposit_intent_response.into_inner())\n}\n","traces":[{"line":7,"address":[],"length":0,"stats":{"Line":0}},{"line":11,"address":[],"length":0,"stats":{"Line":0}},{"line":13,"address":[],"length":0,"stats":{"Line":0}},{"line":14,"address":[],"length":0,"stats":{"Line":0}},{"line":15,"address":[],"length":0,"stats":{"Line":0}},{"line":18,"address":[],"length":0,"stats":{"Line":0}},{"line":19,"address":[],"length":0,"stats":{"Line":0}},{"line":20,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":44},{"path":["/","home","vidyootsenthil","TheValut-nameTBD","experiments","cli","src","tests.rs"],"content":"use super::*;\nuse assert_matches::assert_matches;\nuse std::fs;\nuse tempfile::tempdir;\n\n// Helper function to decrypt private key\nfn decrypt_private_key(\n    encrypted_key: \u0026str,\n    password: \u0026str,\n    params: \u0026EncryptionParams,\n) -\u003e Result\u003cVec\u003cu8\u003e, KeygenError\u003e {\n    let salt = SaltString::from_b64(\u0026params.salt_b64)\n        .map_err(|e| KeygenError::Encryption(e.to_string()))?;\n    let key = generate_key(password, \u0026salt)?;\n\n    let nonce_bytes = BASE64\n        .decode(\u0026params.iv_b64)\n        .map_err(|e| KeygenError::Encryption(e.to_string()))?;\n    let nonce = Nonce::from_slice(\u0026nonce_bytes);\n\n    let cipher = Aes256Gcm::new(Key::\u003cAes256Gcm\u003e::from_slice(\u0026key));\n\n    let ciphertext = BASE64\n        .decode(encrypted_key)\n        .map_err(|e| KeygenError::Encryption(e.to_string()))?;\n\n    cipher\n        .decrypt(nonce, ciphertext.as_ref())\n        .map_err(|e| KeygenError::Encryption(e.to_string()))\n}\n\n// Test helper to generate keypair without password prompt\nfn generate_test_keypair(output_path: Option\u003cPathBuf\u003e, password: \u0026str) -\u003e Result\u003c(), KeygenError\u003e {\n    let keypair = Keypair::generate_ed25519();\n    let public_key = keypair.public().encode_protobuf();\n    let public_key_b58 = bs58::encode(public_key).into_string();\n\n    let (encrypted_private_key, encryption_params) = encrypt_private_key(\u0026keypair, password)?;\n\n    let key_data = KeyData {\n        public_key_b58: public_key_b58.clone(),\n        encrypted_private_key_b64: encrypted_private_key,\n        encryption_params,\n    };\n\n    let json = serde_json::to_string_pretty(\u0026key_data)\n        .map_err(|e| KeygenError::Io(std::io::Error::other(e)))?;\n\n    let key_file_path = if let Some(path) = output_path {\n        if path.is_dir() {\n            path.join(\"config.json\")\n        } else {\n            path\n        }\n    } else {\n        get_key_file_path()?\n    };\n\n    fs::write(\u0026key_file_path, json).map_err(KeygenError::Io)?;\n    Ok(())\n}\n\n#[test]\nfn test_key_generation_and_encryption() {\n    let keypair = Keypair::generate_ed25519();\n    let password = \"test_password123\";\n\n    let (encrypted_key, params) = encrypt_private_key(\u0026keypair, password).unwrap();\n\n    assert_eq!(params.kdf, \"argon2id\");\n    assert!(!params.salt_b64.is_empty());\n    assert!(!params.iv_b64.is_empty());\n    assert!(!encrypted_key.is_empty());\n\n    // Verify we can decrypt with correct password\n    let decrypted = decrypt_private_key(\u0026encrypted_key, password, \u0026params).unwrap();\n    let original = keypair.to_protobuf_encoding().unwrap();\n    assert_eq!(decrypted, original);\n}\n\n#[test]\nfn test_decryption_with_wrong_password() {\n    let keypair = Keypair::generate_ed25519();\n    let password = \"correct_password\";\n    let wrong_password = \"wrong_password\";\n\n    let (encrypted_key, params) = encrypt_private_key(\u0026keypair, password).unwrap();\n\n    // Attempt decryption with wrong password should fail\n    let result = decrypt_private_key(\u0026encrypted_key, wrong_password, \u0026params);\n    assert!(result.is_err());\n}\n\n#[test]\nfn test_key_file_operations() {\n    let temp_dir = tempdir().unwrap();\n    let output_path = temp_dir.path().join(\"test_config.json\");\n\n    // Test key generation and file writing\n    let result = generate_test_keypair(Some(output_path.clone()), \"test_password123\");\n    assert!(result.is_ok());\n\n    // Verify file exists and contains valid JSON\n    let contents = fs::read_to_string(\u0026output_path).unwrap();\n    let key_data: KeyData = serde_json::from_str(\u0026contents).unwrap();\n\n    assert!(!key_data.public_key_b58.is_empty());\n    assert!(!key_data.encrypted_private_key_b64.is_empty());\n    assert_eq!(key_data.encryption_params.kdf, \"argon2id\");\n}\n\n#[test]\nfn test_invalid_directory() {\n    // Test with a non-existent directory\n    let result = generate_test_keypair(\n        Some(PathBuf::from(\"/nonexistent/path/config.json\")),\n        \"test_password123\",\n    );\n    assert_matches!(result, Err(KeygenError::Io(_)));\n}\n\n#[test]\nfn test_key_encoding() {\n    let keypair = Keypair::generate_ed25519();\n    let public_key = keypair.public().encode_protobuf();\n    let public_key_b58 = bs58::encode(public_key).into_string();\n\n    // Verify the public key is properly encoded\n    assert!(!public_key_b58.is_empty());\n    assert!(bs58::decode(\u0026public_key_b58).into_vec().is_ok());\n}\n\n#[test]\nfn test_encryption_params_serialization() {\n    let params = EncryptionParams {\n        kdf: \"argon2id\".to_string(),\n        salt_b64: \"test_salt\".to_string(),\n        iv_b64: \"test_iv\".to_string(),\n    };\n\n    let json = serde_json::to_string(\u0026params).unwrap();\n    let deserialized: EncryptionParams = serde_json::from_str(\u0026json).unwrap();\n\n    assert_eq!(params.kdf, deserialized.kdf);\n    assert_eq!(params.salt_b64, deserialized.salt_b64);\n    assert_eq!(params.iv_b64, deserialized.iv_b64);\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","vidyootsenthil","TheValut-nameTBD","node","build.rs"],"content":"fn main() -\u003e Result\u003c(), Box\u003cdyn std::error::Error\u003e\u003e {\n    tonic_build::compile_protos(\"proto/node.proto\")?;\n    Ok(())\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","vidyootsenthil","TheValut-nameTBD","node","src","db.rs"],"content":"use rocksdb::DB;\n\nuse crate::{\n    errors::NodeError,\n    protocol::{\n        block::{Block, BlockHash},\n        chain_state::ChainState,\n    },\n};\n\npub struct Db {\n    pub db: DB,\n}\n\nimpl Db {\n    pub fn new(path: \u0026str) -\u003e Self {\n        let db = DB::open_default(path).unwrap();\n        Self { db }\n    }\n\n    pub fn get_value(\u0026self, key: \u0026str) -\u003e Option\u003cString\u003e {\n        let value = self.db.get(key).unwrap();\n        value.map(|v| String::from_utf8(v).unwrap())\n    }\n\n    pub fn set_value(\u0026self, key: \u0026str, value: \u0026str) {\n        self.db.put(key, value).unwrap();\n    }\n\n    pub fn get_block_by_height(\u0026self, height: u64) -\u003e Result\u003cOption\u003cBlock\u003e, NodeError\u003e {\n        let block_hash = self.db.get(format!(\"h:{}\", height))?;\n        if let Some(block_hash) = block_hash {\n            let block = self.db.get(format!(\"b:{}\", hex::encode(block_hash)))?;\n            Ok(block.and_then(|b| Block::deserialize(\u0026b).ok()))\n        } else {\n            Ok(None)\n        }\n    }\n\n    pub fn get_block_by_hash(\u0026self, hash: BlockHash) -\u003e Result\u003cOption\u003cBlock\u003e, NodeError\u003e {\n        let block = self.db.get(format!(\"b:{}\", hex::encode(hash)))?;\n        Ok(block.and_then(|b| Block::deserialize(\u0026b).ok()))\n    }\n\n    pub fn get_tip_block_hash(\u0026self) -\u003e Result\u003cOption\u003cBlockHash\u003e, NodeError\u003e {\n        let tip = self.db.get(\"h:tip\")?;\n        Ok(tip.and_then(|b| b.as_slice().try_into().ok()))\n    }\n\n    pub fn insert_chain_state(\u0026self, chain_state: ChainState) -\u003e Result\u003c(), NodeError\u003e {\n        self.db.put(\"c:state\", chain_state.serialize()?)?;\n        Ok(())\n    }\n\n    pub fn get_chain_state(\u0026self) -\u003e Result\u003cOption\u003cChainState\u003e, NodeError\u003e {\n        let chain_state = self.db.get(\"c:state\")?;\n        Ok(chain_state.and_then(|b| ChainState::deserialize(\u0026b).ok()))\n    }\n\n    pub fn insert_block(\u0026self, block: Block) -\u003e Result\u003c(), NodeError\u003e {\n        let block_hash = block.hash();\n        self.db\n            .put(format!(\"b:{}\", hex::encode(block_hash)), block.serialize()?)\n            .map_err(|e| NodeError::Error(format!(\"Failed to insert block: {}\", e)))?;\n\n        self.db\n            .put(format!(\"h:{}\", block.header.height), block_hash)\n            .map_err(|e| NodeError::Error(format!(\"Failed to insert block: {}\", e)))?;\n\n        self.db.put(\"h:tip\", block_hash)?;\n\n        Ok(())\n    }\n}\n","traces":[{"line":16,"address":[],"length":0,"stats":{"Line":0}},{"line":17,"address":[],"length":0,"stats":{"Line":0}},{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":35},{"path":["/","home","vidyootsenthil","TheValut-nameTBD","node","src","dkg","mod.rs"],"content":"use std::collections::{BTreeMap, HashSet};\nuse tracing::{debug, error, info, warn};\n\nuse crate::{\n    errors::NodeError,\n    peer_id_to_identifier,\n    swarm_manager::{NetworkHandle, PrivateRequest, PrivateResponse},\n};\nuse frost_secp256k1::{\n    self as frost, Identifier,\n    keys::dkg::{round1, round2},\n};\nuse libp2p::PeerId;\n\npub mod utils;\n\npub struct DkgState {\n    pub dkg_started: bool,\n    pub network_handle: NetworkHandle,\n    pub min_signers: u16,\n    pub max_signers: u16,\n    pub rng: frost::rand_core::OsRng,\n    pub peer_id: PeerId,\n    pub peers: HashSet\u003cPeerId\u003e,\n\n    pub peers_to_names: BTreeMap\u003cPeerId, String\u003e,\n    pub dkg_listeners: HashSet\u003cPeerId\u003e,\n\n    pub config_file: String,\n\n    pub start_dkg_topic: libp2p::gossipsub::IdentTopic,\n    pub round1_topic: libp2p::gossipsub::IdentTopic,\n\n    pub round1_peer_packages: BTreeMap\u003cIdentifier, round1::Package\u003e,\n    pub round2_peer_packages: BTreeMap\u003cIdentifier, round2::Package\u003e,\n\n    pub r1_secret_package: Option\u003cround1::SecretPackage\u003e,\n    pub r2_secret_package: Option\u003cround2::SecretPackage\u003e,\n\n    pub pubkey_package: Option\u003cfrost::keys::PublicKeyPackage\u003e,\n    pub private_key_package: Option\u003cfrost::keys::KeyPackage\u003e,\n}\n\nimpl DkgState {\n    pub fn handle_dkg_start(\u0026mut self) -\u003e Result\u003c(), NodeError\u003e {\n        if self.dkg_started {\n            debug!(\"DKG already started, skipping DKG process\");\n            return Ok(());\n        }\n\n        // Check if DKG keys already exist\n        if self.private_key_package.is_some() \u0026\u0026 self.pubkey_package.is_some() {\n            info!(\"DKG keys already exist, skipping DKG process\");\n            if let Some(pubkey) = \u0026self.pubkey_package {\n                info!(\"Existing public key: {:?}\", pubkey.verifying_key());\n            }\n            return Ok(());\n        }\n\n        if self.dkg_listeners.len() + 1 != self.max_signers as usize {\n            debug!(\n                \"Not all listeners have subscribed to the DKG topic, not starting DKG process. Listeners: {:?}\",\n                self.dkg_listeners.len()\n            );\n            return Ok(());\n        }\n\n        self.dkg_started = true;\n\n        // Run the DKG initialization code\n        let participant_identifier = peer_id_to_identifier(\u0026self.peer_id);\n\n        let (round1_secret_package, round1_package) = frost::keys::dkg::part1(\n            participant_identifier,\n            self.max_signers,\n            self.min_signers,\n            self.rng,\n        )\n        .expect(\"Failed to generate round1 package\");\n\n        self.r1_secret_package = Some(round1_secret_package);\n\n        let round1_package_bytes = round1_package\n            .serialize()\n            .expect(\"Failed to serialize round1 package\");\n\n        // Broadcast START_DKG message to the network,\n        let start_message = format!(\"START_DKG:{}\", self.peer_id);\n\n        match self.network_handle.send_broadcast(\n            self.start_dkg_topic.clone(),\n            start_message.as_bytes().to_vec(),\n        ) {\n            Ok(_) =\u003e (),\n            Err(e) =\u003e {\n                return Err(NodeError::Error(format!(\n                    \"Failed to send broadcast: {:?}\",\n                    e\n                )));\n            }\n        }\n\n        match self\n            .network_handle\n            .send_broadcast(self.round1_topic.clone(), round1_package_bytes)\n        {\n            Ok(_) =\u003e (),\n            Err(e) =\u003e {\n                return Err(NodeError::Error(format!(\n                    \"Failed to send broadcast: {:?}\",\n                    e\n                )));\n            }\n        }\n\n        match self.try_enter_round2() {\n            Ok(_) =\u003e {\n                info!(\n                    \"Generated and published round1 package in response to DKG start signal from {}\",\n                    \u0026self.peer_id\n                );\n                Ok(())\n            }\n            Err(e) =\u003e Err(NodeError::Error(format!(\"Failed to enter round2: {}\", e))),\n        }\n    }\n\n    pub fn handle_round1_payload(\n        \u0026mut self,\n        sender_peer_id: PeerId,\n        package: Vec\u003cu8\u003e,\n    ) -\u003e Result\u003c(), NodeError\u003e {\n        let identifier = peer_id_to_identifier(\u0026sender_peer_id);\n        let package = match frost::keys::dkg::round1::Package::deserialize(\u0026package) {\n            Ok(package) =\u003e package,\n            Err(e) =\u003e {\n                return Err(NodeError::Error(format!(\n                    \"Failed to deserialize round1 package: {}\",\n                    e\n                )));\n            }\n        };\n        // Add package to peer packages\n        self.round1_peer_packages.insert(identifier, package);\n\n        debug!(\n            \"Received round1 package from {} ({}/{})\",\n            sender_peer_id,\n            self.round1_peer_packages.len(),\n            self.max_signers - 1\n        );\n\n        self.try_enter_round2()?;\n\n        Ok(())\n    }\n\n    pub fn try_enter_round2(\u0026mut self) -\u003e Result\u003c(), NodeError\u003e {\n        if let Some(r1_secret_package) = self.r1_secret_package.as_ref() {\n            if self.round1_peer_packages.len() + 1 == self.max_signers as usize {\n                info!(\"Received all round1 packages, entering part2\");\n                // all packages received\n                let part2_result =\n                    frost::keys::dkg::part2(r1_secret_package.clone(), \u0026self.round1_peer_packages);\n                match part2_result {\n                    Ok((round2_secret_package, round2_packages)) =\u003e {\n                        info!(\"-------------------- ENTERING ROUND 2 ---------------------\");\n                        self.r1_secret_package = None;\n                        self.r2_secret_package = Some(round2_secret_package);\n\n                        for peer_to_send_to in self.peers.iter() {\n                            let identifier = peer_id_to_identifier(peer_to_send_to);\n                            let package_to_send = match round2_packages.get(\u0026identifier) {\n                                Some(package) =\u003e package,\n                                None =\u003e {\n                                    warn!(\"Round2 package not found for {}\", peer_to_send_to);\n                                    return Err(NodeError::Error(format!(\n                                        \"Round2 package not found for {}\",\n                                        peer_to_send_to\n                                    )));\n                                }\n                            };\n\n                            let request = PrivateRequest::Round2Package(package_to_send.clone());\n\n                            match self\n                                .network_handle\n                                .send_private_request(*peer_to_send_to, request)\n                            {\n                                Ok(_) =\u003e (),\n                                Err(e) =\u003e {\n                                    error!(\"Round2 package not found for {}\", peer_to_send_to);\n                                    return Err(NodeError::Error(format!(\n                                        \"Failed to send private request: {:?}\",\n                                        e\n                                    )));\n                                }\n                            }\n\n                            debug!(\"Sent round2 package to {}\", peer_to_send_to);\n                        }\n                    }\n                    Err(e) =\u003e {\n                        return Err(NodeError::Error(format!(\"DKG round2 failed: {}\", e)));\n                    }\n                }\n            }\n        }\n\n        Ok(())\n    }\n\n    pub fn handle_round2_payload(\n        \u0026mut self,\n        sender_peer_id: PeerId,\n        package: round2::Package,\n        response_channel: libp2p::request_response::ResponseChannel\u003cPrivateResponse\u003e,\n    ) -\u003e Result\u003c(), NodeError\u003e {\n        let identifier = peer_id_to_identifier(\u0026sender_peer_id);\n\n        match self\n            .network_handle\n            .send_private_response(response_channel, PrivateResponse::Pong)\n        {\n            Ok(_) =\u003e (),\n            Err(e) =\u003e {\n                return Err(NodeError::Error(format!(\n                    \"Failed to send private response: {:?}\",\n                    e\n                )));\n            }\n        }\n\n        // Add package to peer packages\n        self.round2_peer_packages.insert(identifier, package);\n\n        debug!(\n            \"Received round2 package from {} ({}/{})\",\n            sender_peer_id,\n            self.round2_peer_packages.len(),\n            self.max_signers - 1\n        );\n\n        if let Some(r2_secret_package) = self.r2_secret_package.as_ref() {\n            if self.round2_peer_packages.len() + 1 == self.max_signers as usize {\n                info!(\"Received all round2 packages, entering part3\");\n                let part3_result = frost::keys::dkg::part3(\n                    \u0026r2_secret_package.clone(),\n                    \u0026self.round1_peer_packages,\n                    \u0026self.round2_peer_packages,\n                );\n\n                match part3_result {\n                    Ok((private_key_package, pubkey_package)) =\u003e {\n                        info!(\n                            \" DKG finished successfully. Public key: {:?}\",\n                            pubkey_package.verifying_key()\n                        );\n\n                        self.private_key_package = Some(private_key_package);\n                        self.pubkey_package = Some(pubkey_package);\n\n                        if let Err(e) = self.save_dkg_keys() {\n                            error!(\"Failed to save DKG keys: {}\", e);\n                        } else {\n                            info!(\"DKG keys saved to config file\");\n                        }\n\n                        self.dkg_started = false;\n                    }\n                    Err(e) =\u003e {\n                        error!(\"DKG failed during part3 aggregation: {}\", e);\n                        // Reset state so that a fresh DKG can be attempted again later\n                        self.reset_dkg_state();\n                    }\n                }\n            }\n        }\n\n        Ok(())\n    }\n\n    /// Reset DKG state after a failed run so that a new DKG round can be initiated.\n    fn reset_dkg_state(\u0026mut self) {\n        self.dkg_started = false;\n        self.r1_secret_package = None;\n        self.r2_secret_package = None;\n        self.round1_peer_packages.clear();\n        self.round2_peer_packages.clear();\n    }\n}\n","traces":[{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":222,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":239,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":244,"address":[],"length":0,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":250,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":260,"address":[],"length":0,"stats":{"Line":0}},{"line":261,"address":[],"length":0,"stats":{"Line":0}},{"line":263,"address":[],"length":0,"stats":{"Line":0}},{"line":264,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":0}},{"line":274,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":285,"address":[],"length":0,"stats":{"Line":0}},{"line":286,"address":[],"length":0,"stats":{"Line":0}},{"line":287,"address":[],"length":0,"stats":{"Line":0}},{"line":288,"address":[],"length":0,"stats":{"Line":0}},{"line":289,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":137},{"path":["/","home","vidyootsenthil","TheValut-nameTBD","node","src","dkg","utils.rs"],"content":"use std::{\n    collections::{BTreeMap, HashSet},\n    fs,\n    path::Path,\n};\n\nuse aes_gcm::{Aes256Gcm, Key, KeyInit, Nonce, aead::Aead};\nuse argon2::{Argon2, password_hash::SaltString};\nuse base64::{Engine as _, engine::general_purpose::STANDARD as BASE64};\nuse frost_secp256k1::{self as frost};\nuse libp2p::{PeerId, gossipsub};\n\nuse crate::{\n    Config, DkgKeys, EncryptionParams, KeyData, NodeError, PeerData,\n    dkg::DkgState,\n    protocol::block::{ChainConfig, GenesisBlock, ValidatorInfo},\n    swarm_manager::{NetworkHandle, PrivateRequest},\n};\n\nfn derive_key_from_password(\n    password: \u0026str,\n    salt_str: \u0026str,\n) -\u003e Result\u003cVec\u003cu8\u003e, Box\u003cdyn std::error::Error\u003e\u003e {\n    let argon2 = Argon2::default();\n    let password_bytes = password.as_bytes();\n    let salt =\n        SaltString::from_b64(salt_str).map_err(|e| format!(\"Salt decoding failed: {}\", e))?;\n\n    let mut key = vec![0u8; 32];\n    argon2\n        .hash_password_into(password_bytes, salt.as_str().as_bytes(), \u0026mut key)\n        .map_err(|e| format!(\"Argon2 key derivation failed: {}\", e))?;\n    Ok(key)\n}\n\nfn encrypt_dkg_private_key(\n    private_key_data: \u0026[u8],\n    password: \u0026str,\n    salt_b64: \u0026str,\n) -\u003e Result\u003c(String, String), Box\u003cdyn std::error::Error\u003e\u003e {\n    let key_bytes = derive_key_from_password(password, salt_b64)?;\n\n    // Generate random IV\n    let mut iv = [0u8; 12];\n    use frost::rand_core::RngCore;\n    frost::rand_core::OsRng.fill_bytes(\u0026mut iv);\n    let nonce = Nonce::from_slice(\u0026iv);\n\n    let cipher = Aes256Gcm::new(Key::\u003cAes256Gcm\u003e::from_slice(\u0026key_bytes));\n    let ciphertext = cipher\n        .encrypt(nonce, private_key_data)\n        .map_err(|e| format!(\"AES encryption failed: {}\", e))?;\n\n    let encrypted_b64 = BASE64.encode(ciphertext);\n    let iv_b64 = BASE64.encode(iv);\n\n    Ok((encrypted_b64, iv_b64))\n}\n\nfn decrypt_dkg_private_key(\n    encrypted_private_key_b64: \u0026str,\n    password: \u0026str,\n    params: \u0026EncryptionParams,\n) -\u003e Result\u003cVec\u003cu8\u003e, Box\u003cdyn std::error::Error\u003e\u003e {\n    let key_bytes = derive_key_from_password(password, \u0026params.salt_b64)?;\n\n    let iv_bytes = BASE64.decode(\u0026params.iv_b64)?;\n    let nonce = Nonce::from_slice(\u0026iv_bytes);\n\n    let ciphertext = BASE64.decode(encrypted_private_key_b64)?;\n\n    let cipher = Aes256Gcm::new(Key::\u003cAes256Gcm\u003e::from_slice(\u0026key_bytes));\n    let decrypted_private_key = cipher\n        .decrypt(nonce, ciphertext.as_ref())\n        .map_err(|e| format!(\"AES decryption failed: {}\", e))?;\n\n    Ok(decrypted_private_key)\n}\n\nfn get_password_for_dkg() -\u003e Result\u003cString, Box\u003cdyn std::error::Error\u003e\u003e {\n    match std::env::var(\"KEY_PASSWORD\") {\n        Ok(pw) =\u003e Ok(pw),\n        Err(_) =\u003e {\n            use std::io::{self, Write};\n            print!(\"Enter password to encrypt/decrypt DKG keys: \");\n            io::stdout().flush()?;\n            let password = rpassword::read_password()?;\n            Ok(password)\n        }\n    }\n}\n\nimpl DkgState {\n    pub fn get_public_key(\u0026self) -\u003e Option\u003cfrost::keys::PublicKeyPackage\u003e {\n        self.pubkey_package.clone()\n    }\n\n    pub fn get_private_key(\u0026self) -\u003e Option\u003cfrost::keys::KeyPackage\u003e {\n        self.private_key_package.clone()\n    }\n}\n\nimpl DkgState {\n    pub fn new(\n        network_handle: NetworkHandle,\n        min_signers: u16,\n        max_signers: u16,\n        peer_id: PeerId,\n        peers_to_names: BTreeMap\u003cPeerId, String\u003e,\n        config_file: String,\n    ) -\u003e Result\u003cSelf, NodeError\u003e {\n        let mut dkg_state = DkgState {\n            network_handle,\n            min_signers,\n            max_signers,\n            rng: frost::rand_core::OsRng,\n            peer_id,\n            peers_to_names,\n            dkg_listeners: HashSet::new(),\n            config_file,\n            start_dkg_topic: gossipsub::IdentTopic::new(\"start-dkg\"),\n            round1_topic: gossipsub::IdentTopic::new(\"round1_topic\"),\n            round1_peer_packages: BTreeMap::new(),\n            round2_peer_packages: BTreeMap::new(),\n            r1_secret_package: None,\n            r2_secret_package: None,\n            pubkey_package: None,\n            private_key_package: None,\n            peers: HashSet::new(),\n            dkg_started: false,\n        };\n\n        let keys = DkgState::load_dkg_keys(\u0026dkg_state.config_file)\n            .map_err(|e| NodeError::Error(format!(\"Failed to load DKG keys: {}\", e)))?;\n\n        if let Some((private_key, pubkey)) = keys {\n            dkg_state.private_key_package = Some(private_key);\n            dkg_state.pubkey_package = Some(pubkey);\n        }\n\n        Ok(dkg_state)\n    }\n\n    pub fn save_dkg_keys(\u0026self) -\u003e Result\u003c(), NodeError\u003e {\n        // Load existing config or create new one\n        let mut config = if Path::new(\u0026self.config_file).exists() {\n            let config_str = fs::read_to_string(\u0026self.config_file)\n                .map_err(|e| NodeError::Error(format!(\"Failed to read config: {}\", e)))?;\n            serde_json::from_str::\u003cConfig\u003e(\u0026config_str)\n                .map_err(|e| NodeError::Error(format!(\"Failed to deserialize config: {}\", e)))?\n        } else {\n            // For new configs, we need to create a dummy key_data\n            // This is not ideal but maintains compatibility with the structure\n            Config {\n                allowed_peers: self\n                    .peers_to_names\n                    .iter()\n                    .map(|(peer_id, name)| PeerData {\n                        name: name.clone(),\n                        public_key: peer_id.to_string(),\n                    })\n                    .collect(),\n                key_data: KeyData {\n                    public_key_b58: self.peer_id.to_string(),\n                    encrypted_private_key_b64: String::new(),\n                    encryption_params: EncryptionParams {\n                        kdf: String::new(),\n                        salt_b64: String::new(),\n                        iv_b64: String::new(),\n                    },\n                },\n                dkg_keys: None,\n                log_file_path: None,\n            }\n        };\n\n        // Update DKG keys if they exist\n        if let (Some(private_key), Some(pubkey)) = (\u0026self.private_key_package, \u0026self.pubkey_package)\n        {\n            let password = get_password_for_dkg()\n                .map_err(|e| NodeError::Error(format!(\"Failed to get password for DKG: {}\", e)))?;\n\n            // Serialize private key to bytes\n            let private_key_bytes = private_key\n                .serialize()\n                .map_err(|e| NodeError::Error(format!(\"Failed to serialize private key: {}\", e)))?;\n\n            // Use existing salt from key_data, or generate a new one if empty\n            let salt_b64 = if config.key_data.encryption_params.salt_b64.is_empty() {\n                // Generate a new salt\n                use frost::rand_core::RngCore;\n                let mut salt = [0u8; 16];\n                frost::rand_core::OsRng.fill_bytes(\u0026mut salt);\n                BASE64.encode(salt)\n            } else {\n                config.key_data.encryption_params.salt_b64.clone()\n            };\n\n            // Encrypt the private key package\n            let (encrypted_private_key_b64, iv_b64) =\n                encrypt_dkg_private_key(\u0026private_key_bytes, \u0026password, \u0026salt_b64).map_err(|e| {\n                    NodeError::Error(format!(\"Failed to encrypt private key: {}\", e))\n                })?;\n\n            // Serialize and base64 encode the public key package\n            let pubkey_bytes = pubkey\n                .serialize()\n                .map_err(|e| NodeError::Error(format!(\"Failed to serialize public key: {}\", e)))?;\n            let pubkey_package_b64 = BASE64.encode(pubkey_bytes);\n\n            config.dkg_keys = Some(DkgKeys {\n                encrypted_private_key_package_b64: encrypted_private_key_b64,\n                dkg_encryption_params: EncryptionParams {\n                    kdf: \"argon2id\".to_string(),\n                    salt_b64,\n                    iv_b64,\n                },\n                pubkey_package_b64,\n            });\n            let validators = self\n                .peers\n                .iter()\n                .map(|peer_id| ValidatorInfo {\n                    pub_key: peer_id.to_bytes(),\n                    stake: 100,\n                })\n                .collect();\n\n            let chain_config = ChainConfig {\n                block_time_seconds: 10,\n                min_signers: self.min_signers,\n                max_signers: self.max_signers,\n                min_stake: 100,\n                max_block_size: 1000,\n            };\n\n            let genesis_block = GenesisBlock::new(\n                validators,\n                chain_config,\n                pubkey.serialize().map_err(|e| {\n                    NodeError::Error(format!(\"Failed to serialize public key: {}\", e))\n                })?,\n            );\n            self.network_handle\n                .send_self_request(\n                    PrivateRequest::InsertBlock {\n                        block: genesis_block.to_block(),\n                    },\n                    false,\n                )\n                .map_err(|e| NodeError::Error(format!(\"Failed to send genesis block: {:?}\", e)))?;\n        }\n\n        // Save config\n        let config_str = serde_json::to_string_pretty(\u0026config)\n            .map_err(|e| NodeError::Error(format!(\"Failed to serialize config: {}\", e)))?;\n        fs::write(\u0026self.config_file, config_str)\n            .map_err(|e| NodeError::Error(format!(\"Failed to write config: {}\", e)))?;\n        Ok(())\n    }\n\n    pub fn load_dkg_keys(\n        config_path: \u0026str,\n    ) -\u003e Result\u003c\n        Option\u003c(frost::keys::KeyPackage, frost::keys::PublicKeyPackage)\u003e,\n        Box\u003cdyn std::error::Error\u003e,\n    \u003e {\n        if !Path::new(config_path).exists() {\n            return Ok(None);\n        }\n\n        let config_str = fs::read_to_string(config_path)?;\n        let config: Config = serde_json::from_str(\u0026config_str)?;\n\n        if let Some(dkg_keys) = config.dkg_keys {\n            let password = get_password_for_dkg()?;\n\n            // Decrypt the private key package\n            let private_key_bytes = decrypt_dkg_private_key(\n                \u0026dkg_keys.encrypted_private_key_package_b64,\n                \u0026password,\n                \u0026dkg_keys.dkg_encryption_params,\n            )?;\n\n            // Deserialize the private key from decrypted bytes\n            let private_key = frost::keys::KeyPackage::deserialize(\u0026private_key_bytes)?;\n\n            // Deserialize the public key from base64\n            let pubkey_bytes = BASE64.decode(\u0026dkg_keys.pubkey_package_b64)?;\n            let pubkey = frost::keys::PublicKeyPackage::deserialize(\u0026pubkey_bytes)?;\n\n            Ok(Some((private_key, pubkey)))\n        } else {\n            Ok(None)\n        }\n    }\n}\n","traces":[{"line":20,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[],"length":0,"stats":{"Line":0}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":239,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":244,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":268,"address":[],"length":0,"stats":{"Line":0}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":0}},{"line":273,"address":[],"length":0,"stats":{"Line":0}},{"line":275,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":281,"address":[],"length":0,"stats":{"Line":0}},{"line":282,"address":[],"length":0,"stats":{"Line":0}},{"line":286,"address":[],"length":0,"stats":{"Line":0}},{"line":289,"address":[],"length":0,"stats":{"Line":0}},{"line":290,"address":[],"length":0,"stats":{"Line":0}},{"line":292,"address":[],"length":0,"stats":{"Line":0}},{"line":294,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":122},{"path":["/","home","vidyootsenthil","TheValut-nameTBD","node","src","errors.rs"],"content":"use std::error::Error;\n\nuse derive_more::Display;\nuse tokio::sync::mpsc::error::SendError;\n\nuse crate::swarm_manager::NetworkMessage;\n\n#[derive(Debug, Display)]\npub enum NodeError {\n    Error(String),\n}\n\n#[derive(Debug)]\npub enum NetworkError {\n    SendError(String),\n    RecvError,\n}\n\nimpl From\u003cSendError\u003cNetworkMessage\u003e\u003e for NetworkError {\n    fn from(e: SendError\u003cNetworkMessage\u003e) -\u003e Self {\n        NetworkError::SendError(e.to_string())\n    }\n}\n\nimpl From\u003crocksdb::Error\u003e for NodeError {\n    fn from(e: rocksdb::Error) -\u003e Self {\n        NodeError::Error(e.to_string())\n    }\n}\n\nimpl Error for NodeError {}\n","traces":[{"line":20,"address":[],"length":0,"stats":{"Line":0}},{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":4},{"path":["/","home","vidyootsenthil","TheValut-nameTBD","node","src","grpc","grpc_handler.rs"],"content":"use crate::swarm_manager::NetworkHandle;\nuse tonic::{Request, Response, Status};\n\nuse crate::grpc::grpc_operator;\n\n// Include the generated proto code\npub mod node_proto {\n    tonic::include_proto!(\"node\");\n}\n\nuse node_proto::{\n    node_control_server::{NodeControl, NodeControlServer},\n    *,\n};\n\npub struct NodeControlService {\n    network: NetworkHandle,\n}\n\nimpl NodeControlService {\n    pub fn new(network: NetworkHandle) -\u003e Self {\n        Self { network }\n    }\n\n    pub fn into_server(self) -\u003e NodeControlServer\u003cSelf\u003e {\n        NodeControlServer::new(self)\n    }\n}\n\n#[tonic::async_trait]\nimpl NodeControl for NodeControlService {\n    async fn start_dkg(\n        \u0026self,\n        _request: Request\u003cStartDkgRequest\u003e,\n    ) -\u003e Result\u003cResponse\u003cStartDkgResponse\u003e, Status\u003e {\n        grpc_operator::start_dkg(\u0026self.network, _request).await\n    }\n\n    async fn spend_funds(\n        \u0026self,\n        request: Request\u003cSpendFundsRequest\u003e,\n    ) -\u003e Result\u003cResponse\u003cSpendFundsResponse\u003e, Status\u003e {\n        grpc_operator::spend_funds(\u0026self.network, request).await\n    }\n\n    async fn start_signing(\n        \u0026self,\n        request: Request\u003cStartSigningRequest\u003e,\n    ) -\u003e Result\u003cResponse\u003cStartSigningResponse\u003e, Status\u003e {\n        grpc_operator::start_signing(\u0026self.network, request).await\n    }\n\n    async fn send_direct_message(\n        \u0026self,\n        request: Request\u003cSendDirectMessageRequest\u003e,\n    ) -\u003e Result\u003cResponse\u003cSendDirectMessageResponse\u003e, Status\u003e {\n        grpc_operator::send_direct_message(\u0026self.network, request).await\n    }\n\n    async fn create_deposit_intent(\n        \u0026self,\n        request: Request\u003cCreateDepositIntentRequest\u003e,\n    ) -\u003e Result\u003cResponse\u003cCreateDepositIntentResponse\u003e, Status\u003e {\n        grpc_operator::create_deposit_intent(\u0026self.network, request).await\n    }\n}\n","traces":[{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":8},{"path":["/","home","vidyootsenthil","TheValut-nameTBD","node","src","grpc","grpc_operator.rs"],"content":"use crate::grpc::grpc_handler::node_proto::{\n    CreateDepositIntentRequest, CreateDepositIntentResponse, SendDirectMessageRequest,\n    SendDirectMessageResponse, SpendFundsRequest, SpendFundsResponse, StartDkgRequest,\n    StartDkgResponse, StartSigningRequest, StartSigningResponse,\n};\nuse crate::swarm_manager::{NetworkHandle, PingBody, PrivateRequest, PrivateResponse};\nuse libp2p::PeerId;\nuse libp2p::gossipsub::IdentTopic;\nuse tonic::{Request, Response, Status};\nuse tracing::{debug, info};\n\nuse bitcoin::Address;\nuse bitcoin::Network;\nuse bitcoin::PublicKey;\nuse bitcoin::script::Builder;\nuse std::str::FromStr;\nuse uuid::Uuid;\n\npub async fn start_dkg(\n    network: \u0026NetworkHandle,\n    _request: Request\u003cStartDkgRequest\u003e,\n) -\u003e Result\u003cResponse\u003cStartDkgResponse\u003e, Status\u003e {\n    // Create start-dkg topic\n    let start_dkg_topic = IdentTopic::new(\"start-dkg\");\n\n    // Send a message to start DKG\n    let start_message = \"START_DKG\".to_string();\n\n    match network.send_broadcast(start_dkg_topic.clone(), start_message.as_bytes().to_vec()) {\n        Ok(_) =\u003e Ok(Response::new(StartDkgResponse {\n            success: true,\n            message: \"DKG process started\".to_string(),\n        })),\n        Err(e) =\u003e Err(Status::internal(format!(\"Network error: {:?}\", e))),\n    }\n}\n\npub async fn spend_funds(\n    network: \u0026NetworkHandle,\n    request: Request\u003cSpendFundsRequest\u003e,\n) -\u003e Result\u003cResponse\u003cSpendFundsResponse\u003e, Status\u003e {\n    let amount_sat = request.into_inner().amount_satoshis;\n\n    debug!(\"Received request to spend {} satoshis\", amount_sat);\n    let response = network\n        .send_self_request(PrivateRequest::Spend { amount_sat }, true)\n        .map_err(|e| Status::internal(format!(\"Network error: {:?}\", e)))?\n        .ok_or(Status::internal(\"No response from node\"))?\n        .await\n        .map_err(|e| Status::internal(format!(\"Network error: {:?}\", e)))?;\n\n    let PrivateResponse::SpendRequestSent { sighash } = response else {\n        return Err(Status::internal(\"Invalid response from node\"));\n    };\n\n    Ok(Response::new(SpendFundsResponse {\n        success: true,\n        message: format!(\"Spending {} satoshis\", amount_sat),\n        sighash: sighash.to_string(),\n    }))\n}\n\npub async fn start_signing(\n    network: \u0026NetworkHandle,\n    request: Request\u003cStartSigningRequest\u003e,\n) -\u003e Result\u003cResponse\u003cStartSigningResponse\u003e, Status\u003e {\n    let hex_msg = request.into_inner().hex_message;\n\n    let network_request = PrivateRequest::StartSigningSession {\n        hex_message: hex_msg.clone(),\n    };\n\n    let response = network\n        .send_self_request(network_request, true)\n        .map_err(|e| Status::internal(format!(\"Network error: {:?}\", e)))?\n        .ok_or(Status::internal(\"No response from node\"))?\n        .await\n        .map_err(|e| Status::internal(format!(\"Network error: {:?}\", e)))?;\n\n    let PrivateResponse::StartSigningSession { sign_id } = response else {\n        return Err(Status::internal(format!(\n            \"Invalid response from node {:?}\",\n            response\n        )));\n    };\n\n    Ok(Response::new(StartSigningResponse {\n        success: true,\n        message: \"Signing session started\".to_string(),\n        sign_id,\n    }))\n}\n\npub async fn send_direct_message(\n    network: \u0026NetworkHandle,\n    request: Request\u003cSendDirectMessageRequest\u003e,\n) -\u003e Result\u003cResponse\u003cSendDirectMessageResponse\u003e, Status\u003e {\n    let req = request.into_inner();\n\n    let target_peer_id = req\n        .peer_id\n        .parse::\u003cPeerId\u003e()\n        .map_err(|e| Status::invalid_argument(format!(\"Invalid peer ID: {}\", e)))?;\n\n    let direct_message = format!(\"From: {}\", req.message);\n\n    match network.send_private_request(\n        target_peer_id,\n        PrivateRequest::Ping(PingBody {\n            message: direct_message,\n        }),\n    ) {\n        Ok(_) =\u003e Ok(Response::new(SendDirectMessageResponse {\n            success: true,\n            message: format!(\"Message sent to {}\", target_peer_id),\n        })),\n        Err(e) =\u003e Err(Status::internal(format!(\"Network error: {:?}\", e))),\n    }\n}\n\npub async fn create_deposit_intent(\n    network: \u0026NetworkHandle,\n    request: Request\u003cCreateDepositIntentRequest\u003e,\n) -\u003e Result\u003cResponse\u003cCreateDepositIntentResponse\u003e, Status\u003e {\n    let req = request.into_inner();\n\n    let user_id = req\n        .user_id\n        .parse::\u003cPeerId\u003e()\n        .map_err(|e| Status::invalid_argument(format!(\"Invalid peer ID: {}\", e)))?;\n\n    let amount_sat = if req.amount_satoshis \u003e 0 {\n        req.amount_satoshis\n    } else {\n        return Err(Status::invalid_argument(\n            \"Amount to deposit must be greater than 0\",\n        ));\n    };\n\n    let deposit_tracking_id = Uuid::new_v4().to_string();\n\n    let frost_pubkey_hex = network\n        .send_self_request(PrivateRequest::GetFrostPublicKey, true)\n        .map_err(|e| Status::internal(format!(\"Network error: {:?}\", e)))?\n        .ok_or(Status::internal(\"No response from node\"))?\n        .await\n        .map_err(|e| Status::internal(format!(\"Network error: {:?}\", e)))?;\n\n    let PrivateResponse::GetFrostPublicKey { public_key } = frost_pubkey_hex else {\n        return Err(Status::internal(\n            \"Invalid response from node. No public key found.\",\n        ));\n    };\n\n    let public_key = PublicKey::from_str(\u0026public_key)\n        .map_err(|e| Status::internal(format!(\"Failed to parse public key: {}\", e)))?;\n\n    let witness_script = Builder::new()\n        .push_key(\u0026public_key)\n        .push_opcode(bitcoin::opcodes::all::OP_CHECKSIG)\n        .into_script();\n\n    let deposit_address = Address::p2wsh(\u0026witness_script, Network::Testnet);\n\n    info!(\n        \"Received request to create deposit intent for user {} with amount {}. Tracking ID: {}. Deposit Address: {}\",\n        user_id,\n        amount_sat,\n        deposit_tracking_id.clone(),\n        deposit_address\n    );\n\n    Ok(Response::new(CreateDepositIntentResponse {\n        success: true,\n        message: format!(\"Deposit intent created for user {}\", user_id),\n        deposit_tracking_id,\n        deposit_address: deposit_address.to_string(),\n    }))\n}\n","traces":[{"line":19,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":89},{"path":["/","home","vidyootsenthil","TheValut-nameTBD","node","src","grpc","mod.rs"],"content":"pub mod grpc_handler;\npub mod grpc_operator;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","vidyootsenthil","TheValut-nameTBD","node","src","key_manager.rs"],"content":"use std::{fs, path::PathBuf};\n\nuse crate::{Config, EncryptionParams, errors::NodeError};\nuse aes_gcm::{Aes256Gcm, Key, KeyInit, Nonce, aead::Aead};\nuse argon2::{Argon2, password_hash::SaltString};\nuse base64::{Engine as _, engine::general_purpose::STANDARD as BASE64};\nuse directories::ProjectDirs;\nuse libp2p::identity::Keypair;\nuse tracing::debug;\n\npub fn get_key_file_path() -\u003e Result\u003cPathBuf, NodeError\u003e {\n    let proj_dirs = ProjectDirs::from(\"\", \"\", \"TheVault\")\n        .ok_or_else(|| NodeError::Error(\"Failed to determine project directory\".into()))?;\n\n    let config_dir = proj_dirs.config_dir();\n    fs::create_dir_all(config_dir)\n        .map_err(|e| NodeError::Error(format!(\"Failed to create config directory: {}\", e)))?;\n\n    let path = config_dir.join(\"config.json\");\n    debug!(\"Using key file path: {}\", path.display());\n    Ok(path)\n}\n\npub fn get_config_file_path(file_path_option: Option\u003cString\u003e) -\u003e Result\u003cPathBuf, NodeError\u003e {\n    if let Some(file_path_str) = file_path_option {\n        let mut path = PathBuf::from(file_path_str);\n        if path.is_dir() {\n            path.push(\"config.json\");\n        }\n        println!(\"Using key file path: {}\", path.display());\n        Ok(path)\n    } else {\n        let proj_dirs = ProjectDirs::from(\"\", \"\", \"TheVault\")\n            .ok_or_else(|| NodeError::Error(\"Failed to determine project directory\".into()))?;\n        let config_dir = proj_dirs.config_dir();\n        Ok(config_dir.join(\"config.json\"))\n    }\n}\n\nfn derive_key_from_password(password: \u0026str, salt_str: \u0026str) -\u003e Result\u003cVec\u003cu8\u003e, NodeError\u003e {\n    let argon2 = Argon2::default();\n    let password_bytes = password.as_bytes();\n    let salt = SaltString::from_b64(salt_str)\n        .map_err(|e| NodeError::Error(format!(\"Salt decoding failed: {}\", e)))?;\n\n    let mut key = vec![0u8; 32];\n    argon2\n        .hash_password_into(password_bytes, salt.as_str().as_bytes(), \u0026mut key)\n        .map_err(|e| NodeError::Error(format!(\"Argon2 key derivation failed: {}\", e)))?;\n    Ok(key)\n}\n\nfn decrypt_private_key(\n    encrypted_private_key_b64: \u0026str,\n    password: \u0026str,\n    params: \u0026EncryptionParams,\n) -\u003e Result\u003cVec\u003cu8\u003e, NodeError\u003e {\n    let key_bytes = derive_key_from_password(password, \u0026params.salt_b64)?;\n\n    let iv_bytes = BASE64\n        .decode(\u0026params.iv_b64)\n        .map_err(|e| NodeError::Error(format!(\"IV decoding failed: {}\", e)))?;\n    let nonce = Nonce::from_slice(\u0026iv_bytes);\n\n    let ciphertext = BASE64\n        .decode(encrypted_private_key_b64)\n        .map_err(|e| NodeError::Error(format!(\"Ciphertext decoding failed: {}\", e)))?;\n\n    let cipher = Aes256Gcm::new(Key::\u003cAes256Gcm\u003e::from_slice(\u0026key_bytes));\n\n    let decrypted_private_key = cipher\n        .decrypt(nonce, ciphertext.as_ref())\n        .map_err(|e| NodeError::Error(format!(\"AES decryption failed: {}\", e)))?;\n\n    Ok(decrypted_private_key)\n}\n\nfn get_password_from_prompt() -\u003e Result\u003cString, NodeError\u003e {\n    rpassword::prompt_password(\"Enter password to decrypt identity key: \")\n        .map_err(|e| NodeError::Error(e.to_string()))\n}\n\npub fn get_config(config_filepath: Option\u003cString\u003e) -\u003e Result\u003cConfig, NodeError\u003e {\n    let key_file_path = if let Some(config_path) = config_filepath {\n        PathBuf::from(config_path)\n    } else {\n        get_key_file_path()?\n    };\n\n    debug!(\"Using key file path: {}\", key_file_path.display());\n\n    let config_contents = fs::read_to_string(\u0026key_file_path)\n        .map_err(|e| NodeError::Error(format!(\"Failed to read config file: {}\", e)))?;\n\n    debug!(\"Read config file\");\n\n    let config = serde_json::from_str::\u003cConfig\u003e(\u0026config_contents)\n        .map_err(|e| NodeError::Error(format!(\"Failed to deserialize config file: {}\", e)))?;\n\n    debug!(\"Deserialized config file\");\n\n    Ok(config)\n}\n\npub fn load_and_decrypt_keypair(config_data: \u0026Config) -\u003e Result\u003cKeypair, NodeError\u003e {\n    let password = match std::env::var(\"KEY_PASSWORD\") {\n        Ok(pw) =\u003e pw,\n        Err(_) =\u003e get_password_from_prompt()?,\n    };\n\n    let private_key_protobuf = decrypt_private_key(\n        \u0026config_data.key_data.encrypted_private_key_b64,\n        \u0026password,\n        \u0026config_data.key_data.encryption_params,\n    )?;\n\n    Keypair::from_protobuf_encoding(\u0026private_key_protobuf).map_err(|e| {\n        NodeError::Error(format!(\n            \"Failed to reconstruct keypair from protobuf: {}\",\n            e\n        ))\n    })\n}\n","traces":[{"line":11,"address":[],"length":0,"stats":{"Line":0}},{"line":12,"address":[],"length":0,"stats":{"Line":0}},{"line":13,"address":[],"length":0,"stats":{"Line":0}},{"line":15,"address":[],"length":0,"stats":{"Line":0}},{"line":16,"address":[],"length":0,"stats":{"Line":0}},{"line":17,"address":[],"length":0,"stats":{"Line":0}},{"line":19,"address":[],"length":0,"stats":{"Line":0}},{"line":20,"address":[],"length":0,"stats":{"Line":0}},{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":70},{"path":["/","home","vidyootsenthil","TheValut-nameTBD","node","src","lib.rs"],"content":"use crate::{db::Db, dkg::DkgState, errors::NodeError};\nuse frost_secp256k1::{self as frost, Identifier};\nuse libp2p::PeerId;\nuse serde::{Deserialize, Serialize};\nuse std::{\n    collections::{BTreeMap, HashSet},\n    path::PathBuf,\n};\nuse swarm_manager::{NetworkEvent, NetworkHandle};\nuse tokio::sync::mpsc::UnboundedReceiver;\nuse tracing::error;\n\npub mod db;\npub mod dkg;\npub mod grpc;\npub mod main_loop;\npub mod protocol;\npub mod signing;\npub mod start_node;\npub mod swarm_manager;\npub mod wallet;\n\npub mod errors;\npub mod key_manager;\n\n#[derive(Clone, Serialize, Deserialize, PartialEq)]\npub struct PeerData {\n    pub name: String,\n    pub public_key: String,\n}\n\n#[derive(Serialize, Deserialize)]\npub struct DkgKeys {\n    pub encrypted_private_key_package_b64: String,\n    pub dkg_encryption_params: EncryptionParams,\n    pub pubkey_package_b64: String,\n}\n\n#[derive(Serialize, Deserialize)]\npub struct EncryptionParams {\n    pub kdf: String,\n    pub salt_b64: String,\n    pub iv_b64: String,\n}\n\n#[derive(Serialize, Deserialize)]\npub struct KeyData {\n    pub public_key_b58: String,\n    pub encrypted_private_key_b64: String,\n    pub encryption_params: EncryptionParams,\n}\n\n#[derive(Serialize, Deserialize)]\npub struct Config {\n    pub allowed_peers: Vec\u003cPeerData\u003e,\n    pub key_data: KeyData,\n    pub dkg_keys: Option\u003cDkgKeys\u003e,\n    pub log_file_path: Option\u003cPathBuf\u003e,\n}\n\npub struct NodeState {\n    pub allowed_peers: Vec\u003cPeerId\u003e,\n    pub peers_to_names: BTreeMap\u003cPeerId, String\u003e,\n\n    // DKG\n    pub dkg_state: DkgState,\n    pub db: Db,\n\n    pub peer_id: PeerId,\n    pub peers: HashSet\u003cPeerId\u003e,\n\n    pub min_signers: u16,\n    pub max_signers: u16,\n    pub rng: frost::rand_core::OsRng,\n\n    // FROST signing\n    pub active_signing: Option\u003cActiveSigning\u003e,\n    pub wallet: crate::wallet::SimpleWallet,\n    pub pending_spends: std::collections::BTreeMap\u003cu64, crate::wallet::PendingSpend\u003e,\n\n    // Config management\n    pub config_file: String,\n\n    pub network_handle: NetworkHandle,\n\n    pub network_events_stream: UnboundedReceiver\u003cNetworkEvent\u003e,\n}\n\nimpl NodeState {\n    pub fn peer_name(\u0026self, peer_id: \u0026PeerId) -\u003e String {\n        self.peers_to_names\n            .get(peer_id)\n            .unwrap_or(\u0026peer_id.to_string())\n            .clone()\n    }\n\n    pub fn new_from_config(\n        network_handle: NetworkHandle,\n        peer_data: Vec\u003cPeerData\u003e,\n        min_signers: u16,\n        max_signers: u16,\n        config_file: String,\n        network_events_emitter: UnboundedReceiver\u003cNetworkEvent\u003e,\n    ) -\u003e Result\u003cSelf, NodeError\u003e {\n        let allowed_peers: Vec\u003cPeerId\u003e = peer_data\n            .iter()\n            .filter_map(|peer| {\n                peer.public_key\n                    .parse()\n                    .map_err(|e| NodeError::Error(format!(\"Failed to parse peer data: {}\", e)))\n                    .ok()\n            })\n            .collect::\u003cVec\u003cPeerId\u003e\u003e();\n\n        let peers_to_names: BTreeMap\u003cPeerId, String\u003e = peer_data\n            .iter()\n            .filter_map(|peer| {\n                let peer_id = peer\n                    .public_key\n                    .parse()\n                    .map_err(|e| NodeError::Error(format!(\"Failed to parse peer data: {}\", e)))\n                    .ok()?;\n                Some((peer_id, peer.name.clone()))\n            })\n            .collect::\u003cBTreeMap\u003cPeerId, String\u003e\u003e();\n\n        let dkg_state = DkgState::new(\n            network_handle.clone(),\n            min_signers,\n            max_signers,\n            network_handle.peer_id(),\n            peers_to_names.clone(),\n            config_file.clone(),\n        )?;\n\n        Ok(NodeState {\n            network_handle: network_handle.clone(),\n            allowed_peers: allowed_peers.clone(),\n            network_events_stream: network_events_emitter,\n            peers_to_names: peers_to_names.clone(),\n            peer_id: network_handle.peer_id(),\n            min_signers,\n            max_signers,\n            db: Db::new(\"node_db.db\"),\n            dkg_state,\n            peers: HashSet::new(),\n            rng: frost::rand_core::OsRng,\n            active_signing: None,\n            wallet: crate::wallet::SimpleWallet::new(),\n            pending_spends: BTreeMap::new(),\n            config_file: config_file.clone(),\n        })\n    }\n}\n\npub fn peer_id_to_identifier(peer_id: \u0026PeerId) -\u003e Identifier {\n    let bytes = peer_id.to_bytes();\n    match Identifier::derive(\u0026bytes) {\n        Ok(identifier) =\u003e identifier,\n        Err(e) =\u003e {\n            error!(\"Failed to derive identifier: {}\", e);\n            panic!(\"Failed to derive identifier\");\n        }\n    }\n}\n\n// Active signing session tracking\npub struct ActiveSigning {\n    pub sign_id: u64,\n    pub message: Vec\u003cu8\u003e,\n    pub selected_peers: Vec\u003cPeerId\u003e,\n    pub nonces: frost::round1::SigningNonces,\n    pub commitments: BTreeMap\u003cIdentifier, frost::round1::SigningCommitments\u003e,\n    pub signature_shares: BTreeMap\u003cIdentifier, frost::round2::SignatureShare\u003e,\n    pub signing_package: Option\u003cfrost::SigningPackage\u003e,\n    pub is_coordinator: bool,\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_config_deserialization() {\n        let json_str = r#\"{\n            \"allowed_peers\": [\n                {\n                    \"public_key\": \"12D3KooWRdtE2nFybk8eMyp3D9B4NvunUYqpN6JDvBcVPTcrDsbF\",\n                    \"name\": \"node-four\"\n                }\n            ],\n            \"key_data\": {\n                \"public_key_b58\": \"12D3KooWQDHzW448RmDoUz1KbMfuD4XqeojRJDsxqUZSEYo7FSUz\",\n                \"encrypted_private_key_b64\": \"EnCF8bEe3tVyMV0EUIK29bOMNjH7gT7mx4ATyBr4WSdphw5ETfm1YdQHDAg+CzBBjt7K2FSbwv8Qkj1y3N4jTU/FkGHggfkwDDl5XkDc5rXi2BW/\",\n                \"encryption_params\": {\n                    \"kdf\": \"argon2id\",\n                    \"salt_b64\": \"TnErEFlx9F1BeU8mJcFzKQ\",\n                    \"iv_b64\": \"hybTge0qoPaxNUhP\"\n                }\n            }\n        }\"#;\n\n        let config: Config = serde_json::from_str(json_str).expect(\"Failed to deserialize\");\n        assert_eq!(config.allowed_peers.len(), 1);\n        assert_eq!(\n            config.key_data.public_key_b58,\n            \"12D3KooWQDHzW448RmDoUz1KbMfuD4XqeojRJDsxqUZSEYo7FSUz\"\n        );\n        assert!(config.dkg_keys.is_none());\n    }\n}\n","traces":[{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":48},{"path":["/","home","vidyootsenthil","TheValut-nameTBD","node","src","main_loop.rs"],"content":"use libp2p::mdns;\n\nuse libp2p::gossipsub;\nuse libp2p::request_response;\nuse libp2p::swarm::SwarmEvent;\nuse tokio::select;\nuse tracing::{debug, error, info};\n\nuse crate::NodeState;\nuse crate::errors::NodeError;\nuse crate::swarm_manager::{\n    MyBehaviourEvent, NetworkEvent, NetworkMessage, PrivateRequest, PrivateResponse,\n};\n\nimpl NodeState {\n    pub async fn start(\u0026mut self) -\u003e Result\u003c(), NodeError\u003e {\n        info!(\"Local peer id: {}\", self.peer_id);\n\n        let round1_topic = gossipsub::IdentTopic::new(\"round1_topic\");\n        let start_dkg_topic = gossipsub::IdentTopic::new(\"start-dkg\");\n        loop {\n            select! {\n                send_message = self.network_events_stream.recv() =\u003e match send_message {\n                    Some(NetworkEvent::NetworkMessage(NetworkMessage::SendSelfRequest { request, response_channel: None })) =\u003e {\n                        debug!(\"Received self request {:?}\", request);\n                        if let PrivateRequest::InsertBlock { block } = request {\n                            if let Err(e) = self.db.insert_block(block) {\n                                return Err(NodeError::Error(format!(\"Failed to handle genesis block: {}\", e)));\n                            }\n                        }\n                    }\n                    Some(NetworkEvent::NetworkMessage(NetworkMessage::SendSelfRequest { request, response_channel: Some(response_channel) })) =\u003e {\n                        debug!(\"Received self request {:?}\", request);\n                            match request {\n                                PrivateRequest::StartSigningSession { hex_message } =\u003e {\n                                    match self.start_signing_session(\u0026hex_message) {\n                                        Ok(_) =\u003e (),\n                                        Err(e) =\u003e {\n                                            return Err(NodeError::Error(format!(\"Failed to start signing session: {}\", e)));\n                                        }\n                                    }\n                                },\n                                PrivateRequest::Spend { amount_sat } =\u003e {\n                                    let response = self.start_spend_request(amount_sat);\n                                    match response_channel.send(PrivateResponse::SpendRequestSent { sighash: response.unwrap_or(\"No sighash\".to_string()) }) {\n                                        Ok(_) =\u003e (),\n                                        Err(e) =\u003e {\n                                            return Err(NodeError::Error(format!(\"Failed to send response: {}\", e)));\n                                        }\n                                    }\n                                }\n                                PrivateRequest::GetFrostPublicKey =\u003e {\n                                    let response = self.get_frost_public_key();\n                                    match response_channel.send(PrivateResponse::GetFrostPublicKey { public_key: response.unwrap_or(\"No public key\".to_string()) }) {\n                                        Ok(_) =\u003e (),\n                                        Err(e) =\u003e {\n                                            return Err(NodeError::Error(format!(\"Failed to send response: {}\", e)));\n                                        }\n                                    }\n                                }\n                                _ =\u003e {}\n                            }\n                    }\n                    Some(NetworkEvent::SwarmEvent(SwarmEvent::Behaviour(MyBehaviourEvent::Mdns(mdns::Event::Discovered(list))))) =\u003e {\n                        for (peer_id, _multiaddr) in list {\n                            self.peers.insert(peer_id);\n                            self.dkg_state.peers.insert(peer_id);\n                        }\n                    },\n                    Some(NetworkEvent::SwarmEvent(SwarmEvent::Behaviour(MyBehaviourEvent::Gossipsub(gossipsub::Event::Message {\n                        message,\n                        ..\n                    })))) =\u003e {\n                        match message.topic {\n                            t if t == round1_topic.hash() =\u003e {\n                                if let Some(source_peer) = message.source {\n                                    info!(\"Received round1 payload from {}\", self.peer_name(\u0026source_peer));\n                                } else {\n                                    return Err(NodeError::Error(\"No source peer\".to_string()));\n                                }\n\n                                if let Some(source_peer) = message.source {\n                                    match self.dkg_state.handle_round1_payload(source_peer, message.data) {\n                                        Ok(_) =\u003e (),\n                                        Err(e) =\u003e {\n                                            error!(\" Failed to handle round1 payload: {}\", e);\n                                        }\n                                    }\n                                }\n                            }\n                            t if t == start_dkg_topic.hash() =\u003e {\n                                match self.dkg_state.handle_dkg_start() {\n                                    Ok(_) =\u003e (),\n                                    Err(e) =\u003e {\n                                        error!(\" Failed to handle DKG start: {}\", e);\n                                    }\n                                }\n                            }\n                            _ =\u003e {\n                                debug!(\"Received unhandled broadcast\");\n                            }\n                        }\n                    },\n                    // Handle direct message requests (incoming)\n                    Some(NetworkEvent::SwarmEvent(SwarmEvent::Behaviour(MyBehaviourEvent::RequestResponse(\n                        request_response::Event::Message {\n                            peer,\n                            message: request_response::Message::Request { request: PrivateRequest::Round2Package(package), channel, .. }\n                        }\n                    )))) =\u003e {\n                        match self.dkg_state.handle_round2_payload(peer, package, channel) {\n                            Ok(_) =\u003e (),\n                            Err(e) =\u003e {\n                                error!(\" Failed to handle round2 payload: {}\", e);\n                            }\n                        }\n                    },\n                    // Incoming SignRequest\n                    Some(NetworkEvent::SwarmEvent(SwarmEvent::Behaviour(MyBehaviourEvent::RequestResponse(\n                        request_response::Event::Message {\n                            peer,\n                            message: request_response::Message::Request { request: PrivateRequest::SignRequest { sign_id, message }, channel, .. }\n                        }\n                    )))) =\u003e {\n                        match self.handle_sign_request(peer, sign_id, message, channel) {\n                            Ok(_) =\u003e (),\n                            Err(e) =\u003e {\n                                error!(\" Failed to handle sign request: {}\", e);\n                            }\n                        }\n                    },\n                    // Incoming SignPackage request to generate signature share\n                    Some(NetworkEvent::SwarmEvent(SwarmEvent::Behaviour(MyBehaviourEvent::RequestResponse(\n                        request_response::Event::Message {\n                            peer,\n                            message: request_response::Message::Request { request: PrivateRequest::SignPackage { sign_id, package }, channel, .. }\n                        }\n                    )))) =\u003e {\n                        match self.handle_sign_package(peer, sign_id, package, channel) {\n                            Ok(_) =\u003e (),\n                            Err(e) =\u003e {\n                                error!(\" Failed to handle sign package: {}\", e);\n                            }\n                        }\n                    },\n                    Some(NetworkEvent::SwarmEvent(SwarmEvent::Behaviour(MyBehaviourEvent::Gossipsub(gossipsub::Event::Subscribed {\n                        peer_id,\n                        topic,\n                    })))) =\u003e {\n                        if topic == start_dkg_topic.hash() {\n                            self.dkg_state.dkg_listeners.insert(peer_id);\n                            info!(\"Peer {} subscribed to topic {topic}. Listeners: {}\", self.peer_name(\u0026peer_id), self.dkg_state.dkg_listeners.len());\n                            if let Err(e) = self.dkg_state.handle_dkg_start() {\n                                error!(\" Failed to handle DKG start: {}\", e);\n                            }\n                        }\n                    },\n                    // Responses with commitments\n                    Some(NetworkEvent::SwarmEvent(SwarmEvent::Behaviour(MyBehaviourEvent::RequestResponse(\n                        request_response::Event::Message {\n                            peer,\n                            message: request_response::Message::Response { response: PrivateResponse::Commitments { sign_id, commitments }, .. }\n                        }\n                    )))) =\u003e {\n                        match self.handle_commitments_response(peer, sign_id, commitments) {\n                            Ok(_) =\u003e (),\n                            Err(e) =\u003e {\n                                error!(\" Failed to handle commitments response: {}\", e);\n                            }\n                        }\n                    },\n                    // Responses with signature share\n                    Some(NetworkEvent::SwarmEvent(SwarmEvent::Behaviour(MyBehaviourEvent::RequestResponse(\n                        request_response::Event::Message {\n                            peer,\n                            message: request_response::Message::Response { response: PrivateResponse::SignatureShare { sign_id, signature_share }, .. }\n                        }\n                    )))) =\u003e {\n                        match self.handle_signature_share(peer, sign_id, signature_share) {\n                            Ok(_) =\u003e (),\n                            Err(e) =\u003e {\n                                error!(\" Failed to handle signature share: {}\", e);\n                            }\n                        }\n                    },\n                    _ =\u003e {}\n                }\n            }\n        }\n    }\n}\n","traces":[{"line":16,"address":[],"length":0,"stats":{"Line":0}},{"line":17,"address":[],"length":0,"stats":{"Line":0}},{"line":19,"address":[],"length":0,"stats":{"Line":0}},{"line":20,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":98},{"path":["/","home","vidyootsenthil","TheValut-nameTBD","node","src","protocol","block.rs"],"content":"use std::time::{SystemTime, UNIX_EPOCH};\n\nuse bincode::{Decode, Encode};\nuse serde::{Deserialize, Serialize};\nuse sha2::{Digest, Sha256};\n\nuse crate::{errors::NodeError, protocol::transaction::Transaction};\n\npub type BlockHash = [u8; 32];\npub type StateRoot = [u8; 32];\n\n/// Block header containing all metadata\n#[derive(Debug, Clone, Encode, Decode, Serialize, Deserialize, PartialEq)]\npub struct BlockHeader {\n    /// Version of the block structure\n    pub version: u32,\n\n    /// Hash of the previous block\n    pub previous_block_hash: BlockHash,\n\n    /// Unix timestamp when block was created\n    pub timestamp: u64,\n\n    /// Block height/number in the chain\n    pub height: u64,\n\n    /// Proposer of this block (for PoS/PoA)\n    pub proposer: Vec\u003cu8\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize, Encode, Decode)]\npub struct GenesisBlock {\n    pub version: u32,\n    pub timestamp: u64,\n    pub initial_state: GenesisState,\n    pub extra_data: Vec\u003cu8\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize, Encode, Decode)]\npub struct GenesisState {\n    pub validators: Vec\u003cValidatorInfo\u003e,\n    pub vault_pub_key: Vec\u003cu8\u003e,\n    pub initial_balances: Vec\u003c(String, u64)\u003e,\n    pub chain_config: ChainConfig,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize, Encode, Decode)]\npub struct ValidatorInfo {\n    pub pub_key: Vec\u003cu8\u003e,\n    pub stake: u64,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize, Encode, Decode)]\npub struct ChainConfig {\n    pub min_signers: u16,\n    pub max_signers: u16,\n    pub min_stake: u64,\n    pub block_time_seconds: u64,\n    pub max_block_size: u64,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize, Encode, Decode)]\npub struct Block {\n    pub header: BlockHeader,\n    pub body: BlockBody,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize, Encode, Decode)]\npub struct BlockBody {\n    pub transactions: Vec\u003cTransaction\u003e,\n}\n\nimpl BlockHeader {\n    pub fn calculate_hash(\u0026self) -\u003e BlockHash {\n        let mut hasher = Sha256::new();\n\n        hasher.update(self.version.to_le_bytes());\n        hasher.update(self.previous_block_hash);\n        hasher.update(self.timestamp.to_le_bytes());\n        hasher.update(self.height.to_le_bytes());\n        hasher.update(\u0026self.proposer);\n\n        let result = hasher.finalize();\n        let mut hash = [0u8; 32];\n        hash.copy_from_slice(\u0026result);\n        hash\n    }\n}\n\nimpl Block {\n    /// Create a new block\n    pub fn new(\n        previous_block_hash: BlockHash,\n        height: u64,\n        transactions: Vec\u003cTransaction\u003e,\n        proposer: Vec\u003cu8\u003e,\n    ) -\u003e Self {\n        let header = BlockHeader {\n            version: 1,\n            previous_block_hash,\n            timestamp: SystemTime::now()\n                .duration_since(UNIX_EPOCH)\n                .unwrap()\n                .as_secs(),\n            height,\n            proposer,\n        };\n\n        Block {\n            header,\n            body: BlockBody { transactions },\n        }\n    }\n\n    pub fn hash(\u0026self) -\u003e BlockHash {\n        self.header.calculate_hash()\n    }\n\n    pub fn serialize(\u0026self) -\u003e Result\u003cVec\u003cu8\u003e, NodeError\u003e {\n        bincode::encode_to_vec(self, bincode::config::standard())\n            .map_err(|e| NodeError::Error(format!(\"Failed to serialize block: {}\", e)))\n    }\n\n    pub fn deserialize(data: \u0026[u8]) -\u003e Result\u003cSelf, NodeError\u003e {\n        let (block, _): (Self, _) =\n            bincode::decode_from_slice(data, bincode::config::standard())\n                .map_err(|e| NodeError::Error(format!(\"Failed to deserialize block: {}\", e)))?;\n        Ok(block)\n    }\n}\n\nimpl GenesisBlock {\n    /// Create a new genesis block\n    pub fn new(\n        validators: Vec\u003cValidatorInfo\u003e,\n        chain_config: ChainConfig,\n        vault_pub_key: Vec\u003cu8\u003e,\n    ) -\u003e Self {\n        GenesisBlock {\n            version: 1,\n            timestamp: SystemTime::now()\n                .duration_since(UNIX_EPOCH)\n                .unwrap()\n                .as_secs(),\n            initial_state: GenesisState {\n                validators,\n                vault_pub_key,\n                initial_balances: vec![],\n                chain_config,\n            },\n            extra_data: b\"Genesis Block\".to_vec(),\n        }\n    }\n\n    pub fn to_block(\u0026self) -\u003e Block {\n        let mut hasher = Sha256::new();\n        hasher.update(b\"GENESIS\");\n        hasher.update(self.timestamp.to_le_bytes());\n        let state_bytes =\n            bincode::encode_to_vec(\u0026self.initial_state, bincode::config::standard()).unwrap();\n        hasher.update(\u0026state_bytes);\n        let result = hasher.finalize();\n        let mut state_root = [0u8; 32];\n        state_root.copy_from_slice(\u0026result);\n\n        Block::new(\n            [0u8; 32], // No previous block\n            0,         // Height 0\n            vec![],    // No transactions in genesis\n            self.initial_state\n                .validators\n                .first()\n                .map(|v| v.pub_key.clone())\n                .unwrap_or_default(),\n        )\n    }\n\n    /// Get hash of genesis block\n    pub fn hash(\u0026self) -\u003e BlockHash {\n        self.to_block().hash()\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_block_creation_and_hashing() {\n        let block = Block::new([0u8; 32], 1, vec![], vec![1, 2, 3]);\n\n        let hash1 = block.hash();\n        let hash2 = block.hash();\n        assert_eq!(hash1, hash2); // Hash should be deterministic\n    }\n}\n","traces":[{"line":74,"address":[],"length":0,"stats":{"Line":2}},{"line":75,"address":[],"length":0,"stats":{"Line":2}},{"line":77,"address":[],"length":0,"stats":{"Line":2}},{"line":78,"address":[],"length":0,"stats":{"Line":2}},{"line":79,"address":[],"length":0,"stats":{"Line":2}},{"line":80,"address":[],"length":0,"stats":{"Line":2}},{"line":81,"address":[],"length":0,"stats":{"Line":2}},{"line":83,"address":[],"length":0,"stats":{"Line":2}},{"line":84,"address":[],"length":0,"stats":{"Line":2}},{"line":85,"address":[],"length":0,"stats":{"Line":2}},{"line":86,"address":[],"length":0,"stats":{"Line":2}},{"line":92,"address":[],"length":0,"stats":{"Line":1}},{"line":101,"address":[],"length":0,"stats":{"Line":1}},{"line":111,"address":[],"length":0,"stats":{"Line":1}},{"line":115,"address":[],"length":0,"stats":{"Line":2}},{"line":116,"address":[],"length":0,"stats":{"Line":2}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}}],"covered":16,"coverable":47},{"path":["/","home","vidyootsenthil","TheValut-nameTBD","node","src","protocol","chain_state.rs"],"content":"use std::collections::HashMap;\n\nuse bincode::{Decode, Encode};\nuse serde::{Deserialize, Serialize};\n\nuse crate::errors::NodeError;\n\n#[derive(Debug, Clone, Serialize, Deserialize, Encode, Decode)]\npub struct Account {\n    pub address: String,\n    pub balance: u64,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize, Encode, Decode)]\npub struct ChainState {\n    // address -\u003e account\n    accounts: HashMap\u003cString, Account\u003e,\n    block_height: u64,\n}\n\nimpl Default for ChainState {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\n// TODO: implement periodic flushing of chain state to rocksdb\nimpl ChainState {\n    pub fn new() -\u003e Self {\n        Self {\n            accounts: HashMap::new(),\n            block_height: 0,\n        }\n    }\n\n    pub fn new_with_accounts(accounts: HashMap\u003cString, Account\u003e, block_height: u64) -\u003e Self {\n        Self {\n            accounts,\n            block_height,\n        }\n    }\n\n    pub fn get_account(\u0026self, address: \u0026str) -\u003e Option\u003c\u0026Account\u003e {\n        self.accounts.get(address)\n    }\n\n    pub fn get_account_mut(\u0026mut self, address: \u0026str) -\u003e Option\u003c\u0026mut Account\u003e {\n        self.accounts.get_mut(address)\n    }\n\n    pub fn get_block_height(\u0026self) -\u003e u64 {\n        self.block_height\n    }\n\n    pub fn serialize(\u0026self) -\u003e Result\u003cVec\u003cu8\u003e, NodeError\u003e {\n        bincode::encode_to_vec(self, bincode::config::standard())\n            .map_err(|e| NodeError::Error(e.to_string()))\n    }\n\n    pub fn deserialize(data: \u0026[u8]) -\u003e Result\u003cSelf, NodeError\u003e {\n        let (chain_state, _): (Self, _) =\n            bincode::decode_from_slice(data, bincode::config::standard())\n                .map_err(|e| NodeError::Error(e.to_string()))?;\n        Ok(chain_state)\n    }\n}\n","traces":[{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":1}},{"line":31,"address":[],"length":0,"stats":{"Line":1}},{"line":36,"address":[],"length":0,"stats":{"Line":3}},{"line":43,"address":[],"length":0,"stats":{"Line":5}},{"line":44,"address":[],"length":0,"stats":{"Line":5}},{"line":47,"address":[],"length":0,"stats":{"Line":7}},{"line":48,"address":[],"length":0,"stats":{"Line":7}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}}],"covered":7,"coverable":19},{"path":["/","home","vidyootsenthil","TheValut-nameTBD","node","src","protocol","executor.rs"],"content":"use crate::{\n    errors::NodeError,\n    protocol::{\n        chain_state::ChainState,\n        transaction::{Operation, Transaction},\n    },\n};\n\npub struct TransactionExecutor;\n\nimpl TransactionExecutor {\n    pub fn execute_transaction(\n        transaction: Transaction,\n        chain_state: \u0026mut ChainState,\n    ) -\u003e Result\u003c(), NodeError\u003e {\n        for operation in transaction.operations {\n            match operation {\n                Operation::OpIncrementBalance { account_id, amount } =\u003e {\n                    let account = chain_state.get_account_mut(\u0026account_id);\n                    if let Some(account) = account {\n                        account.balance += amount;\n                    } else {\n                        return Err(NodeError::Error(\"Account not found\".to_string()));\n                    }\n                }\n            }\n        }\n        Ok(())\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use std::collections::HashMap;\n\n    use crate::protocol::chain_state::Account;\n\n    use super::*;\n\n    #[test]\n    fn test_execute_transaction() {\n        let accounts = HashMap::from([(\n            \"1\".to_string(),\n            Account {\n                balance: 0,\n                address: \"1\".to_string(),\n            },\n        )]);\n        let mut chain_state = ChainState::new_with_accounts(accounts, 0);\n        let transaction = Transaction::new(vec![Operation::OpIncrementBalance {\n            account_id: \"1\".to_string(),\n            amount: 100,\n        }]);\n        TransactionExecutor::execute_transaction(transaction, \u0026mut chain_state).unwrap();\n        assert_eq!(chain_state.get_account(\"1\").unwrap().balance, 100);\n    }\n\n    #[test]\n    fn test_execute_transaction_with_multiple_operations() {\n        let accounts = HashMap::from([\n            (\n                \"1\".to_string(),\n                Account {\n                    balance: 100,\n                    address: \"1\".to_string(),\n                },\n            ),\n            (\n                \"2\".to_string(),\n                Account {\n                    balance: 200,\n                    address: \"2\".to_string(),\n                },\n            ),\n            (\n                \"3\".to_string(),\n                Account {\n                    balance: 300,\n                    address: \"3\".to_string(),\n                },\n            ),\n        ]);\n        let mut chain_state = ChainState::new_with_accounts(accounts, 0);\n        let transaction = Transaction::new(vec![\n            Operation::OpIncrementBalance {\n                account_id: \"1\".to_string(),\n                amount: 100,\n            },\n            Operation::OpIncrementBalance {\n                account_id: \"2\".to_string(),\n                amount: 200,\n            },\n            Operation::OpIncrementBalance {\n                account_id: \"1\".to_string(),\n                amount: 100,\n            },\n            Operation::OpIncrementBalance {\n                account_id: \"3\".to_string(),\n                amount: 300,\n            },\n        ]);\n        TransactionExecutor::execute_transaction(transaction, \u0026mut chain_state).unwrap();\n        assert_eq!(chain_state.get_account(\"1\").unwrap().balance, 300);\n        assert_eq!(chain_state.get_account(\"2\").unwrap().balance, 400);\n        assert_eq!(chain_state.get_account(\"3\").unwrap().balance, 600);\n    }\n\n    #[test]\n    fn test_execute_transaction_with_zero_amount() {\n        let accounts = HashMap::from([(\n            \"1\".to_string(),\n            Account {\n                balance: 0,\n                address: \"1\".to_string(),\n            },\n        )]);\n        let mut chain_state = ChainState::new_with_accounts(accounts, 0);\n        let transaction = Transaction::new(vec![Operation::OpIncrementBalance {\n            account_id: \"1\".to_string(),\n            amount: 0,\n        }]);\n        let result = TransactionExecutor::execute_transaction(transaction, \u0026mut chain_state);\n        assert!(result.is_ok());\n        assert_eq!(chain_state.get_account(\"1\").unwrap().balance, 0);\n    }\n\n    #[test]\n    fn test_execute_transaction_with_invalid_account() {\n        let mut chain_state = ChainState::new();\n        let transaction = Transaction::new(vec![Operation::OpIncrementBalance {\n            account_id: \"1\".to_string(),\n            amount: 100,\n        }]);\n        let result = TransactionExecutor::execute_transaction(transaction, \u0026mut chain_state);\n        assert!(result.is_err());\n    }\n}\n","traces":[{"line":12,"address":[],"length":0,"stats":{"Line":4}},{"line":16,"address":[],"length":0,"stats":{"Line":17}},{"line":17,"address":[],"length":0,"stats":{"Line":7}},{"line":18,"address":[],"length":0,"stats":{"Line":7}},{"line":19,"address":[],"length":0,"stats":{"Line":7}},{"line":20,"address":[],"length":0,"stats":{"Line":13}},{"line":23,"address":[],"length":0,"stats":{"Line":1}},{"line":28,"address":[],"length":0,"stats":{"Line":3}}],"covered":8,"coverable":8},{"path":["/","home","vidyootsenthil","TheValut-nameTBD","node","src","protocol","mod.rs"],"content":"pub mod block;\npub mod chain_state;\npub mod executor;\npub mod transaction;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","vidyootsenthil","TheValut-nameTBD","node","src","protocol","transaction.rs"],"content":"use bincode::{Decode, Encode};\nuse serde::{Deserialize, Serialize};\nuse sha2::{Digest, Sha256};\n\npub type TransactionId = [u8; 32];\n\n#[derive(Debug, Clone, Serialize, Deserialize, Encode, Decode, PartialEq)]\npub struct Transaction {\n    pub version: u32,\n    pub timestamp: u64,\n    pub operations: Vec\u003cOperation\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize, Encode, Decode, PartialEq)]\npub enum Operation {\n    OpIncrementBalance { account_id: String, amount: u64 },\n}\n\nimpl Transaction {\n    pub fn new(operations: Vec\u003cOperation\u003e) -\u003e Self {\n        Transaction {\n            version: 1,\n            timestamp: std::time::SystemTime::now()\n                .duration_since(std::time::UNIX_EPOCH)\n                .unwrap()\n                .as_secs(),\n            operations,\n        }\n    }\n\n    pub fn id(\u0026self) -\u003e TransactionId {\n        let mut hasher = Sha256::new();\n        hasher.update(self.version.to_le_bytes());\n        hasher.update(self.timestamp.to_le_bytes());\n\n        for op in \u0026self.operations {\n            let op_bytes = bincode::encode_to_vec(op, bincode::config::standard()).unwrap();\n            hasher.update(\u0026op_bytes);\n        }\n\n        let result = hasher.finalize();\n        let mut id = [0u8; 32];\n        id.copy_from_slice(\u0026result);\n        id\n    }\n\n    pub fn total_value(\u0026self) -\u003e u64 {\n        self.operations\n            .iter()\n            .map(|op| match op {\n                Operation::OpIncrementBalance { amount, .. } =\u003e *amount,\n            })\n            .sum()\n    }\n}\n","traces":[{"line":20,"address":[],"length":0,"stats":{"Line":4}},{"line":23,"address":[],"length":0,"stats":{"Line":4}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}}],"covered":2,"coverable":17},{"path":["/","home","vidyootsenthil","TheValut-nameTBD","node","src","signing.rs"],"content":"use rand::seq::SliceRandom;\nuse std::collections::BTreeMap;\n\nuse frost_secp256k1::rand_core::RngCore;\nuse frost_secp256k1::{self as frost};\nuse hex;\nuse libp2p::{PeerId, request_response};\nuse tracing::{debug, error, info, warn};\n\nuse crate::errors::NodeError;\nuse crate::swarm_manager::{PrivateRequest, PrivateResponse};\nuse crate::{ActiveSigning, NodeState, peer_id_to_identifier};\n\nimpl NodeState {\n    /// Coordinator entrypoint. Start a threshold signing session across the network.\n    /// `message_hex` must be hex-encoded 32-byte sighash.\n    pub fn start_signing_session(\u0026mut self, message_hex: \u0026str) -\u003e Result\u003cOption\u003cu64\u003e, NodeError\u003e {\n        if self.dkg_state.get_private_key().is_none() || self.dkg_state.get_public_key().is_none() {\n            error!(\" DKG not completed  cannot start signing\");\n            return Err(NodeError::Error(\"DKG not completed\".to_string()));\n        }\n\n        let Ok(message) = hex::decode(message_hex.trim()) else {\n            error!(\" Invalid hex message\");\n            return Err(NodeError::Error(\"Invalid hex message\".to_string()));\n        };\n        if message.len() != 32 {\n            error!(\n                \" Message must be 32-byte (sighash)  got {} bytes\",\n                message.len()\n            );\n            return Err(NodeError::Error(\n                \"Message must be 32-byte (sighash)\".to_string(),\n            ));\n        }\n\n        info!(\"Starting signing session for message: {}\", message_hex);\n\n        if self.active_signing.is_some() {\n            error!(\" A signing session is already active\");\n            return Err(NodeError::Error(\n                \"A signing session is already active\".to_string(),\n            ));\n        }\n\n        let sign_id = self.rng.next_u64();\n        let self_identifier = peer_id_to_identifier(\u0026self.peer_id);\n\n        // Select participants: self + first (min_signers -1) peers\n        let required = (self.min_signers - 1) as usize;\n        if self.peers.len() \u003c required {\n            error!(\" Not enough peers  need at least {} others\", required);\n            return Err(NodeError::Error(\"Not enough peers\".to_string()));\n        }\n        // Randomly shuffle peers and pick required number\n        let mut rng_rand = rand::rng();\n        let mut peer_pool = self.peers.clone().into_iter().collect::\u003cVec\u003c_\u003e\u003e();\n        peer_pool.shuffle(\u0026mut rng_rand);\n\n        let selected_peers: Vec\u003cPeerId\u003e = peer_pool.into_iter().take(required).collect();\n\n        let mut participants: Vec\u003c_\u003e = Vec::new();\n        participants.push(self_identifier);\n        for peer in \u0026selected_peers {\n            participants.push(peer_id_to_identifier(peer));\n        }\n\n        // Generate nonces \u0026 commitments for self\n        let key_pkg = match self.dkg_state.get_private_key().as_ref() {\n            Some(key_pkg) =\u003e key_pkg.clone(),\n            None =\u003e {\n                return Err(NodeError::Error(\"No private key found\".to_string()));\n            }\n        };\n        let (nonces, commitments) = frost::round1::commit(key_pkg.signing_share(), \u0026mut self.rng);\n\n        let mut commitments_map = BTreeMap::new();\n        commitments_map.insert(self_identifier, commitments);\n\n        // Save active session\n        self.active_signing = Some(ActiveSigning {\n            sign_id,\n            message: message.clone(),\n            selected_peers: selected_peers.clone(),\n            nonces,\n            commitments: commitments_map,\n            signature_shares: BTreeMap::new(),\n            signing_package: None,\n            is_coordinator: true,\n        });\n\n        // Broadcast SignRequest to chosen peers (skip self)\n        for peer in \u0026selected_peers {\n            let req = PrivateRequest::SignRequest {\n                sign_id,\n                message: message.clone(),\n            };\n            self.network_handle\n                .send_private_request(*peer, req)\n                .map_err(|e| {\n                    NodeError::Error(format!(\"Failed to send private request: {:?}\", e))\n                })?;\n        }\n\n        Ok(Some(sign_id))\n    }\n\n    /// Handle incoming SignRequest (participant side)\n    pub fn handle_sign_request(\n        \u0026mut self,\n        peer: PeerId,\n        sign_id: u64,\n        message: Vec\u003cu8\u003e,\n        channel: request_response::ResponseChannel\u003cPrivateResponse\u003e,\n    ) -\u003e Result\u003c(), NodeError\u003e {\n        if self.dkg_state.get_private_key().is_none() {\n            let _ = self.network_handle.send_private_response(\n                channel,\n                PrivateResponse::Commitments {\n                    sign_id,\n                    commitments: Vec::new(),\n                },\n            );\n            return Ok(());\n        }\n\n        let key_pkg = match self.dkg_state.get_private_key().as_ref() {\n            Some(key_pkg) =\u003e key_pkg.clone(),\n            None =\u003e {\n                return Err(NodeError::Error(\"No private key found\".to_string()));\n            }\n        };\n        let (nonces, commitments) = frost::round1::commit(key_pkg.signing_share(), \u0026mut self.rng);\n\n        // Save session (one at a time for simplicity)\n        self.active_signing = Some(ActiveSigning {\n            sign_id,\n            message: message.clone(),\n            selected_peers: Vec::new(),\n            nonces,\n            commitments: BTreeMap::new(), // not used for participant\n            signature_shares: BTreeMap::new(),\n            signing_package: None,\n            is_coordinator: false,\n        });\n\n        let Ok(commit_bytes) = commitments.serialize() else {\n            return Err(NodeError::Error(\n                \"Failed to serialize commitments\".to_string(),\n            ));\n        };\n\n        let resp = PrivateResponse::Commitments {\n            sign_id,\n            commitments: commit_bytes,\n        };\n        let _ = self.network_handle.send_private_response(channel, resp);\n\n        debug!(\n            \" Provided commitments for sign_id {} to {}\",\n            sign_id, peer\n        );\n\n        Ok(())\n    }\n\n    /// Coordinator receives commitments responses\n    pub fn handle_commitments_response(\n        \u0026mut self,\n        peer: PeerId,\n        sign_id: u64,\n        commitments_bytes: Vec\u003cu8\u003e,\n    ) -\u003e Result\u003c(), NodeError\u003e {\n        let Some(active) = self.active_signing.as_mut() else {\n            return Err(NodeError::Error(\"No active session\".to_string()));\n        };\n        if !active.is_coordinator || active.sign_id != sign_id {\n            return Err(NodeError::Error(\"Session id mismatch\".to_string()));\n        }\n\n        let Ok(commitments) = frost::round1::SigningCommitments::deserialize(\u0026commitments_bytes)\n        else {\n            warn!(\"Failed to deserialize commitments from {}\", peer);\n            return Err(NodeError::Error(\n                \"Failed to deserialize commitments\".to_string(),\n            ));\n        };\n        let identifier = peer_id_to_identifier(\u0026peer);\n        active.commitments.insert(identifier, commitments);\n        debug!(\n            \" Received commitments from {} (total {}/{})\",\n            peer,\n            active.commitments.len(),\n            self.min_signers\n        );\n\n        if active.commitments.len() == self.min_signers as usize {\n            // Build signing package\n            let signing_package =\n                frost::SigningPackage::new(active.commitments.clone(), \u0026active.message);\n            active.signing_package = Some(signing_package.clone());\n            let Ok(pkg_bytes) = signing_package.serialize() else {\n                warn!(\"Failed to serialize signing package\");\n                return Err(NodeError::Error(\n                    \"Failed to serialize signing package\".to_string(),\n                ));\n            };\n\n            // Send package to participants (excluding self)\n            for peer in \u0026active.selected_peers {\n                let req = PrivateRequest::SignPackage {\n                    sign_id,\n                    package: pkg_bytes.clone(),\n                };\n                let _ = self.network_handle.send_private_request(*peer, req);\n            }\n\n            // Generate our signature share\n            let sig_share = frost::round2::sign(\n                \u0026signing_package,\n                \u0026active.nonces,\n                match self.dkg_state.get_private_key().as_ref() {\n                    Some(key_pkg) =\u003e key_pkg,\n                    None =\u003e {\n                        return Err(NodeError::Error(\"No private key found\".to_string()));\n                    }\n                },\n            );\n            match sig_share {\n                Ok(sig_share) =\u003e {\n                    active\n                        .signature_shares\n                        .insert(peer_id_to_identifier(\u0026self.peer_id), sig_share);\n                }\n                Err(e) =\u003e {\n                    return Err(NodeError::Error(format!(\"Failed to sign: {}\", e)));\n                }\n            }\n\n            debug!(\" Distributed signing package for session {}\", sign_id);\n        }\n\n        Ok(())\n    }\n\n    /// Participant handles SignPackage request\n    pub fn handle_sign_package(\n        \u0026mut self,\n        peer: PeerId,\n        sign_id: u64,\n        package_bytes: Vec\u003cu8\u003e,\n        channel: request_response::ResponseChannel\u003cPrivateResponse\u003e,\n    ) -\u003e Result\u003c(), NodeError\u003e {\n        let Some(active) = self.active_signing.as_ref() else {\n            warn!(\"No active session to sign\");\n            return Err(NodeError::Error(\"No active session\".to_string()));\n        };\n        if active.sign_id != sign_id {\n            warn!(\"Session id mismatch\");\n            return Err(NodeError::Error(\"Session id mismatch\".to_string()));\n        }\n\n        let Ok(signing_package) = frost::SigningPackage::deserialize(\u0026package_bytes) else {\n            warn!(\"Failed to deserialize signing package\");\n            return Err(NodeError::Error(\n                \"Failed to deserialize signing package\".to_string(),\n            ));\n        };\n\n        let sig_share = frost::round2::sign(\n            \u0026signing_package,\n            \u0026active.nonces,\n            match self.dkg_state.get_private_key().as_ref() {\n                Some(key_pkg) =\u003e key_pkg,\n                None =\u003e {\n                    return Err(NodeError::Error(\"No private key found\".to_string()));\n                }\n            },\n        );\n        match sig_share {\n            Ok(sig_share) =\u003e {\n                let sig_bytes = sig_share.serialize();\n                let resp = PrivateResponse::SignatureShare {\n                    sign_id,\n                    signature_share: sig_bytes,\n                };\n                let _ = self.network_handle.send_private_response(channel, resp);\n            }\n            Err(e) =\u003e {\n                return Err(NodeError::Error(format!(\"Failed to sign: {}\", e)));\n            }\n        }\n\n        debug!(\n            \"  Sent signature share for session {} to {}\",\n            sign_id, peer\n        );\n\n        Ok(())\n    }\n\n    /// Coordinator handles incoming signature share\n    pub fn handle_signature_share(\n        \u0026mut self,\n        peer: PeerId,\n        sign_id: u64,\n        sig_bytes: Vec\u003cu8\u003e,\n    ) -\u003e Result\u003c(), NodeError\u003e {\n        let Some(active) = self.active_signing.as_mut() else {\n            return Err(NodeError::Error(\"No active session\".to_string()));\n        };\n        if !active.is_coordinator || active.sign_id != sign_id {\n            return Err(NodeError::Error(\"Session id mismatch\".to_string()));\n        }\n\n        let Ok(sig_share) = frost::round2::SignatureShare::deserialize(\u0026sig_bytes) else {\n            warn!(\"Failed to deserialize signature share from {}\", peer);\n            return Err(NodeError::Error(\n                \"Failed to deserialize signature share\".to_string(),\n            ));\n        };\n        let identifier = peer_id_to_identifier(\u0026peer);\n        active.signature_shares.insert(identifier, sig_share);\n        debug!(\n            \" Received signature share from {} (total {}/{})\",\n            peer,\n            active.signature_shares.len(),\n            self.min_signers\n        );\n\n        if active.signature_shares.len() == self.min_signers as usize {\n            let signing_package = match active.signing_package.clone() {\n                Some(signing_package) =\u003e signing_package,\n                None =\u003e {\n                    return Err(NodeError::Error(\"No signing package found\".to_string()));\n                }\n            };\n            let group_sig = frost::aggregate(\n                \u0026signing_package,\n                \u0026active.signature_shares,\n                match self.dkg_state.get_public_key().as_ref() {\n                    Some(public_key) =\u003e public_key,\n                    None =\u003e {\n                        return Err(NodeError::Error(\"No public key found\".to_string()));\n                    }\n                },\n            )\n            .expect(\"Aggregate\");\n            let sig_hex = hex::encode(group_sig.serialize().expect(\"serialize group sig\"));\n            debug!(\n                \" Final FROST signature for session {}: {}\",\n                sign_id, sig_hex\n            );\n\n            // If this signing session corresponds to a pending spend, finalise the transaction.\n            if let Some(pending) = self.pending_spends.remove(\u0026sign_id) {\n                match Self::frost_signature_to_bitcoin(\u0026group_sig) {\n                    Ok(bitcoin_sig) =\u003e {\n                        let mut tx = pending.tx;\n                        let mut witness = bitcoin::witness::Witness::new();\n                        witness.push(bitcoin_sig.as_ref());\n                        if let Some(input) = tx.input.first_mut() {\n                            input.witness = witness;\n                        }\n                        let raw_tx = bitcoin::consensus::encode::serialize(\u0026tx);\n                        debug!(\" Signed transaction (hex): {}\", hex::encode(raw_tx));\n                    }\n                    Err(e) =\u003e debug!(\" Failed to convert signature: {}\", e),\n                }\n            }\n            // Reset\n            self.active_signing = None;\n        }\n\n        Ok(())\n    }\n}\n","traces":[{"line":17,"address":[],"length":0,"stats":{"Line":0}},{"line":18,"address":[],"length":0,"stats":{"Line":0}},{"line":19,"address":[],"length":0,"stats":{"Line":0}},{"line":20,"address":[],"length":0,"stats":{"Line":0}},{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":222,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":236,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":243,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":260,"address":[],"length":0,"stats":{"Line":0}},{"line":263,"address":[],"length":0,"stats":{"Line":0}},{"line":264,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":0}},{"line":273,"address":[],"length":0,"stats":{"Line":0}},{"line":274,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":281,"address":[],"length":0,"stats":{"Line":0}},{"line":282,"address":[],"length":0,"stats":{"Line":0}},{"line":287,"address":[],"length":0,"stats":{"Line":0}},{"line":289,"address":[],"length":0,"stats":{"Line":0}},{"line":290,"address":[],"length":0,"stats":{"Line":0}},{"line":294,"address":[],"length":0,"stats":{"Line":0}},{"line":295,"address":[],"length":0,"stats":{"Line":0}},{"line":299,"address":[],"length":0,"stats":{"Line":0}},{"line":303,"address":[],"length":0,"stats":{"Line":0}},{"line":309,"address":[],"length":0,"stats":{"Line":0}},{"line":310,"address":[],"length":0,"stats":{"Line":0}},{"line":312,"address":[],"length":0,"stats":{"Line":0}},{"line":313,"address":[],"length":0,"stats":{"Line":0}},{"line":316,"address":[],"length":0,"stats":{"Line":0}},{"line":317,"address":[],"length":0,"stats":{"Line":0}},{"line":318,"address":[],"length":0,"stats":{"Line":0}},{"line":319,"address":[],"length":0,"stats":{"Line":0}},{"line":322,"address":[],"length":0,"stats":{"Line":0}},{"line":323,"address":[],"length":0,"stats":{"Line":0}},{"line":324,"address":[],"length":0,"stats":{"Line":0}},{"line":325,"address":[],"length":0,"stats":{"Line":0}},{"line":326,"address":[],"length":0,"stats":{"Line":0}},{"line":327,"address":[],"length":0,"stats":{"Line":0}},{"line":331,"address":[],"length":0,"stats":{"Line":0}},{"line":332,"address":[],"length":0,"stats":{"Line":0}},{"line":333,"address":[],"length":0,"stats":{"Line":0}},{"line":335,"address":[],"length":0,"stats":{"Line":0}},{"line":339,"address":[],"length":0,"stats":{"Line":0}},{"line":340,"address":[],"length":0,"stats":{"Line":0}},{"line":341,"address":[],"length":0,"stats":{"Line":0}},{"line":342,"address":[],"length":0,"stats":{"Line":0}},{"line":344,"address":[],"length":0,"stats":{"Line":0}},{"line":349,"address":[],"length":0,"stats":{"Line":0}},{"line":350,"address":[],"length":0,"stats":{"Line":0}},{"line":351,"address":[],"length":0,"stats":{"Line":0}},{"line":356,"address":[],"length":0,"stats":{"Line":0}},{"line":357,"address":[],"length":0,"stats":{"Line":0}},{"line":358,"address":[],"length":0,"stats":{"Line":0}},{"line":359,"address":[],"length":0,"stats":{"Line":0}},{"line":360,"address":[],"length":0,"stats":{"Line":0}},{"line":361,"address":[],"length":0,"stats":{"Line":0}},{"line":362,"address":[],"length":0,"stats":{"Line":0}},{"line":363,"address":[],"length":0,"stats":{"Line":0}},{"line":365,"address":[],"length":0,"stats":{"Line":0}},{"line":366,"address":[],"length":0,"stats":{"Line":0}},{"line":368,"address":[],"length":0,"stats":{"Line":0}},{"line":372,"address":[],"length":0,"stats":{"Line":0}},{"line":375,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":187},{"path":["/","home","vidyootsenthil","TheValut-nameTBD","node","src","start_node.rs"],"content":"use crate::{\n    NodeState,\n    errors::NodeError,\n    grpc::grpc_handler::NodeControlService,\n    key_manager::{get_config, get_key_file_path, load_and_decrypt_keypair},\n    swarm_manager::build_swarm,\n};\nuse std::path::{Path, PathBuf};\nuse tonic::transport::Server;\nuse tracing::{error, info};\nuse tracing_appender::rolling::{RollingFileAppender, Rotation};\nuse tracing_subscriber::{EnvFilter, fmt, prelude::*};\n\npub async fn start_node(\n    max_signers: Option\u003cu16\u003e,\n    min_signers: Option\u003cu16\u003e,\n    config_filepath: Option\u003cString\u003e,\n    grpc_port: Option\u003cu16\u003e,\n    log_file: Option\u003cPathBuf\u003e,\n) -\u003e Result\u003c(), NodeError\u003e {\n    // Initialize logging\n    let env_filter = EnvFilter::try_from_default_env().unwrap_or_else(|_| EnvFilter::new(\"info\"));\n\n    let registry = tracing_subscriber::registry().with(env_filter);\n\n    let config = match get_config(config_filepath.clone()) {\n        Ok(config) =\u003e config,\n        Err(e) =\u003e {\n            error!(\"Failed to get config: {}\", e);\n            return Err(e);\n        }\n    };\n\n    if let Some(log_path) = config.log_file_path.clone().or(log_file) {\n        // File logging\n        let log_dir = Path::new(\u0026log_path);\n\n        if !log_dir.exists() {\n            info!(\"Creating log directory: {:?}\", log_dir);\n            if let Err(e) = std::fs::create_dir_all(log_dir) {\n                error!(\n                    \"Failed to create log directory {}: {}\",\n                    log_dir.display(),\n                    e\n                );\n                return Err(NodeError::Error(e.to_string()));\n            }\n        }\n\n        let file_appender = RollingFileAppender::new(Rotation::DAILY, log_dir, \"node.log\");\n\n        let file_layer = fmt::layer()\n            .with_writer(file_appender)\n            .with_ansi(false)\n            .with_target(true)\n            .with_thread_ids(true)\n            .with_thread_names(true);\n\n        let console_layer = fmt::layer()\n            .with_writer(std::io::stdout)\n            .with_ansi(true)\n            .with_target(false);\n\n        registry.with(file_layer).with(console_layer).init();\n        info!(\n            \"Logging initialized with file output: {}\",\n            log_path.display()\n        );\n    } else {\n        // Console-only logging\n        let console_layer = fmt::layer()\n            .with_writer(std::io::stdout)\n            .with_ansi(true)\n            .with_target(false);\n\n        registry.with(console_layer).init();\n        info!(\"Logging initialized with console output only\");\n    }\n\n    let config_file_path = if let Some(path) = config_filepath.clone() {\n        path\n    } else {\n        match get_key_file_path() {\n            Ok(path) =\u003e path.to_string_lossy().to_string(),\n            Err(e) =\u003e {\n                error!(\"Failed to get config file path: {}\", e);\n                std::process::exit(1);\n            }\n        }\n    };\n\n    let keypair = match load_and_decrypt_keypair(\u0026config) {\n        Ok(kp) =\u003e kp,\n        Err(e) =\u003e {\n            error!(\"Failed to decrypt key: {}\", e);\n            return Err(e);\n        }\n    };\n\n    let max_signers = max_signers.unwrap_or(5);\n    let min_signers = min_signers.unwrap_or(3);\n\n    let allowed_peers = config.allowed_peers;\n\n    let (network_handle, mut swarm, network_events_stream) =\n        build_swarm(keypair.clone(), allowed_peers.clone()).expect(\"Failed to build swarm\");\n\n    let mut node_state = NodeState::new_from_config(\n        network_handle,\n        allowed_peers,\n        min_signers,\n        max_signers,\n        config_file_path,\n        network_events_stream,\n    )\n    .expect(\"Failed to create node\");\n\n    let network_handle = node_state.network_handle.clone();\n\n    let swarm_handle = tokio::spawn(async move {\n        swarm.start().await;\n    });\n\n    let grpc_handle = tokio::spawn(async move {\n        let addr = format!(\"0.0.0.0:{}\", grpc_port.unwrap_or(50051))\n            .parse()\n            .unwrap();\n\n        let node_control_service = NodeControlService::new(network_handle);\n\n        info!(\"gRPC server listening on {}\", addr);\n\n        Server::builder()\n            .add_service(node_control_service.into_server())\n            .serve(addr)\n            .await\n            .expect(\"gRPC server failed\");\n    });\n\n    let main_loop_handle = tokio::spawn(async move { node_state.start().await });\n\n    // Wait for either task to complete (they should run indefinitely)\n    tokio::select! {\n        result = grpc_handle =\u003e {\n            match result {\n                Ok(_) =\u003e info!(\"gRPC server stopped\"),\n                Err(e) =\u003e error!(\"gRPC server error: {}\", e),\n            }\n        }\n        result = swarm_handle =\u003e {\n            match result {\n                Ok(_) =\u003e info!(\"Swarm stopped\"),\n                Err(e) =\u003e error!(\"Swarm error: {}\", e),\n            }\n        }\n        result = main_loop_handle =\u003e {\n            match result {\n                Ok(Ok(_)) =\u003e info!(\"Main loop stopped\"),\n                Ok(Err(e)) =\u003e error!(\"Main loop error: {}\", e),\n                Err(e) =\u003e error!(\"Main loop task error: {}\", e),\n            }\n        }\n    }\n\n    Ok(())\n}\n","traces":[{"line":14,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":83},{"path":["/","home","vidyootsenthil","TheValut-nameTBD","node","src","swarm_manager.rs"],"content":"use futures::StreamExt;\nuse libp2p::{PeerId, request_response::ResponseChannel, swarm::SwarmEvent};\nuse std::{\n    collections::{BTreeMap, HashSet, hash_map::DefaultHasher},\n    future::Future,\n    hash::{Hash, Hasher},\n    pin::Pin,\n    time::Duration,\n};\nuse tracing::info;\n\nuse frost_secp256k1::keys::dkg::round2;\nuse libp2p::{\n    StreamProtocol, Swarm, gossipsub, mdns, noise, request_response, swarm::NetworkBehaviour, tcp,\n    yamux,\n};\nuse libp2p::{identity::Keypair, request_response::cbor};\nuse tokio::{\n    io,\n    sync::mpsc::{self, UnboundedReceiver, unbounded_channel},\n};\n\nuse crate::{\n    PeerData,\n    errors::{NetworkError, NodeError},\n    protocol::block::Block,\n};\n\n#[derive(Debug, serde::Serialize, serde::Deserialize)]\npub struct PingBody {\n    pub message: String,\n}\n\n#[derive(Debug, serde::Serialize, serde::Deserialize)]\npub enum PrivateRequest {\n    Ping(PingBody),\n    Round2Package(round2::Package),\n    SignRequest { sign_id: u64, message: Vec\u003cu8\u003e },\n    SignPackage { sign_id: u64, package: Vec\u003cu8\u003e },\n    InsertBlock { block: Block },\n    StartSigningSession { hex_message: String },\n    Spend { amount_sat: u64 },\n    GetFrostPublicKey,\n}\n\n#[derive(Debug, serde::Serialize, serde::Deserialize)]\npub enum PrivateResponse {\n    Pong,\n    Commitments {\n        sign_id: u64,\n        commitments: Vec\u003cu8\u003e,\n    },\n    SignatureShare {\n        sign_id: u64,\n        signature_share: Vec\u003cu8\u003e,\n    },\n\n    StartSigningSession {\n        sign_id: u64,\n    },\n    SpendRequestSent {\n        sighash: String,\n    },\n    GetFrostPublicKey {\n        public_key: String,\n    },\n}\n\n#[derive(NetworkBehaviour)]\npub struct MyBehaviour {\n    pub gossipsub: gossipsub::Behaviour,\n    pub mdns: mdns::tokio::Behaviour,\n    pub request_response: cbor::Behaviour\u003cPrivateRequest, PrivateResponse\u003e,\n}\n\npub enum NetworkMessage {\n    SendBroadcast {\n        topic: gossipsub::IdentTopic,\n        message: Vec\u003cu8\u003e,\n    },\n    SendPrivateRequest(PeerId, PrivateRequest),\n    SendPrivateResponse(ResponseChannel\u003cPrivateResponse\u003e, PrivateResponse),\n    SendSelfRequest {\n        request: PrivateRequest,\n        response_channel: Option\u003cmpsc::UnboundedSender\u003cPrivateResponse\u003e\u003e,\n    },\n}\n\ntype NetworkResponseFuture =\n    Pin\u003cBox\u003cdyn Future\u003cOutput = Result\u003cPrivateResponse, NetworkError\u003e\u003e + Send\u003e\u003e;\n\n#[derive(Debug, Clone)]\npub struct NetworkHandle {\n    peer_id: PeerId,\n    tx: mpsc::UnboundedSender\u003cNetworkMessage\u003e,\n}\n\nimpl NetworkHandle {\n    pub fn peer_id(\u0026self) -\u003e PeerId {\n        self.peer_id\n    }\n\n    pub fn send_broadcast(\n        \u0026self,\n        topic: gossipsub::IdentTopic,\n        message: Vec\u003cu8\u003e,\n    ) -\u003e Result\u003c(), NetworkError\u003e {\n        let network_message = NetworkMessage::SendBroadcast { topic, message };\n        self.tx\n            .send(network_message)\n            .map_err(|e| NetworkError::SendError(e.to_string()))\n    }\n\n    pub fn send_private_request(\n        \u0026self,\n        peer_id: PeerId,\n        request: PrivateRequest,\n    ) -\u003e Result\u003c(), NetworkError\u003e {\n        let network_message = NetworkMessage::SendPrivateRequest(peer_id, request);\n        self.tx\n            .send(network_message)\n            .map_err(|e| NetworkError::SendError(e.to_string()))\n    }\n\n    pub fn send_private_response(\n        \u0026self,\n        channel: ResponseChannel\u003cPrivateResponse\u003e,\n        response: PrivateResponse,\n    ) -\u003e Result\u003c(), NetworkError\u003e {\n        let network_message = NetworkMessage::SendPrivateResponse(channel, response);\n        self.tx\n            .send(network_message)\n            .map_err(|e| NetworkError::SendError(e.to_string()))\n    }\n\n    pub fn send_self_request(\n        \u0026self,\n        request: PrivateRequest,\n        sync: bool,\n    ) -\u003e Result\u003cOption\u003cNetworkResponseFuture\u003e, NetworkError\u003e {\n        if sync {\n            let (tx, mut rx) = unbounded_channel::\u003cPrivateResponse\u003e();\n\n            let network_message = NetworkMessage::SendSelfRequest {\n                request,\n                response_channel: Some(tx),\n            };\n\n            self.tx\n                .send(network_message)\n                .map_err(|e| NetworkError::SendError(e.to_string()))?;\n\n            Ok(Some(Box::pin(async move {\n                rx.recv().await.ok_or(NetworkError::RecvError)\n            })))\n        } else {\n            let network_message = NetworkMessage::SendSelfRequest {\n                request,\n                response_channel: None,\n            };\n\n            self.tx\n                .send(network_message)\n                .map_err(|e| NetworkError::SendError(e.to_string()))?;\n\n            Ok(None)\n        }\n    }\n}\n\npub enum NetworkEvent {\n    SwarmEvent(SwarmEvent\u003cMyBehaviourEvent\u003e),\n    NetworkMessage(NetworkMessage),\n}\n\npub struct SwarmManager {\n    pub inner: Swarm\u003cMyBehaviour\u003e,\n\n    pub network_manager_rx: mpsc::UnboundedReceiver\u003cNetworkMessage\u003e,\n    pub network_events: mpsc::UnboundedSender\u003cNetworkEvent\u003e,\n\n    pub allowed_peers: Vec\u003cPeerId\u003e,\n    pub peers_to_names: BTreeMap\u003cPeerId, String\u003e,\n\n    pub live_peers: HashSet\u003cPeerId\u003e,\n\n    pub round1_topic: gossipsub::IdentTopic,\n    pub start_dkg_topic: gossipsub::IdentTopic,\n}\n\nimpl SwarmManager {\n    pub fn new(\n        mut swarm: Swarm\u003cMyBehaviour\u003e,\n        peer_data: Vec\u003cPeerData\u003e,\n    ) -\u003e Result\u003c(Self, NetworkHandle, UnboundedReceiver\u003cNetworkEvent\u003e), NodeError\u003e {\n        let (send_commands, receiving_commands) = unbounded_channel::\u003cNetworkMessage\u003e();\n\n        let (network_events_emitter, network_events_stream) = unbounded_channel::\u003cNetworkEvent\u003e();\n\n        let network_handle = NetworkHandle {\n            peer_id: *swarm.local_peer_id(),\n            tx: send_commands,\n        };\n\n        // Read full lines from stdin\n        let round1_topic = gossipsub::IdentTopic::new(\"round1_topic\");\n        swarm\n            .behaviour_mut()\n            .gossipsub\n            .subscribe(\u0026round1_topic)\n            .map_err(|e| NodeError::Error(e.to_string()))?;\n\n        let allowed_peers: Vec\u003cPeerId\u003e = peer_data\n            .iter()\n            .map(|peer| peer.public_key.parse().unwrap())\n            .collect();\n\n        let peers_to_names: BTreeMap\u003cPeerId, String\u003e = peer_data\n            .iter()\n            .map(|peer| (peer.public_key.parse().unwrap(), peer.name.clone()))\n            .collect();\n\n        let start_dkg_topic = gossipsub::IdentTopic::new(\"start-dkg\");\n        swarm\n            .behaviour_mut()\n            .gossipsub\n            .subscribe(\u0026start_dkg_topic)\n            .map_err(|e| NodeError::Error(e.to_string()))?;\n\n        Ok((\n            Self {\n                round1_topic,\n                live_peers: HashSet::new(),\n                start_dkg_topic,\n                inner: swarm,\n                network_manager_rx: receiving_commands,\n                network_events: network_events_emitter,\n                allowed_peers,\n                peers_to_names,\n            },\n            network_handle,\n            network_events_stream,\n        ))\n    }\n\n    pub fn peer_name(\u0026self, peer_id: \u0026PeerId) -\u003e String {\n        self.peers_to_names\n            .get(peer_id)\n            .unwrap_or(\u0026peer_id.to_string())\n            .clone()\n    }\n\n    pub async fn start(\u0026mut self) {\n        info!(\"Starting swarm manager\");\n        loop {\n            tokio::select! {\n                send_message = self.network_manager_rx.recv() =\u003e match send_message {\n                    Some(NetworkMessage::SendBroadcast { topic, message }) =\u003e {\n                        let _ = self.inner\n                            .behaviour_mut()\n                            .gossipsub\n                            .publish(topic, message);\n                    }\n                    Some(NetworkMessage::SendPrivateRequest(peer_id, request)) =\u003e {\n                        self.inner\n                            .behaviour_mut()\n                            .request_response\n                            .send_request(\u0026peer_id, request);\n                    }\n                    Some(NetworkMessage::SendPrivateResponse(channel, response)) =\u003e {\n                        let _ = self.inner\n                            .behaviour_mut()\n                            .request_response\n                            .send_response(channel, response);\n                    }\n                    Some(message) =\u003e {\n                        self.network_events.send(NetworkEvent::NetworkMessage(message)).unwrap();\n                    }\n                    _ =\u003e {\n                    }\n                },\n                event = self.inner.select_next_some() =\u003e {\n                    match \u0026event {\n                        SwarmEvent::Behaviour(MyBehaviourEvent::Mdns(mdns::Event::Discovered(list))) =\u003e {\n                            for (peer_id, _multiaddr) in list {\n                                if self.allowed_peers.contains(peer_id) {\n                                    info!(\"Discovered peer: {}\", self.peer_name(peer_id));\n                                    self.live_peers.insert(*peer_id);\n                                    self.inner.behaviour_mut().gossipsub.add_explicit_peer(peer_id);\n                                }\n                            }\n                            self.network_events.send(NetworkEvent::SwarmEvent(event)).unwrap();\n                        },\n                        SwarmEvent::Behaviour(MyBehaviourEvent::Mdns(mdns::Event::Expired(list))) =\u003e {\n                            for (peer_id, _multiaddr) in list {\n                                if self.allowed_peers.contains(peer_id) {\n                                    info!(\"Peer expired: {}\", self.peer_name(peer_id));\n                                    self.live_peers.retain(|p| *p != *peer_id);\n                                    self.inner.behaviour_mut().gossipsub.remove_explicit_peer(peer_id);\n                                }\n                            }\n                            self.network_events.send(NetworkEvent::SwarmEvent(event)).unwrap();\n                        },\n                        _ =\u003e {\n                            self.network_events.send(NetworkEvent::SwarmEvent(event)).unwrap();\n                        }\n                    }\n                }\n\n            }\n        }\n    }\n}\n\npub fn build_swarm(\n    keypair: Keypair,\n    peer_data: Vec\u003cPeerData\u003e,\n) -\u003e Result\u003c(NetworkHandle, SwarmManager, UnboundedReceiver\u003cNetworkEvent\u003e), NodeError\u003e {\n    let mut swarm = libp2p::SwarmBuilder::with_existing_identity(keypair)\n        .with_tokio()\n        .with_tcp(\n            tcp::Config::default(),\n            noise::Config::new,\n            yamux::Config::default,\n        )\n        .map_err(|e| NodeError::Error(format!(\"Failed to add tcp {}\", e)))?\n        .with_quic()\n        .with_behaviour(|key| {\n            // To content-address message, we can take the hash of message and use it as an ID.\n            let message_id_fn = |message: \u0026gossipsub::Message| {\n                let mut s = DefaultHasher::new();\n                message.data.hash(\u0026mut s);\n                gossipsub::MessageId::from(s.finish().to_string())\n            };\n\n            let gossipsub_config = gossipsub::ConfigBuilder::default()\n                .heartbeat_interval(Duration::from_secs(10)) // This is set to aid debugging by not cluttering the log space\n                .validation_mode(gossipsub::ValidationMode::Strict) // This sets the kind of message validation. The default is Strict (enforce message signing)\n                .message_id_fn(message_id_fn) // content-address messages. No two messages of the same content will be propagated.\n                .mesh_n_low(1) // Minimum number of peers in mesh network (default is 4)\n                .mesh_n_high(12) // Maximum number of peers in mesh network\n                .mesh_n(3) // Target number of peers in mesh network (default is 6)\n                .mesh_outbound_min(1) // Minimum outbound connections (default is 2)\n                .gossip_lazy(3) // Number of peers to gossip to (default is 6)\n                .flood_publish(true) // Always flood publish messages to all peers, regardless of mesh\n                .build()\n                .map_err(io::Error::other)?; // Temporary hack because `build` does not return a proper `std::error::Error`.\n\n            let gossipsub = gossipsub::Behaviour::new(\n                gossipsub::MessageAuthenticity::Signed(key.clone()),\n                gossipsub_config,\n            )?;\n\n            let mdns =\n                mdns::tokio::Behaviour::new(mdns::Config::default(), key.public().to_peer_id())?;\n\n            let request_response = cbor::Behaviour::new(\n                [(\n                    StreamProtocol::new(\"/direct-message/1.0.0\"),\n                    request_response::ProtocolSupport::Full,\n                )],\n                request_response::Config::default(),\n            );\n\n            Ok(MyBehaviour {\n                gossipsub,\n                mdns,\n                request_response,\n            })\n        })\n        .map_err(|e| NodeError::Error(format!(\"Failed to add behaviour {}\", e)))?\n        .with_swarm_config(|c| c.with_idle_connection_timeout(Duration::from_secs(60)))\n        .build();\n\n    swarm\n        .listen_on(\n            \"/ip4/0.0.0.0/udp/0/quic-v1\"\n                .parse()\n                .expect(\"Failed to deserialize message\"),\n        )\n        .map_err(|e| NodeError::Error(format!(\"Failed to listen on quic {}\", e)))?;\n\n    swarm\n        .listen_on(\n            \"/ip4/0.0.0.0/tcp/0\"\n                .parse()\n                .expect(\"Failed to deserialize message\"),\n        )\n        .map_err(|e| NodeError::Error(format!(\"Failed to listen on tcp {}\", e)))?;\n\n    let (swarm_manager, network, network_events_stream) = SwarmManager::new(swarm, peer_data)\n        .map_err(|e| NodeError::Error(format!(\"Failed to create swarm manager: {}\", e)))?;\n\n    Ok((network, swarm_manager, network_events_stream))\n}\n","traces":[{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":236,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":239,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":260,"address":[],"length":0,"stats":{"Line":0}},{"line":261,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":264,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":267,"address":[],"length":0,"stats":{"Line":0}},{"line":268,"address":[],"length":0,"stats":{"Line":0}},{"line":270,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":0}},{"line":273,"address":[],"length":0,"stats":{"Line":0}},{"line":274,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":277,"address":[],"length":0,"stats":{"Line":0}},{"line":279,"address":[],"length":0,"stats":{"Line":0}},{"line":282,"address":[],"length":0,"stats":{"Line":0}},{"line":283,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":285,"address":[],"length":0,"stats":{"Line":0}},{"line":286,"address":[],"length":0,"stats":{"Line":0}},{"line":287,"address":[],"length":0,"stats":{"Line":0}},{"line":288,"address":[],"length":0,"stats":{"Line":0}},{"line":289,"address":[],"length":0,"stats":{"Line":0}},{"line":292,"address":[],"length":0,"stats":{"Line":0}},{"line":294,"address":[],"length":0,"stats":{"Line":0}},{"line":295,"address":[],"length":0,"stats":{"Line":0}},{"line":296,"address":[],"length":0,"stats":{"Line":0}},{"line":297,"address":[],"length":0,"stats":{"Line":0}},{"line":298,"address":[],"length":0,"stats":{"Line":0}},{"line":299,"address":[],"length":0,"stats":{"Line":0}},{"line":302,"address":[],"length":0,"stats":{"Line":0}},{"line":304,"address":[],"length":0,"stats":{"Line":0}},{"line":305,"address":[],"length":0,"stats":{"Line":0}},{"line":315,"address":[],"length":0,"stats":{"Line":0}},{"line":319,"address":[],"length":0,"stats":{"Line":0}},{"line":322,"address":[],"length":0,"stats":{"Line":0}},{"line":323,"address":[],"length":0,"stats":{"Line":0}},{"line":324,"address":[],"length":0,"stats":{"Line":0}},{"line":326,"address":[],"length":0,"stats":{"Line":0}},{"line":328,"address":[],"length":0,"stats":{"Line":0}},{"line":330,"address":[],"length":0,"stats":{"Line":0}},{"line":331,"address":[],"length":0,"stats":{"Line":0}},{"line":332,"address":[],"length":0,"stats":{"Line":0}},{"line":333,"address":[],"length":0,"stats":{"Line":0}},{"line":336,"address":[],"length":0,"stats":{"Line":0}},{"line":337,"address":[],"length":0,"stats":{"Line":0}},{"line":338,"address":[],"length":0,"stats":{"Line":0}},{"line":339,"address":[],"length":0,"stats":{"Line":0}},{"line":340,"address":[],"length":0,"stats":{"Line":0}},{"line":341,"address":[],"length":0,"stats":{"Line":0}},{"line":342,"address":[],"length":0,"stats":{"Line":0}},{"line":343,"address":[],"length":0,"stats":{"Line":0}},{"line":344,"address":[],"length":0,"stats":{"Line":0}},{"line":345,"address":[],"length":0,"stats":{"Line":0}},{"line":346,"address":[],"length":0,"stats":{"Line":0}},{"line":347,"address":[],"length":0,"stats":{"Line":0}},{"line":349,"address":[],"length":0,"stats":{"Line":0}},{"line":350,"address":[],"length":0,"stats":{"Line":0}},{"line":351,"address":[],"length":0,"stats":{"Line":0}},{"line":354,"address":[],"length":0,"stats":{"Line":0}},{"line":355,"address":[],"length":0,"stats":{"Line":0}},{"line":357,"address":[],"length":0,"stats":{"Line":0}},{"line":359,"address":[],"length":0,"stats":{"Line":0}},{"line":360,"address":[],"length":0,"stats":{"Line":0}},{"line":362,"address":[],"length":0,"stats":{"Line":0}},{"line":365,"address":[],"length":0,"stats":{"Line":0}},{"line":366,"address":[],"length":0,"stats":{"Line":0}},{"line":367,"address":[],"length":0,"stats":{"Line":0}},{"line":368,"address":[],"length":0,"stats":{"Line":0}},{"line":371,"address":[],"length":0,"stats":{"Line":0}},{"line":372,"address":[],"length":0,"stats":{"Line":0}},{"line":375,"address":[],"length":0,"stats":{"Line":0}},{"line":377,"address":[],"length":0,"stats":{"Line":0}},{"line":378,"address":[],"length":0,"stats":{"Line":0}},{"line":379,"address":[],"length":0,"stats":{"Line":0}},{"line":381,"address":[],"length":0,"stats":{"Line":0}},{"line":383,"address":[],"length":0,"stats":{"Line":0}},{"line":385,"address":[],"length":0,"stats":{"Line":0}},{"line":386,"address":[],"length":0,"stats":{"Line":0}},{"line":387,"address":[],"length":0,"stats":{"Line":0}},{"line":389,"address":[],"length":0,"stats":{"Line":0}},{"line":391,"address":[],"length":0,"stats":{"Line":0}},{"line":392,"address":[],"length":0,"stats":{"Line":0}},{"line":394,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":157},{"path":["/","home","vidyootsenthil","TheValut-nameTBD","node","src","wallet.rs"],"content":"use bitcoin::absolute::LockTime;\nuse bitcoin::consensus::encode::serialize;\nuse bitcoin::hashes::Hash;\nuse bitcoin::transaction::{OutPoint, Version};\nuse bitcoin::witness::Witness;\nuse bitcoin::{Amount, ScriptBuf, Transaction, TxIn, TxOut, hashes::sha256};\nuse hex;\nuse tracing::{error, info};\n\nuse crate::NodeState;\nuse frost_secp256k1::{self as frost};\n\n/// Very simple demonstration UTXO representation (key-path Taproot assumed)\n#[derive(Debug, Clone)]\npub struct Utxo {\n    pub outpoint: OutPoint,\n    pub value: Amount,\n    pub script_pubkey: ScriptBuf,\n}\n\n/// Wallet that only tracks a list of local UTXOs and is able to construct a\n/// single-input spending transaction that possibly creates a change output. No\n/// fee calculation is performed  this is purely for demonstration purposes.\n#[derive(Debug)]\npub struct SimpleWallet {\n    pub utxos: Vec\u003cUtxo\u003e,\n}\n\nimpl Default for SimpleWallet {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\nimpl SimpleWallet {\n    pub fn new() -\u003e Self {\n        Self {\n            utxos: vec![\n                Utxo {\n                    outpoint: OutPoint {\n                        txid: bitcoin::Txid::from_slice(\u0026[0u8; 32]).expect(\"Failed to create UTXO\"),\n                        vout: 0,\n                    },\n                    value: Amount::from_sat(100_000),\n                    script_pubkey: ScriptBuf::new(),\n                },\n                Utxo {\n                    outpoint: OutPoint {\n                        txid: bitcoin::Txid::from_slice(\u0026[1u8; 32]).expect(\"Failed to create UTXO\"),\n                        vout: 0,\n                    },\n                    value: Amount::from_sat(50_000),\n                    script_pubkey: ScriptBuf::new(),\n                },\n                Utxo {\n                    outpoint: OutPoint {\n                        txid: bitcoin::Txid::from_slice(\u0026[2u8; 32]).expect(\"Failed to create UTXO\"),\n                        vout: 0,\n                    },\n                    value: Amount::from_sat(20_000),\n                    script_pubkey: ScriptBuf::new(),\n                },\n            ],\n        }\n    }\n\n    pub fn create_spend(\u0026mut self, amount_sat: u64) -\u003e Result\u003c(Transaction, [u8; 32]), String\u003e {\n        let pos = self\n            .utxos\n            .iter()\n            .position(|u| u.value.to_sat() \u003e= amount_sat)\n            .ok_or_else(|| {\n                \"No single UTXO large enough  coin selection not implemented\".to_string()\n            })?;\n\n        let utxo = self.utxos.remove(pos);\n        let change_sat = utxo.value.to_sat() - amount_sat;\n\n        let input = TxIn {\n            previous_output: utxo.outpoint,\n            script_sig: ScriptBuf::new(),\n            sequence: bitcoin::Sequence::ZERO,\n            witness: Witness::new(),\n        };\n\n        let recipient_output = TxOut {\n            value: Amount::from_sat(amount_sat),\n            script_pubkey: ScriptBuf::new(),\n        };\n\n        let mut outputs = vec![recipient_output];\n\n        // Add change output if needed\n        if change_sat \u003e 0 {\n            outputs.push(TxOut {\n                value: Amount::from_sat(change_sat),\n                script_pubkey: ScriptBuf::new(),\n            });\n        }\n\n        let tx = Transaction {\n            version: Version::TWO,\n            lock_time: LockTime::ZERO,\n            input: vec![input],\n            output: outputs,\n        };\n\n        let sighash = sha256::Hash::hash(\u0026serialize(\u0026tx));\n        Ok((tx, sighash.to_byte_array()))\n    }\n}\n\n#[derive(Debug)]\npub struct PendingSpend {\n    pub tx: Transaction,\n}\n\nimpl NodeState {\n    pub fn get_frost_public_key(\u0026self) -\u003e Option\u003cString\u003e {\n        self.dkg_state.pubkey_package.as_ref().map(|p| {\n            format!(\"{:?}\", p.verifying_key())\n                .replace(\"VerifyingKey(\", \"\")\n                .replace(\")\", \"\")\n                .replace(\"\\\\\", \"\")\n                .replace(\"\\\"\", \"\")\n        })\n    }\n\n    pub fn frost_signature_to_bitcoin(\n        frost_sig: \u0026frost::Signature,\n    ) -\u003e Result\u003cbitcoin::secp256k1::schnorr::Signature, String\u003e {\n        let sig_bytes = frost_sig\n            .serialize()\n            .map_err(|e| format!(\"Serialize frost sig: {}\", e))?;\n\n        let schnorr_bytes = match sig_bytes.len() {\n            64 =\u003e sig_bytes,\n            65 =\u003e sig_bytes[..64].to_vec(),\n            _ =\u003e return Err(format!(\"Unsupported signature len {}\", sig_bytes.len())),\n        };\n\n        bitcoin::secp256k1::schnorr::Signature::from_slice(\u0026schnorr_bytes)\n            .map_err(|e| format!(\"Parse schnorr sig: {}\", e))\n    }\n\n    pub fn start_spend_request(\u0026mut self, amount_sat: u64) -\u003e Option\u003cString\u003e {\n        info!(\" Creating spend request for {} sat\", amount_sat);\n        match self.wallet.create_spend(amount_sat) {\n            Ok((tx, sighash)) =\u003e {\n                let sighash_hex = hex::encode(sighash);\n                match self.start_signing_session(\u0026sighash_hex) {\n                    Ok(_) =\u003e (),\n                    Err(e) =\u003e {\n                        error!(\" Failed to start signing session: {}\", e);\n                        return None;\n                    }\n                }\n\n                if let Some(active) = \u0026self.active_signing {\n                    self.pending_spends\n                        .insert(active.sign_id, crate::wallet::PendingSpend { tx });\n                    info!(\" Spend request prepared (session id {})\", active.sign_id);\n\n                    Some(hex::encode(sighash))\n                } else {\n                    error!(\" Failed to start signing session\");\n                    None\n                }\n            }\n            Err(e) =\u003e {\n                error!(\" Failed to create spend transaction: {}\", e);\n                None\n            }\n        }\n    }\n}\n","traces":[{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":61}]};
        var previousData = {"files":[{"path":["/","home","vidyootsenthil","TheValut-nameTBD","bin","esplora-client","src","main.rs"],"content":"use async_trait::async_trait;\nuse bitcoin::{consensus, Address, Network, Transaction};\nuse esplora_client::{AsyncClient, Builder};\nuse std::str::FromStr;\nuse tokio::sync::broadcast;\nuse tokio::time::{sleep, Duration};\n\n#[derive(Debug)]\npub enum NodeError {\n    Error(String),\n}\n\n#[async_trait]\npub trait WindowedConfirmedTransactionProvider {\n    // Must only return transactions that are confirmed in the given range [min_height, max_height].\n    // All returned transactions must have at least six confirmations (\u003c current_chain_tip_height - 6).\n    async fn get_confirmed_transactions(\n        \u0026self,\n        address: Address,\n        min_height: u32,\n        max_height: u32,\n    ) -\u003e Result\u003cVec\u003cTransaction\u003e, NodeError\u003e;\n\n    // Must poll for new transactions and send them to the given channel.\n    async fn poll_new_transactions(\u0026self, address: Address);\n}\n\npub struct EsploraApiClient {\n    client: AsyncClient,\n    tx_channel: broadcast::Sender\u003cTransaction\u003e,\n}\n\nimpl EsploraApiClient {\n    pub fn new(client: AsyncClient, capacity: usize) -\u003e Self {\n        Self {\n            client,\n            tx_channel: broadcast::channel(capacity).0,\n        }\n    }\n}\n\n#[async_trait]\nimpl WindowedConfirmedTransactionProvider for EsploraApiClient {\n    async fn get_confirmed_transactions(\n        \u0026self,\n        address: Address,\n        min_height: u32,\n        max_height: u32,\n    ) -\u003e Result\u003cVec\u003cTransaction\u003e, NodeError\u003e {\n        let blockchain_height = self.client.get_height().await.map_err(|e| {\n            NodeError::Error(format!(\"Cannot retrieve height of blockchain: {}\", e))\n        })?;\n\n        let new_max_height = max_height.min(blockchain_height - 6);\n\n        let mut confirmed_txs = Vec::new();\n        let mut last_seen_txid = None;\n\n        loop {\n            let address_txs = self\n                .client\n                .scripthash_txs(\u0026address.script_pubkey(), last_seen_txid)\n                .await\n                .map_err(|e| {\n                    NodeError::Error(format!(\"Cannot retrieve transactions for address: {}\", e))\n                })?;\n\n            if address_txs.is_empty() {\n                break;\n            }\n\n            let mut found_confirmed = false;\n            let last_tx_height = address_txs.last().and_then(|tx| tx.status.block_height);\n\n            for tx in address_txs {\n                if let Some(block_height) = tx.status.block_height {\n                    if block_height \u003e= min_height \u0026\u0026 block_height \u003c= new_max_height {\n                        if let Ok(full_tx) = self.client.get_tx(\u0026tx.txid).await {\n                            if let Ok(bitcoin_tx) =\n                                consensus::deserialize(\u0026consensus::serialize(\u0026full_tx.unwrap()))\n                            {\n                                confirmed_txs.push(bitcoin_tx);\n                                found_confirmed = true;\n                            }\n                        }\n                    }\n                }\n                last_seen_txid = Some(tx.txid);\n            }\n\n            if !found_confirmed \u0026\u0026 last_tx_height.is_some_and(|height| height \u003c min_height) {\n                break;\n            }\n        }\n\n        Ok(confirmed_txs)\n    }\n\n    async fn poll_new_transactions(\u0026self, address: Address) {\n        let mut last_confirmed_height = match self.client.get_height().await {\n            Ok(height) =\u003e height - 6,\n            Err(e) =\u003e {\n                eprintln!(\"Cannot retrieve height of blockchain: {}\", e);\n                return;\n            }\n        };\n\n        println!(\n            \"Polling for new transactions for address {}, starting from confirmed height {}\",\n            address, last_confirmed_height\n        );\n\n        loop {\n            sleep(Duration::from_secs(60)).await;\n\n            let current_height = match self.client.get_height().await {\n                Ok(height) =\u003e height,\n                Err(e) =\u003e {\n                    eprintln!(\"Cannot retrieve height of blockchain: {}\", e);\n                    continue;\n                }\n            };\n\n            let new_confirmed_height = current_height - 6;\n\n            if new_confirmed_height \u003e last_confirmed_height {\n                println!(\n                    \"New confirmed block found. From height {} to {}\",\n                    last_confirmed_height + 1,\n                    new_confirmed_height\n                );\n\n                let new_txs = match self\n                    .get_confirmed_transactions(\n                        address.clone(),\n                        last_confirmed_height + 1,\n                        new_confirmed_height,\n                    )\n                    .await\n                {\n                    Ok(txs) =\u003e txs,\n                    Err(e) =\u003e {\n                        eprintln!(\"Error getting confirmed transactions: {:?}\", e);\n                        continue;\n                    }\n                };\n\n                for tx in new_txs {\n                    println!(\"Found new confirmed transaction: {}\", tx.compute_txid());\n                    match self.tx_channel.send(tx) {\n                        Ok(_) =\u003e (),\n                        Err(e) =\u003e {\n                            eprintln!(\"Error sending transaction to channel: {:?}\", e);\n                        }\n                    }\n                }\n\n                last_confirmed_height = new_confirmed_height;\n            }\n        }\n    }\n}\n\n#[tokio::main]\nasync fn main() {\n    let client = EsploraApiClient::new(\n        Builder::new(\"https://blockstream.info/api\")\n            .build_async()\n            .unwrap(),\n        100,\n    );\n\n    let address = Address::from_str(\"bc1qezwz3yt46nsgzcwlg0dsw680nryjpq5u8pvzts\")\n        .unwrap()\n        .require_network(Network::Bitcoin)\n        .unwrap();\n\n    let transactions = client\n        .get_confirmed_transactions(address.clone(), 899900, 900000)\n        .await\n        .unwrap();\n    println!(\"Found {} transactions.\", transactions.len());\n    for tx in transactions {\n        println!(\"Transaction ID: {}\", tx.compute_txid());\n    }\n\n    client.poll_new_transactions(address).await;\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[tokio::test]\n    async fn test_get_confirmed_transactions() {\n        let client = EsploraApiClient::new(\n            Builder::new(\"https://blockstream.info/api\")\n                .build_async()\n                .unwrap(),\n            100,\n        );\n        let address = Address::from_str(\"bc1qezwz3yt46nsgzcwlg0dsw680nryjpq5u8pvzts\")\n            .unwrap()\n            .require_network(Network::Bitcoin)\n            .unwrap();\n        let transactions = client\n            .get_confirmed_transactions(address.clone(), 899900, 899930)\n            .await\n            .unwrap();\n\n        let correct_txs = vec![\n            \"99c024e891c3110297513a1bc8c6f36948b36461096e664be72c3ac96e958c5c\",\n            \"1d0249929acaf31c2c6b6e6f9c72f44bd663a426cb146afe0b7bbaa66e0bc0df\",\n            \"fdcd9cf8d660e359a6ab2993d649276fca60be01c2b4327f95ad2527cbe3db08\",\n            \"3fd280c3ccc13f0f88433f0ce95aeebacc249565c8e8b671005302de0616babe\",\n            \"a8705186a9d6b5063484a8029b0e2c4064e3e2723ea61ea10b6bc38d0abbc77a\",\n        ];\n\n        assert_eq!(transactions.len(), correct_txs.len());\n\n        for tx in transactions {\n            assert!(correct_txs.contains(\u0026tx.compute_txid().to_string().as_str()));\n        }\n    }\n}\n","traces":[{"line":34,"address":[2156960,2157137,2157131],"length":1,"stats":{"Line":1}},{"line":37,"address":[2157018,2157070],"length":1,"stats":{"Line":2}},{"line":50,"address":[2118879,2118740,2118295,2119215,2122896,2119467,2123114],"length":1,"stats":{"Line":2}},{"line":51,"address":[2122926,2122974],"length":1,"stats":{"Line":0}},{"line":54,"address":[2119262],"length":1,"stats":{"Line":1}},{"line":56,"address":[2119385],"length":1,"stats":{"Line":1}},{"line":57,"address":[2119407],"length":1,"stats":{"Line":1}},{"line":59,"address":[2121288],"length":1,"stats":{"Line":1}},{"line":60,"address":[2121865,2121941,2121593,2121779,2121563,2119422],"length":1,"stats":{"Line":5}},{"line":62,"address":[2121395,2121494,2119439],"length":1,"stats":{"Line":3}},{"line":63,"address":[2006359],"length":1,"stats":{"Line":5}},{"line":64,"address":[2123136,2123354],"length":1,"stats":{"Line":0}},{"line":65,"address":[2123214,2123166],"length":1,"stats":{"Line":0}},{"line":68,"address":[2122085],"length":1,"stats":{"Line":1}},{"line":72,"address":[2122125],"length":1,"stats":{"Line":1}},{"line":73,"address":[2122140,2123376,2123381],"length":1,"stats":{"Line":3}},{"line":75,"address":[2122251,2121010],"length":1,"stats":{"Line":2}},{"line":76,"address":[2122692,2121117],"length":1,"stats":{"Line":2}},{"line":77,"address":[2120787,2122717],"length":1,"stats":{"Line":2}},{"line":78,"address":[2006378],"length":1,"stats":{"Line":5}},{"line":79,"address":[2120169,2120237,2120065,2120317],"length":1,"stats":{"Line":4}},{"line":82,"address":[2120499],"length":1,"stats":{"Line":1}},{"line":83,"address":[2120603],"length":1,"stats":{"Line":1}},{"line":88,"address":[2120808],"length":1,"stats":{"Line":1}},{"line":91,"address":[2121297,2123392,2121218,2123401],"length":1,"stats":{"Line":4}},{"line":96,"address":[2122415],"length":1,"stats":{"Line":1}},{"line":99,"address":[2123424,2123901,2123662,2123768,2124650,2123485],"length":1,"stats":{"Line":0}},{"line":100,"address":[2005906],"length":1,"stats":{"Line":0}},{"line":101,"address":[2124313,2124240],"length":1,"stats":{"Line":0}},{"line":102,"address":[2124166],"length":1,"stats":{"Line":0}},{"line":103,"address":[2124522,2124230],"length":1,"stats":{"Line":0}},{"line":108,"address":[2124333,2124286],"length":1,"stats":{"Line":0}},{"line":114,"address":[2123713,2124459,2124656,2126258,2126345],"length":1,"stats":{"Line":0}},{"line":116,"address":[2124690,2123734,2126507,2126595],"length":1,"stats":{"Line":0}},{"line":117,"address":[2126908],"length":1,"stats":{"Line":0}},{"line":118,"address":[2126834],"length":1,"stats":{"Line":0}},{"line":119,"address":[2126898,2127453],"length":1,"stats":{"Line":0}},{"line":124,"address":[2126989,2126922],"length":1,"stats":{"Line":0}},{"line":126,"address":[2125541,2126954],"length":1,"stats":{"Line":0}},{"line":127,"address":[2127095,2127047],"length":1,"stats":{"Line":0}},{"line":133,"address":[2127382,2127214,2127307,2124890,2124979],"length":1,"stats":{"Line":0}},{"line":135,"address":[2127231],"length":1,"stats":{"Line":0}},{"line":136,"address":[2127324,2127250],"length":1,"stats":{"Line":0}},{"line":137,"address":[2127285],"length":1,"stats":{"Line":0}},{"line":139,"address":[2005964],"length":1,"stats":{"Line":0}},{"line":141,"address":[2125051],"length":1,"stats":{"Line":0}},{"line":142,"address":[2124993],"length":1,"stats":{"Line":0}},{"line":143,"address":[2125041,2126152],"length":1,"stats":{"Line":0}},{"line":148,"address":[2125926,2125123,2125227,2125354],"length":1,"stats":{"Line":0}},{"line":149,"address":[2125463,2125587],"length":1,"stats":{"Line":0}},{"line":150,"address":[2125683],"length":1,"stats":{"Line":0}},{"line":152,"address":[2125831],"length":1,"stats":{"Line":0}},{"line":153,"address":[2125911,2125971],"length":1,"stats":{"Line":0}},{"line":158,"address":[2125505],"length":1,"stats":{"Line":0}},{"line":165,"address":[2157849,2157843,2157456],"length":1,"stats":{"Line":0}},{"line":167,"address":[2127769,2127636],"length":1,"stats":{"Line":0}},{"line":173,"address":[2127965,2127855,2127927],"length":1,"stats":{"Line":0}},{"line":175,"address":[2127957],"length":1,"stats":{"Line":0}},{"line":178,"address":[2128362,2128168,2128114,2128023,2128410],"length":1,"stats":{"Line":0}},{"line":179,"address":[2128048],"length":1,"stats":{"Line":0}},{"line":180,"address":[2128231,2128184,2128394,2127694,2128141],"length":1,"stats":{"Line":0}},{"line":182,"address":[2128450,2128522],"length":1,"stats":{"Line":0}},{"line":183,"address":[2128817,2128626],"length":1,"stats":{"Line":0}},{"line":184,"address":[2129178,2128918],"length":1,"stats":{"Line":0}},{"line":187,"address":[2008337],"length":1,"stats":{"Line":0}}],"covered":23,"coverable":65},{"path":["/","home","vidyootsenthil","TheValut-nameTBD","experiments","cli","src","errors.rs"],"content":"use derive_more::Display;\n\n#[derive(Debug, Display)]\npub enum KeygenError {\n    #[display(\"Password mismatch\")]\n    PasswordMismatch,\n\n    #[display(\"Failed to create directory.\")]\n    DirectoryCreation(String),\n\n    #[display(\"Io error: {}\", _0)]\n    Io(std::io::Error),\n\n    #[display(\"Failed to encode key.\")]\n    KeyEncoding(String),\n\n    #[display(\"Failed to encrypt key.\")]\n    Encryption(String),\n\n    #[display(\"Failed to create directory.\")]\n    KeyFileNotFound(String),\n}\n\n#[derive(Debug)]\n#[allow(dead_code, clippy::enum_variant_names, clippy::large_enum_variant)]\npub enum CliError {\n    KeygenError(KeygenError),\n    RpcError(tonic::Status),\n    NodeError,\n}\n\nimpl From\u003cKeygenError\u003e for CliError {\n    fn from(error: KeygenError) -\u003e Self {\n        CliError::KeygenError(error)\n    }\n}\n","traces":[{"line":33,"address":[5276208],"length":1,"stats":{"Line":0}},{"line":34,"address":[5276211],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":2},{"path":["/","home","vidyootsenthil","TheValut-nameTBD","experiments","cli","src","main.rs"],"content":"mod errors;\nmod rpc_client;\n\nuse aes_gcm::{\n    aead::{Aead, KeyInit},\n    Aes256Gcm, Key, Nonce,\n};\nuse argon2::{\n    password_hash::{\n        rand_core::{OsRng, RngCore},\n        SaltString,\n    },\n    Argon2,\n};\nuse base64::{engine::general_purpose::STANDARD as BASE64, Engine as _};\nuse clap::{Parser, Subcommand};\nuse directories::ProjectDirs;\nuse libp2p::identity::Keypair;\nuse rpc_client::{\n    rpc_create_deposit_intent, rpc_send_direct_message, rpc_spend, rpc_start_signing,\n};\nuse std::{fs, path::PathBuf};\n\nuse node::{start_node::start_node, Config, EncryptionParams, KeyData, PeerData};\n\nuse crate::errors::{CliError, KeygenError};\n\nfn get_key_file_path() -\u003e Result\u003cPathBuf, KeygenError\u003e {\n    let proj_dirs = ProjectDirs::from(\"\", \"\", \"TheVault\").ok_or_else(|| {\n        KeygenError::DirectoryCreation(\"Failed to determine project directory\".into())\n    })?;\n\n    let config_dir = proj_dirs.config_dir();\n    fs::create_dir_all(config_dir).map_err(|e| KeygenError::DirectoryCreation(e.to_string()))?;\n\n    Ok(config_dir.join(\"config.json\"))\n}\n\nfn get_log_file_path() -\u003e Result\u003cPathBuf, KeygenError\u003e {\n    let proj_dirs = ProjectDirs::from(\"\", \"\", \"TheVault\").ok_or_else(|| {\n        KeygenError::DirectoryCreation(\"Failed to determine project directory\".into())\n    })?;\n\n    let log_dir = proj_dirs.config_dir();\n    let path = log_dir.join(\"node.log\");\n    Ok(path)\n}\n\nfn generate_key(password: \u0026str, salt: \u0026SaltString) -\u003e Result\u003cVec\u003cu8\u003e, KeygenError\u003e {\n    let argon2 = Argon2::default();\n    let password_bytes = password.as_bytes();\n    let mut key = vec![0u8; 32];\n\n    argon2\n        .hash_password_into(password_bytes, salt.as_str().as_bytes(), \u0026mut key)\n        .map_err(|e| KeygenError::Encryption(e.to_string()))?;\n    Ok(key)\n}\n\nfn encrypt_private_key(\n    keypair: \u0026Keypair,\n    password: \u0026str,\n) -\u003e Result\u003c(String, EncryptionParams), KeygenError\u003e {\n    let salt = SaltString::generate(\u0026mut OsRng);\n    let key = generate_key(password, \u0026salt)?;\n\n    let mut nonce_bytes = [0u8; 12];\n    OsRng.fill_bytes(\u0026mut nonce_bytes);\n    let nonce = Nonce::from_slice(\u0026nonce_bytes);\n\n    let private_key_bytes = keypair\n        .to_protobuf_encoding()\n        .map_err(|e| KeygenError::KeyEncoding(e.to_string()))?;\n\n    let cipher = Aes256Gcm::new(Key::\u003cAes256Gcm\u003e::from_slice(\u0026key));\n\n    let ciphertext = cipher\n        .encrypt(nonce, private_key_bytes.as_ref())\n        .map_err(|e| KeygenError::Encryption(e.to_string()))?;\n\n    let params = EncryptionParams {\n        kdf: \"argon2id\".to_string(),\n        salt_b64: salt.to_string(),\n        iv_b64: BASE64.encode(nonce_bytes),\n    };\n\n    Ok((BASE64.encode(ciphertext), params))\n}\n\nfn get_password() -\u003e Result\u003cString, KeygenError\u003e {\n    let password = rpassword::prompt_password(\"Enter password: \").map_err(KeygenError::Io)?;\n\n    let confirm = rpassword::prompt_password(\"Confirm password: \").map_err(KeygenError::Io)?;\n\n    if password != confirm {\n        return Err(KeygenError::PasswordMismatch);\n    }\n\n    Ok(password)\n}\n\n#[derive(Parser)]\n#[command(name = \"keygen\")]\n#[command(about = \"Generate public and private key pairs for the Vault.\")]\n#[command(version = \"0.0.1\")]\nstruct Cli {\n    #[command(subcommand)]\n    command: Commands,\n}\n\n#[derive(Subcommand)]\nenum Commands {\n    /// Generate a new keypair and save it to a file set by the --output flag\n    Setup {\n        #[arg(short, long)]\n        output: Option\u003cString\u003e,\n        #[arg(short, long)]\n        allowed_peers: Option\u003cVec\u003cString\u003e\u003e,\n    },\n    /// Run the node and connect to the network\n    Run {\n        #[arg(short, long)]\n        config: Option\u003cString\u003e,\n        #[arg(short, long)]\n        grpc_port: Option\u003cu16\u003e,\n        #[arg(short, long)]\n        log_file: Option\u003cString\u003e,\n        #[arg(short = 'n', long)]\n        max_signers: Option\u003cu16\u003e,\n        #[arg(short = 't', long)]\n        min_signers: Option\u003cu16\u003e,\n    },\n    Spend {\n        amount: u64,\n        #[arg(short, long)]\n        endpoint: Option\u003cString\u003e,\n    },\n    StartSigning {\n        hex_message: String,\n        #[arg(short, long)]\n        endpoint: Option\u003cString\u003e,\n    },\n    SendDirectMessage {\n        peer_id: String,\n        message: String,\n        #[arg(short, long)]\n        endpoint: Option\u003cString\u003e,\n    },\n    Deposit {\n        peer_id: String,\n        amount: u64,\n        #[arg(short, long)]\n        endpoint: Option\u003cString\u003e,\n    },\n}\n\n#[tokio::main]\n#[allow(clippy::result_large_err)]\nasync fn main() -\u003e Result\u003c(), CliError\u003e {\n    let cli = Cli::parse();\n\n    match cli.command {\n        Commands::Setup {\n            output,\n            allowed_peers,\n        } =\u003e {\n            setup_config(output, allowed_peers).map_err(|e| {\n                println!(\"Keygen Error: {}\", e);\n                CliError::KeygenError(e)\n            })?;\n        }\n        Commands::Run {\n            config,\n            grpc_port,\n            log_file,\n            max_signers,\n            min_signers,\n        } =\u003e {\n            start_node_cli(config, grpc_port, log_file, max_signers, min_signers)\n                .await\n                .map_err(|_| CliError::NodeError)?;\n        }\n        Commands::Spend { amount, endpoint } =\u003e {\n            rpc_spend(endpoint, amount)\n                .await\n                .map_err(CliError::RpcError)?;\n        }\n        Commands::StartSigning {\n            hex_message,\n            endpoint,\n        } =\u003e {\n            rpc_start_signing(endpoint, hex_message)\n                .await\n                .map_err(CliError::RpcError)?;\n        }\n        Commands::SendDirectMessage {\n            peer_id,\n            message,\n            endpoint,\n        } =\u003e {\n            rpc_send_direct_message(endpoint, peer_id, message)\n                .await\n                .map_err(CliError::RpcError)?;\n        }\n        Commands::Deposit {\n            peer_id,\n            amount,\n            endpoint,\n        } =\u003e {\n            rpc_create_deposit_intent(endpoint, peer_id, amount)\n                .await\n                .map_err(CliError::RpcError)?;\n        }\n    };\n\n    Ok(())\n}\n\nfn setup_config(\n    output: Option\u003cString\u003e,\n    allowed_peers: Option\u003cVec\u003cString\u003e\u003e,\n) -\u003e Result\u003c(), KeygenError\u003e {\n    let keypair = Keypair::generate_ed25519();\n    let public_key_b58 = keypair.public().to_peer_id().to_base58();\n\n    let user_password = get_password()?;\n\n    let (encrypted_private_key, encryption_params) = encrypt_private_key(\u0026keypair, \u0026user_password)?;\n\n    let key_data = KeyData {\n        public_key_b58: public_key_b58.clone(),\n        encrypted_private_key_b64: encrypted_private_key,\n        encryption_params,\n    };\n\n    let allowed_peer_ids = allowed_peers.unwrap_or_default();\n\n    let allowed_peer_data = allowed_peer_ids\n        .iter()\n        .map(|peer_id| PeerData {\n            public_key: peer_id.to_string(),\n            name: peer_id.to_string(),\n        })\n        .collect();\n\n    let config = Config {\n        allowed_peers: allowed_peer_data,\n        key_data,\n        dkg_keys: None,\n        log_file_path: Some(get_log_file_path()?),\n    };\n\n    let json = serde_json::to_string_pretty(\u0026config)\n        .map_err(|e| KeygenError::Io(std::io::Error::other(e)))?;\n\n    let key_file_path = if let Some(output) = output {\n        let path = PathBuf::from(output);\n        if path.is_dir() {\n            return Err(KeygenError::KeyFileNotFound(format!(\n                \"The path {} is a directory\",\n                path.display()\n            )));\n        } else {\n            path\n        }\n    } else {\n        get_key_file_path()?\n    };\n\n    fs::write(\u0026key_file_path, json).map_err(KeygenError::Io)?;\n\n    println!(\n        \"Key data has been saved to {} with the peer id {}. To modify the allowed peers, edit the config file.\",\n        key_file_path.display(),\n        public_key_b58\n    );\n\n    Ok(())\n}\n\nasync fn start_node_cli(\n    config_filepath: Option\u003cString\u003e,\n    grpc_port: Option\u003cu16\u003e,\n    log_file: Option\u003cString\u003e,\n    max_signers: Option\u003cu16\u003e,\n    min_signers: Option\u003cu16\u003e,\n) -\u003e Result\u003c(), Box\u003cdyn std::error::Error\u003e\u003e {\n    start_node(\n        max_signers,\n        min_signers,\n        config_filepath,\n        grpc_port,\n        log_file.map(PathBuf::from),\n    )\n    .await?;\n    Ok(())\n}\n\n#[cfg(test)]\nmod tests;\n","traces":[{"line":28,"address":[5287728,5288423,5288417],"length":1,"stats":{"Line":0}},{"line":29,"address":[5278288],"length":1,"stats":{"Line":0}},{"line":30,"address":[5278302],"length":1,"stats":{"Line":0}},{"line":33,"address":[5288112,5288040],"length":1,"stats":{"Line":0}},{"line":34,"address":[5278402,5278384],"length":1,"stats":{"Line":0}},{"line":36,"address":[5288300],"length":1,"stats":{"Line":0}},{"line":39,"address":[5288448,5288952,5288958],"length":1,"stats":{"Line":0}},{"line":40,"address":[5278544],"length":1,"stats":{"Line":0}},{"line":41,"address":[5278558],"length":1,"stats":{"Line":0}},{"line":44,"address":[5288832,5288760],"length":1,"stats":{"Line":0}},{"line":45,"address":[5288848],"length":1,"stats":{"Line":0}},{"line":46,"address":[5288885],"length":1,"stats":{"Line":0}},{"line":49,"address":[5289595,5288976,5289601],"length":1,"stats":{"Line":1}},{"line":50,"address":[5289032],"length":1,"stats":{"Line":1}},{"line":51,"address":[5289059],"length":1,"stats":{"Line":1}},{"line":52,"address":[5289096],"length":1,"stats":{"Line":1}},{"line":54,"address":[5289448,5289309],"length":1,"stats":{"Line":1}},{"line":55,"address":[5289132,5289213],"length":1,"stats":{"Line":2}},{"line":56,"address":[5278660,5278640],"length":1,"stats":{"Line":0}},{"line":57,"address":[5289475],"length":1,"stats":{"Line":1}},{"line":60,"address":[5291535,5291627,5289616],"length":1,"stats":{"Line":1}},{"line":64,"address":[5289672],"length":1,"stats":{"Line":1}},{"line":65,"address":[5289708],"length":1,"stats":{"Line":1}},{"line":67,"address":[5289933],"length":1,"stats":{"Line":1}},{"line":68,"address":[5289956],"length":1,"stats":{"Line":1}},{"line":69,"address":[5290032],"length":1,"stats":{"Line":1}},{"line":71,"address":[5291625,5290079,5290209],"length":1,"stats":{"Line":1}},{"line":73,"address":[5278759,5278736],"length":1,"stats":{"Line":0}},{"line":75,"address":[5290298,5290381],"length":1,"stats":{"Line":2}},{"line":77,"address":[5290507,5290645],"length":1,"stats":{"Line":1}},{"line":78,"address":[5290421],"length":1,"stats":{"Line":1}},{"line":79,"address":[5278880,5278893],"length":1,"stats":{"Line":0}},{"line":82,"address":[5290742],"length":1,"stats":{"Line":1}},{"line":83,"address":[5290827],"length":1,"stats":{"Line":1}},{"line":84,"address":[5290875],"length":1,"stats":{"Line":1}},{"line":87,"address":[5291199,5291076],"length":1,"stats":{"Line":2}},{"line":90,"address":[5292429,5292447,5291648],"length":1,"stats":{"Line":0}},{"line":91,"address":[5291665],"length":1,"stats":{"Line":0}},{"line":93,"address":[5291981,5292435,5291893],"length":1,"stats":{"Line":0}},{"line":95,"address":[5292165,5292241],"length":1,"stats":{"Line":0}},{"line":96,"address":[5292341],"length":1,"stats":{"Line":0}},{"line":99,"address":[5292252],"length":1,"stats":{"Line":0}},{"line":159,"address":[5344393,5343968,5344387],"length":1,"stats":{"Line":0}},{"line":160,"address":[5280971],"length":1,"stats":{"Line":0}},{"line":162,"address":[5281163],"length":1,"stats":{"Line":0}},{"line":163,"address":[5281235],"length":1,"stats":{"Line":0}},{"line":167,"address":[5285086,5281323,5282007,5284848,5282105,5282143],"length":1,"stats":{"Line":0}},{"line":168,"address":[5284875,5284919],"length":1,"stats":{"Line":0}},{"line":169,"address":[5284988],"length":1,"stats":{"Line":0}},{"line":172,"address":[5281493,5281473,5281484],"length":1,"stats":{"Line":0}},{"line":179,"address":[5281514,5281379,5282833,5281373,5282754,5281481,5281488,5281442,5281450,5282931,5282222,5282958],"length":1,"stats":{"Line":0}},{"line":180,"address":[5581057],"length":1,"stats":{"Line":0}},{"line":181,"address":[5285120,5282924,5285142],"length":1,"stats":{"Line":0}},{"line":183,"address":[5281560],"length":1,"stats":{"Line":0}},{"line":184,"address":[5282302,5281628,5283450,5283275,5283177,5283140],"length":1,"stats":{"Line":0}},{"line":185,"address":[5283142,5282969,5282332,5281040,5282295],"length":1,"stats":{"Line":0}},{"line":186,"address":[5283428,5283268],"length":1,"stats":{"Line":0}},{"line":188,"address":[5281638],"length":1,"stats":{"Line":0}},{"line":192,"address":[5283901,5283626,5283761,5283663,5281726,5282382],"length":1,"stats":{"Line":0}},{"line":193,"address":[5282412,5282375,5283455,5283628,5281061],"length":1,"stats":{"Line":0}},{"line":194,"address":[5283879,5283754],"length":1,"stats":{"Line":0}},{"line":196,"address":[5281736],"length":1,"stats":{"Line":0}},{"line":201,"address":[5282462,5281863,5284320,5284212,5284077,5284114],"length":1,"stats":{"Line":0}},{"line":202,"address":[5283906,5282455,5281082,5282492,5284079],"length":1,"stats":{"Line":0}},{"line":203,"address":[5284205,5284298],"length":1,"stats":{"Line":0}},{"line":205,"address":[5281905],"length":1,"stats":{"Line":0}},{"line":210,"address":[5281981,5284838,5282542,5284533,5284631,5284496],"length":1,"stats":{"Line":0}},{"line":211,"address":[5284498,5282572,5284325,5281103,5282535],"length":1,"stats":{"Line":0}},{"line":212,"address":[5284624,5284816],"length":1,"stats":{"Line":0}},{"line":216,"address":[5282129],"length":1,"stats":{"Line":0}},{"line":219,"address":[5295849,5292480,5297414],"length":1,"stats":{"Line":0}},{"line":223,"address":[5292519],"length":1,"stats":{"Line":0}},{"line":224,"address":[5292643,5292711],"length":1,"stats":{"Line":0}},{"line":226,"address":[5292840,5292773,5297203],"length":1,"stats":{"Line":0}},{"line":228,"address":[5293012,5293111,5297179],"length":1,"stats":{"Line":0}},{"line":231,"address":[5293467],"length":1,"stats":{"Line":0}},{"line":236,"address":[5293823],"length":1,"stats":{"Line":0}},{"line":238,"address":[5293918,5294010],"length":1,"stats":{"Line":0}},{"line":240,"address":[5278960,5279135,5279077,5279141],"length":1,"stats":{"Line":0}},{"line":241,"address":[5278997],"length":1,"stats":{"Line":0}},{"line":242,"address":[5279031],"length":1,"stats":{"Line":0}},{"line":250,"address":[5294350,5294283],"length":1,"stats":{"Line":0}},{"line":253,"address":[5294834,5296807,5294921,5295019],"length":1,"stats":{"Line":0}},{"line":254,"address":[5294987],"length":1,"stats":{"Line":0}},{"line":256,"address":[5295156,5295458,5296067],"length":1,"stats":{"Line":0}},{"line":257,"address":[5295243],"length":1,"stats":{"Line":0}},{"line":258,"address":[5295385,5295317],"length":1,"stats":{"Line":0}},{"line":259,"address":[5295609],"length":1,"stats":{"Line":0}},{"line":261,"address":[5295468,5295566],"length":1,"stats":{"Line":0}},{"line":264,"address":[5295410],"length":1,"stats":{"Line":0}},{"line":267,"address":[5295871,5296734,5295258],"length":1,"stats":{"Line":0}},{"line":270,"address":[5295485,5296129],"length":1,"stats":{"Line":0}},{"line":272,"address":[5296330],"length":1,"stats":{"Line":0}},{"line":278,"address":[5296477],"length":1,"stats":{"Line":0}},{"line":281,"address":[5297456],"length":1,"stats":{"Line":0}},{"line":291,"address":[5279516],"length":1,"stats":{"Line":0}},{"line":293,"address":[5279569],"length":1,"stats":{"Line":0}},{"line":295,"address":[5279603,5280213,5279791,5279872,5280133,5279954],"length":1,"stats":{"Line":0}},{"line":296,"address":[5280277],"length":1,"stats":{"Line":0}}],"covered":21,"coverable":99},{"path":["/","home","vidyootsenthil","TheValut-nameTBD","experiments","cli","src","rpc_client.rs"],"content":"use node::grpc::grpc_handler::node_proto::{\n    self, node_control_client::NodeControlClient, CreateDepositIntentResponse,\n    SendDirectMessageResponse, SpendFundsResponse, StartSigningResponse,\n};\nuse tonic::Status;\n\npub async fn rpc_spend(\n    endpoint: Option\u003cString\u003e,\n    amount: u64,\n) -\u003e Result\u003cSpendFundsResponse, Status\u003e {\n    println!(\"Spending {} satoshis\", amount);\n\n    let mut client =\n        NodeControlClient::connect(endpoint.unwrap_or(\"http://[::1]:50051\".to_string()))\n            .await\n            .expect(\"Failed to connect\");\n\n    let spendfunds_response = client\n        .spend_funds(tonic::Request::new(node_proto::SpendFundsRequest {\n            amount_satoshis: amount,\n        }))\n        .await?;\n\n    println!(\"Spent {:?} satoshis\", spendfunds_response);\n\n    Ok(spendfunds_response.into_inner())\n}\n\npub async fn rpc_start_signing(\n    endpoint: Option\u003cString\u003e,\n    hex_message: String,\n) -\u003e Result\u003cStartSigningResponse, Status\u003e {\n    println!(\"Starting signing session for message: {}\", hex_message);\n\n    let mut client =\n        NodeControlClient::connect(endpoint.unwrap_or(\"http://[::1]:50051\".to_string()))\n            .await\n            .expect(\"Failed to connect\");\n\n    let start_signing_response = client\n        .start_signing(tonic::Request::new(node_proto::StartSigningRequest {\n            hex_message,\n        }))\n        .await?;\n\n    Ok(start_signing_response.into_inner())\n}\n\npub async fn rpc_send_direct_message(\n    endpoint: Option\u003cString\u003e,\n    peer_id: String,\n    message: String,\n) -\u003e Result\u003cSendDirectMessageResponse, Status\u003e {\n    println!(\"Sending direct message to {}: {}\", peer_id, message);\n\n    let mut client =\n        NodeControlClient::connect(endpoint.unwrap_or(\"http://[::1]:50051\".to_string()))\n            .await\n            .expect(\"Failed to connect\");\n\n    let send_direct_message_response = client\n        .send_direct_message(tonic::Request::new(node_proto::SendDirectMessageRequest {\n            peer_id,\n            message,\n        }))\n        .await?;\n\n    Ok(send_direct_message_response.into_inner())\n}\n\npub async fn rpc_create_deposit_intent(\n    endpoint: Option\u003cString\u003e,\n    peer_id: String,\n    amount: u64,\n) -\u003e Result\u003cCreateDepositIntentResponse, Status\u003e {\n    println!(\"Creating deposit intent for user {}: {}\", peer_id, amount);\n\n    let mut client =\n        NodeControlClient::connect(endpoint.unwrap_or(\"http://[::1]:50051\".to_string()))\n            .await\n            .expect(\"Failed to connect\");\n\n    let create_deposit_intent_response = client\n        .create_deposit_intent(tonic::Request::new(\n            node_proto::CreateDepositIntentRequest {\n                user_id: peer_id,\n                amount_satoshis: amount,\n            },\n        ))\n        .await?;\n\n    Ok(create_deposit_intent_response.into_inner())\n}\n","traces":[{"line":7,"address":[5286176],"length":1,"stats":{"Line":0}},{"line":11,"address":[5652587,5652715],"length":1,"stats":{"Line":0}},{"line":13,"address":[5652861,5653270,5652784,5653047,5652999,5653288],"length":1,"stats":{"Line":0}},{"line":15,"address":[5583161],"length":1,"stats":{"Line":0}},{"line":18,"address":[5653720,5653795,5653437,5653331,5653683,5653467],"length":1,"stats":{"Line":0}},{"line":19,"address":[5653360],"length":1,"stats":{"Line":0}},{"line":20,"address":[5653348],"length":1,"stats":{"Line":0}},{"line":22,"address":[5653685,5653521,5653497,5653788,5653460,5652660],"length":1,"stats":{"Line":0}},{"line":24,"address":[5653964,5653916],"length":1,"stats":{"Line":0}},{"line":26,"address":[5654033],"length":1,"stats":{"Line":0}},{"line":29,"address":[5286224],"length":1,"stats":{"Line":0}},{"line":33,"address":[5654693,5654565],"length":1,"stats":{"Line":0}},{"line":35,"address":[5654762,5655266,5654977,5655248,5654839,5655025],"length":1,"stats":{"Line":0}},{"line":37,"address":[5583693],"length":1,"stats":{"Line":0}},{"line":40,"address":[5655730,5655767,5655309,5655484,5655514,5655842],"length":1,"stats":{"Line":0}},{"line":41,"address":[5655359],"length":1,"stats":{"Line":0}},{"line":42,"address":[5655326],"length":1,"stats":{"Line":0}},{"line":44,"address":[5583708],"length":1,"stats":{"Line":0}},{"line":46,"address":[5656047,5655963],"length":1,"stats":{"Line":0}},{"line":49,"address":[5286288],"length":1,"stats":{"Line":0}},{"line":54,"address":[5656604,5656732],"length":1,"stats":{"Line":0}},{"line":56,"address":[5657352,5656845,5657111,5657060,5656922,5657334],"length":1,"stats":{"Line":0}},{"line":58,"address":[5584269],"length":1,"stats":{"Line":0}},{"line":61,"address":[5657923,5657670,5657395,5657998,5657886,5657640],"length":1,"stats":{"Line":0}},{"line":62,"address":[5657483],"length":1,"stats":{"Line":0}},{"line":63,"address":[5657412],"length":1,"stats":{"Line":0}},{"line":64,"address":[5657445],"length":1,"stats":{"Line":0}},{"line":66,"address":[5584287],"length":1,"stats":{"Line":0}},{"line":68,"address":[5658203,5658119],"length":1,"stats":{"Line":0}},{"line":71,"address":[5286368],"length":1,"stats":{"Line":0}},{"line":76,"address":[5658786,5658914],"length":1,"stats":{"Line":0}},{"line":78,"address":[5659104,5659531,5659290,5659513,5659242,5659027],"length":1,"stats":{"Line":0}},{"line":80,"address":[5584893],"length":1,"stats":{"Line":0}},{"line":83,"address":[5660049,5660012,5659766,5660124,5659574,5659796],"length":1,"stats":{"Line":0}},{"line":84,"address":[5659689],"length":1,"stats":{"Line":0}},{"line":85,"address":[5659633],"length":1,"stats":{"Line":0}},{"line":86,"address":[5659591],"length":1,"stats":{"Line":0}},{"line":87,"address":[5659624],"length":1,"stats":{"Line":0}},{"line":90,"address":[5584908],"length":1,"stats":{"Line":0}},{"line":92,"address":[5660245,5660329],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":40},{"path":["/","home","vidyootsenthil","TheValut-nameTBD","experiments","cli","src","tests.rs"],"content":"use super::*;\nuse assert_matches::assert_matches;\nuse std::fs;\nuse tempfile::tempdir;\n\n// Helper function to decrypt private key\nfn decrypt_private_key(\n    encrypted_key: \u0026str,\n    password: \u0026str,\n    params: \u0026EncryptionParams,\n) -\u003e Result\u003cVec\u003cu8\u003e, KeygenError\u003e {\n    let salt = SaltString::from_b64(\u0026params.salt_b64)\n        .map_err(|e| KeygenError::Encryption(e.to_string()))?;\n    let key = generate_key(password, \u0026salt)?;\n\n    let nonce_bytes = BASE64\n        .decode(\u0026params.iv_b64)\n        .map_err(|e| KeygenError::Encryption(e.to_string()))?;\n    let nonce = Nonce::from_slice(\u0026nonce_bytes);\n\n    let cipher = Aes256Gcm::new(Key::\u003cAes256Gcm\u003e::from_slice(\u0026key));\n\n    let ciphertext = BASE64\n        .decode(encrypted_key)\n        .map_err(|e| KeygenError::Encryption(e.to_string()))?;\n\n    cipher\n        .decrypt(nonce, ciphertext.as_ref())\n        .map_err(|e| KeygenError::Encryption(e.to_string()))\n}\n\n// Test helper to generate keypair without password prompt\nfn generate_test_keypair(output_path: Option\u003cPathBuf\u003e, password: \u0026str) -\u003e Result\u003c(), KeygenError\u003e {\n    let keypair = Keypair::generate_ed25519();\n    let public_key = keypair.public().encode_protobuf();\n    let public_key_b58 = bs58::encode(public_key).into_string();\n\n    let (encrypted_private_key, encryption_params) = encrypt_private_key(\u0026keypair, password)?;\n\n    let key_data = KeyData {\n        public_key_b58: public_key_b58.clone(),\n        encrypted_private_key_b64: encrypted_private_key,\n        encryption_params,\n    };\n\n    let json = serde_json::to_string_pretty(\u0026key_data)\n        .map_err(|e| KeygenError::Io(std::io::Error::other(e)))?;\n\n    let key_file_path = if let Some(path) = output_path {\n        if path.is_dir() {\n            path.join(\"config.json\")\n        } else {\n            path\n        }\n    } else {\n        get_key_file_path()?\n    };\n\n    fs::write(\u0026key_file_path, json).map_err(KeygenError::Io)?;\n    Ok(())\n}\n\n#[test]\nfn test_key_generation_and_encryption() {\n    let keypair = Keypair::generate_ed25519();\n    let password = \"test_password123\";\n\n    let (encrypted_key, params) = encrypt_private_key(\u0026keypair, password).unwrap();\n\n    assert_eq!(params.kdf, \"argon2id\");\n    assert!(!params.salt_b64.is_empty());\n    assert!(!params.iv_b64.is_empty());\n    assert!(!encrypted_key.is_empty());\n\n    // Verify we can decrypt with correct password\n    let decrypted = decrypt_private_key(\u0026encrypted_key, password, \u0026params).unwrap();\n    let original = keypair.to_protobuf_encoding().unwrap();\n    assert_eq!(decrypted, original);\n}\n\n#[test]\nfn test_decryption_with_wrong_password() {\n    let keypair = Keypair::generate_ed25519();\n    let password = \"correct_password\";\n    let wrong_password = \"wrong_password\";\n\n    let (encrypted_key, params) = encrypt_private_key(\u0026keypair, password).unwrap();\n\n    // Attempt decryption with wrong password should fail\n    let result = decrypt_private_key(\u0026encrypted_key, wrong_password, \u0026params);\n    assert!(result.is_err());\n}\n\n#[test]\nfn test_key_file_operations() {\n    let temp_dir = tempdir().unwrap();\n    let output_path = temp_dir.path().join(\"test_config.json\");\n\n    // Test key generation and file writing\n    let result = generate_test_keypair(Some(output_path.clone()), \"test_password123\");\n    assert!(result.is_ok());\n\n    // Verify file exists and contains valid JSON\n    let contents = fs::read_to_string(\u0026output_path).unwrap();\n    let key_data: KeyData = serde_json::from_str(\u0026contents).unwrap();\n\n    assert!(!key_data.public_key_b58.is_empty());\n    assert!(!key_data.encrypted_private_key_b64.is_empty());\n    assert_eq!(key_data.encryption_params.kdf, \"argon2id\");\n}\n\n#[test]\nfn test_invalid_directory() {\n    // Test with a non-existent directory\n    let result = generate_test_keypair(\n        Some(PathBuf::from(\"/nonexistent/path/config.json\")),\n        \"test_password123\",\n    );\n    assert_matches!(result, Err(KeygenError::Io(_)));\n}\n\n#[test]\nfn test_key_encoding() {\n    let keypair = Keypair::generate_ed25519();\n    let public_key = keypair.public().encode_protobuf();\n    let public_key_b58 = bs58::encode(public_key).into_string();\n\n    // Verify the public key is properly encoded\n    assert!(!public_key_b58.is_empty());\n    assert!(bs58::decode(\u0026public_key_b58).into_vec().is_ok());\n}\n\n#[test]\nfn test_encryption_params_serialization() {\n    let params = EncryptionParams {\n        kdf: \"argon2id\".to_string(),\n        salt_b64: \"test_salt\".to_string(),\n        iv_b64: \"test_iv\".to_string(),\n    };\n\n    let json = serde_json::to_string(\u0026params).unwrap();\n    let deserialized: EncryptionParams = serde_json::from_str(\u0026json).unwrap();\n\n    assert_eq!(params.kdf, deserialized.kdf);\n    assert_eq!(params.salt_b64, deserialized.salt_b64);\n    assert_eq!(params.iv_b64, deserialized.iv_b64);\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","vidyootsenthil","TheValut-nameTBD","node","build.rs"],"content":"fn main() -\u003e Result\u003c(), Box\u003cdyn std::error::Error\u003e\u003e {\n    tonic_build::compile_protos(\"proto/node.proto\")?;\n    Ok(())\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","vidyootsenthil","TheValut-nameTBD","node","src","db.rs"],"content":"use rocksdb::DB;\n\nuse crate::{\n    errors::NodeError,\n    protocol::{\n        block::{Block, BlockHash},\n        chain_state::ChainState,\n    },\n};\n\npub struct Db {\n    pub db: DB,\n}\n\nimpl Db {\n    pub fn new(path: \u0026str) -\u003e Self {\n        let db = DB::open_default(path).unwrap();\n        Self { db }\n    }\n\n    pub fn get_value(\u0026self, key: \u0026str) -\u003e Option\u003cString\u003e {\n        let value = self.db.get(key).unwrap();\n        value.map(|v| String::from_utf8(v).unwrap())\n    }\n\n    pub fn set_value(\u0026self, key: \u0026str, value: \u0026str) {\n        self.db.put(key, value).unwrap();\n    }\n\n    pub fn get_block_by_height(\u0026self, height: u64) -\u003e Result\u003cOption\u003cBlock\u003e, NodeError\u003e {\n        let block_hash = self.db.get(format!(\"h:{}\", height))?;\n        if let Some(block_hash) = block_hash {\n            let block = self.db.get(format!(\"b:{}\", hex::encode(block_hash)))?;\n            Ok(block.and_then(|b| Block::deserialize(\u0026b).ok()))\n        } else {\n            Ok(None)\n        }\n    }\n\n    pub fn get_block_by_hash(\u0026self, hash: BlockHash) -\u003e Result\u003cOption\u003cBlock\u003e, NodeError\u003e {\n        let block = self.db.get(format!(\"b:{}\", hex::encode(hash)))?;\n        Ok(block.and_then(|b| Block::deserialize(\u0026b).ok()))\n    }\n\n    pub fn get_tip_block_hash(\u0026self) -\u003e Result\u003cOption\u003cBlockHash\u003e, NodeError\u003e {\n        let tip = self.db.get(\"h:tip\")?;\n        Ok(tip.and_then(|b| b.as_slice().try_into().ok()))\n    }\n\n    pub fn insert_chain_state(\u0026self, chain_state: ChainState) -\u003e Result\u003c(), NodeError\u003e {\n        self.db.put(\"c:state\", chain_state.serialize()?)?;\n        Ok(())\n    }\n\n    pub fn get_chain_state(\u0026self) -\u003e Result\u003cOption\u003cChainState\u003e, NodeError\u003e {\n        let chain_state = self.db.get(\"c:state\")?;\n        Ok(chain_state.and_then(|b| ChainState::deserialize(\u0026b).ok()))\n    }\n\n    pub fn insert_block(\u0026self, block: Block) -\u003e Result\u003c(), NodeError\u003e {\n        let block_hash = block.hash();\n        self.db\n            .put(format!(\"b:{}\", hex::encode(block_hash)), block.serialize()?)\n            .map_err(|e| NodeError::Error(format!(\"Failed to insert block: {}\", e)))?;\n\n        self.db\n            .put(format!(\"h:{}\", block.header.height), block_hash)\n            .map_err(|e| NodeError::Error(format!(\"Failed to insert block: {}\", e)))?;\n\n        self.db.put(\"h:tip\", block_hash)?;\n\n        Ok(())\n    }\n}\n","traces":[{"line":16,"address":[5069712],"length":1,"stats":{"Line":0}},{"line":17,"address":[5069745],"length":1,"stats":{"Line":0}},{"line":21,"address":[5069824],"length":1,"stats":{"Line":0}},{"line":22,"address":[5069853],"length":1,"stats":{"Line":0}},{"line":23,"address":[8391406,8391392],"length":1,"stats":{"Line":0}},{"line":26,"address":[5069920],"length":1,"stats":{"Line":0}},{"line":27,"address":[5069964],"length":1,"stats":{"Line":0}},{"line":30,"address":[5071263,5071229,5070000],"length":1,"stats":{"Line":0}},{"line":31,"address":[5070035],"length":1,"stats":{"Line":0}},{"line":32,"address":[5070378,5070510],"length":1,"stats":{"Line":0}},{"line":33,"address":[5070462,5070578],"length":1,"stats":{"Line":0}},{"line":34,"address":[8391456,8391484],"length":1,"stats":{"Line":0}},{"line":36,"address":[5070474],"length":1,"stats":{"Line":0}},{"line":40,"address":[11878672,11879386,11879357],"length":1,"stats":{"Line":0}},{"line":41,"address":[5071823,5071373],"length":1,"stats":{"Line":0}},{"line":42,"address":[11879218,11879318],"length":1,"stats":{"Line":0}},{"line":45,"address":[5072413,5072442,5072064],"length":1,"stats":{"Line":0}},{"line":46,"address":[5072208,5072088],"length":1,"stats":{"Line":0}},{"line":47,"address":[11879698,11879599],"length":1,"stats":{"Line":0}},{"line":50,"address":[5072448,5072843],"length":1,"stats":{"Line":0}},{"line":51,"address":[5072828,5072547,5072494,5072841],"length":1,"stats":{"Line":0}},{"line":52,"address":[11880169],"length":1,"stats":{"Line":0}},{"line":55,"address":[11880629,11880600,11880240],"length":1,"stats":{"Line":0}},{"line":56,"address":[5073008,5072888],"length":1,"stats":{"Line":0}},{"line":57,"address":[5073068,5073163],"length":1,"stats":{"Line":0}},{"line":60,"address":[5074719,5073264],"length":1,"stats":{"Line":0}},{"line":61,"address":[11880681],"length":1,"stats":{"Line":0}},{"line":62,"address":[11881479,11881372,11882112,11881283],"length":1,"stats":{"Line":0}},{"line":63,"address":[5073361,5073919,5074668],"length":1,"stats":{"Line":0}},{"line":64,"address":[11881453],"length":1,"stats":{"Line":0}},{"line":66,"address":[5074401,5074664,5074224],"length":1,"stats":{"Line":0}},{"line":67,"address":[5074096],"length":1,"stats":{"Line":0}},{"line":68,"address":[5074369],"length":1,"stats":{"Line":0}},{"line":70,"address":[5074651,5074431],"length":1,"stats":{"Line":0}},{"line":72,"address":[5074620],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":35},{"path":["/","home","vidyootsenthil","TheValut-nameTBD","node","src","dkg","mod.rs"],"content":"use std::collections::{BTreeMap, HashSet};\nuse tracing::{debug, error, info, warn};\n\nuse crate::{\n    errors::NodeError,\n    peer_id_to_identifier,\n    swarm_manager::{NetworkHandle, PrivateRequest, PrivateResponse},\n};\nuse frost_secp256k1::{\n    self as frost, Identifier,\n    keys::dkg::{round1, round2},\n};\nuse libp2p::PeerId;\n\npub mod utils;\n\npub struct DkgState {\n    pub dkg_started: bool,\n    pub network_handle: NetworkHandle,\n    pub min_signers: u16,\n    pub max_signers: u16,\n    pub rng: frost::rand_core::OsRng,\n    pub peer_id: PeerId,\n    pub peers: HashSet\u003cPeerId\u003e,\n\n    pub peers_to_names: BTreeMap\u003cPeerId, String\u003e,\n    pub dkg_listeners: HashSet\u003cPeerId\u003e,\n\n    pub config_file: String,\n\n    pub start_dkg_topic: libp2p::gossipsub::IdentTopic,\n    pub round1_topic: libp2p::gossipsub::IdentTopic,\n\n    pub round1_peer_packages: BTreeMap\u003cIdentifier, round1::Package\u003e,\n    pub round2_peer_packages: BTreeMap\u003cIdentifier, round2::Package\u003e,\n\n    pub r1_secret_package: Option\u003cround1::SecretPackage\u003e,\n    pub r2_secret_package: Option\u003cround2::SecretPackage\u003e,\n\n    pub pubkey_package: Option\u003cfrost::keys::PublicKeyPackage\u003e,\n    pub private_key_package: Option\u003cfrost::keys::KeyPackage\u003e,\n}\n\nimpl DkgState {\n    pub fn handle_dkg_start(\u0026mut self) -\u003e Result\u003c(), NodeError\u003e {\n        if self.dkg_started {\n            debug!(\"DKG already started, skipping DKG process\");\n            return Ok(());\n        }\n\n        // Check if DKG keys already exist\n        if self.private_key_package.is_some() \u0026\u0026 self.pubkey_package.is_some() {\n            info!(\"DKG keys already exist, skipping DKG process\");\n            if let Some(pubkey) = \u0026self.pubkey_package {\n                info!(\"Existing public key: {:?}\", pubkey.verifying_key());\n            }\n            return Ok(());\n        }\n\n        if self.dkg_listeners.len() + 1 != self.max_signers as usize {\n            debug!(\n                \"Not all listeners have subscribed to the DKG topic, not starting DKG process. Listeners: {:?}\",\n                self.dkg_listeners.len()\n            );\n            return Ok(());\n        }\n\n        self.dkg_started = true;\n\n        // Run the DKG initialization code\n        let participant_identifier = peer_id_to_identifier(\u0026self.peer_id);\n\n        let (round1_secret_package, round1_package) = frost::keys::dkg::part1(\n            participant_identifier,\n            self.max_signers,\n            self.min_signers,\n            self.rng,\n        )\n        .expect(\"Failed to generate round1 package\");\n\n        self.r1_secret_package = Some(round1_secret_package);\n\n        let round1_package_bytes = round1_package\n            .serialize()\n            .expect(\"Failed to serialize round1 package\");\n\n        // Broadcast START_DKG message to the network,\n        let start_message = format!(\"START_DKG:{}\", self.peer_id);\n\n        match self.network_handle.send_broadcast(\n            self.start_dkg_topic.clone(),\n            start_message.as_bytes().to_vec(),\n        ) {\n            Ok(_) =\u003e (),\n            Err(e) =\u003e {\n                return Err(NodeError::Error(format!(\n                    \"Failed to send broadcast: {:?}\",\n                    e\n                )));\n            }\n        }\n\n        match self\n            .network_handle\n            .send_broadcast(self.round1_topic.clone(), round1_package_bytes)\n        {\n            Ok(_) =\u003e (),\n            Err(e) =\u003e {\n                return Err(NodeError::Error(format!(\n                    \"Failed to send broadcast: {:?}\",\n                    e\n                )));\n            }\n        }\n\n        match self.try_enter_round2() {\n            Ok(_) =\u003e {\n                info!(\n                    \"Generated and published round1 package in response to DKG start signal from {}\",\n                    \u0026self.peer_id\n                );\n                Ok(())\n            }\n            Err(e) =\u003e Err(NodeError::Error(format!(\"Failed to enter round2: {}\", e))),\n        }\n    }\n\n    pub fn handle_round1_payload(\n        \u0026mut self,\n        sender_peer_id: PeerId,\n        package: Vec\u003cu8\u003e,\n    ) -\u003e Result\u003c(), NodeError\u003e {\n        let identifier = peer_id_to_identifier(\u0026sender_peer_id);\n        let package = match frost::keys::dkg::round1::Package::deserialize(\u0026package) {\n            Ok(package) =\u003e package,\n            Err(e) =\u003e {\n                return Err(NodeError::Error(format!(\n                    \"Failed to deserialize round1 package: {}\",\n                    e\n                )));\n            }\n        };\n        // Add package to peer packages\n        self.round1_peer_packages.insert(identifier, package);\n\n        debug!(\n            \"Received round1 package from {} ({}/{})\",\n            sender_peer_id,\n            self.round1_peer_packages.len(),\n            self.max_signers - 1\n        );\n\n        self.try_enter_round2()?;\n\n        Ok(())\n    }\n\n    pub fn try_enter_round2(\u0026mut self) -\u003e Result\u003c(), NodeError\u003e {\n        if let Some(r1_secret_package) = self.r1_secret_package.as_ref() {\n            if self.round1_peer_packages.len() + 1 == self.max_signers as usize {\n                info!(\"Received all round1 packages, entering part2\");\n                // all packages received\n                let part2_result =\n                    frost::keys::dkg::part2(r1_secret_package.clone(), \u0026self.round1_peer_packages);\n                match part2_result {\n                    Ok((round2_secret_package, round2_packages)) =\u003e {\n                        info!(\"-------------------- ENTERING ROUND 2 ---------------------\");\n                        self.r1_secret_package = None;\n                        self.r2_secret_package = Some(round2_secret_package);\n\n                        for peer_to_send_to in self.peers.iter() {\n                            let identifier = peer_id_to_identifier(peer_to_send_to);\n                            let package_to_send = match round2_packages.get(\u0026identifier) {\n                                Some(package) =\u003e package,\n                                None =\u003e {\n                                    warn!(\"Round2 package not found for {}\", peer_to_send_to);\n                                    return Err(NodeError::Error(format!(\n                                        \"Round2 package not found for {}\",\n                                        peer_to_send_to\n                                    )));\n                                }\n                            };\n\n                            let request = PrivateRequest::Round2Package(package_to_send.clone());\n\n                            match self\n                                .network_handle\n                                .send_private_request(*peer_to_send_to, request)\n                            {\n                                Ok(_) =\u003e (),\n                                Err(e) =\u003e {\n                                    error!(\"Round2 package not found for {}\", peer_to_send_to);\n                                    return Err(NodeError::Error(format!(\n                                        \"Failed to send private request: {:?}\",\n                                        e\n                                    )));\n                                }\n                            }\n\n                            debug!(\"Sent round2 package to {}\", peer_to_send_to);\n                        }\n                    }\n                    Err(e) =\u003e {\n                        return Err(NodeError::Error(format!(\"DKG round2 failed: {}\", e)));\n                    }\n                }\n            }\n        }\n\n        Ok(())\n    }\n\n    pub fn handle_round2_payload(\n        \u0026mut self,\n        sender_peer_id: PeerId,\n        package: round2::Package,\n        response_channel: libp2p::request_response::ResponseChannel\u003cPrivateResponse\u003e,\n    ) -\u003e Result\u003c(), NodeError\u003e {\n        let identifier = peer_id_to_identifier(\u0026sender_peer_id);\n\n        match self\n            .network_handle\n            .send_private_response(response_channel, PrivateResponse::Pong)\n        {\n            Ok(_) =\u003e (),\n            Err(e) =\u003e {\n                return Err(NodeError::Error(format!(\n                    \"Failed to send private response: {:?}\",\n                    e\n                )));\n            }\n        }\n\n        // Add package to peer packages\n        self.round2_peer_packages.insert(identifier, package);\n\n        debug!(\n            \"Received round2 package from {} ({}/{})\",\n            sender_peer_id,\n            self.round2_peer_packages.len(),\n            self.max_signers - 1\n        );\n\n        if let Some(r2_secret_package) = self.r2_secret_package.as_ref() {\n            if self.round2_peer_packages.len() + 1 == self.max_signers as usize {\n                info!(\"Received all round2 packages, entering part3\");\n                let part3_result = frost::keys::dkg::part3(\n                    \u0026r2_secret_package.clone(),\n                    \u0026self.round1_peer_packages,\n                    \u0026self.round2_peer_packages,\n                );\n\n                match part3_result {\n                    Ok((private_key_package, pubkey_package)) =\u003e {\n                        info!(\n                            \" DKG finished successfully. Public key: {:?}\",\n                            pubkey_package.verifying_key()\n                        );\n\n                        self.private_key_package = Some(private_key_package);\n                        self.pubkey_package = Some(pubkey_package);\n\n                        if let Err(e) = self.save_dkg_keys() {\n                            error!(\"Failed to save DKG keys: {}\", e);\n                        } else {\n                            info!(\"DKG keys saved to config file\");\n                        }\n\n                        self.dkg_started = false;\n                    }\n                    Err(e) =\u003e {\n                        error!(\"DKG failed during part3 aggregation: {}\", e);\n                        // Reset state so that a fresh DKG can be attempted again later\n                        self.reset_dkg_state();\n                    }\n                }\n            }\n        }\n\n        Ok(())\n    }\n\n    /// Reset DKG state after a failed run so that a new DKG round can be initiated.\n    fn reset_dkg_state(\u0026mut self) {\n        self.dkg_started = false;\n        self.r1_secret_package = None;\n        self.r2_secret_package = None;\n        self.round1_peer_packages.clear();\n        self.round2_peer_packages.clear();\n    }\n}\n","traces":[{"line":45,"address":[12399920,12402991,12403587],"length":1,"stats":{"Line":0}},{"line":46,"address":[8339415],"length":1,"stats":{"Line":0}},{"line":47,"address":[8339474,8344848,8345023],"length":1,"stats":{"Line":0}},{"line":48,"address":[8345005],"length":1,"stats":{"Line":0}},{"line":52,"address":[8339456,8339554],"length":1,"stats":{"Line":0}},{"line":53,"address":[8343612,8343818,8339572],"length":1,"stats":{"Line":0}},{"line":54,"address":[8344192,8343769],"length":1,"stats":{"Line":0}},{"line":55,"address":[8344200,8344251],"length":1,"stats":{"Line":0}},{"line":57,"address":[12404875],"length":1,"stats":{"Line":0}},{"line":60,"address":[8339620,8339514],"length":1,"stats":{"Line":0}},{"line":61,"address":[8343283],"length":1,"stats":{"Line":0}},{"line":65,"address":[8343134],"length":1,"stats":{"Line":0}},{"line":68,"address":[8339659],"length":1,"stats":{"Line":0}},{"line":71,"address":[8339666],"length":1,"stats":{"Line":0}},{"line":81,"address":[12400508,12400763],"length":1,"stats":{"Line":0}},{"line":83,"address":[8340399,8340352],"length":1,"stats":{"Line":0}},{"line":88,"address":[8340457,8340524],"length":1,"stats":{"Line":0}},{"line":90,"address":[8340879,8340632,8340832],"length":1,"stats":{"Line":0}},{"line":91,"address":[8340712,8340649],"length":1,"stats":{"Line":0}},{"line":92,"address":[8340805,8340728],"length":1,"stats":{"Line":0}},{"line":95,"address":[8340916],"length":1,"stats":{"Line":0}},{"line":96,"address":[8340964,8342659],"length":1,"stats":{"Line":0}},{"line":103,"address":[8340982,8341084],"length":1,"stats":{"Line":0}},{"line":105,"address":[8340996],"length":1,"stats":{"Line":0}},{"line":108,"address":[8341128],"length":1,"stats":{"Line":0}},{"line":109,"address":[8342419,8341176],"length":1,"stats":{"Line":0}},{"line":116,"address":[8341202],"length":1,"stats":{"Line":0}},{"line":118,"address":[8341582,8341765,8341304],"length":1,"stats":{"Line":0}},{"line":122,"address":[8341564],"length":1,"stats":{"Line":0}},{"line":124,"address":[8342072,8341246],"length":1,"stats":{"Line":0}},{"line":128,"address":[8347107,8347309,8345392],"length":1,"stats":{"Line":0}},{"line":133,"address":[8345458],"length":1,"stats":{"Line":0}},{"line":134,"address":[8345533],"length":1,"stats":{"Line":0}},{"line":135,"address":[8345745],"length":1,"stats":{"Line":0}},{"line":136,"address":[8345628],"length":1,"stats":{"Line":0}},{"line":137,"address":[8347113,8345692],"length":1,"stats":{"Line":0}},{"line":144,"address":[8345963,8345808],"length":1,"stats":{"Line":0}},{"line":146,"address":[8346515,8346580],"length":1,"stats":{"Line":0}},{"line":153,"address":[8347063,8346898,8346238],"length":1,"stats":{"Line":0}},{"line":155,"address":[8347020],"length":1,"stats":{"Line":0}},{"line":158,"address":[8347328,8353288,8353294],"length":1,"stats":{"Line":0}},{"line":159,"address":[8347378],"length":1,"stats":{"Line":0}},{"line":160,"address":[8347540,8347466],"length":1,"stats":{"Line":0}},{"line":161,"address":[8347567,8347847],"length":1,"stats":{"Line":0}},{"line":163,"address":[8347751],"length":1,"stats":{"Line":0}},{"line":165,"address":[8347801],"length":1,"stats":{"Line":0}},{"line":166,"address":[12409164],"length":1,"stats":{"Line":0}},{"line":167,"address":[8348609,8348993,8348688],"length":1,"stats":{"Line":0}},{"line":168,"address":[8348971,8349412],"length":1,"stats":{"Line":0}},{"line":169,"address":[8349547,8349769],"length":1,"stats":{"Line":0}},{"line":171,"address":[12410618],"length":1,"stats":{"Line":0}},{"line":172,"address":[8350088],"length":1,"stats":{"Line":0}},{"line":173,"address":[8350225],"length":1,"stats":{"Line":0}},{"line":174,"address":[8350307],"length":1,"stats":{"Line":0}},{"line":176,"address":[12411378,12411048],"length":1,"stats":{"Line":0}},{"line":177,"address":[8351133,8350641],"length":1,"stats":{"Line":0}},{"line":184,"address":[12412061,12411026],"length":1,"stats":{"Line":0}},{"line":186,"address":[8351518,8351420],"length":1,"stats":{"Line":0}},{"line":188,"address":[8351427],"length":1,"stats":{"Line":0}},{"line":191,"address":[8351562],"length":1,"stats":{"Line":0}},{"line":192,"address":[12413088,12412305,12413341],"length":1,"stats":{"Line":0}},{"line":193,"address":[8353060,8352612],"length":1,"stats":{"Line":0}},{"line":200,"address":[8351625],"length":1,"stats":{"Line":0}},{"line":203,"address":[8348222],"length":1,"stats":{"Line":0}},{"line":204,"address":[12408942],"length":1,"stats":{"Line":0}},{"line":210,"address":[8347506],"length":1,"stats":{"Line":0}},{"line":213,"address":[12418967,12420658,12414080],"length":1,"stats":{"Line":0}},{"line":219,"address":[12414169],"length":1,"stats":{"Line":0}},{"line":221,"address":[8353529,8353580],"length":1,"stats":{"Line":0}},{"line":223,"address":[8353536],"length":1,"stats":{"Line":0}},{"line":226,"address":[12414368],"length":1,"stats":{"Line":0}},{"line":227,"address":[12420473,12414400],"length":1,"stats":{"Line":0}},{"line":235,"address":[12414446],"length":1,"stats":{"Line":0}},{"line":237,"address":[8354391,8354462],"length":1,"stats":{"Line":0}},{"line":244,"address":[12415527,12414820],"length":1,"stats":{"Line":0}},{"line":245,"address":[12420372,12415598,12415658],"length":1,"stats":{"Line":0}},{"line":246,"address":[12415726,12416056],"length":1,"stats":{"Line":0}},{"line":248,"address":[8355290],"length":1,"stats":{"Line":0}},{"line":249,"address":[12416475],"length":1,"stats":{"Line":0}},{"line":250,"address":[12416485],"length":1,"stats":{"Line":0}},{"line":253,"address":[8355882],"length":1,"stats":{"Line":0}},{"line":254,"address":[8356024],"length":1,"stats":{"Line":0}},{"line":255,"address":[8356813],"length":1,"stats":{"Line":0}},{"line":260,"address":[8356466],"length":1,"stats":{"Line":0}},{"line":261,"address":[8356517,8357128],"length":1,"stats":{"Line":0}},{"line":263,"address":[8357233],"length":1,"stats":{"Line":0}},{"line":264,"address":[8357402,8357685,8357309],"length":1,"stats":{"Line":0}},{"line":266,"address":[8358177],"length":1,"stats":{"Line":0}},{"line":269,"address":[12418947],"length":1,"stats":{"Line":0}},{"line":271,"address":[8355909],"length":1,"stats":{"Line":0}},{"line":272,"address":[8359127,8355957,8358886],"length":1,"stats":{"Line":0}},{"line":274,"address":[8359559,8359117],"length":1,"stats":{"Line":0}},{"line":280,"address":[12415632],"length":1,"stats":{"Line":0}},{"line":284,"address":[8359888,8360199],"length":1,"stats":{"Line":0}},{"line":285,"address":[8359907],"length":1,"stats":{"Line":0}},{"line":286,"address":[8359944,8359924],"length":1,"stats":{"Line":0}},{"line":287,"address":[8360087,8360064],"length":1,"stats":{"Line":0}},{"line":288,"address":[8360163],"length":1,"stats":{"Line":0}},{"line":289,"address":[8360179],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":99},{"path":["/","home","vidyootsenthil","TheValut-nameTBD","node","src","dkg","utils.rs"],"content":"use std::{\n    collections::{BTreeMap, HashSet},\n    fs,\n    path::Path,\n};\n\nuse aes_gcm::{Aes256Gcm, Key, KeyInit, Nonce, aead::Aead};\nuse argon2::{Argon2, password_hash::SaltString};\nuse base64::{Engine as _, engine::general_purpose::STANDARD as BASE64};\nuse frost_secp256k1::{self as frost};\nuse libp2p::{PeerId, gossipsub};\n\nuse crate::{\n    Config, DkgKeys, EncryptionParams, KeyData, NodeError, PeerData,\n    dkg::DkgState,\n    protocol::block::{ChainConfig, GenesisBlock, ValidatorInfo},\n    swarm_manager::{NetworkHandle, PrivateRequest},\n};\n\nfn derive_key_from_password(\n    password: \u0026str,\n    salt_str: \u0026str,\n) -\u003e Result\u003cVec\u003cu8\u003e, Box\u003cdyn std::error::Error\u003e\u003e {\n    let argon2 = Argon2::default();\n    let password_bytes = password.as_bytes();\n    let salt =\n        SaltString::from_b64(salt_str).map_err(|e| format!(\"Salt decoding failed: {}\", e))?;\n\n    let mut key = vec![0u8; 32];\n    argon2\n        .hash_password_into(password_bytes, salt.as_str().as_bytes(), \u0026mut key)\n        .map_err(|e| format!(\"Argon2 key derivation failed: {}\", e))?;\n    Ok(key)\n}\n\nfn encrypt_dkg_private_key(\n    private_key_data: \u0026[u8],\n    password: \u0026str,\n    salt_b64: \u0026str,\n) -\u003e Result\u003c(String, String), Box\u003cdyn std::error::Error\u003e\u003e {\n    let key_bytes = derive_key_from_password(password, salt_b64)?;\n\n    // Generate random IV\n    let mut iv = [0u8; 12];\n    use frost::rand_core::RngCore;\n    frost::rand_core::OsRng.fill_bytes(\u0026mut iv);\n    let nonce = Nonce::from_slice(\u0026iv);\n\n    let cipher = Aes256Gcm::new(Key::\u003cAes256Gcm\u003e::from_slice(\u0026key_bytes));\n    let ciphertext = cipher\n        .encrypt(nonce, private_key_data)\n        .map_err(|e| format!(\"AES encryption failed: {}\", e))?;\n\n    let encrypted_b64 = BASE64.encode(ciphertext);\n    let iv_b64 = BASE64.encode(iv);\n\n    Ok((encrypted_b64, iv_b64))\n}\n\nfn decrypt_dkg_private_key(\n    encrypted_private_key_b64: \u0026str,\n    password: \u0026str,\n    params: \u0026EncryptionParams,\n) -\u003e Result\u003cVec\u003cu8\u003e, Box\u003cdyn std::error::Error\u003e\u003e {\n    let key_bytes = derive_key_from_password(password, \u0026params.salt_b64)?;\n\n    let iv_bytes = BASE64.decode(\u0026params.iv_b64)?;\n    let nonce = Nonce::from_slice(\u0026iv_bytes);\n\n    let ciphertext = BASE64.decode(encrypted_private_key_b64)?;\n\n    let cipher = Aes256Gcm::new(Key::\u003cAes256Gcm\u003e::from_slice(\u0026key_bytes));\n    let decrypted_private_key = cipher\n        .decrypt(nonce, ciphertext.as_ref())\n        .map_err(|e| format!(\"AES decryption failed: {}\", e))?;\n\n    Ok(decrypted_private_key)\n}\n\nfn get_password_for_dkg() -\u003e Result\u003cString, Box\u003cdyn std::error::Error\u003e\u003e {\n    match std::env::var(\"KEY_PASSWORD\") {\n        Ok(pw) =\u003e Ok(pw),\n        Err(_) =\u003e {\n            use std::io::{self, Write};\n            print!(\"Enter password to encrypt/decrypt DKG keys: \");\n            io::stdout().flush()?;\n            let password = rpassword::read_password()?;\n            Ok(password)\n        }\n    }\n}\n\nimpl DkgState {\n    pub fn get_public_key(\u0026self) -\u003e Option\u003cfrost::keys::PublicKeyPackage\u003e {\n        self.pubkey_package.clone()\n    }\n\n    pub fn get_private_key(\u0026self) -\u003e Option\u003cfrost::keys::KeyPackage\u003e {\n        self.private_key_package.clone()\n    }\n}\n\nimpl DkgState {\n    pub fn new(\n        network_handle: NetworkHandle,\n        min_signers: u16,\n        max_signers: u16,\n        peer_id: PeerId,\n        peers_to_names: BTreeMap\u003cPeerId, String\u003e,\n        config_file: String,\n    ) -\u003e Result\u003cSelf, NodeError\u003e {\n        let mut dkg_state = DkgState {\n            network_handle,\n            min_signers,\n            max_signers,\n            rng: frost::rand_core::OsRng,\n            peer_id,\n            peers_to_names,\n            dkg_listeners: HashSet::new(),\n            config_file,\n            start_dkg_topic: gossipsub::IdentTopic::new(\"start-dkg\"),\n            round1_topic: gossipsub::IdentTopic::new(\"round1_topic\"),\n            round1_peer_packages: BTreeMap::new(),\n            round2_peer_packages: BTreeMap::new(),\n            r1_secret_package: None,\n            r2_secret_package: None,\n            pubkey_package: None,\n            private_key_package: None,\n            peers: HashSet::new(),\n            dkg_started: false,\n        };\n\n        let keys = DkgState::load_dkg_keys(\u0026dkg_state.config_file)\n            .map_err(|e| NodeError::Error(format!(\"Failed to load DKG keys: {}\", e)))?;\n\n        if let Some((private_key, pubkey)) = keys {\n            dkg_state.private_key_package = Some(private_key);\n            dkg_state.pubkey_package = Some(pubkey);\n        }\n\n        Ok(dkg_state)\n    }\n\n    pub fn save_dkg_keys(\u0026self) -\u003e Result\u003c(), NodeError\u003e {\n        // Load existing config or create new one\n        let mut config = if Path::new(\u0026self.config_file).exists() {\n            let config_str = fs::read_to_string(\u0026self.config_file)\n                .map_err(|e| NodeError::Error(format!(\"Failed to read config: {}\", e)))?;\n            serde_json::from_str::\u003cConfig\u003e(\u0026config_str)\n                .map_err(|e| NodeError::Error(format!(\"Failed to deserialize config: {}\", e)))?\n        } else {\n            // For new configs, we need to create a dummy key_data\n            // This is not ideal but maintains compatibility with the structure\n            Config {\n                allowed_peers: self\n                    .peers_to_names\n                    .iter()\n                    .map(|(peer_id, name)| PeerData {\n                        name: name.clone(),\n                        public_key: peer_id.to_string(),\n                    })\n                    .collect(),\n                key_data: KeyData {\n                    public_key_b58: self.peer_id.to_string(),\n                    encrypted_private_key_b64: String::new(),\n                    encryption_params: EncryptionParams {\n                        kdf: String::new(),\n                        salt_b64: String::new(),\n                        iv_b64: String::new(),\n                    },\n                },\n                dkg_keys: None,\n                log_file_path: None,\n            }\n        };\n\n        // Update DKG keys if they exist\n        if let (Some(private_key), Some(pubkey)) = (\u0026self.private_key_package, \u0026self.pubkey_package)\n        {\n            let password = get_password_for_dkg()\n                .map_err(|e| NodeError::Error(format!(\"Failed to get password for DKG: {}\", e)))?;\n\n            // Serialize private key to bytes\n            let private_key_bytes = private_key\n                .serialize()\n                .map_err(|e| NodeError::Error(format!(\"Failed to serialize private key: {}\", e)))?;\n\n            // Use existing salt from key_data, or generate a new one if empty\n            let salt_b64 = if config.key_data.encryption_params.salt_b64.is_empty() {\n                // Generate a new salt\n                use frost::rand_core::RngCore;\n                let mut salt = [0u8; 16];\n                frost::rand_core::OsRng.fill_bytes(\u0026mut salt);\n                BASE64.encode(salt)\n            } else {\n                config.key_data.encryption_params.salt_b64.clone()\n            };\n\n            // Encrypt the private key package\n            let (encrypted_private_key_b64, iv_b64) =\n                encrypt_dkg_private_key(\u0026private_key_bytes, \u0026password, \u0026salt_b64).map_err(|e| {\n                    NodeError::Error(format!(\"Failed to encrypt private key: {}\", e))\n                })?;\n\n            // Serialize and base64 encode the public key package\n            let pubkey_bytes = pubkey\n                .serialize()\n                .map_err(|e| NodeError::Error(format!(\"Failed to serialize public key: {}\", e)))?;\n            let pubkey_package_b64 = BASE64.encode(pubkey_bytes);\n\n            config.dkg_keys = Some(DkgKeys {\n                encrypted_private_key_package_b64: encrypted_private_key_b64,\n                dkg_encryption_params: EncryptionParams {\n                    kdf: \"argon2id\".to_string(),\n                    salt_b64,\n                    iv_b64,\n                },\n                pubkey_package_b64,\n            });\n            let validators = self\n                .peers\n                .iter()\n                .map(|peer_id| ValidatorInfo {\n                    pub_key: peer_id.to_bytes(),\n                    stake: 100,\n                })\n                .collect();\n\n            let chain_config = ChainConfig {\n                block_time_seconds: 10,\n                min_signers: self.min_signers,\n                max_signers: self.max_signers,\n                min_stake: 100,\n                max_block_size: 1000,\n            };\n\n            let genesis_block = GenesisBlock::new(\n                validators,\n                chain_config,\n                pubkey.serialize().map_err(|e| {\n                    NodeError::Error(format!(\"Failed to serialize public key: {}\", e))\n                })?,\n            );\n            self.network_handle\n                .send_self_request(\n                    PrivateRequest::InsertBlock {\n                        block: genesis_block.to_block(),\n                    },\n                    false,\n                )\n                .map_err(|e| NodeError::Error(format!(\"Failed to send genesis block: {:?}\", e)))?;\n        }\n\n        // Save config\n        let config_str = serde_json::to_string_pretty(\u0026config)\n            .map_err(|e| NodeError::Error(format!(\"Failed to serialize config: {}\", e)))?;\n        fs::write(\u0026self.config_file, config_str)\n            .map_err(|e| NodeError::Error(format!(\"Failed to write config: {}\", e)))?;\n        Ok(())\n    }\n\n    pub fn load_dkg_keys(\n        config_path: \u0026str,\n    ) -\u003e Result\u003c\n        Option\u003c(frost::keys::KeyPackage, frost::keys::PublicKeyPackage)\u003e,\n        Box\u003cdyn std::error::Error\u003e,\n    \u003e {\n        if !Path::new(config_path).exists() {\n            return Ok(None);\n        }\n\n        let config_str = fs::read_to_string(config_path)?;\n        let config: Config = serde_json::from_str(\u0026config_str)?;\n\n        if let Some(dkg_keys) = config.dkg_keys {\n            let password = get_password_for_dkg()?;\n\n            // Decrypt the private key package\n            let private_key_bytes = decrypt_dkg_private_key(\n                \u0026dkg_keys.encrypted_private_key_package_b64,\n                \u0026password,\n                \u0026dkg_keys.dkg_encryption_params,\n            )?;\n\n            // Deserialize the private key from decrypted bytes\n            let private_key = frost::keys::KeyPackage::deserialize(\u0026private_key_bytes)?;\n\n            // Deserialize the public key from base64\n            let pubkey_bytes = BASE64.decode(\u0026dkg_keys.pubkey_package_b64)?;\n            let pubkey = frost::keys::PublicKeyPackage::deserialize(\u0026pubkey_bytes)?;\n\n            Ok(Some((private_key, pubkey)))\n        } else {\n            Ok(None)\n        }\n    }\n}\n","traces":[{"line":20,"address":[8291950,8291956,8290976],"length":1,"stats":{"Line":0}},{"line":24,"address":[8775064],"length":1,"stats":{"Line":0}},{"line":25,"address":[8775088],"length":1,"stats":{"Line":0}},{"line":26,"address":[8775141],"length":1,"stats":{"Line":0}},{"line":29,"address":[8775451],"length":1,"stats":{"Line":0}},{"line":30,"address":[8775664,8775816],"length":1,"stats":{"Line":0}},{"line":31,"address":[8775482,8775565],"length":1,"stats":{"Line":0}},{"line":32,"address":[8291775],"length":1,"stats":{"Line":0}},{"line":33,"address":[8775843],"length":1,"stats":{"Line":0}},{"line":36,"address":[8777178,8777242,8775984],"length":1,"stats":{"Line":0}},{"line":41,"address":[8292114],"length":1,"stats":{"Line":0}},{"line":44,"address":[8776305],"length":1,"stats":{"Line":0}},{"line":46,"address":[8776328],"length":1,"stats":{"Line":0}},{"line":47,"address":[8776414],"length":1,"stats":{"Line":0}},{"line":49,"address":[8292445],"length":1,"stats":{"Line":0}},{"line":50,"address":[8776605,8776542,8776686],"length":1,"stats":{"Line":0}},{"line":52,"address":[7051456,7051472],"length":1,"stats":{"Line":0}},{"line":54,"address":[8776783],"length":1,"stats":{"Line":0}},{"line":55,"address":[8776894],"length":1,"stats":{"Line":0}},{"line":57,"address":[8293038],"length":1,"stats":{"Line":0}},{"line":60,"address":[8778694,8778668,8777264],"length":1,"stats":{"Line":0}},{"line":65,"address":[8777354],"length":1,"stats":{"Line":0}},{"line":67,"address":[8778692,8777659,8777573],"length":1,"stats":{"Line":0}},{"line":68,"address":[8777813,8777896],"length":1,"stats":{"Line":0}},{"line":70,"address":[8778674,8777931],"length":1,"stats":{"Line":0}},{"line":72,"address":[8778210,8778127],"length":1,"stats":{"Line":0}},{"line":73,"address":[8778450,8778346],"length":1,"stats":{"Line":0}},{"line":74,"address":[8294324],"length":1,"stats":{"Line":0}},{"line":75,"address":[10044480,10044464],"length":1,"stats":{"Line":0}},{"line":77,"address":[8778512],"length":1,"stats":{"Line":0}},{"line":80,"address":[8779347,8778720,8779376],"length":1,"stats":{"Line":0}},{"line":81,"address":[8778737],"length":1,"stats":{"Line":0}},{"line":82,"address":[8294895],"length":1,"stats":{"Line":0}},{"line":85,"address":[8778771,8778914],"length":1,"stats":{"Line":0}},{"line":86,"address":[8778930,8779332],"length":1,"stats":{"Line":0}},{"line":87,"address":[8779317,8779086],"length":1,"stats":{"Line":0}},{"line":88,"address":[8779253],"length":1,"stats":{"Line":0}},{"line":94,"address":[8327136],"length":1,"stats":{"Line":0}},{"line":95,"address":[8327153],"length":1,"stats":{"Line":0}},{"line":98,"address":[8327184],"length":1,"stats":{"Line":0}},{"line":99,"address":[8327201],"length":1,"stats":{"Line":0}},{"line":104,"address":[8327232,8329406,8329982],"length":1,"stats":{"Line":0}},{"line":119,"address":[8327449],"length":1,"stats":{"Line":0}},{"line":121,"address":[8327544],"length":1,"stats":{"Line":0}},{"line":122,"address":[8327615],"length":1,"stats":{"Line":0}},{"line":123,"address":[8327687],"length":1,"stats":{"Line":0}},{"line":124,"address":[8327731],"length":1,"stats":{"Line":0}},{"line":129,"address":[8327829],"length":1,"stats":{"Line":0}},{"line":133,"address":[8328719,8328643,8328836],"length":1,"stats":{"Line":0}},{"line":134,"address":[7051712,7051751],"length":1,"stats":{"Line":0}},{"line":136,"address":[12389513,12389065],"length":1,"stats":{"Line":0}},{"line":137,"address":[8329069],"length":1,"stats":{"Line":0}},{"line":138,"address":[8329327,8329237,8329119],"length":1,"stats":{"Line":0}},{"line":141,"address":[8329139],"length":1,"stats":{"Line":0}},{"line":144,"address":[12390208,12391394,12391400],"length":1,"stats":{"Line":0}},{"line":146,"address":[12390273],"length":1,"stats":{"Line":0}},{"line":147,"address":[8331247,8330282],"length":1,"stats":{"Line":0}},{"line":148,"address":[10044870,10044848],"length":1,"stats":{"Line":0}},{"line":149,"address":[8331344,8331435,8331565],"length":1,"stats":{"Line":0}},{"line":150,"address":[8331533],"length":1,"stats":{"Line":0}},{"line":155,"address":[8330166],"length":1,"stats":{"Line":0}},{"line":163,"address":[8330768],"length":1,"stats":{"Line":0}},{"line":178,"address":[8331097,8331721,8331661],"length":1,"stats":{"Line":0}},{"line":180,"address":[12392017,12396018,12392176,12392068],"length":1,"stats":{"Line":0}},{"line":181,"address":[8331889],"length":1,"stats":{"Line":0}},{"line":184,"address":[8332023,8335606,8332174,8332090],"length":1,"stats":{"Line":0}},{"line":186,"address":[7052976,7052960],"length":1,"stats":{"Line":0}},{"line":189,"address":[12392605,12392776,12392538],"length":1,"stats":{"Line":0}},{"line":192,"address":[12392638],"length":1,"stats":{"Line":0}},{"line":193,"address":[8332374],"length":1,"stats":{"Line":0}},{"line":194,"address":[8332443],"length":1,"stats":{"Line":0}},{"line":196,"address":[12392611,12392681],"length":1,"stats":{"Line":0}},{"line":200,"address":[10046230,10046236,10046000],"length":1,"stats":{"Line":0}},{"line":202,"address":[7053207,7053159],"length":1,"stats":{"Line":0}},{"line":206,"address":[12393424,12393316,12395748,12393256],"length":1,"stats":{"Line":0}},{"line":208,"address":[12393392],"length":1,"stats":{"Line":0}},{"line":209,"address":[8333329,8333218],"length":1,"stats":{"Line":0}},{"line":211,"address":[12394270,12393979],"length":1,"stats":{"Line":0}},{"line":212,"address":[12393648],"length":1,"stats":{"Line":0}},{"line":213,"address":[8333532],"length":1,"stats":{"Line":0}},{"line":214,"address":[8333377],"length":1,"stats":{"Line":0}},{"line":215,"address":[12393763],"length":1,"stats":{"Line":0}},{"line":216,"address":[8333492],"length":1,"stats":{"Line":0}},{"line":218,"address":[12393939],"length":1,"stats":{"Line":0}},{"line":220,"address":[12394533,12394466],"length":1,"stats":{"Line":0}},{"line":223,"address":[7053536,7053623],"length":1,"stats":{"Line":0}},{"line":224,"address":[10046462],"length":1,"stats":{"Line":0}},{"line":231,"address":[12394603],"length":1,"stats":{"Line":0}},{"line":232,"address":[12394610],"length":1,"stats":{"Line":0}},{"line":238,"address":[8334346],"length":1,"stats":{"Line":0}},{"line":240,"address":[10046560],"length":1,"stats":{"Line":0}},{"line":241,"address":[7053696],"length":1,"stats":{"Line":0}},{"line":244,"address":[12395408,12395049,12395248],"length":1,"stats":{"Line":0}},{"line":246,"address":[12395136],"length":1,"stats":{"Line":0}},{"line":247,"address":[8334729],"length":1,"stats":{"Line":0}},{"line":251,"address":[10046742,10046720],"length":1,"stats":{"Line":0}},{"line":255,"address":[12396592,12391934,12396128,12396020],"length":1,"stats":{"Line":0}},{"line":256,"address":[8335696],"length":1,"stats":{"Line":0}},{"line":257,"address":[12396347,12396470,12396237,12396555],"length":1,"stats":{"Line":0}},{"line":258,"address":[12396438],"length":1,"stats":{"Line":0}},{"line":259,"address":[8336084],"length":1,"stats":{"Line":0}},{"line":262,"address":[8336192,8339348,8338749],"length":1,"stats":{"Line":0}},{"line":268,"address":[8336284],"length":1,"stats":{"Line":0}},{"line":269,"address":[12396753],"length":1,"stats":{"Line":0}},{"line":272,"address":[12396896,12396797],"length":1,"stats":{"Line":0}},{"line":273,"address":[8339343,8336564,8336655],"length":1,"stats":{"Line":0}},{"line":275,"address":[12397496,12397270],"length":1,"stats":{"Line":0}},{"line":276,"address":[12399310,12397455,12397545],"length":1,"stats":{"Line":0}},{"line":280,"address":[12397742],"length":1,"stats":{"Line":0}},{"line":281,"address":[8337378],"length":1,"stats":{"Line":0}},{"line":282,"address":[8337415],"length":1,"stats":{"Line":0}},{"line":286,"address":[8338757,8337710,8337619],"length":1,"stats":{"Line":0}},{"line":289,"address":[8337930,8338755],"length":1,"stats":{"Line":0}},{"line":290,"address":[8338224,8338133],"length":1,"stats":{"Line":0}},{"line":292,"address":[8338494],"length":1,"stats":{"Line":0}},{"line":294,"address":[8337023],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":116},{"path":["/","home","vidyootsenthil","TheValut-nameTBD","node","src","errors.rs"],"content":"use std::error::Error;\n\nuse derive_more::Display;\nuse tokio::sync::mpsc::error::SendError;\n\nuse crate::swarm_manager::NetworkMessage;\n\n#[derive(Debug, Display)]\npub enum NodeError {\n    Error(String),\n}\n\n#[derive(Debug)]\npub enum NetworkError {\n    SendError(String),\n    RecvError,\n}\n\nimpl From\u003cSendError\u003cNetworkMessage\u003e\u003e for NetworkError {\n    fn from(e: SendError\u003cNetworkMessage\u003e) -\u003e Self {\n        NetworkError::SendError(e.to_string())\n    }\n}\n\nimpl From\u003crocksdb::Error\u003e for NodeError {\n    fn from(e: rocksdb::Error) -\u003e Self {\n        NodeError::Error(e.to_string())\n    }\n}\n\nimpl Error for NodeError {}\n","traces":[{"line":20,"address":[9067726,9067616],"length":1,"stats":{"Line":0}},{"line":21,"address":[9067640,9067685],"length":1,"stats":{"Line":0}},{"line":26,"address":[9067859,9067744],"length":1,"stats":{"Line":0}},{"line":27,"address":[9067768,9067817],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":4},{"path":["/","home","vidyootsenthil","TheValut-nameTBD","node","src","grpc","grpc_handler.rs"],"content":"use crate::swarm_manager::NetworkHandle;\nuse tonic::{Request, Response, Status};\n\nuse crate::grpc::grpc_operator;\n\n// Include the generated proto code\npub mod node_proto {\n    tonic::include_proto!(\"node\");\n}\n\nuse node_proto::{\n    node_control_server::{NodeControl, NodeControlServer},\n    *,\n};\n\npub struct NodeControlService {\n    network: NetworkHandle,\n}\n\nimpl NodeControlService {\n    pub fn new(network: NetworkHandle) -\u003e Self {\n        Self { network }\n    }\n\n    pub fn into_server(self) -\u003e NodeControlServer\u003cSelf\u003e {\n        NodeControlServer::new(self)\n    }\n}\n\n#[tonic::async_trait]\nimpl NodeControl for NodeControlService {\n    async fn start_dkg(\n        \u0026self,\n        _request: Request\u003cStartDkgRequest\u003e,\n    ) -\u003e Result\u003cResponse\u003cStartDkgResponse\u003e, Status\u003e {\n        grpc_operator::start_dkg(\u0026self.network, _request).await\n    }\n\n    async fn spend_funds(\n        \u0026self,\n        request: Request\u003cSpendFundsRequest\u003e,\n    ) -\u003e Result\u003cResponse\u003cSpendFundsResponse\u003e, Status\u003e {\n        grpc_operator::spend_funds(\u0026self.network, request).await\n    }\n\n    async fn start_signing(\n        \u0026self,\n        request: Request\u003cStartSigningRequest\u003e,\n    ) -\u003e Result\u003cResponse\u003cStartSigningResponse\u003e, Status\u003e {\n        grpc_operator::start_signing(\u0026self.network, request).await\n    }\n\n    async fn send_direct_message(\n        \u0026self,\n        request: Request\u003cSendDirectMessageRequest\u003e,\n    ) -\u003e Result\u003cResponse\u003cSendDirectMessageResponse\u003e, Status\u003e {\n        grpc_operator::send_direct_message(\u0026self.network, request).await\n    }\n\n    async fn create_deposit_intent(\n        \u0026self,\n        request: Request\u003cCreateDepositIntentRequest\u003e,\n    ) -\u003e Result\u003cResponse\u003cCreateDepositIntentResponse\u003e, Status\u003e {\n        grpc_operator::create_deposit_intent(\u0026self.network, request).await\n    }\n}\n","traces":[{"line":21,"address":[8779392],"length":1,"stats":{"Line":0}},{"line":25,"address":[8779424],"length":1,"stats":{"Line":0}},{"line":26,"address":[8779432],"length":1,"stats":{"Line":0}},{"line":36,"address":[8282479,8282848,8282980],"length":1,"stats":{"Line":0}},{"line":43,"address":[8283776,8283407,8283908],"length":1,"stats":{"Line":0}},{"line":50,"address":[6252761,6252255,6252652],"length":1,"stats":{"Line":0}},{"line":57,"address":[6253514,6253183,6253623],"length":1,"stats":{"Line":0}},{"line":64,"address":[6254047,6254488,6254378],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":8},{"path":["/","home","vidyootsenthil","TheValut-nameTBD","node","src","grpc","grpc_operator.rs"],"content":"use crate::grpc::grpc_handler::node_proto::{\n    CreateDepositIntentRequest, CreateDepositIntentResponse, SendDirectMessageRequest,\n    SendDirectMessageResponse, SpendFundsRequest, SpendFundsResponse, StartDkgRequest,\n    StartDkgResponse, StartSigningRequest, StartSigningResponse,\n};\nuse crate::swarm_manager::{NetworkHandle, PingBody, PrivateRequest, PrivateResponse};\nuse libp2p::PeerId;\nuse libp2p::gossipsub::IdentTopic;\nuse tonic::{Request, Response, Status};\nuse tracing::{debug, info};\n\nuse bitcoin::Address;\nuse bitcoin::Network;\nuse bitcoin::PublicKey;\nuse bitcoin::script::Builder;\nuse std::str::FromStr;\nuse uuid::Uuid;\n\npub async fn start_dkg(\n    network: \u0026NetworkHandle,\n    _request: Request\u003cStartDkgRequest\u003e,\n) -\u003e Result\u003cResponse\u003cStartDkgResponse\u003e, Status\u003e {\n    // Create start-dkg topic\n    let start_dkg_topic = IdentTopic::new(\"start-dkg\");\n\n    // Send a message to start DKG\n    let start_message = \"START_DKG\".to_string();\n\n    match network.send_broadcast(start_dkg_topic.clone(), start_message.as_bytes().to_vec()) {\n        Ok(_) =\u003e Ok(Response::new(StartDkgResponse {\n            success: true,\n            message: \"DKG process started\".to_string(),\n        })),\n        Err(e) =\u003e Err(Status::internal(format!(\"Network error: {:?}\", e))),\n    }\n}\n\npub async fn spend_funds(\n    network: \u0026NetworkHandle,\n    request: Request\u003cSpendFundsRequest\u003e,\n) -\u003e Result\u003cResponse\u003cSpendFundsResponse\u003e, Status\u003e {\n    let amount_sat = request.into_inner().amount_satoshis;\n\n    debug!(\"Received request to spend {} satoshis\", amount_sat);\n    let response = network\n        .send_self_request(PrivateRequest::Spend { amount_sat }, true)\n        .map_err(|e| Status::internal(format!(\"Network error: {:?}\", e)))?\n        .ok_or(Status::internal(\"No response from node\"))?\n        .await\n        .map_err(|e| Status::internal(format!(\"Network error: {:?}\", e)))?;\n\n    let PrivateResponse::SpendRequestSent { sighash } = response else {\n        return Err(Status::internal(\"Invalid response from node\"));\n    };\n\n    Ok(Response::new(SpendFundsResponse {\n        success: true,\n        message: format!(\"Spending {} satoshis\", amount_sat),\n        sighash: sighash.to_string(),\n    }))\n}\n\npub async fn start_signing(\n    network: \u0026NetworkHandle,\n    request: Request\u003cStartSigningRequest\u003e,\n) -\u003e Result\u003cResponse\u003cStartSigningResponse\u003e, Status\u003e {\n    let hex_msg = request.into_inner().hex_message;\n\n    let network_request = PrivateRequest::StartSigningSession {\n        hex_message: hex_msg.clone(),\n    };\n\n    let response = network\n        .send_self_request(network_request, true)\n        .map_err(|e| Status::internal(format!(\"Network error: {:?}\", e)))?\n        .ok_or(Status::internal(\"No response from node\"))?\n        .await\n        .map_err(|e| Status::internal(format!(\"Network error: {:?}\", e)))?;\n\n    let PrivateResponse::StartSigningSession { sign_id } = response else {\n        return Err(Status::internal(format!(\n            \"Invalid response from node {:?}\",\n            response\n        )));\n    };\n\n    Ok(Response::new(StartSigningResponse {\n        success: true,\n        message: \"Signing session started\".to_string(),\n        sign_id,\n    }))\n}\n\npub async fn send_direct_message(\n    network: \u0026NetworkHandle,\n    request: Request\u003cSendDirectMessageRequest\u003e,\n) -\u003e Result\u003cResponse\u003cSendDirectMessageResponse\u003e, Status\u003e {\n    let req = request.into_inner();\n\n    let target_peer_id = req\n        .peer_id\n        .parse::\u003cPeerId\u003e()\n        .map_err(|e| Status::invalid_argument(format!(\"Invalid peer ID: {}\", e)))?;\n\n    let direct_message = format!(\"From: {}\", req.message);\n\n    match network.send_private_request(\n        target_peer_id,\n        PrivateRequest::Ping(PingBody {\n            message: direct_message,\n        }),\n    ) {\n        Ok(_) =\u003e Ok(Response::new(SendDirectMessageResponse {\n            success: true,\n            message: format!(\"Message sent to {}\", target_peer_id),\n        })),\n        Err(e) =\u003e Err(Status::internal(format!(\"Network error: {:?}\", e))),\n    }\n}\n\npub async fn create_deposit_intent(\n    network: \u0026NetworkHandle,\n    request: Request\u003cCreateDepositIntentRequest\u003e,\n) -\u003e Result\u003cResponse\u003cCreateDepositIntentResponse\u003e, Status\u003e {\n    let req = request.into_inner();\n\n    let user_id = req\n        .user_id\n        .parse::\u003cPeerId\u003e()\n        .map_err(|e| Status::invalid_argument(format!(\"Invalid peer ID: {}\", e)))?;\n\n    let amount_sat = if req.amount_satoshis \u003e 0 {\n        req.amount_satoshis\n    } else {\n        return Err(Status::invalid_argument(\n            \"Amount to deposit must be greater than 0\",\n        ));\n    };\n\n    let deposit_tracking_id = Uuid::new_v4().to_string();\n\n    let frost_pubkey_hex = network\n        .send_self_request(PrivateRequest::GetFrostPublicKey, true)\n        .map_err(|e| Status::internal(format!(\"Network error: {:?}\", e)))?\n        .ok_or(Status::internal(\"No response from node\"))?\n        .await\n        .map_err(|e| Status::internal(format!(\"Network error: {:?}\", e)))?;\n\n    let PrivateResponse::GetFrostPublicKey { public_key } = frost_pubkey_hex else {\n        return Err(Status::internal(\n            \"Invalid response from node. No public key found.\",\n        ));\n    };\n\n    let public_key = PublicKey::from_str(\u0026public_key)\n        .map_err(|e| Status::internal(format!(\"Failed to parse public key: {}\", e)))?;\n\n    let witness_script = Builder::new()\n        .push_key(\u0026public_key)\n        .push_opcode(bitcoin::opcodes::all::OP_CHECKSIG)\n        .into_script();\n\n    let deposit_address = Address::p2wsh(\u0026witness_script, Network::Testnet);\n\n    info!(\n        \"Received request to create deposit intent for user {} with amount {}. Tracking ID: {}. Deposit Address: {}\",\n        user_id,\n        amount_sat,\n        deposit_tracking_id.clone(),\n        deposit_address\n    );\n\n    Ok(Response::new(CreateDepositIntentResponse {\n        success: true,\n        message: format!(\"Deposit intent created for user {}\", user_id),\n        deposit_tracking_id,\n        deposit_address: deposit_address.to_string(),\n    }))\n}\n","traces":[{"line":19,"address":[10712192],"length":1,"stats":{"Line":0}},{"line":24,"address":[5278769],"length":1,"stats":{"Line":0}},{"line":27,"address":[5278855],"length":1,"stats":{"Line":0}},{"line":29,"address":[5279014,5278946,5279770,5278939],"length":1,"stats":{"Line":0}},{"line":30,"address":[5279306],"length":1,"stats":{"Line":0}},{"line":32,"address":[5279231],"length":1,"stats":{"Line":0}},{"line":34,"address":[9091861,9091593],"length":1,"stats":{"Line":0}},{"line":38,"address":[6793152],"length":1,"stats":{"Line":0}},{"line":42,"address":[5280192,5280076],"length":1,"stats":{"Line":0}},{"line":44,"address":[5280204,5280530],"length":1,"stats":{"Line":0}},{"line":45,"address":[9093610,9093467,9093832,9094396,9094590,9093977,9093898,9095424,9094072,9094128,9092951,9094470,9093773],"length":1,"stats":{"Line":0}},{"line":46,"address":[5280461],"length":1,"stats":{"Line":0}},{"line":47,"address":[9093563,9095440,9095462],"length":1,"stats":{"Line":0}},{"line":48,"address":[5280972,5281651,5281348,5281453,5281707,5281260,5281229],"length":1,"stats":{"Line":0}},{"line":49,"address":[7654752],"length":1,"stats":{"Line":0}},{"line":50,"address":[5283120,5283150,5282068],"length":1,"stats":{"Line":0}},{"line":52,"address":[5282163],"length":1,"stats":{"Line":0}},{"line":53,"address":[5282245,5282813],"length":1,"stats":{"Line":0}},{"line":56,"address":[5282494],"length":1,"stats":{"Line":0}},{"line":58,"address":[5282214,5282323],"length":1,"stats":{"Line":0}},{"line":59,"address":[5282423],"length":1,"stats":{"Line":0}},{"line":63,"address":[6793232],"length":1,"stats":{"Line":0}},{"line":67,"address":[5283674,5283580],"length":1,"stats":{"Line":0}},{"line":70,"address":[5283709],"length":1,"stats":{"Line":0}},{"line":73,"address":[5284430,5284188,5284032,5283864,5284816,5284243,5285501,5284733,5283922,5284346,5284476,5284914],"length":1,"stats":{"Line":0}},{"line":75,"address":[5283988,5285520,5285550],"length":1,"stats":{"Line":0}},{"line":76,"address":[5284560,5284504,5283871,5284302,5284235,5284116,5284147],"length":1,"stats":{"Line":0}},{"line":77,"address":[8692993],"length":1,"stats":{"Line":0}},{"line":78,"address":[5285774,5285744,5284907],"length":1,"stats":{"Line":0}},{"line":80,"address":[5284995],"length":1,"stats":{"Line":0}},{"line":81,"address":[5285326,5285073],"length":1,"stats":{"Line":0}},{"line":87,"address":[5285127],"length":1,"stats":{"Line":0}},{"line":89,"address":[9097670],"length":1,"stats":{"Line":0}},{"line":94,"address":[10712432],"length":1,"stats":{"Line":0}},{"line":98,"address":[5286102],"length":1,"stats":{"Line":0}},{"line":100,"address":[5286186,5286258,5286377],"length":1,"stats":{"Line":0}},{"line":103,"address":[5286371,5287662,5287632],"length":1,"stats":{"Line":0}},{"line":105,"address":[9099274],"length":1,"stats":{"Line":0}},{"line":107,"address":[5286856],"length":1,"stats":{"Line":0}},{"line":108,"address":[9099406],"length":1,"stats":{"Line":0}},{"line":109,"address":[9099486],"length":1,"stats":{"Line":0}},{"line":113,"address":[5287189],"length":1,"stats":{"Line":0}},{"line":115,"address":[9099782],"length":1,"stats":{"Line":0}},{"line":117,"address":[5287320,5287004],"length":1,"stats":{"Line":0}},{"line":121,"address":[6793392],"length":1,"stats":{"Line":0}},{"line":125,"address":[9100843],"length":1,"stats":{"Line":0}},{"line":127,"address":[5288312,5288206,5289648,5288439],"length":1,"stats":{"Line":0}},{"line":130,"address":[5292608,5288429,5292638],"length":1,"stats":{"Line":0}},{"line":132,"address":[9101303],"length":1,"stats":{"Line":0}},{"line":133,"address":[5288572],"length":1,"stats":{"Line":0}},{"line":135,"address":[9101321,9101393],"length":1,"stats":{"Line":0}},{"line":140,"address":[5288594,5288722],"length":1,"stats":{"Line":0}},{"line":142,"address":[9102660,9105450,9102307,9102734,9102109,9101797,9101581,9101648,9102363,9102856,9101960,9102019,9102197],"length":1,"stats":{"Line":0}},{"line":143,"address":[5288789],"length":1,"stats":{"Line":0}},{"line":144,"address":[9105766,9105744,9101744],"length":1,"stats":{"Line":0}},{"line":145,"address":[5289638,5289088,5289336,5289207,5289582,5289119,5288825],"length":1,"stats":{"Line":0}},{"line":146,"address":[8699092],"length":1,"stats":{"Line":0}},{"line":147,"address":[9102849,9105984,9106006],"length":1,"stats":{"Line":0}},{"line":149,"address":[5290101],"length":1,"stats":{"Line":0}},{"line":150,"address":[5290177,5292400],"length":1,"stats":{"Line":0}},{"line":155,"address":[9103254,9103113,9103008],"length":1,"stats":{"Line":0}},{"line":156,"address":[5290391,5293296,5293280],"length":1,"stats":{"Line":0}},{"line":158,"address":[9103447],"length":1,"stats":{"Line":0}},{"line":163,"address":[5290688,5290771],"length":1,"stats":{"Line":0}},{"line":165,"address":[5291319],"length":1,"stats":{"Line":0}},{"line":173,"address":[5291981],"length":1,"stats":{"Line":0}},{"line":175,"address":[5291054,5291761],"length":1,"stats":{"Line":0}},{"line":176,"address":[5291861],"length":1,"stats":{"Line":0}},{"line":177,"address":[5291930],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":69},{"path":["/","home","vidyootsenthil","TheValut-nameTBD","node","src","grpc","mod.rs"],"content":"pub mod grpc_handler;\npub mod grpc_operator;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","vidyootsenthil","TheValut-nameTBD","node","src","key_manager.rs"],"content":"use std::{fs, path::PathBuf};\n\nuse crate::{Config, EncryptionParams, errors::NodeError};\nuse aes_gcm::{Aes256Gcm, Key, KeyInit, Nonce, aead::Aead};\nuse argon2::{Argon2, password_hash::SaltString};\nuse base64::{Engine as _, engine::general_purpose::STANDARD as BASE64};\nuse directories::ProjectDirs;\nuse libp2p::identity::Keypair;\nuse tracing::debug;\n\npub fn get_key_file_path() -\u003e Result\u003cPathBuf, NodeError\u003e {\n    let proj_dirs = ProjectDirs::from(\"\", \"\", \"TheVault\")\n        .ok_or_else(|| NodeError::Error(\"Failed to determine project directory\".into()))?;\n\n    let config_dir = proj_dirs.config_dir();\n    fs::create_dir_all(config_dir)\n        .map_err(|e| NodeError::Error(format!(\"Failed to create config directory: {}\", e)))?;\n\n    let path = config_dir.join(\"config.json\");\n    debug!(\"Using key file path: {}\", path.display());\n    Ok(path)\n}\n\npub fn get_config_file_path(file_path_option: Option\u003cString\u003e) -\u003e Result\u003cPathBuf, NodeError\u003e {\n    if let Some(file_path_str) = file_path_option {\n        let mut path = PathBuf::from(file_path_str);\n        if path.is_dir() {\n            path.push(\"config.json\");\n        }\n        println!(\"Using key file path: {}\", path.display());\n        Ok(path)\n    } else {\n        let proj_dirs = ProjectDirs::from(\"\", \"\", \"TheVault\")\n            .ok_or_else(|| NodeError::Error(\"Failed to determine project directory\".into()))?;\n        let config_dir = proj_dirs.config_dir();\n        Ok(config_dir.join(\"config.json\"))\n    }\n}\n\nfn derive_key_from_password(password: \u0026str, salt_str: \u0026str) -\u003e Result\u003cVec\u003cu8\u003e, NodeError\u003e {\n    let argon2 = Argon2::default();\n    let password_bytes = password.as_bytes();\n    let salt = SaltString::from_b64(salt_str)\n        .map_err(|e| NodeError::Error(format!(\"Salt decoding failed: {}\", e)))?;\n\n    let mut key = vec![0u8; 32];\n    argon2\n        .hash_password_into(password_bytes, salt.as_str().as_bytes(), \u0026mut key)\n        .map_err(|e| NodeError::Error(format!(\"Argon2 key derivation failed: {}\", e)))?;\n    Ok(key)\n}\n\nfn decrypt_private_key(\n    encrypted_private_key_b64: \u0026str,\n    password: \u0026str,\n    params: \u0026EncryptionParams,\n) -\u003e Result\u003cVec\u003cu8\u003e, NodeError\u003e {\n    let key_bytes = derive_key_from_password(password, \u0026params.salt_b64)?;\n\n    let iv_bytes = BASE64\n        .decode(\u0026params.iv_b64)\n        .map_err(|e| NodeError::Error(format!(\"IV decoding failed: {}\", e)))?;\n    let nonce = Nonce::from_slice(\u0026iv_bytes);\n\n    let ciphertext = BASE64\n        .decode(encrypted_private_key_b64)\n        .map_err(|e| NodeError::Error(format!(\"Ciphertext decoding failed: {}\", e)))?;\n\n    let cipher = Aes256Gcm::new(Key::\u003cAes256Gcm\u003e::from_slice(\u0026key_bytes));\n\n    let decrypted_private_key = cipher\n        .decrypt(nonce, ciphertext.as_ref())\n        .map_err(|e| NodeError::Error(format!(\"AES decryption failed: {}\", e)))?;\n\n    Ok(decrypted_private_key)\n}\n\nfn get_password_from_prompt() -\u003e Result\u003cString, NodeError\u003e {\n    rpassword::prompt_password(\"Enter password to decrypt identity key: \")\n        .map_err(|e| NodeError::Error(e.to_string()))\n}\n\npub fn get_config(config_filepath: Option\u003cString\u003e) -\u003e Result\u003cConfig, NodeError\u003e {\n    let key_file_path = if let Some(config_path) = config_filepath {\n        PathBuf::from(config_path)\n    } else {\n        get_key_file_path()?\n    };\n\n    debug!(\"Using key file path: {}\", key_file_path.display());\n\n    let config_contents = fs::read_to_string(\u0026key_file_path)\n        .map_err(|e| NodeError::Error(format!(\"Failed to read config file: {}\", e)))?;\n\n    debug!(\"Read config file\");\n\n    let config = serde_json::from_str::\u003cConfig\u003e(\u0026config_contents)\n        .map_err(|e| NodeError::Error(format!(\"Failed to deserialize config file: {}\", e)))?;\n\n    debug!(\"Deserialized config file\");\n\n    Ok(config)\n}\n\npub fn load_and_decrypt_keypair(config_data: \u0026Config) -\u003e Result\u003cKeypair, NodeError\u003e {\n    let password = match std::env::var(\"KEY_PASSWORD\") {\n        Ok(pw) =\u003e pw,\n        Err(_) =\u003e get_password_from_prompt()?,\n    };\n\n    let private_key_protobuf = decrypt_private_key(\n        \u0026config_data.key_data.encrypted_private_key_b64,\n        \u0026password,\n        \u0026config_data.key_data.encryption_params,\n    )?;\n\n    Keypair::from_protobuf_encoding(\u0026private_key_protobuf).map_err(|e| {\n        NodeError::Error(format!(\n            \"Failed to reconstruct keypair from protobuf: {}\",\n            e\n        ))\n    })\n}\n","traces":[{"line":11,"address":[8164034,8162400,8164012],"length":1,"stats":{"Line":0}},{"line":12,"address":[10400439,10400621],"length":1,"stats":{"Line":0}},{"line":13,"address":[8276798,8276784],"length":1,"stats":{"Line":0}},{"line":15,"address":[8162732,8162819],"length":1,"stats":{"Line":0}},{"line":16,"address":[8162996,8162854],"length":1,"stats":{"Line":0}},{"line":17,"address":[10400991],"length":1,"stats":{"Line":0}},{"line":19,"address":[8163034],"length":1,"stats":{"Line":0}},{"line":20,"address":[8163066,8163480,8163139],"length":1,"stats":{"Line":0}},{"line":21,"address":[8163370],"length":1,"stats":{"Line":0}},{"line":24,"address":[8165233,8164048,8164753],"length":1,"stats":{"Line":0}},{"line":25,"address":[10402108],"length":1,"stats":{"Line":0}},{"line":26,"address":[8164176],"length":1,"stats":{"Line":0}},{"line":27,"address":[10402344,10402412],"length":1,"stats":{"Line":0}},{"line":28,"address":[10402462],"length":1,"stats":{"Line":0}},{"line":30,"address":[8164469,8164413],"length":1,"stats":{"Line":0}},{"line":31,"address":[8164616],"length":1,"stats":{"Line":0}},{"line":33,"address":[8164183,8164882,8164775],"length":1,"stats":{"Line":0}},{"line":34,"address":[8277150,8277136],"length":1,"stats":{"Line":0}},{"line":35,"address":[8165062,8164987],"length":1,"stats":{"Line":0}},{"line":36,"address":[8165078],"length":1,"stats":{"Line":0}},{"line":40,"address":[8166231,8166237,8165264],"length":1,"stats":{"Line":0}},{"line":41,"address":[8165336],"length":1,"stats":{"Line":0}},{"line":42,"address":[8165360],"length":1,"stats":{"Line":0}},{"line":43,"address":[8165413,8165542],"length":1,"stats":{"Line":0}},{"line":44,"address":[10403544],"length":1,"stats":{"Line":0}},{"line":46,"address":[8165723],"length":1,"stats":{"Line":0}},{"line":47,"address":[8165936,8166084],"length":1,"stats":{"Line":0}},{"line":48,"address":[8165754,8165837],"length":1,"stats":{"Line":0}},{"line":49,"address":[8277392,8277416],"length":1,"stats":{"Line":0}},{"line":50,"address":[8166111],"length":1,"stats":{"Line":0}},{"line":53,"address":[8167727,8167701,8166256],"length":1,"stats":{"Line":0}},{"line":58,"address":[8166346],"length":1,"stats":{"Line":0}},{"line":60,"address":[8166570,8166652,8166733,8167725],"length":1,"stats":{"Line":0}},{"line":61,"address":[8166566],"length":1,"stats":{"Line":0}},{"line":62,"address":[8166701],"length":1,"stats":{"Line":0}},{"line":63,"address":[8166905,8166822],"length":1,"stats":{"Line":0}},{"line":65,"address":[8167707,8167063,8166940],"length":1,"stats":{"Line":0}},{"line":67,"address":[10627184,10627200],"length":1,"stats":{"Line":0}},{"line":69,"address":[8167235,8167152],"length":1,"stats":{"Line":0}},{"line":71,"address":[8167475,8167371],"length":1,"stats":{"Line":0}},{"line":72,"address":[8167271],"length":1,"stats":{"Line":0}},{"line":73,"address":[10405561],"length":1,"stats":{"Line":0}},{"line":75,"address":[8167537],"length":1,"stats":{"Line":0}},{"line":78,"address":[8167744],"length":1,"stats":{"Line":0}},{"line":79,"address":[10405885],"length":1,"stats":{"Line":0}},{"line":80,"address":[8278064,8278082],"length":1,"stats":{"Line":0}},{"line":83,"address":[8171274,8171407,8167808],"length":1,"stats":{"Line":0}},{"line":84,"address":[8168264,8167839],"length":1,"stats":{"Line":0}},{"line":85,"address":[10406165,10406070],"length":1,"stats":{"Line":0}},{"line":87,"address":[10406198,10406077,10409538],"length":1,"stats":{"Line":0}},{"line":90,"address":[8168611,8168320,8168035],"length":1,"stats":{"Line":0}},{"line":92,"address":[10409494,10406725,10407319,10407427],"length":1,"stats":{"Line":0}},{"line":93,"address":[8169243],"length":1,"stats":{"Line":0}},{"line":95,"address":[8169742,8169443,8169364],"length":1,"stats":{"Line":0}},{"line":97,"address":[10408475,10407872,10408325],"length":1,"stats":{"Line":0}},{"line":98,"address":[8278499,8278464],"length":1,"stats":{"Line":0}},{"line":100,"address":[10408647,10408574,10408962],"length":1,"stats":{"Line":0}},{"line":102,"address":[10408913],"length":1,"stats":{"Line":0}},{"line":105,"address":[8172375,8171440,8172356],"length":1,"stats":{"Line":0}},{"line":106,"address":[8171470],"length":1,"stats":{"Line":0}},{"line":107,"address":[10409698],"length":1,"stats":{"Line":0}},{"line":108,"address":[8171684,8171512],"length":1,"stats":{"Line":0}},{"line":112,"address":[8171880],"length":1,"stats":{"Line":0}},{"line":113,"address":[8171967],"length":1,"stats":{"Line":0}},{"line":114,"address":[8172009],"length":1,"stats":{"Line":0}},{"line":117,"address":[8172191,8172274],"length":1,"stats":{"Line":0}},{"line":118,"address":[8278750,8278798],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":67},{"path":["/","home","vidyootsenthil","TheValut-nameTBD","node","src","lib.rs"],"content":"use crate::{db::Db, dkg::DkgState, errors::NodeError};\nuse frost_secp256k1::{self as frost, Identifier};\nuse libp2p::PeerId;\nuse serde::{Deserialize, Serialize};\nuse std::{\n    collections::{BTreeMap, HashSet},\n    path::PathBuf,\n};\nuse swarm_manager::{NetworkEvent, NetworkHandle};\nuse tokio::sync::mpsc::UnboundedReceiver;\nuse tracing::error;\n\npub mod db;\npub mod dkg;\npub mod grpc;\npub mod main_loop;\npub mod protocol;\npub mod signing;\npub mod start_node;\npub mod swarm_manager;\npub mod wallet;\n\npub mod errors;\npub mod key_manager;\n\n#[derive(Clone, Serialize, Deserialize, PartialEq)]\npub struct PeerData {\n    pub name: String,\n    pub public_key: String,\n}\n\n#[derive(Serialize, Deserialize)]\npub struct DkgKeys {\n    pub encrypted_private_key_package_b64: String,\n    pub dkg_encryption_params: EncryptionParams,\n    pub pubkey_package_b64: String,\n}\n\n#[derive(Serialize, Deserialize)]\npub struct EncryptionParams {\n    pub kdf: String,\n    pub salt_b64: String,\n    pub iv_b64: String,\n}\n\n#[derive(Serialize, Deserialize)]\npub struct KeyData {\n    pub public_key_b58: String,\n    pub encrypted_private_key_b64: String,\n    pub encryption_params: EncryptionParams,\n}\n\n#[derive(Serialize, Deserialize)]\npub struct Config {\n    pub allowed_peers: Vec\u003cPeerData\u003e,\n    pub key_data: KeyData,\n    pub dkg_keys: Option\u003cDkgKeys\u003e,\n    pub log_file_path: Option\u003cPathBuf\u003e,\n}\n\npub struct NodeState {\n    pub allowed_peers: Vec\u003cPeerId\u003e,\n    pub peers_to_names: BTreeMap\u003cPeerId, String\u003e,\n\n    // DKG\n    pub dkg_state: DkgState,\n    pub db: Db,\n\n    pub peer_id: PeerId,\n    pub peers: HashSet\u003cPeerId\u003e,\n\n    pub min_signers: u16,\n    pub max_signers: u16,\n    pub rng: frost::rand_core::OsRng,\n\n    // FROST signing\n    pub active_signing: Option\u003cActiveSigning\u003e,\n    pub wallet: crate::wallet::SimpleWallet,\n    pub pending_spends: std::collections::BTreeMap\u003cu64, crate::wallet::PendingSpend\u003e,\n\n    // Config management\n    pub config_file: String,\n\n    pub network_handle: NetworkHandle,\n\n    pub network_events_stream: UnboundedReceiver\u003cNetworkEvent\u003e,\n}\n\nimpl NodeState {\n    pub fn peer_name(\u0026self, peer_id: \u0026PeerId) -\u003e String {\n        self.peers_to_names\n            .get(peer_id)\n            .unwrap_or(\u0026peer_id.to_string())\n            .clone()\n    }\n\n    pub fn new_from_config(\n        network_handle: NetworkHandle,\n        peer_data: Vec\u003cPeerData\u003e,\n        min_signers: u16,\n        max_signers: u16,\n        config_file: String,\n        network_events_emitter: UnboundedReceiver\u003cNetworkEvent\u003e,\n    ) -\u003e Result\u003cSelf, NodeError\u003e {\n        let allowed_peers: Vec\u003cPeerId\u003e = peer_data\n            .iter()\n            .filter_map(|peer| {\n                peer.public_key\n                    .parse()\n                    .map_err(|e| NodeError::Error(format!(\"Failed to parse peer data: {}\", e)))\n                    .ok()\n            })\n            .collect::\u003cVec\u003cPeerId\u003e\u003e();\n\n        let peers_to_names: BTreeMap\u003cPeerId, String\u003e = peer_data\n            .iter()\n            .filter_map(|peer| {\n                let peer_id = peer\n                    .public_key\n                    .parse()\n                    .map_err(|e| NodeError::Error(format!(\"Failed to parse peer data: {}\", e)))\n                    .ok()?;\n                Some((peer_id, peer.name.clone()))\n            })\n            .collect::\u003cBTreeMap\u003cPeerId, String\u003e\u003e();\n\n        let dkg_state = DkgState::new(\n            network_handle.clone(),\n            min_signers,\n            max_signers,\n            network_handle.peer_id(),\n            peers_to_names.clone(),\n            config_file.clone(),\n        )?;\n\n        Ok(NodeState {\n            network_handle: network_handle.clone(),\n            allowed_peers: allowed_peers.clone(),\n            network_events_stream: network_events_emitter,\n            peers_to_names: peers_to_names.clone(),\n            peer_id: network_handle.peer_id(),\n            min_signers,\n            max_signers,\n            db: Db::new(\"node_db.db\"),\n            dkg_state,\n            peers: HashSet::new(),\n            rng: frost::rand_core::OsRng,\n            active_signing: None,\n            wallet: crate::wallet::SimpleWallet::new(),\n            pending_spends: BTreeMap::new(),\n            config_file: config_file.clone(),\n        })\n    }\n}\n\npub fn peer_id_to_identifier(peer_id: \u0026PeerId) -\u003e Identifier {\n    let bytes = peer_id.to_bytes();\n    match Identifier::derive(\u0026bytes) {\n        Ok(identifier) =\u003e identifier,\n        Err(e) =\u003e {\n            error!(\"Failed to derive identifier: {}\", e);\n            panic!(\"Failed to derive identifier\");\n        }\n    }\n}\n\n// Active signing session tracking\npub struct ActiveSigning {\n    pub sign_id: u64,\n    pub message: Vec\u003cu8\u003e,\n    pub selected_peers: Vec\u003cPeerId\u003e,\n    pub nonces: frost::round1::SigningNonces,\n    pub commitments: BTreeMap\u003cIdentifier, frost::round1::SigningCommitments\u003e,\n    pub signature_shares: BTreeMap\u003cIdentifier, frost::round2::SignatureShare\u003e,\n    pub signing_package: Option\u003cfrost::SigningPackage\u003e,\n    pub is_coordinator: bool,\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_config_deserialization() {\n        let json_str = r#\"{\n            \"allowed_peers\": [\n                {\n                    \"public_key\": \"12D3KooWRdtE2nFybk8eMyp3D9B4NvunUYqpN6JDvBcVPTcrDsbF\",\n                    \"name\": \"node-four\"\n                }\n            ],\n            \"key_data\": {\n                \"public_key_b58\": \"12D3KooWQDHzW448RmDoUz1KbMfuD4XqeojRJDsxqUZSEYo7FSUz\",\n                \"encrypted_private_key_b64\": \"EnCF8bEe3tVyMV0EUIK29bOMNjH7gT7mx4ATyBr4WSdphw5ETfm1YdQHDAg+CzBBjt7K2FSbwv8Qkj1y3N4jTU/FkGHggfkwDDl5XkDc5rXi2BW/\",\n                \"encryption_params\": {\n                    \"kdf\": \"argon2id\",\n                    \"salt_b64\": \"TnErEFlx9F1BeU8mJcFzKQ\",\n                    \"iv_b64\": \"hybTge0qoPaxNUhP\"\n                }\n            }\n        }\"#;\n\n        let config: Config = serde_json::from_str(json_str).expect(\"Failed to deserialize\");\n        assert_eq!(config.allowed_peers.len(), 1);\n        assert_eq!(\n            config.key_data.public_key_b58,\n            \"12D3KooWQDHzW448RmDoUz1KbMfuD4XqeojRJDsxqUZSEYo7FSUz\"\n        );\n        assert!(config.dkg_keys.is_none());\n    }\n}\n","traces":[{"line":90,"address":[11839081,11838880,11839075],"length":1,"stats":{"Line":0}},{"line":91,"address":[8840519,8840465,8840418],"length":1,"stats":{"Line":0}},{"line":93,"address":[8840450],"length":1,"stats":{"Line":0}},{"line":97,"address":[8843234,8840576,8842947],"length":1,"stats":{"Line":0}},{"line":105,"address":[11839357,11839233],"length":1,"stats":{"Line":0}},{"line":107,"address":[6432624],"length":1,"stats":{"Line":0}},{"line":108,"address":[6432668],"length":1,"stats":{"Line":0}},{"line":110,"address":[6432736,6432766],"length":1,"stats":{"Line":0}},{"line":115,"address":[8840902,8840973],"length":1,"stats":{"Line":0}},{"line":117,"address":[6432976],"length":1,"stats":{"Line":0}},{"line":118,"address":[6433022],"length":1,"stats":{"Line":0}},{"line":121,"address":[6433326,6433296],"length":1,"stats":{"Line":0}},{"line":123,"address":[6433159],"length":1,"stats":{"Line":0}},{"line":128,"address":[8841058,8841113],"length":1,"stats":{"Line":0}},{"line":131,"address":[8841129],"length":1,"stats":{"Line":0}},{"line":132,"address":[8841190],"length":1,"stats":{"Line":0}},{"line":133,"address":[8841210],"length":1,"stats":{"Line":0}},{"line":136,"address":[8842165],"length":1,"stats":{"Line":0}},{"line":137,"address":[8841593],"length":1,"stats":{"Line":0}},{"line":138,"address":[8841641],"length":1,"stats":{"Line":0}},{"line":139,"address":[8841708],"length":1,"stats":{"Line":0}},{"line":140,"address":[8841748],"length":1,"stats":{"Line":0}},{"line":141,"address":[11840403],"length":1,"stats":{"Line":0}},{"line":144,"address":[8841855],"length":1,"stats":{"Line":0}},{"line":145,"address":[11840494],"length":1,"stats":{"Line":0}},{"line":146,"address":[8841920],"length":1,"stats":{"Line":0}},{"line":148,"address":[8841989],"length":1,"stats":{"Line":0}},{"line":149,"address":[8842005],"length":1,"stats":{"Line":0}},{"line":150,"address":[11840676],"length":1,"stats":{"Line":0}},{"line":151,"address":[8842109],"length":1,"stats":{"Line":0}},{"line":156,"address":[11843048,11841936,11843042],"length":1,"stats":{"Line":0}},{"line":157,"address":[8843273],"length":1,"stats":{"Line":0}},{"line":158,"address":[8843364,8843444],"length":1,"stats":{"Line":0}},{"line":159,"address":[8843557],"length":1,"stats":{"Line":0}},{"line":160,"address":[8843479],"length":1,"stats":{"Line":0}},{"line":161,"address":[8843632,8843884,8843527],"length":1,"stats":{"Line":0}},{"line":162,"address":[8844318,8843855],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":37},{"path":["/","home","vidyootsenthil","TheValut-nameTBD","node","src","main_loop.rs"],"content":"use libp2p::mdns;\n\nuse libp2p::gossipsub;\nuse libp2p::request_response;\nuse libp2p::swarm::SwarmEvent;\nuse tokio::select;\nuse tracing::{debug, error, info};\n\nuse crate::NodeState;\nuse crate::errors::NodeError;\nuse crate::swarm_manager::{\n    MyBehaviourEvent, NetworkEvent, NetworkMessage, PrivateRequest, PrivateResponse,\n};\n\nimpl NodeState {\n    pub async fn start(\u0026mut self) -\u003e Result\u003c(), NodeError\u003e {\n        info!(\"Local peer id: {}\", self.peer_id);\n\n        let round1_topic = gossipsub::IdentTopic::new(\"round1_topic\");\n        let start_dkg_topic = gossipsub::IdentTopic::new(\"start-dkg\");\n        loop {\n            select! {\n                send_message = self.network_events_stream.recv() =\u003e match send_message {\n                    Some(NetworkEvent::NetworkMessage(NetworkMessage::SendSelfRequest { request, response_channel: None })) =\u003e {\n                        debug!(\"Received self request {:?}\", request);\n                        if let PrivateRequest::InsertBlock { block } = request {\n                            if let Err(e) = self.db.insert_block(block) {\n                                return Err(NodeError::Error(format!(\"Failed to handle genesis block: {}\", e)));\n                            }\n                        }\n                    }\n                    Some(NetworkEvent::NetworkMessage(NetworkMessage::SendSelfRequest { request, response_channel: Some(response_channel) })) =\u003e {\n                        debug!(\"Received self request {:?}\", request);\n                            match request {\n                                PrivateRequest::StartSigningSession { hex_message } =\u003e {\n                                    match self.start_signing_session(\u0026hex_message) {\n                                        Ok(_) =\u003e (),\n                                        Err(e) =\u003e {\n                                            return Err(NodeError::Error(format!(\"Failed to start signing session: {}\", e)));\n                                        }\n                                    }\n                                },\n                                PrivateRequest::Spend { amount_sat } =\u003e {\n                                    let response = self.start_spend_request(amount_sat);\n                                    match response_channel.send(PrivateResponse::SpendRequestSent { sighash: response.unwrap_or(\"No sighash\".to_string()) }) {\n                                        Ok(_) =\u003e (),\n                                        Err(e) =\u003e {\n                                            return Err(NodeError::Error(format!(\"Failed to send response: {}\", e)));\n                                        }\n                                    }\n                                }\n                                PrivateRequest::GetFrostPublicKey =\u003e {\n                                    let response = self.get_frost_public_key();\n                                    match response_channel.send(PrivateResponse::GetFrostPublicKey { public_key: response.unwrap_or(\"No public key\".to_string()) }) {\n                                        Ok(_) =\u003e (),\n                                        Err(e) =\u003e {\n                                            return Err(NodeError::Error(format!(\"Failed to send response: {}\", e)));\n                                        }\n                                    }\n                                }\n                                _ =\u003e {}\n                            }\n                    }\n                    Some(NetworkEvent::SwarmEvent(SwarmEvent::Behaviour(MyBehaviourEvent::Mdns(mdns::Event::Discovered(list))))) =\u003e {\n                        for (peer_id, _multiaddr) in list {\n                            self.peers.insert(peer_id);\n                            self.dkg_state.peers.insert(peer_id);\n                        }\n                    },\n                    Some(NetworkEvent::SwarmEvent(SwarmEvent::Behaviour(MyBehaviourEvent::Gossipsub(gossipsub::Event::Message {\n                        message,\n                        ..\n                    })))) =\u003e {\n                        match message.topic {\n                            t if t == round1_topic.hash() =\u003e {\n                                if let Some(source_peer) = message.source {\n                                    info!(\"Received round1 payload from {}\", self.peer_name(\u0026source_peer));\n                                } else {\n                                    return Err(NodeError::Error(\"No source peer\".to_string()));\n                                }\n\n                                if let Some(source_peer) = message.source {\n                                    match self.dkg_state.handle_round1_payload(source_peer, message.data) {\n                                        Ok(_) =\u003e (),\n                                        Err(e) =\u003e {\n                                            error!(\" Failed to handle round1 payload: {}\", e);\n                                        }\n                                    }\n                                }\n                            }\n                            t if t == start_dkg_topic.hash() =\u003e {\n                                match self.dkg_state.handle_dkg_start() {\n                                    Ok(_) =\u003e (),\n                                    Err(e) =\u003e {\n                                        error!(\" Failed to handle DKG start: {}\", e);\n                                    }\n                                }\n                            }\n                            _ =\u003e {\n                                debug!(\"Received unhandled broadcast\");\n                            }\n                        }\n                    },\n                    // Handle direct message requests (incoming)\n                    Some(NetworkEvent::SwarmEvent(SwarmEvent::Behaviour(MyBehaviourEvent::RequestResponse(\n                        request_response::Event::Message {\n                            peer,\n                            message: request_response::Message::Request { request: PrivateRequest::Round2Package(package), channel, .. }\n                        }\n                    )))) =\u003e {\n                        match self.dkg_state.handle_round2_payload(peer, package, channel) {\n                            Ok(_) =\u003e (),\n                            Err(e) =\u003e {\n                                error!(\" Failed to handle round2 payload: {}\", e);\n                            }\n                        }\n                    },\n                    // Incoming SignRequest\n                    Some(NetworkEvent::SwarmEvent(SwarmEvent::Behaviour(MyBehaviourEvent::RequestResponse(\n                        request_response::Event::Message {\n                            peer,\n                            message: request_response::Message::Request { request: PrivateRequest::SignRequest { sign_id, message }, channel, .. }\n                        }\n                    )))) =\u003e {\n                        match self.handle_sign_request(peer, sign_id, message, channel) {\n                            Ok(_) =\u003e (),\n                            Err(e) =\u003e {\n                                error!(\" Failed to handle sign request: {}\", e);\n                            }\n                        }\n                    },\n                    // Incoming SignPackage request to generate signature share\n                    Some(NetworkEvent::SwarmEvent(SwarmEvent::Behaviour(MyBehaviourEvent::RequestResponse(\n                        request_response::Event::Message {\n                            peer,\n                            message: request_response::Message::Request { request: PrivateRequest::SignPackage { sign_id, package }, channel, .. }\n                        }\n                    )))) =\u003e {\n                        match self.handle_sign_package(peer, sign_id, package, channel) {\n                            Ok(_) =\u003e (),\n                            Err(e) =\u003e {\n                                error!(\" Failed to handle sign package: {}\", e);\n                            }\n                        }\n                    },\n                    Some(NetworkEvent::SwarmEvent(SwarmEvent::Behaviour(MyBehaviourEvent::Gossipsub(gossipsub::Event::Subscribed {\n                        peer_id,\n                        topic,\n                    })))) =\u003e {\n                        if topic == start_dkg_topic.hash() {\n                            self.dkg_state.dkg_listeners.insert(peer_id);\n                            info!(\"Peer {} subscribed to topic {topic}. Listeners: {}\", self.peer_name(\u0026peer_id), self.dkg_state.dkg_listeners.len());\n                            if let Err(e) = self.dkg_state.handle_dkg_start() {\n                                error!(\" Failed to handle DKG start: {}\", e);\n                            }\n                        }\n                    },\n                    // Responses with commitments\n                    Some(NetworkEvent::SwarmEvent(SwarmEvent::Behaviour(MyBehaviourEvent::RequestResponse(\n                        request_response::Event::Message {\n                            peer,\n                            message: request_response::Message::Response { response: PrivateResponse::Commitments { sign_id, commitments }, .. }\n                        }\n                    )))) =\u003e {\n                        match self.handle_commitments_response(peer, sign_id, commitments) {\n                            Ok(_) =\u003e (),\n                            Err(e) =\u003e {\n                                error!(\" Failed to handle commitments response: {}\", e);\n                            }\n                        }\n                    },\n                    // Responses with signature share\n                    Some(NetworkEvent::SwarmEvent(SwarmEvent::Behaviour(MyBehaviourEvent::RequestResponse(\n                        request_response::Event::Message {\n                            peer,\n                            message: request_response::Message::Response { response: PrivateResponse::SignatureShare { sign_id, signature_share }, .. }\n                        }\n                    )))) =\u003e {\n                        match self.handle_signature_share(peer, sign_id, signature_share) {\n                            Ok(_) =\u003e (),\n                            Err(e) =\u003e {\n                                error!(\" Failed to handle signature share: {}\", e);\n                            }\n                        }\n                    },\n                    _ =\u003e {}\n                }\n            }\n        }\n    }\n}\n","traces":[{"line":16,"address":[7874458,7875398,7874415,7878735,7874093,7874016],"length":1,"stats":{"Line":0}},{"line":17,"address":[7874387,7874512,7874811],"length":1,"stats":{"Line":0}},{"line":19,"address":[7874777],"length":1,"stats":{"Line":0}},{"line":20,"address":[7875284,7875359],"length":1,"stats":{"Line":0}},{"line":21,"address":[7897085],"length":1,"stats":{"Line":0}},{"line":22,"address":[7534700,7534644,7534659],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":6},{"path":["/","home","vidyootsenthil","TheValut-nameTBD","node","src","protocol","block.rs"],"content":"use std::time::{SystemTime, UNIX_EPOCH};\n\nuse bincode::{Decode, Encode};\nuse serde::{Deserialize, Serialize};\nuse sha2::{Digest, Sha256};\n\nuse crate::{errors::NodeError, protocol::transaction::Transaction};\n\npub type BlockHash = [u8; 32];\npub type StateRoot = [u8; 32];\n\n/// Block header containing all metadata\n#[derive(Debug, Clone, Encode, Decode, Serialize, Deserialize, PartialEq)]\npub struct BlockHeader {\n    /// Version of the block structure\n    pub version: u32,\n\n    /// Hash of the previous block\n    pub previous_block_hash: BlockHash,\n\n    /// Unix timestamp when block was created\n    pub timestamp: u64,\n\n    /// Block height/number in the chain\n    pub height: u64,\n\n    /// Proposer of this block (for PoS/PoA)\n    pub proposer: Vec\u003cu8\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize, Encode, Decode)]\npub struct GenesisBlock {\n    pub version: u32,\n    pub timestamp: u64,\n    pub initial_state: GenesisState,\n    pub extra_data: Vec\u003cu8\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize, Encode, Decode)]\npub struct GenesisState {\n    pub validators: Vec\u003cValidatorInfo\u003e,\n    pub vault_pub_key: Vec\u003cu8\u003e,\n    pub initial_balances: Vec\u003c(String, u64)\u003e,\n    pub chain_config: ChainConfig,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize, Encode, Decode)]\npub struct ValidatorInfo {\n    pub pub_key: Vec\u003cu8\u003e,\n    pub stake: u64,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize, Encode, Decode)]\npub struct ChainConfig {\n    pub min_signers: u16,\n    pub max_signers: u16,\n    pub min_stake: u64,\n    pub block_time_seconds: u64,\n    pub max_block_size: u64,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize, Encode, Decode)]\npub struct Block {\n    pub header: BlockHeader,\n    pub body: BlockBody,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize, Encode, Decode)]\npub struct BlockBody {\n    pub transactions: Vec\u003cTransaction\u003e,\n}\n\nimpl BlockHeader {\n    pub fn calculate_hash(\u0026self) -\u003e BlockHash {\n        let mut hasher = Sha256::new();\n\n        hasher.update(self.version.to_le_bytes());\n        hasher.update(self.previous_block_hash);\n        hasher.update(self.timestamp.to_le_bytes());\n        hasher.update(self.height.to_le_bytes());\n        hasher.update(\u0026self.proposer);\n\n        let result = hasher.finalize();\n        let mut hash = [0u8; 32];\n        hash.copy_from_slice(\u0026result);\n        hash\n    }\n}\n\nimpl Block {\n    /// Create a new block\n    pub fn new(\n        previous_block_hash: BlockHash,\n        height: u64,\n        transactions: Vec\u003cTransaction\u003e,\n        proposer: Vec\u003cu8\u003e,\n    ) -\u003e Self {\n        let header = BlockHeader {\n            version: 1,\n            previous_block_hash,\n            timestamp: SystemTime::now()\n                .duration_since(UNIX_EPOCH)\n                .unwrap()\n                .as_secs(),\n            height,\n            proposer,\n        };\n\n        Block {\n            header,\n            body: BlockBody { transactions },\n        }\n    }\n\n    pub fn hash(\u0026self) -\u003e BlockHash {\n        self.header.calculate_hash()\n    }\n\n    pub fn serialize(\u0026self) -\u003e Result\u003cVec\u003cu8\u003e, NodeError\u003e {\n        bincode::encode_to_vec(self, bincode::config::standard())\n            .map_err(|e| NodeError::Error(format!(\"Failed to serialize block: {}\", e)))\n    }\n\n    pub fn deserialize(data: \u0026[u8]) -\u003e Result\u003cSelf, NodeError\u003e {\n        let (block, _): (Self, _) =\n            bincode::decode_from_slice(data, bincode::config::standard())\n                .map_err(|e| NodeError::Error(format!(\"Failed to deserialize block: {}\", e)))?;\n        Ok(block)\n    }\n}\n\nimpl GenesisBlock {\n    /// Create a new genesis block\n    pub fn new(\n        validators: Vec\u003cValidatorInfo\u003e,\n        chain_config: ChainConfig,\n        vault_pub_key: Vec\u003cu8\u003e,\n    ) -\u003e Self {\n        GenesisBlock {\n            version: 1,\n            timestamp: SystemTime::now()\n                .duration_since(UNIX_EPOCH)\n                .unwrap()\n                .as_secs(),\n            initial_state: GenesisState {\n                validators,\n                vault_pub_key,\n                initial_balances: vec![],\n                chain_config,\n            },\n            extra_data: b\"Genesis Block\".to_vec(),\n        }\n    }\n\n    pub fn to_block(\u0026self) -\u003e Block {\n        let mut hasher = Sha256::new();\n        hasher.update(b\"GENESIS\");\n        hasher.update(self.timestamp.to_le_bytes());\n        let state_bytes =\n            bincode::encode_to_vec(\u0026self.initial_state, bincode::config::standard()).unwrap();\n        hasher.update(\u0026state_bytes);\n        let result = hasher.finalize();\n        let mut state_root = [0u8; 32];\n        state_root.copy_from_slice(\u0026result);\n\n        Block::new(\n            [0u8; 32], // No previous block\n            0,         // Height 0\n            vec![],    // No transactions in genesis\n            self.initial_state\n                .validators\n                .first()\n                .map(|v| v.pub_key.clone())\n                .unwrap_or_default(),\n        )\n    }\n\n    /// Get hash of genesis block\n    pub fn hash(\u0026self) -\u003e BlockHash {\n        self.to_block().hash()\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_block_creation_and_hashing() {\n        let block = Block::new([0u8; 32], 1, vec![], vec![1, 2, 3]);\n\n        let hash1 = block.hash();\n        let hash2 = block.hash();\n        assert_eq!(hash1, hash2); // Hash should be deterministic\n    }\n}\n","traces":[{"line":74,"address":[8266176],"length":1,"stats":{"Line":1}},{"line":75,"address":[6161949],"length":1,"stats":{"Line":1}},{"line":77,"address":[6161964],"length":1,"stats":{"Line":1}},{"line":78,"address":[6162028],"length":1,"stats":{"Line":1}},{"line":79,"address":[6162098],"length":1,"stats":{"Line":1}},{"line":80,"address":[6162169],"length":1,"stats":{"Line":1}},{"line":81,"address":[8266500],"length":1,"stats":{"Line":1}},{"line":83,"address":[6162250],"length":1,"stats":{"Line":1}},{"line":84,"address":[6162295],"length":1,"stats":{"Line":1}},{"line":85,"address":[6162315],"length":1,"stats":{"Line":1}},{"line":86,"address":[6162378],"length":1,"stats":{"Line":1}},{"line":92,"address":[6162448,6163033,6163015],"length":1,"stats":{"Line":1}},{"line":101,"address":[6162493,6162563],"length":1,"stats":{"Line":2}},{"line":111,"address":[6162863],"length":1,"stats":{"Line":1}},{"line":115,"address":[6163056],"length":1,"stats":{"Line":1}},{"line":116,"address":[8267329],"length":1,"stats":{"Line":1}},{"line":119,"address":[6163088],"length":1,"stats":{"Line":0}},{"line":120,"address":[6163112],"length":1,"stats":{"Line":0}},{"line":121,"address":[4898206,4898176],"length":1,"stats":{"Line":0}},{"line":124,"address":[6163168],"length":1,"stats":{"Line":0}},{"line":125,"address":[6163420],"length":1,"stats":{"Line":0}},{"line":127,"address":[4898446,4898416],"length":1,"stats":{"Line":0}},{"line":128,"address":[6163448],"length":1,"stats":{"Line":0}},{"line":134,"address":[6163488,6164157,6164209],"length":1,"stats":{"Line":0}},{"line":141,"address":[6163622,6163520],"length":1,"stats":{"Line":0}},{"line":145,"address":[6163868],"length":1,"stats":{"Line":0}},{"line":151,"address":[6163987],"length":1,"stats":{"Line":0}},{"line":155,"address":[8269347,8268528,8269341],"length":1,"stats":{"Line":0}},{"line":156,"address":[8268558],"length":1,"stats":{"Line":0}},{"line":157,"address":[6164302],"length":1,"stats":{"Line":0}},{"line":158,"address":[8268611],"length":1,"stats":{"Line":0}},{"line":159,"address":[8268685],"length":1,"stats":{"Line":0}},{"line":161,"address":[8268765],"length":1,"stats":{"Line":0}},{"line":162,"address":[6164512],"length":1,"stats":{"Line":0}},{"line":163,"address":[8268953],"length":1,"stats":{"Line":0}},{"line":164,"address":[6164664],"length":1,"stats":{"Line":0}},{"line":167,"address":[6164734],"length":1,"stats":{"Line":0}},{"line":169,"address":[6164761],"length":1,"stats":{"Line":0}},{"line":170,"address":[6164773,6164849],"length":1,"stats":{"Line":0}},{"line":173,"address":[4898656,4898672],"length":1,"stats":{"Line":0}},{"line":179,"address":[6165152,6165040,6165158],"length":1,"stats":{"Line":0}},{"line":180,"address":[6165074],"length":1,"stats":{"Line":0}}],"covered":16,"coverable":42},{"path":["/","home","vidyootsenthil","TheValut-nameTBD","node","src","protocol","chain_state.rs"],"content":"use std::collections::HashMap;\n\nuse bincode::{Decode, Encode};\nuse serde::{Deserialize, Serialize};\n\nuse crate::errors::NodeError;\n\n#[derive(Debug, Clone, Serialize, Deserialize, Encode, Decode)]\npub struct Account {\n    pub address: String,\n    pub balance: u64,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize, Encode, Decode)]\npub struct ChainState {\n    // address -\u003e account\n    accounts: HashMap\u003cString, Account\u003e,\n    block_height: u64,\n}\n\nimpl Default for ChainState {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\n// TODO: implement periodic flushing of chain state to rocksdb\nimpl ChainState {\n    pub fn new() -\u003e Self {\n        Self {\n            accounts: HashMap::new(),\n            block_height: 0,\n        }\n    }\n\n    pub fn new_with_accounts(accounts: HashMap\u003cString, Account\u003e, block_height: u64) -\u003e Self {\n        Self {\n            accounts,\n            block_height,\n        }\n    }\n\n    pub fn get_account(\u0026self, address: \u0026str) -\u003e Option\u003c\u0026Account\u003e {\n        self.accounts.get(address)\n    }\n\n    pub fn get_account_mut(\u0026mut self, address: \u0026str) -\u003e Option\u003c\u0026mut Account\u003e {\n        self.accounts.get_mut(address)\n    }\n\n    pub fn get_block_height(\u0026self) -\u003e u64 {\n        self.block_height\n    }\n\n    pub fn serialize(\u0026self) -\u003e Result\u003cVec\u003cu8\u003e, NodeError\u003e {\n        bincode::encode_to_vec(self, bincode::config::standard())\n            .map_err(|e| NodeError::Error(e.to_string()))\n    }\n\n    pub fn deserialize(data: \u0026[u8]) -\u003e Result\u003cSelf, NodeError\u003e {\n        let (chain_state, _): (Self, _) =\n            bincode::decode_from_slice(data, bincode::config::standard())\n                .map_err(|e| NodeError::Error(e.to_string()))?;\n        Ok(chain_state)\n    }\n}\n","traces":[{"line":22,"address":[9152304],"length":1,"stats":{"Line":0}},{"line":23,"address":[6793480],"length":1,"stats":{"Line":0}},{"line":29,"address":[6793504],"length":1,"stats":{"Line":1}},{"line":31,"address":[6793518],"length":1,"stats":{"Line":1}},{"line":36,"address":[6793584],"length":1,"stats":{"Line":1}},{"line":43,"address":[6793648],"length":1,"stats":{"Line":1}},{"line":44,"address":[6793666],"length":1,"stats":{"Line":1}},{"line":47,"address":[6793680],"length":1,"stats":{"Line":1}},{"line":48,"address":[6793698],"length":1,"stats":{"Line":1}},{"line":51,"address":[6793712],"length":1,"stats":{"Line":0}},{"line":52,"address":[9152549],"length":1,"stats":{"Line":0}},{"line":55,"address":[6793728],"length":1,"stats":{"Line":0}},{"line":56,"address":[6793752],"length":1,"stats":{"Line":0}},{"line":57,"address":[8281648,8281671],"length":1,"stats":{"Line":0}},{"line":60,"address":[6793808],"length":1,"stats":{"Line":0}},{"line":61,"address":[6793991,6793851],"length":1,"stats":{"Line":0}},{"line":63,"address":[6793952],"length":1,"stats":{"Line":0}},{"line":64,"address":[6794064],"length":1,"stats":{"Line":0}}],"covered":7,"coverable":18},{"path":["/","home","vidyootsenthil","TheValut-nameTBD","node","src","protocol","executor.rs"],"content":"use crate::{\n    errors::NodeError,\n    protocol::{\n        chain_state::ChainState,\n        transaction::{Operation, Transaction},\n    },\n};\n\npub struct TransactionExecutor;\n\nimpl TransactionExecutor {\n    pub fn execute_transaction(\n        transaction: Transaction,\n        chain_state: \u0026mut ChainState,\n    ) -\u003e Result\u003c(), NodeError\u003e {\n        for operation in transaction.operations {\n            match operation {\n                Operation::OpIncrementBalance { account_id, amount } =\u003e {\n                    let account = chain_state.get_account_mut(\u0026account_id);\n                    if let Some(account) = account {\n                        account.balance += amount;\n                    } else {\n                        return Err(NodeError::Error(\"Account not found\".to_string()));\n                    }\n                }\n            }\n        }\n        Ok(())\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use std::collections::HashMap;\n\n    use crate::protocol::chain_state::Account;\n\n    use super::*;\n\n    #[test]\n    fn test_execute_transaction() {\n        let accounts = HashMap::from([(\n            \"1\".to_string(),\n            Account {\n                balance: 0,\n                address: \"1\".to_string(),\n            },\n        )]);\n        let mut chain_state = ChainState::new_with_accounts(accounts, 0);\n        let transaction = Transaction::new(vec![Operation::OpIncrementBalance {\n            account_id: \"1\".to_string(),\n            amount: 100,\n        }]);\n        TransactionExecutor::execute_transaction(transaction, \u0026mut chain_state).unwrap();\n        assert_eq!(chain_state.get_account(\"1\").unwrap().balance, 100);\n    }\n\n    #[test]\n    fn test_execute_transaction_with_multiple_operations() {\n        let accounts = HashMap::from([\n            (\n                \"1\".to_string(),\n                Account {\n                    balance: 100,\n                    address: \"1\".to_string(),\n                },\n            ),\n            (\n                \"2\".to_string(),\n                Account {\n                    balance: 200,\n                    address: \"2\".to_string(),\n                },\n            ),\n            (\n                \"3\".to_string(),\n                Account {\n                    balance: 300,\n                    address: \"3\".to_string(),\n                },\n            ),\n        ]);\n        let mut chain_state = ChainState::new_with_accounts(accounts, 0);\n        let transaction = Transaction::new(vec![\n            Operation::OpIncrementBalance {\n                account_id: \"1\".to_string(),\n                amount: 100,\n            },\n            Operation::OpIncrementBalance {\n                account_id: \"2\".to_string(),\n                amount: 200,\n            },\n            Operation::OpIncrementBalance {\n                account_id: \"1\".to_string(),\n                amount: 100,\n            },\n            Operation::OpIncrementBalance {\n                account_id: \"3\".to_string(),\n                amount: 300,\n            },\n        ]);\n        TransactionExecutor::execute_transaction(transaction, \u0026mut chain_state).unwrap();\n        assert_eq!(chain_state.get_account(\"1\").unwrap().balance, 300);\n        assert_eq!(chain_state.get_account(\"2\").unwrap().balance, 400);\n        assert_eq!(chain_state.get_account(\"3\").unwrap().balance, 600);\n    }\n\n    #[test]\n    fn test_execute_transaction_with_zero_amount() {\n        let accounts = HashMap::from([(\n            \"1\".to_string(),\n            Account {\n                balance: 0,\n                address: \"1\".to_string(),\n            },\n        )]);\n        let mut chain_state = ChainState::new_with_accounts(accounts, 0);\n        let transaction = Transaction::new(vec![Operation::OpIncrementBalance {\n            account_id: \"1\".to_string(),\n            amount: 0,\n        }]);\n        let result = TransactionExecutor::execute_transaction(transaction, \u0026mut chain_state);\n        assert!(result.is_ok());\n        assert_eq!(chain_state.get_account(\"1\").unwrap().balance, 0);\n    }\n\n    #[test]\n    fn test_execute_transaction_with_invalid_account() {\n        let mut chain_state = ChainState::new();\n        let transaction = Transaction::new(vec![Operation::OpIncrementBalance {\n            account_id: \"1\".to_string(),\n            amount: 100,\n        }]);\n        let result = TransactionExecutor::execute_transaction(transaction, \u0026mut chain_state);\n        assert!(result.is_err());\n    }\n}\n","traces":[{"line":12,"address":[6523536,6524252],"length":1,"stats":{"Line":1}},{"line":16,"address":[6523722,6523566],"length":1,"stats":{"Line":2}},{"line":18,"address":[6523791],"length":1,"stats":{"Line":1}},{"line":19,"address":[6523972,6523852],"length":1,"stats":{"Line":2}},{"line":20,"address":[6523997],"length":1,"stats":{"Line":1}},{"line":21,"address":[6524109,6524053,6524135],"length":1,"stats":{"Line":2}},{"line":23,"address":[6524160,6524069],"length":1,"stats":{"Line":2}},{"line":28,"address":[6523887],"length":1,"stats":{"Line":1}}],"covered":8,"coverable":8},{"path":["/","home","vidyootsenthil","TheValut-nameTBD","node","src","protocol","mod.rs"],"content":"pub mod block;\npub mod chain_state;\npub mod executor;\npub mod transaction;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","vidyootsenthil","TheValut-nameTBD","node","src","protocol","transaction.rs"],"content":"use bincode::{Decode, Encode};\nuse serde::{Deserialize, Serialize};\nuse sha2::{Digest, Sha256};\n\npub type TransactionId = [u8; 32];\n\n#[derive(Debug, Clone, Serialize, Deserialize, Encode, Decode, PartialEq)]\npub struct Transaction {\n    pub version: u32,\n    pub timestamp: u64,\n    pub operations: Vec\u003cOperation\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize, Encode, Decode, PartialEq)]\npub enum Operation {\n    OpIncrementBalance { account_id: String, amount: u64 },\n}\n\nimpl Transaction {\n    pub fn new(operations: Vec\u003cOperation\u003e) -\u003e Self {\n        Transaction {\n            version: 1,\n            timestamp: std::time::SystemTime::now()\n                .duration_since(std::time::UNIX_EPOCH)\n                .unwrap()\n                .as_secs(),\n            operations,\n        }\n    }\n\n    pub fn id(\u0026self) -\u003e TransactionId {\n        let mut hasher = Sha256::new();\n        hasher.update(self.version.to_le_bytes());\n        hasher.update(self.timestamp.to_le_bytes());\n\n        for op in \u0026self.operations {\n            let op_bytes = bincode::encode_to_vec(op, bincode::config::standard()).unwrap();\n            hasher.update(\u0026op_bytes);\n        }\n\n        let result = hasher.finalize();\n        let mut id = [0u8; 32];\n        id.copy_from_slice(\u0026result);\n        id\n    }\n\n    pub fn total_value(\u0026self) -\u003e u64 {\n        self.operations\n            .iter()\n            .map(|op| match op {\n                Operation::OpIncrementBalance { amount, .. } =\u003e *amount,\n            })\n            .sum()\n    }\n}\n","traces":[{"line":20,"address":[8143486,8143184],"length":1,"stats":{"Line":1}},{"line":23,"address":[8281926,8281992],"length":1,"stats":{"Line":2}},{"line":31,"address":[8282224,8282826,8282832],"length":1,"stats":{"Line":0}},{"line":32,"address":[8282254],"length":1,"stats":{"Line":0}},{"line":33,"address":[8282270],"length":1,"stats":{"Line":0}},{"line":34,"address":[8282335],"length":1,"stats":{"Line":0}},{"line":36,"address":[8282428,8282407],"length":1,"stats":{"Line":0}},{"line":37,"address":[8282501],"length":1,"stats":{"Line":0}},{"line":38,"address":[8282573],"length":1,"stats":{"Line":0}},{"line":41,"address":[8282583],"length":1,"stats":{"Line":0}},{"line":42,"address":[8282628],"length":1,"stats":{"Line":0}},{"line":43,"address":[8282648],"length":1,"stats":{"Line":0}},{"line":44,"address":[8282711],"length":1,"stats":{"Line":0}},{"line":47,"address":[8282848],"length":1,"stats":{"Line":0}},{"line":48,"address":[8282853],"length":1,"stats":{"Line":0}},{"line":50,"address":[6259280],"length":1,"stats":{"Line":0}},{"line":51,"address":[6259290],"length":1,"stats":{"Line":0}}],"covered":2,"coverable":17},{"path":["/","home","vidyootsenthil","TheValut-nameTBD","node","src","signing.rs"],"content":"use rand::seq::SliceRandom;\nuse std::collections::BTreeMap;\n\nuse frost_secp256k1::rand_core::RngCore;\nuse frost_secp256k1::{self as frost};\nuse hex;\nuse libp2p::{PeerId, request_response};\nuse tracing::{debug, error, info, warn};\n\nuse crate::errors::NodeError;\nuse crate::swarm_manager::{PrivateRequest, PrivateResponse};\nuse crate::{ActiveSigning, NodeState, peer_id_to_identifier};\n\nimpl NodeState {\n    /// Coordinator entrypoint. Start a threshold signing session across the network.\n    /// `message_hex` must be hex-encoded 32-byte sighash.\n    pub fn start_signing_session(\u0026mut self, message_hex: \u0026str) -\u003e Result\u003cOption\u003cu64\u003e, NodeError\u003e {\n        if self.dkg_state.get_private_key().is_none() || self.dkg_state.get_public_key().is_none() {\n            error!(\" DKG not completed  cannot start signing\");\n            return Err(NodeError::Error(\"DKG not completed\".to_string()));\n        }\n\n        let Ok(message) = hex::decode(message_hex.trim()) else {\n            error!(\" Invalid hex message\");\n            return Err(NodeError::Error(\"Invalid hex message\".to_string()));\n        };\n        if message.len() != 32 {\n            error!(\n                \" Message must be 32-byte (sighash)  got {} bytes\",\n                message.len()\n            );\n            return Err(NodeError::Error(\n                \"Message must be 32-byte (sighash)\".to_string(),\n            ));\n        }\n\n        info!(\"Starting signing session for message: {}\", message_hex);\n\n        if self.active_signing.is_some() {\n            error!(\" A signing session is already active\");\n            return Err(NodeError::Error(\n                \"A signing session is already active\".to_string(),\n            ));\n        }\n\n        let sign_id = self.rng.next_u64();\n        let self_identifier = peer_id_to_identifier(\u0026self.peer_id);\n\n        // Select participants: self + first (min_signers -1) peers\n        let required = (self.min_signers - 1) as usize;\n        if self.peers.len() \u003c required {\n            error!(\" Not enough peers  need at least {} others\", required);\n            return Err(NodeError::Error(\"Not enough peers\".to_string()));\n        }\n        // Randomly shuffle peers and pick required number\n        let mut rng_rand = rand::rng();\n        let mut peer_pool = self.peers.clone().into_iter().collect::\u003cVec\u003c_\u003e\u003e();\n        peer_pool.shuffle(\u0026mut rng_rand);\n\n        let selected_peers: Vec\u003cPeerId\u003e = peer_pool.into_iter().take(required).collect();\n\n        let mut participants: Vec\u003c_\u003e = Vec::new();\n        participants.push(self_identifier);\n        for peer in \u0026selected_peers {\n            participants.push(peer_id_to_identifier(peer));\n        }\n\n        // Generate nonces \u0026 commitments for self\n        let key_pkg = match self.dkg_state.get_private_key().as_ref() {\n            Some(key_pkg) =\u003e key_pkg.clone(),\n            None =\u003e {\n                return Err(NodeError::Error(\"No private key found\".to_string()));\n            }\n        };\n        let (nonces, commitments) = frost::round1::commit(key_pkg.signing_share(), \u0026mut self.rng);\n\n        let mut commitments_map = BTreeMap::new();\n        commitments_map.insert(self_identifier, commitments);\n\n        // Save active session\n        self.active_signing = Some(ActiveSigning {\n            sign_id,\n            message: message.clone(),\n            selected_peers: selected_peers.clone(),\n            nonces,\n            commitments: commitments_map,\n            signature_shares: BTreeMap::new(),\n            signing_package: None,\n            is_coordinator: true,\n        });\n\n        // Broadcast SignRequest to chosen peers (skip self)\n        for peer in \u0026selected_peers {\n            let req = PrivateRequest::SignRequest {\n                sign_id,\n                message: message.clone(),\n            };\n            self.network_handle\n                .send_private_request(*peer, req)\n                .map_err(|e| {\n                    NodeError::Error(format!(\"Failed to send private request: {:?}\", e))\n                })?;\n        }\n\n        Ok(Some(sign_id))\n    }\n\n    /// Handle incoming SignRequest (participant side)\n    pub fn handle_sign_request(\n        \u0026mut self,\n        peer: PeerId,\n        sign_id: u64,\n        message: Vec\u003cu8\u003e,\n        channel: request_response::ResponseChannel\u003cPrivateResponse\u003e,\n    ) -\u003e Result\u003c(), NodeError\u003e {\n        if self.dkg_state.get_private_key().is_none() {\n            let _ = self.network_handle.send_private_response(\n                channel,\n                PrivateResponse::Commitments {\n                    sign_id,\n                    commitments: Vec::new(),\n                },\n            );\n            return Ok(());\n        }\n\n        let key_pkg = match self.dkg_state.get_private_key().as_ref() {\n            Some(key_pkg) =\u003e key_pkg.clone(),\n            None =\u003e {\n                return Err(NodeError::Error(\"No private key found\".to_string()));\n            }\n        };\n        let (nonces, commitments) = frost::round1::commit(key_pkg.signing_share(), \u0026mut self.rng);\n\n        // Save session (one at a time for simplicity)\n        self.active_signing = Some(ActiveSigning {\n            sign_id,\n            message: message.clone(),\n            selected_peers: Vec::new(),\n            nonces,\n            commitments: BTreeMap::new(), // not used for participant\n            signature_shares: BTreeMap::new(),\n            signing_package: None,\n            is_coordinator: false,\n        });\n\n        let Ok(commit_bytes) = commitments.serialize() else {\n            return Err(NodeError::Error(\n                \"Failed to serialize commitments\".to_string(),\n            ));\n        };\n\n        let resp = PrivateResponse::Commitments {\n            sign_id,\n            commitments: commit_bytes,\n        };\n        let _ = self.network_handle.send_private_response(channel, resp);\n\n        debug!(\n            \" Provided commitments for sign_id {} to {}\",\n            sign_id, peer\n        );\n\n        Ok(())\n    }\n\n    /// Coordinator receives commitments responses\n    pub fn handle_commitments_response(\n        \u0026mut self,\n        peer: PeerId,\n        sign_id: u64,\n        commitments_bytes: Vec\u003cu8\u003e,\n    ) -\u003e Result\u003c(), NodeError\u003e {\n        let Some(active) = self.active_signing.as_mut() else {\n            return Err(NodeError::Error(\"No active session\".to_string()));\n        };\n        if !active.is_coordinator || active.sign_id != sign_id {\n            return Err(NodeError::Error(\"Session id mismatch\".to_string()));\n        }\n\n        let Ok(commitments) = frost::round1::SigningCommitments::deserialize(\u0026commitments_bytes)\n        else {\n            warn!(\"Failed to deserialize commitments from {}\", peer);\n            return Err(NodeError::Error(\n                \"Failed to deserialize commitments\".to_string(),\n            ));\n        };\n        let identifier = peer_id_to_identifier(\u0026peer);\n        active.commitments.insert(identifier, commitments);\n        debug!(\n            \" Received commitments from {} (total {}/{})\",\n            peer,\n            active.commitments.len(),\n            self.min_signers\n        );\n\n        if active.commitments.len() == self.min_signers as usize {\n            // Build signing package\n            let signing_package =\n                frost::SigningPackage::new(active.commitments.clone(), \u0026active.message);\n            active.signing_package = Some(signing_package.clone());\n            let Ok(pkg_bytes) = signing_package.serialize() else {\n                warn!(\"Failed to serialize signing package\");\n                return Err(NodeError::Error(\n                    \"Failed to serialize signing package\".to_string(),\n                ));\n            };\n\n            // Send package to participants (excluding self)\n            for peer in \u0026active.selected_peers {\n                let req = PrivateRequest::SignPackage {\n                    sign_id,\n                    package: pkg_bytes.clone(),\n                };\n                let _ = self.network_handle.send_private_request(*peer, req);\n            }\n\n            // Generate our signature share\n            let sig_share = frost::round2::sign(\n                \u0026signing_package,\n                \u0026active.nonces,\n                match self.dkg_state.get_private_key().as_ref() {\n                    Some(key_pkg) =\u003e key_pkg,\n                    None =\u003e {\n                        return Err(NodeError::Error(\"No private key found\".to_string()));\n                    }\n                },\n            );\n            match sig_share {\n                Ok(sig_share) =\u003e {\n                    active\n                        .signature_shares\n                        .insert(peer_id_to_identifier(\u0026self.peer_id), sig_share);\n                }\n                Err(e) =\u003e {\n                    return Err(NodeError::Error(format!(\"Failed to sign: {}\", e)));\n                }\n            }\n\n            debug!(\" Distributed signing package for session {}\", sign_id);\n        }\n\n        Ok(())\n    }\n\n    /// Participant handles SignPackage request\n    pub fn handle_sign_package(\n        \u0026mut self,\n        peer: PeerId,\n        sign_id: u64,\n        package_bytes: Vec\u003cu8\u003e,\n        channel: request_response::ResponseChannel\u003cPrivateResponse\u003e,\n    ) -\u003e Result\u003c(), NodeError\u003e {\n        let Some(active) = self.active_signing.as_ref() else {\n            warn!(\"No active session to sign\");\n            return Err(NodeError::Error(\"No active session\".to_string()));\n        };\n        if active.sign_id != sign_id {\n            warn!(\"Session id mismatch\");\n            return Err(NodeError::Error(\"Session id mismatch\".to_string()));\n        }\n\n        let Ok(signing_package) = frost::SigningPackage::deserialize(\u0026package_bytes) else {\n            warn!(\"Failed to deserialize signing package\");\n            return Err(NodeError::Error(\n                \"Failed to deserialize signing package\".to_string(),\n            ));\n        };\n\n        let sig_share = frost::round2::sign(\n            \u0026signing_package,\n            \u0026active.nonces,\n            match self.dkg_state.get_private_key().as_ref() {\n                Some(key_pkg) =\u003e key_pkg,\n                None =\u003e {\n                    return Err(NodeError::Error(\"No private key found\".to_string()));\n                }\n            },\n        );\n        match sig_share {\n            Ok(sig_share) =\u003e {\n                let sig_bytes = sig_share.serialize();\n                let resp = PrivateResponse::SignatureShare {\n                    sign_id,\n                    signature_share: sig_bytes,\n                };\n                let _ = self.network_handle.send_private_response(channel, resp);\n            }\n            Err(e) =\u003e {\n                return Err(NodeError::Error(format!(\"Failed to sign: {}\", e)));\n            }\n        }\n\n        debug!(\n            \"  Sent signature share for session {} to {}\",\n            sign_id, peer\n        );\n\n        Ok(())\n    }\n\n    /// Coordinator handles incoming signature share\n    pub fn handle_signature_share(\n        \u0026mut self,\n        peer: PeerId,\n        sign_id: u64,\n        sig_bytes: Vec\u003cu8\u003e,\n    ) -\u003e Result\u003c(), NodeError\u003e {\n        let Some(active) = self.active_signing.as_mut() else {\n            return Err(NodeError::Error(\"No active session\".to_string()));\n        };\n        if !active.is_coordinator || active.sign_id != sign_id {\n            return Err(NodeError::Error(\"Session id mismatch\".to_string()));\n        }\n\n        let Ok(sig_share) = frost::round2::SignatureShare::deserialize(\u0026sig_bytes) else {\n            warn!(\"Failed to deserialize signature share from {}\", peer);\n            return Err(NodeError::Error(\n                \"Failed to deserialize signature share\".to_string(),\n            ));\n        };\n        let identifier = peer_id_to_identifier(\u0026peer);\n        active.signature_shares.insert(identifier, sig_share);\n        debug!(\n            \" Received signature share from {} (total {}/{})\",\n            peer,\n            active.signature_shares.len(),\n            self.min_signers\n        );\n\n        if active.signature_shares.len() == self.min_signers as usize {\n            let signing_package = match active.signing_package.clone() {\n                Some(signing_package) =\u003e signing_package,\n                None =\u003e {\n                    return Err(NodeError::Error(\"No signing package found\".to_string()));\n                }\n            };\n            let group_sig = frost::aggregate(\n                \u0026signing_package,\n                \u0026active.signature_shares,\n                match self.dkg_state.get_public_key().as_ref() {\n                    Some(public_key) =\u003e public_key,\n                    None =\u003e {\n                        return Err(NodeError::Error(\"No public key found\".to_string()));\n                    }\n                },\n            )\n            .expect(\"Aggregate\");\n            let sig_hex = hex::encode(group_sig.serialize().expect(\"serialize group sig\"));\n            debug!(\n                \" Final FROST signature for session {}: {}\",\n                sign_id, sig_hex\n            );\n\n            // If this signing session corresponds to a pending spend, finalise the transaction.\n            if let Some(pending) = self.pending_spends.remove(\u0026sign_id) {\n                match Self::frost_signature_to_bitcoin(\u0026group_sig) {\n                    Ok(bitcoin_sig) =\u003e {\n                        let mut tx = pending.tx;\n                        let mut witness = bitcoin::witness::Witness::new();\n                        witness.push(bitcoin_sig.as_ref());\n                        if let Some(input) = tx.input.first_mut() {\n                            input.witness = witness;\n                        }\n                        let raw_tx = bitcoin::consensus::encode::serialize(\u0026tx);\n                        debug!(\" Signed transaction (hex): {}\", hex::encode(raw_tx));\n                    }\n                    Err(e) =\u003e debug!(\" Failed to convert signature: {}\", e),\n                }\n            }\n            // Reset\n            self.active_signing = None;\n        }\n\n        Ok(())\n    }\n}\n","traces":[{"line":17,"address":[8805232,8809580,8812169],"length":1,"stats":{"Line":0}},{"line":18,"address":[11803661,11803513,11803366],"length":1,"stats":{"Line":0}},{"line":19,"address":[8805407,8813101,8812826],"length":1,"stats":{"Line":0}},{"line":20,"address":[8812979],"length":1,"stats":{"Line":0}},{"line":23,"address":[8805505,8805644],"length":1,"stats":{"Line":0}},{"line":24,"address":[8812457,8805612,8812182],"length":1,"stats":{"Line":0}},{"line":25,"address":[8812335],"length":1,"stats":{"Line":0}},{"line":27,"address":[11803758,11803837],"length":1,"stats":{"Line":0}},{"line":28,"address":[8805789,8811341,8811796,8811598],"length":1,"stats":{"Line":0}},{"line":32,"address":[8812081],"length":1,"stats":{"Line":0}},{"line":33,"address":[8811564],"length":1,"stats":{"Line":0}},{"line":37,"address":[8805827,8806124,8805761],"length":1,"stats":{"Line":0}},{"line":39,"address":[8806593,8806100],"length":1,"stats":{"Line":0}},{"line":40,"address":[8810558,8810851,8806633],"length":1,"stats":{"Line":0}},{"line":41,"address":[8811246],"length":1,"stats":{"Line":0}},{"line":42,"address":[8810817],"length":1,"stats":{"Line":0}},{"line":46,"address":[8806607,8806680],"length":1,"stats":{"Line":0}},{"line":47,"address":[8806688],"length":1,"stats":{"Line":0}},{"line":50,"address":[8806799,8806718],"length":1,"stats":{"Line":0}},{"line":51,"address":[8806773,8806827],"length":1,"stats":{"Line":0}},{"line":52,"address":[8809993,8809694,8806856],"length":1,"stats":{"Line":0}},{"line":53,"address":[11808656,11808152],"length":1,"stats":{"Line":0}},{"line":56,"address":[8806903,8806837],"length":1,"stats":{"Line":0}},{"line":57,"address":[8806911,8806997],"length":1,"stats":{"Line":0}},{"line":58,"address":[8807131,8807043],"length":1,"stats":{"Line":0}},{"line":60,"address":[8807138],"length":1,"stats":{"Line":0}},{"line":62,"address":[8807267],"length":1,"stats":{"Line":0}},{"line":63,"address":[8807318],"length":1,"stats":{"Line":0}},{"line":64,"address":[8807429],"length":1,"stats":{"Line":0}},{"line":65,"address":[11805703,11807819],"length":1,"stats":{"Line":0}},{"line":69,"address":[8807600],"length":1,"stats":{"Line":0}},{"line":70,"address":[8807689],"length":1,"stats":{"Line":0}},{"line":72,"address":[8807723],"length":1,"stats":{"Line":0}},{"line":75,"address":[8807867],"length":1,"stats":{"Line":0}},{"line":77,"address":[8808009],"length":1,"stats":{"Line":0}},{"line":78,"address":[8808016],"length":1,"stats":{"Line":0}},{"line":81,"address":[8808404,8808711],"length":1,"stats":{"Line":0}},{"line":83,"address":[11806331],"length":1,"stats":{"Line":0}},{"line":84,"address":[8808208],"length":1,"stats":{"Line":0}},{"line":86,"address":[8808279],"length":1,"stats":{"Line":0}},{"line":87,"address":[8808327],"length":1,"stats":{"Line":0}},{"line":88,"address":[8808396],"length":1,"stats":{"Line":0}},{"line":93,"address":[8808808],"length":1,"stats":{"Line":0}},{"line":96,"address":[8808961],"length":1,"stats":{"Line":0}},{"line":98,"address":[8809256,8809480,8809346],"length":1,"stats":{"Line":0}},{"line":99,"address":[8809263],"length":1,"stats":{"Line":0}},{"line":100,"address":[8673056,8673269],"length":1,"stats":{"Line":0}},{"line":101,"address":[8673086,8673130],"length":1,"stats":{"Line":0}},{"line":105,"address":[8809014],"length":1,"stats":{"Line":0}},{"line":109,"address":[8813472,8816342,8815899],"length":1,"stats":{"Line":0}},{"line":116,"address":[8813658,8813558],"length":1,"stats":{"Line":0}},{"line":117,"address":[8816146,8813714],"length":1,"stats":{"Line":0}},{"line":118,"address":[8813725],"length":1,"stats":{"Line":0}},{"line":119,"address":[8816086],"length":1,"stats":{"Line":0}},{"line":121,"address":[8813757],"length":1,"stats":{"Line":0}},{"line":124,"address":[8816216],"length":1,"stats":{"Line":0}},{"line":127,"address":[8813787,8813687],"length":1,"stats":{"Line":0}},{"line":128,"address":[8813843],"length":1,"stats":{"Line":0}},{"line":130,"address":[8813877],"length":1,"stats":{"Line":0}},{"line":133,"address":[8814018],"length":1,"stats":{"Line":0}},{"line":136,"address":[8814363],"length":1,"stats":{"Line":0}},{"line":138,"address":[8814148],"length":1,"stats":{"Line":0}},{"line":139,"address":[8814182],"length":1,"stats":{"Line":0}},{"line":141,"address":[11812453],"length":1,"stats":{"Line":0}},{"line":142,"address":[8814297],"length":1,"stats":{"Line":0}},{"line":143,"address":[8814355],"length":1,"stats":{"Line":0}},{"line":147,"address":[8814777,8814838],"length":1,"stats":{"Line":0}},{"line":148,"address":[8815952],"length":1,"stats":{"Line":0}},{"line":149,"address":[8815913],"length":1,"stats":{"Line":0}},{"line":157,"address":[8815073,8814978],"length":1,"stats":{"Line":0}},{"line":159,"address":[8815380,8815080],"length":1,"stats":{"Line":0}},{"line":164,"address":[11813596],"length":1,"stats":{"Line":0}},{"line":168,"address":[8822448,8820630,8816368],"length":1,"stats":{"Line":0}},{"line":174,"address":[8816539,8816457],"length":1,"stats":{"Line":0}},{"line":175,"address":[8822360,8816613],"length":1,"stats":{"Line":0}},{"line":177,"address":[8816602,8816689],"length":1,"stats":{"Line":0}},{"line":178,"address":[8822264,8816647],"length":1,"stats":{"Line":0}},{"line":181,"address":[8816858,8816714],"length":1,"stats":{"Line":0}},{"line":183,"address":[11819793,11815063,11820050],"length":1,"stats":{"Line":0}},{"line":184,"address":[8822168],"length":1,"stats":{"Line":0}},{"line":185,"address":[11820016],"length":1,"stats":{"Line":0}},{"line":188,"address":[11815132],"length":1,"stats":{"Line":0}},{"line":189,"address":[8816891],"length":1,"stats":{"Line":0}},{"line":190,"address":[8817014,8817610,8817351],"length":1,"stats":{"Line":0}},{"line":197,"address":[8817972,8817322],"length":1,"stats":{"Line":0}},{"line":199,"address":[8818032,8821436],"length":1,"stats":{"Line":0}},{"line":201,"address":[8818268,8818209],"length":1,"stats":{"Line":0}},{"line":202,"address":[8818533,8818472],"length":1,"stats":{"Line":0}},{"line":203,"address":[8820636,8820934],"length":1,"stats":{"Line":0}},{"line":204,"address":[8821329],"length":1,"stats":{"Line":0}},{"line":205,"address":[11819228],"length":1,"stats":{"Line":0}},{"line":210,"address":[8818565,8818652],"length":1,"stats":{"Line":0}},{"line":213,"address":[11817066],"length":1,"stats":{"Line":0}},{"line":215,"address":[11818835],"length":1,"stats":{"Line":0}},{"line":221,"address":[11817119],"length":1,"stats":{"Line":0}},{"line":222,"address":[11817131],"length":1,"stats":{"Line":0}},{"line":223,"address":[8818928],"length":1,"stats":{"Line":0}},{"line":225,"address":[8818974],"length":1,"stats":{"Line":0}},{"line":229,"address":[8819118],"length":1,"stats":{"Line":0}},{"line":230,"address":[11817534],"length":1,"stats":{"Line":0}},{"line":231,"address":[11817582,11817630],"length":1,"stats":{"Line":0}},{"line":233,"address":[8819284],"length":1,"stats":{"Line":0}},{"line":235,"address":[8819132],"length":1,"stats":{"Line":0}},{"line":236,"address":[11818535,11817488],"length":1,"stats":{"Line":0}},{"line":240,"address":[11818035,11817713],"length":1,"stats":{"Line":0}},{"line":243,"address":[11816272],"length":1,"stats":{"Line":0}},{"line":247,"address":[11823077,11825495,11820800],"length":1,"stats":{"Line":0}},{"line":254,"address":[11820882,11820973],"length":1,"stats":{"Line":0}},{"line":255,"address":[8822715,8826559,8826302],"length":1,"stats":{"Line":0}},{"line":256,"address":[11825328,11824901],"length":1,"stats":{"Line":0}},{"line":258,"address":[8822696],"length":1,"stats":{"Line":0}},{"line":259,"address":[8825555,8825812,8822781],"length":1,"stats":{"Line":0}},{"line":260,"address":[11824583,11824154],"length":1,"stats":{"Line":0}},{"line":263,"address":[11821168,11821262,11821094],"length":1,"stats":{"Line":0}},{"line":264,"address":[11823083,11823417],"length":1,"stats":{"Line":0}},{"line":265,"address":[11823836],"length":1,"stats":{"Line":0}},{"line":266,"address":[11823383],"length":1,"stats":{"Line":0}},{"line":272,"address":[8822978],"length":1,"stats":{"Line":0}},{"line":273,"address":[11821405,11821338],"length":1,"stats":{"Line":0}},{"line":274,"address":[11821487],"length":1,"stats":{"Line":0}},{"line":276,"address":[8823177],"length":1,"stats":{"Line":0}},{"line":280,"address":[11821677],"length":1,"stats":{"Line":0}},{"line":281,"address":[11821769],"length":1,"stats":{"Line":0}},{"line":282,"address":[11821817],"length":1,"stats":{"Line":0}},{"line":287,"address":[11821912],"length":1,"stats":{"Line":0}},{"line":289,"address":[11821691],"length":1,"stats":{"Line":0}},{"line":290,"address":[11822859,11821739],"length":1,"stats":{"Line":0}},{"line":294,"address":[8823609,8823952],"length":1,"stats":{"Line":0}},{"line":299,"address":[8823927],"length":1,"stats":{"Line":0}},{"line":303,"address":[11833004,11830975,11825520],"length":1,"stats":{"Line":0}},{"line":309,"address":[11825609,11825711],"length":1,"stats":{"Line":0}},{"line":310,"address":[8827397,8834448],"length":1,"stats":{"Line":0}},{"line":312,"address":[11825861,11825774],"length":1,"stats":{"Line":0}},{"line":313,"address":[8827431,8834352],"length":1,"stats":{"Line":0}},{"line":316,"address":[8827609,8827498],"length":1,"stats":{"Line":0}},{"line":317,"address":[11832021,11832278,11825962],"length":1,"stats":{"Line":0}},{"line":318,"address":[8834256],"length":1,"stats":{"Line":0}},{"line":319,"address":[8833776],"length":1,"stats":{"Line":0}},{"line":322,"address":[11826049],"length":1,"stats":{"Line":0}},{"line":323,"address":[8827680],"length":1,"stats":{"Line":0}},{"line":324,"address":[8828352],"length":1,"stats":{"Line":0}},{"line":331,"address":[8828106,8828756],"length":1,"stats":{"Line":0}},{"line":332,"address":[11827216],"length":1,"stats":{"Line":0}},{"line":333,"address":[8828892],"length":1,"stats":{"Line":0}},{"line":335,"address":[11827464],"length":1,"stats":{"Line":0}},{"line":340,"address":[8829020],"length":1,"stats":{"Line":0}},{"line":341,"address":[11827438,11827725,11827649],"length":1,"stats":{"Line":0}},{"line":342,"address":[8829356],"length":1,"stats":{"Line":0}},{"line":344,"address":[8829402],"length":1,"stats":{"Line":0}},{"line":349,"address":[8829606],"length":1,"stats":{"Line":0}},{"line":350,"address":[8829678,8830063,8829757],"length":1,"stats":{"Line":0}},{"line":356,"address":[8830030,8830568,8833309],"length":1,"stats":{"Line":0}},{"line":357,"address":[8830693,8830759],"length":1,"stats":{"Line":0}},{"line":358,"address":[8830842],"length":1,"stats":{"Line":0}},{"line":359,"address":[8830906],"length":1,"stats":{"Line":0}},{"line":360,"address":[8830986],"length":1,"stats":{"Line":0}},{"line":361,"address":[11829489,11829566],"length":1,"stats":{"Line":0}},{"line":362,"address":[8831451,8831129],"length":1,"stats":{"Line":0}},{"line":363,"address":[8831372,8831266],"length":1,"stats":{"Line":0}},{"line":365,"address":[8831453,8831337],"length":1,"stats":{"Line":0}},{"line":366,"address":[8831821,8831537,8831461],"length":1,"stats":{"Line":0}},{"line":368,"address":[8832561,8830779],"length":1,"stats":{"Line":0}},{"line":372,"address":[8833400,8833348],"length":1,"stats":{"Line":0}},{"line":375,"address":[8828784],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":164},{"path":["/","home","vidyootsenthil","TheValut-nameTBD","node","src","start_node.rs"],"content":"use crate::{\n    NodeState,\n    errors::NodeError,\n    grpc::grpc_handler::NodeControlService,\n    key_manager::{get_config, get_key_file_path, load_and_decrypt_keypair},\n    swarm_manager::build_swarm,\n};\nuse std::path::{Path, PathBuf};\nuse tonic::transport::Server;\nuse tracing::{error, info};\nuse tracing_appender::rolling::{RollingFileAppender, Rotation};\nuse tracing_subscriber::{EnvFilter, fmt, prelude::*};\n\npub async fn start_node(\n    max_signers: Option\u003cu16\u003e,\n    min_signers: Option\u003cu16\u003e,\n    config_filepath: Option\u003cString\u003e,\n    grpc_port: Option\u003cu16\u003e,\n    log_file: Option\u003cPathBuf\u003e,\n) -\u003e Result\u003c(), NodeError\u003e {\n    // Initialize logging\n    let env_filter = EnvFilter::try_from_default_env().unwrap_or_else(|_| EnvFilter::new(\"info\"));\n\n    let registry = tracing_subscriber::registry().with(env_filter);\n\n    let config = match get_config(config_filepath.clone()) {\n        Ok(config) =\u003e config,\n        Err(e) =\u003e {\n            error!(\"Failed to get config: {}\", e);\n            return Err(e);\n        }\n    };\n\n    if let Some(log_path) = config.log_file_path.clone().or(log_file) {\n        // File logging\n        let log_dir = Path::new(\u0026log_path);\n\n        if !log_dir.exists() {\n            info!(\"Creating log directory: {:?}\", log_dir);\n            if let Err(e) = std::fs::create_dir_all(log_dir) {\n                error!(\n                    \"Failed to create log directory {}: {}\",\n                    log_dir.display(),\n                    e\n                );\n                return Err(NodeError::Error(e.to_string()));\n            }\n        }\n\n        let file_appender = RollingFileAppender::new(Rotation::DAILY, log_dir, \"node.log\");\n\n        let file_layer = fmt::layer()\n            .with_writer(file_appender)\n            .with_ansi(false)\n            .with_target(true)\n            .with_thread_ids(true)\n            .with_thread_names(true);\n\n        let console_layer = fmt::layer()\n            .with_writer(std::io::stdout)\n            .with_ansi(true)\n            .with_target(false);\n\n        registry.with(file_layer).with(console_layer).init();\n        info!(\n            \"Logging initialized with file output: {}\",\n            log_path.display()\n        );\n    } else {\n        // Console-only logging\n        let console_layer = fmt::layer()\n            .with_writer(std::io::stdout)\n            .with_ansi(true)\n            .with_target(false);\n\n        registry.with(console_layer).init();\n        info!(\"Logging initialized with console output only\");\n    }\n\n    let config_file_path = if let Some(path) = config_filepath.clone() {\n        path\n    } else {\n        match get_key_file_path() {\n            Ok(path) =\u003e path.to_string_lossy().to_string(),\n            Err(e) =\u003e {\n                error!(\"Failed to get config file path: {}\", e);\n                std::process::exit(1);\n            }\n        }\n    };\n\n    let keypair = match load_and_decrypt_keypair(\u0026config) {\n        Ok(kp) =\u003e kp,\n        Err(e) =\u003e {\n            error!(\"Failed to decrypt key: {}\", e);\n            return Err(e);\n        }\n    };\n\n    let max_signers = max_signers.unwrap_or(5);\n    let min_signers = min_signers.unwrap_or(3);\n\n    let allowed_peers = config.allowed_peers;\n\n    let (network_handle, mut swarm, network_events_stream) =\n        build_swarm(keypair.clone(), allowed_peers.clone()).expect(\"Failed to build swarm\");\n\n    let mut node_state = NodeState::new_from_config(\n        network_handle,\n        allowed_peers,\n        min_signers,\n        max_signers,\n        config_file_path,\n        network_events_stream,\n    )\n    .expect(\"Failed to create node\");\n\n    let network_handle = node_state.network_handle.clone();\n\n    let swarm_handle = tokio::spawn(async move {\n        swarm.start().await;\n    });\n\n    let grpc_handle = tokio::spawn(async move {\n        let addr = format!(\"0.0.0.0:{}\", grpc_port.unwrap_or(50051))\n            .parse()\n            .unwrap();\n\n        let node_control_service = NodeControlService::new(network_handle);\n\n        info!(\"gRPC server listening on {}\", addr);\n\n        Server::builder()\n            .add_service(node_control_service.into_server())\n            .serve(addr)\n            .await\n            .expect(\"gRPC server failed\");\n    });\n\n    let main_loop_handle = tokio::spawn(async move { node_state.start().await });\n\n    // Wait for either task to complete (they should run indefinitely)\n    tokio::select! {\n        result = grpc_handle =\u003e {\n            match result {\n                Ok(_) =\u003e info!(\"gRPC server stopped\"),\n                Err(e) =\u003e error!(\"gRPC server error: {}\", e),\n            }\n        }\n        result = swarm_handle =\u003e {\n            match result {\n                Ok(_) =\u003e info!(\"Swarm stopped\"),\n                Err(e) =\u003e error!(\"Swarm error: {}\", e),\n            }\n        }\n        result = main_loop_handle =\u003e {\n            match result {\n                Ok(Ok(_)) =\u003e info!(\"Main loop stopped\"),\n                Ok(Err(e)) =\u003e error!(\"Main loop error: {}\", e),\n                Err(e) =\u003e error!(\"Main loop task error: {}\", e),\n            }\n        }\n    }\n\n    Ok(())\n}\n","traces":[{"line":14,"address":[10324976],"length":1,"stats":{"Line":0}},{"line":22,"address":[7367509,7386800,7386816,7367384],"length":1,"stats":{"Line":0}},{"line":24,"address":[7367636,7367554],"length":1,"stats":{"Line":0}},{"line":26,"address":[7367735,7367845],"length":1,"stats":{"Line":0}},{"line":27,"address":[7368004],"length":1,"stats":{"Line":0}},{"line":28,"address":[8310573],"length":1,"stats":{"Line":0}},{"line":29,"address":[7378267,7378633,7367921],"length":1,"stats":{"Line":0}},{"line":30,"address":[7378532],"length":1,"stats":{"Line":0}},{"line":34,"address":[7368059,7368141],"length":1,"stats":{"Line":0}},{"line":36,"address":[7368401,7368296],"length":1,"stats":{"Line":0}},{"line":38,"address":[8311109],"length":1,"stats":{"Line":0}},{"line":39,"address":[8311243,8311152,8311546],"length":1,"stats":{"Line":0}},{"line":40,"address":[7368812,7369316],"length":1,"stats":{"Line":0}},{"line":41,"address":[7369949],"length":1,"stats":{"Line":0}},{"line":46,"address":[8313051,8312441],"length":1,"stats":{"Line":0}},{"line":50,"address":[8311180,8313220],"length":1,"stats":{"Line":0}},{"line":52,"address":[7370524,7370647],"length":1,"stats":{"Line":0}},{"line":53,"address":[7370577],"length":1,"stats":{"Line":0}},{"line":59,"address":[8313507,8313567],"length":1,"stats":{"Line":0}},{"line":64,"address":[8313655],"length":1,"stats":{"Line":0}},{"line":65,"address":[7371088,7371710,7371426],"length":1,"stats":{"Line":0}},{"line":71,"address":[7372072],"length":1,"stats":{"Line":0}},{"line":76,"address":[7372155],"length":1,"stats":{"Line":0}},{"line":77,"address":[8315050],"length":1,"stats":{"Line":0}},{"line":80,"address":[7371990,7373155,7373007],"length":1,"stats":{"Line":0}},{"line":81,"address":[8315892],"length":1,"stats":{"Line":0}},{"line":83,"address":[7373214],"length":1,"stats":{"Line":0}},{"line":84,"address":[7373298],"length":1,"stats":{"Line":0}},{"line":85,"address":[7373235],"length":1,"stats":{"Line":0}},{"line":86,"address":[7377476,7377760,7373267],"length":1,"stats":{"Line":0}},{"line":87,"address":[7377741],"length":1,"stats":{"Line":0}},{"line":92,"address":[7373176,7373608],"length":1,"stats":{"Line":0}},{"line":93,"address":[7373685],"length":1,"stats":{"Line":0}},{"line":94,"address":[8316430],"length":1,"stats":{"Line":0}},{"line":95,"address":[7373654,7376910,7376559],"length":1,"stats":{"Line":0}},{"line":96,"address":[7376824],"length":1,"stats":{"Line":0}},{"line":100,"address":[8316709,8316604],"length":1,"stats":{"Line":0}},{"line":101,"address":[7373909],"length":1,"stats":{"Line":0}},{"line":103,"address":[8316763],"length":1,"stats":{"Line":0}},{"line":105,"address":[7374300],"length":1,"stats":{"Line":0}},{"line":109,"address":[8317323],"length":1,"stats":{"Line":0}},{"line":110,"address":[7374614],"length":1,"stats":{"Line":0}},{"line":113,"address":[8317487],"length":1,"stats":{"Line":0}},{"line":114,"address":[7374714],"length":1,"stats":{"Line":0}},{"line":118,"address":[7374916,7375009],"length":1,"stats":{"Line":0}},{"line":120,"address":[7386912,7375202,7375024,7386937,7387007,7387400,7387322,7387149],"length":1,"stats":{"Line":0}},{"line":121,"address":[7386990,7387091,7387034,7387175],"length":1,"stats":{"Line":0}},{"line":124,"address":[7387451,7389275,7387594,7375461,7387408,7375225,7389628],"length":1,"stats":{"Line":0}},{"line":125,"address":[8330759,8330973,8330579],"length":1,"stats":{"Line":0}},{"line":127,"address":[7387847,7387954],"length":1,"stats":{"Line":0}},{"line":129,"address":[7388132,7387973],"length":1,"stats":{"Line":0}},{"line":131,"address":[7388147,7388221,7388470],"length":1,"stats":{"Line":0}},{"line":133,"address":[8332622,8332258,8331996,8332564,8332199,8331524,8332320],"length":1,"stats":{"Line":0}},{"line":134,"address":[7388932],"length":1,"stats":{"Line":0}},{"line":135,"address":[8332226],"length":1,"stats":{"Line":0}},{"line":136,"address":[8566417],"length":1,"stats":{"Line":0}},{"line":137,"address":[7389058,7389536],"length":1,"stats":{"Line":0}},{"line":140,"address":[7389959,7390174,7389825,7389715,7389680,7375653,7375484],"length":1,"stats":{"Line":0}},{"line":143,"address":[7379858,7375800],"length":1,"stats":{"Line":0}},{"line":165,"address":[7380584],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":60},{"path":["/","home","vidyootsenthil","TheValut-nameTBD","node","src","swarm_manager.rs"],"content":"use futures::StreamExt;\nuse libp2p::{PeerId, request_response::ResponseChannel, swarm::SwarmEvent};\nuse std::{\n    collections::{BTreeMap, HashSet, hash_map::DefaultHasher},\n    future::Future,\n    hash::{Hash, Hasher},\n    pin::Pin,\n    time::Duration,\n};\nuse tracing::info;\n\nuse frost_secp256k1::keys::dkg::round2;\nuse libp2p::{\n    StreamProtocol, Swarm, gossipsub, mdns, noise, request_response, swarm::NetworkBehaviour, tcp,\n    yamux,\n};\nuse libp2p::{identity::Keypair, request_response::cbor};\nuse tokio::{\n    io,\n    sync::mpsc::{self, UnboundedReceiver, unbounded_channel},\n};\n\nuse crate::{\n    PeerData,\n    errors::{NetworkError, NodeError},\n    protocol::block::Block,\n};\n\n#[derive(Debug, serde::Serialize, serde::Deserialize)]\npub struct PingBody {\n    pub message: String,\n}\n\n#[derive(Debug, serde::Serialize, serde::Deserialize)]\npub enum PrivateRequest {\n    Ping(PingBody),\n    Round2Package(round2::Package),\n    SignRequest { sign_id: u64, message: Vec\u003cu8\u003e },\n    SignPackage { sign_id: u64, package: Vec\u003cu8\u003e },\n    InsertBlock { block: Block },\n    StartSigningSession { hex_message: String },\n    Spend { amount_sat: u64 },\n    GetFrostPublicKey,\n}\n\n#[derive(Debug, serde::Serialize, serde::Deserialize)]\npub enum PrivateResponse {\n    Pong,\n    Commitments {\n        sign_id: u64,\n        commitments: Vec\u003cu8\u003e,\n    },\n    SignatureShare {\n        sign_id: u64,\n        signature_share: Vec\u003cu8\u003e,\n    },\n\n    StartSigningSession {\n        sign_id: u64,\n    },\n    SpendRequestSent {\n        sighash: String,\n    },\n    GetFrostPublicKey {\n        public_key: String,\n    },\n}\n\n#[derive(NetworkBehaviour)]\npub struct MyBehaviour {\n    pub gossipsub: gossipsub::Behaviour,\n    pub mdns: mdns::tokio::Behaviour,\n    pub request_response: cbor::Behaviour\u003cPrivateRequest, PrivateResponse\u003e,\n}\n\npub enum NetworkMessage {\n    SendBroadcast {\n        topic: gossipsub::IdentTopic,\n        message: Vec\u003cu8\u003e,\n    },\n    SendPrivateRequest(PeerId, PrivateRequest),\n    SendPrivateResponse(ResponseChannel\u003cPrivateResponse\u003e, PrivateResponse),\n    SendSelfRequest {\n        request: PrivateRequest,\n        response_channel: Option\u003cmpsc::UnboundedSender\u003cPrivateResponse\u003e\u003e,\n    },\n}\n\ntype NetworkResponseFuture =\n    Pin\u003cBox\u003cdyn Future\u003cOutput = Result\u003cPrivateResponse, NetworkError\u003e\u003e + Send\u003e\u003e;\n\n#[derive(Debug, Clone)]\npub struct NetworkHandle {\n    peer_id: PeerId,\n    tx: mpsc::UnboundedSender\u003cNetworkMessage\u003e,\n}\n\nimpl NetworkHandle {\n    pub fn peer_id(\u0026self) -\u003e PeerId {\n        self.peer_id\n    }\n\n    pub fn send_broadcast(\n        \u0026self,\n        topic: gossipsub::IdentTopic,\n        message: Vec\u003cu8\u003e,\n    ) -\u003e Result\u003c(), NetworkError\u003e {\n        let network_message = NetworkMessage::SendBroadcast { topic, message };\n        self.tx\n            .send(network_message)\n            .map_err(|e| NetworkError::SendError(e.to_string()))\n    }\n\n    pub fn send_private_request(\n        \u0026self,\n        peer_id: PeerId,\n        request: PrivateRequest,\n    ) -\u003e Result\u003c(), NetworkError\u003e {\n        let network_message = NetworkMessage::SendPrivateRequest(peer_id, request);\n        self.tx\n            .send(network_message)\n            .map_err(|e| NetworkError::SendError(e.to_string()))\n    }\n\n    pub fn send_private_response(\n        \u0026self,\n        channel: ResponseChannel\u003cPrivateResponse\u003e,\n        response: PrivateResponse,\n    ) -\u003e Result\u003c(), NetworkError\u003e {\n        let network_message = NetworkMessage::SendPrivateResponse(channel, response);\n        self.tx\n            .send(network_message)\n            .map_err(|e| NetworkError::SendError(e.to_string()))\n    }\n\n    pub fn send_self_request(\n        \u0026self,\n        request: PrivateRequest,\n        sync: bool,\n    ) -\u003e Result\u003cOption\u003cNetworkResponseFuture\u003e, NetworkError\u003e {\n        if sync {\n            let (tx, mut rx) = unbounded_channel::\u003cPrivateResponse\u003e();\n\n            let network_message = NetworkMessage::SendSelfRequest {\n                request,\n                response_channel: Some(tx),\n            };\n\n            self.tx\n                .send(network_message)\n                .map_err(|e| NetworkError::SendError(e.to_string()))?;\n\n            Ok(Some(Box::pin(async move {\n                rx.recv().await.ok_or(NetworkError::RecvError)\n            })))\n        } else {\n            let network_message = NetworkMessage::SendSelfRequest {\n                request,\n                response_channel: None,\n            };\n\n            self.tx\n                .send(network_message)\n                .map_err(|e| NetworkError::SendError(e.to_string()))?;\n\n            Ok(None)\n        }\n    }\n}\n\npub enum NetworkEvent {\n    SwarmEvent(SwarmEvent\u003cMyBehaviourEvent\u003e),\n    NetworkMessage(NetworkMessage),\n}\n\npub struct SwarmManager {\n    pub inner: Swarm\u003cMyBehaviour\u003e,\n\n    pub network_manager_rx: mpsc::UnboundedReceiver\u003cNetworkMessage\u003e,\n    pub network_events: mpsc::UnboundedSender\u003cNetworkEvent\u003e,\n\n    pub allowed_peers: Vec\u003cPeerId\u003e,\n    pub peers_to_names: BTreeMap\u003cPeerId, String\u003e,\n\n    pub live_peers: HashSet\u003cPeerId\u003e,\n\n    pub round1_topic: gossipsub::IdentTopic,\n    pub start_dkg_topic: gossipsub::IdentTopic,\n}\n\nimpl SwarmManager {\n    pub fn new(\n        mut swarm: Swarm\u003cMyBehaviour\u003e,\n        peer_data: Vec\u003cPeerData\u003e,\n    ) -\u003e Result\u003c(Self, NetworkHandle, UnboundedReceiver\u003cNetworkEvent\u003e), NodeError\u003e {\n        let (send_commands, receiving_commands) = unbounded_channel::\u003cNetworkMessage\u003e();\n\n        let (network_events_emitter, network_events_stream) = unbounded_channel::\u003cNetworkEvent\u003e();\n\n        let network_handle = NetworkHandle {\n            peer_id: *swarm.local_peer_id(),\n            tx: send_commands,\n        };\n\n        // Read full lines from stdin\n        let round1_topic = gossipsub::IdentTopic::new(\"round1_topic\");\n        swarm\n            .behaviour_mut()\n            .gossipsub\n            .subscribe(\u0026round1_topic)\n            .map_err(|e| NodeError::Error(e.to_string()))?;\n\n        let allowed_peers: Vec\u003cPeerId\u003e = peer_data\n            .iter()\n            .map(|peer| peer.public_key.parse().unwrap())\n            .collect();\n\n        let peers_to_names: BTreeMap\u003cPeerId, String\u003e = peer_data\n            .iter()\n            .map(|peer| (peer.public_key.parse().unwrap(), peer.name.clone()))\n            .collect();\n\n        let start_dkg_topic = gossipsub::IdentTopic::new(\"start-dkg\");\n        swarm\n            .behaviour_mut()\n            .gossipsub\n            .subscribe(\u0026start_dkg_topic)\n            .map_err(|e| NodeError::Error(e.to_string()))?;\n\n        Ok((\n            Self {\n                round1_topic,\n                live_peers: HashSet::new(),\n                start_dkg_topic,\n                inner: swarm,\n                network_manager_rx: receiving_commands,\n                network_events: network_events_emitter,\n                allowed_peers,\n                peers_to_names,\n            },\n            network_handle,\n            network_events_stream,\n        ))\n    }\n\n    pub fn peer_name(\u0026self, peer_id: \u0026PeerId) -\u003e String {\n        self.peers_to_names\n            .get(peer_id)\n            .unwrap_or(\u0026peer_id.to_string())\n            .clone()\n    }\n\n    pub async fn start(\u0026mut self) {\n        info!(\"Starting swarm manager\");\n        loop {\n            tokio::select! {\n                send_message = self.network_manager_rx.recv() =\u003e match send_message {\n                    Some(NetworkMessage::SendBroadcast { topic, message }) =\u003e {\n                        let _ = self.inner\n                            .behaviour_mut()\n                            .gossipsub\n                            .publish(topic, message);\n                    }\n                    Some(NetworkMessage::SendPrivateRequest(peer_id, request)) =\u003e {\n                        self.inner\n                            .behaviour_mut()\n                            .request_response\n                            .send_request(\u0026peer_id, request);\n                    }\n                    Some(NetworkMessage::SendPrivateResponse(channel, response)) =\u003e {\n                        let _ = self.inner\n                            .behaviour_mut()\n                            .request_response\n                            .send_response(channel, response);\n                    }\n                    Some(message) =\u003e {\n                        self.network_events.send(NetworkEvent::NetworkMessage(message)).unwrap();\n                    }\n                    _ =\u003e {\n                    }\n                },\n                event = self.inner.select_next_some() =\u003e {\n                    match \u0026event {\n                        SwarmEvent::Behaviour(MyBehaviourEvent::Mdns(mdns::Event::Discovered(list))) =\u003e {\n                            for (peer_id, _multiaddr) in list {\n                                if self.allowed_peers.contains(peer_id) {\n                                    info!(\"Discovered peer: {}\", self.peer_name(peer_id));\n                                    self.live_peers.insert(*peer_id);\n                                    self.inner.behaviour_mut().gossipsub.add_explicit_peer(peer_id);\n                                }\n                            }\n                            self.network_events.send(NetworkEvent::SwarmEvent(event)).unwrap();\n                        },\n                        SwarmEvent::Behaviour(MyBehaviourEvent::Mdns(mdns::Event::Expired(list))) =\u003e {\n                            for (peer_id, _multiaddr) in list {\n                                if self.allowed_peers.contains(peer_id) {\n                                    info!(\"Peer expired: {}\", self.peer_name(peer_id));\n                                    self.live_peers.retain(|p| *p != *peer_id);\n                                    self.inner.behaviour_mut().gossipsub.remove_explicit_peer(peer_id);\n                                }\n                            }\n                            self.network_events.send(NetworkEvent::SwarmEvent(event)).unwrap();\n                        },\n                        _ =\u003e {\n                            self.network_events.send(NetworkEvent::SwarmEvent(event)).unwrap();\n                        }\n                    }\n                }\n\n            }\n        }\n    }\n}\n\npub fn build_swarm(\n    keypair: Keypair,\n    peer_data: Vec\u003cPeerData\u003e,\n) -\u003e Result\u003c(NetworkHandle, SwarmManager, UnboundedReceiver\u003cNetworkEvent\u003e), NodeError\u003e {\n    let mut swarm = libp2p::SwarmBuilder::with_existing_identity(keypair)\n        .with_tokio()\n        .with_tcp(\n            tcp::Config::default(),\n            noise::Config::new,\n            yamux::Config::default,\n        )\n        .map_err(|e| NodeError::Error(format!(\"Failed to add tcp {}\", e)))?\n        .with_quic()\n        .with_behaviour(|key| {\n            // To content-address message, we can take the hash of message and use it as an ID.\n            let message_id_fn = |message: \u0026gossipsub::Message| {\n                let mut s = DefaultHasher::new();\n                message.data.hash(\u0026mut s);\n                gossipsub::MessageId::from(s.finish().to_string())\n            };\n\n            let gossipsub_config = gossipsub::ConfigBuilder::default()\n                .heartbeat_interval(Duration::from_secs(10)) // This is set to aid debugging by not cluttering the log space\n                .validation_mode(gossipsub::ValidationMode::Strict) // This sets the kind of message validation. The default is Strict (enforce message signing)\n                .message_id_fn(message_id_fn) // content-address messages. No two messages of the same content will be propagated.\n                .mesh_n_low(1) // Minimum number of peers in mesh network (default is 4)\n                .mesh_n_high(12) // Maximum number of peers in mesh network\n                .mesh_n(3) // Target number of peers in mesh network (default is 6)\n                .mesh_outbound_min(1) // Minimum outbound connections (default is 2)\n                .gossip_lazy(3) // Number of peers to gossip to (default is 6)\n                .flood_publish(true) // Always flood publish messages to all peers, regardless of mesh\n                .build()\n                .map_err(io::Error::other)?; // Temporary hack because `build` does not return a proper `std::error::Error`.\n\n            let gossipsub = gossipsub::Behaviour::new(\n                gossipsub::MessageAuthenticity::Signed(key.clone()),\n                gossipsub_config,\n            )?;\n\n            let mdns =\n                mdns::tokio::Behaviour::new(mdns::Config::default(), key.public().to_peer_id())?;\n\n            let request_response = cbor::Behaviour::new(\n                [(\n                    StreamProtocol::new(\"/direct-message/1.0.0\"),\n                    request_response::ProtocolSupport::Full,\n                )],\n                request_response::Config::default(),\n            );\n\n            Ok(MyBehaviour {\n                gossipsub,\n                mdns,\n                request_response,\n            })\n        })\n        .map_err(|e| NodeError::Error(format!(\"Failed to add behaviour {}\", e)))?\n        .with_swarm_config(|c| c.with_idle_connection_timeout(Duration::from_secs(60)))\n        .build();\n\n    swarm\n        .listen_on(\n            \"/ip4/0.0.0.0/udp/0/quic-v1\"\n                .parse()\n                .expect(\"Failed to deserialize message\"),\n        )\n        .map_err(|e| NodeError::Error(format!(\"Failed to listen on quic {}\", e)))?;\n\n    swarm\n        .listen_on(\n            \"/ip4/0.0.0.0/tcp/0\"\n                .parse()\n                .expect(\"Failed to deserialize message\"),\n        )\n        .map_err(|e| NodeError::Error(format!(\"Failed to listen on tcp {}\", e)))?;\n\n    let (swarm_manager, network, network_events_stream) = SwarmManager::new(swarm, peer_data)\n        .map_err(|e| NodeError::Error(format!(\"Failed to create swarm manager: {}\", e)))?;\n\n    Ok((network, swarm_manager, network_events_stream))\n}\n","traces":[{"line":99,"address":[10520864],"length":1,"stats":{"Line":0}},{"line":100,"address":[7857713],"length":1,"stats":{"Line":0}},{"line":103,"address":[7857744],"length":1,"stats":{"Line":0}},{"line":108,"address":[7857768],"length":1,"stats":{"Line":0}},{"line":109,"address":[7857835],"length":1,"stats":{"Line":0}},{"line":111,"address":[6683840,6683863],"length":1,"stats":{"Line":0}},{"line":114,"address":[7857888],"length":1,"stats":{"Line":0}},{"line":119,"address":[7857936],"length":1,"stats":{"Line":0}},{"line":120,"address":[10521148],"length":1,"stats":{"Line":0}},{"line":122,"address":[6683991,6683968],"length":1,"stats":{"Line":0}},{"line":125,"address":[7858032],"length":1,"stats":{"Line":0}},{"line":130,"address":[7858083],"length":1,"stats":{"Line":0}},{"line":131,"address":[7858127],"length":1,"stats":{"Line":0}},{"line":133,"address":[6684096,6684119],"length":1,"stats":{"Line":0}},{"line":136,"address":[10522769,10522794,10521360],"length":1,"stats":{"Line":0}},{"line":141,"address":[7859450,7858225],"length":1,"stats":{"Line":0}},{"line":142,"address":[7858839,7858547],"length":1,"stats":{"Line":0}},{"line":146,"address":[7858956],"length":1,"stats":{"Line":0}},{"line":149,"address":[10522315,10522508,10522380],"length":1,"stats":{"Line":0}},{"line":151,"address":[6684247,6684224],"length":1,"stats":{"Line":0}},{"line":153,"address":[9832675,9832640,9832746,9832902,9833281,9833192],"length":1,"stats":{"Line":0}},{"line":154,"address":[6684481,6684437,6684624,6684538],"length":1,"stats":{"Line":0}},{"line":162,"address":[10522021,10521708,10521800,10521928],"length":1,"stats":{"Line":0}},{"line":164,"address":[9833296,9833314],"length":1,"stats":{"Line":0}},{"line":166,"address":[7858755],"length":1,"stats":{"Line":0}},{"line":192,"address":[7862231,7861937,7859584],"length":1,"stats":{"Line":0}},{"line":196,"address":[7859683,7859794],"length":1,"stats":{"Line":0}},{"line":198,"address":[7859905,7859818],"length":1,"stats":{"Line":0}},{"line":201,"address":[7859921,7859984],"length":1,"stats":{"Line":0}},{"line":206,"address":[7860147],"length":1,"stats":{"Line":0}},{"line":207,"address":[7860222,7860307,7862007,7860437],"length":1,"stats":{"Line":0}},{"line":211,"address":[9833440,9833458],"length":1,"stats":{"Line":0}},{"line":213,"address":[7860484],"length":1,"stats":{"Line":0}},{"line":215,"address":[6685232,6685275],"length":1,"stats":{"Line":0}},{"line":218,"address":[7860689,7860618],"length":1,"stats":{"Line":0}},{"line":220,"address":[6685344,6685388],"length":1,"stats":{"Line":0}},{"line":223,"address":[7860758],"length":1,"stats":{"Line":0}},{"line":224,"address":[7860903,7861033,7860833],"length":1,"stats":{"Line":0}},{"line":228,"address":[6685536,6685559],"length":1,"stats":{"Line":0}},{"line":230,"address":[7861713],"length":1,"stats":{"Line":0}},{"line":231,"address":[7861372],"length":1,"stats":{"Line":0}},{"line":232,"address":[7861072],"length":1,"stats":{"Line":0}},{"line":233,"address":[7861112],"length":1,"stats":{"Line":0}},{"line":234,"address":[10524547],"length":1,"stats":{"Line":0}},{"line":235,"address":[7861211],"length":1,"stats":{"Line":0}},{"line":236,"address":[7861269],"length":1,"stats":{"Line":0}},{"line":237,"address":[7861282],"length":1,"stats":{"Line":0}},{"line":238,"address":[7861295],"length":1,"stats":{"Line":0}},{"line":239,"address":[7861327],"length":1,"stats":{"Line":0}},{"line":241,"address":[7861586],"length":1,"stats":{"Line":0}},{"line":242,"address":[7861682],"length":1,"stats":{"Line":0}},{"line":246,"address":[10525680,10525875,10525881],"length":1,"stats":{"Line":0}},{"line":247,"address":[7862369,7862322,7862423],"length":1,"stats":{"Line":0}},{"line":249,"address":[10525756],"length":1,"stats":{"Line":0}},{"line":253,"address":[6685664,6685932,6685710,6688429,6686731,6685964],"length":1,"stats":{"Line":0}},{"line":254,"address":[6685904,6686320,6686018],"length":1,"stats":{"Line":0}},{"line":255,"address":[6689721],"length":1,"stats":{"Line":0}},{"line":256,"address":[8693391,8693437,8693380],"length":1,"stats":{"Line":0}},{"line":315,"address":[7862512,7864426,7864386],"length":1,"stats":{"Line":0}},{"line":319,"address":[7862748,7862656,7862811,7862906,7864392,7863160,7862564],"length":1,"stats":{"Line":0}},{"line":322,"address":[7862691],"length":1,"stats":{"Line":0}},{"line":326,"address":[9842096,9842118],"length":1,"stats":{"Line":0}},{"line":328,"address":[9842352,9844348,9844311],"length":1,"stats":{"Line":0}},{"line":330,"address":[6695728,6693888],"length":1,"stats":{"Line":0}},{"line":331,"address":[9844438],"length":1,"stats":{"Line":0}},{"line":332,"address":[9844453],"length":1,"stats":{"Line":0}},{"line":333,"address":[9844468],"length":1,"stats":{"Line":0}},{"line":336,"address":[9843007,9842658,9842615,9842512],"length":1,"stats":{"Line":0}},{"line":337,"address":[9842534],"length":1,"stats":{"Line":0}},{"line":338,"address":[6694042],"length":1,"stats":{"Line":0}},{"line":347,"address":[6695712,6694371,6693948,6694482],"length":1,"stats":{"Line":0}},{"line":349,"address":[6694772,6694674,6695678],"length":1,"stats":{"Line":0}},{"line":350,"address":[9843182],"length":1,"stats":{"Line":0}},{"line":351,"address":[9843241],"length":1,"stats":{"Line":0}},{"line":355,"address":[6694926,6694859],"length":1,"stats":{"Line":0}},{"line":357,"address":[6695388],"length":1,"stats":{"Line":0}},{"line":359,"address":[6695163],"length":1,"stats":{"Line":0}},{"line":360,"address":[6695234],"length":1,"stats":{"Line":0}},{"line":362,"address":[6695328],"length":1,"stats":{"Line":0}},{"line":365,"address":[6695487],"length":1,"stats":{"Line":0}},{"line":366,"address":[6695435],"length":1,"stats":{"Line":0}},{"line":367,"address":[6695461],"length":1,"stats":{"Line":0}},{"line":371,"address":[10526584],"length":1,"stats":{"Line":0}},{"line":372,"address":[6696128,6696141],"length":1,"stats":{"Line":0}},{"line":375,"address":[7864337,7863437,7863564],"length":1,"stats":{"Line":0}},{"line":377,"address":[7863380,7863308],"length":1,"stats":{"Line":0}},{"line":381,"address":[6696320,6696359],"length":1,"stats":{"Line":0}},{"line":383,"address":[7864335,7863820,7863693],"length":1,"stats":{"Line":0}},{"line":385,"address":[10527093],"length":1,"stats":{"Line":0}},{"line":389,"address":[7863788],"length":1,"stats":{"Line":0}},{"line":391,"address":[7863861,7864321,7864076],"length":1,"stats":{"Line":0}},{"line":392,"address":[6696862,6696832],"length":1,"stats":{"Line":0}},{"line":394,"address":[7864206],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":93},{"path":["/","home","vidyootsenthil","TheValut-nameTBD","node","src","wallet.rs"],"content":"use bitcoin::absolute::LockTime;\nuse bitcoin::consensus::encode::serialize;\nuse bitcoin::hashes::Hash;\nuse bitcoin::transaction::{OutPoint, Version};\nuse bitcoin::witness::Witness;\nuse bitcoin::{Amount, ScriptBuf, Transaction, TxIn, TxOut, hashes::sha256};\nuse hex;\nuse tracing::{error, info};\n\nuse crate::NodeState;\nuse frost_secp256k1::{self as frost};\n\n/// Very simple demonstration UTXO representation (key-path Taproot assumed)\n#[derive(Debug, Clone)]\npub struct Utxo {\n    pub outpoint: OutPoint,\n    pub value: Amount,\n    pub script_pubkey: ScriptBuf,\n}\n\n/// Wallet that only tracks a list of local UTXOs and is able to construct a\n/// single-input spending transaction that possibly creates a change output. No\n/// fee calculation is performed  this is purely for demonstration purposes.\n#[derive(Debug)]\npub struct SimpleWallet {\n    pub utxos: Vec\u003cUtxo\u003e,\n}\n\nimpl Default for SimpleWallet {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\nimpl SimpleWallet {\n    pub fn new() -\u003e Self {\n        Self {\n            utxos: vec![\n                Utxo {\n                    outpoint: OutPoint {\n                        txid: bitcoin::Txid::from_slice(\u0026[0u8; 32]).expect(\"Failed to create UTXO\"),\n                        vout: 0,\n                    },\n                    value: Amount::from_sat(100_000),\n                    script_pubkey: ScriptBuf::new(),\n                },\n                Utxo {\n                    outpoint: OutPoint {\n                        txid: bitcoin::Txid::from_slice(\u0026[1u8; 32]).expect(\"Failed to create UTXO\"),\n                        vout: 0,\n                    },\n                    value: Amount::from_sat(50_000),\n                    script_pubkey: ScriptBuf::new(),\n                },\n                Utxo {\n                    outpoint: OutPoint {\n                        txid: bitcoin::Txid::from_slice(\u0026[2u8; 32]).expect(\"Failed to create UTXO\"),\n                        vout: 0,\n                    },\n                    value: Amount::from_sat(20_000),\n                    script_pubkey: ScriptBuf::new(),\n                },\n            ],\n        }\n    }\n\n    pub fn create_spend(\u0026mut self, amount_sat: u64) -\u003e Result\u003c(Transaction, [u8; 32]), String\u003e {\n        let pos = self\n            .utxos\n            .iter()\n            .position(|u| u.value.to_sat() \u003e= amount_sat)\n            .ok_or_else(|| {\n                \"No single UTXO large enough  coin selection not implemented\".to_string()\n            })?;\n\n        let utxo = self.utxos.remove(pos);\n        let change_sat = utxo.value.to_sat() - amount_sat;\n\n        let input = TxIn {\n            previous_output: utxo.outpoint,\n            script_sig: ScriptBuf::new(),\n            sequence: bitcoin::Sequence::ZERO,\n            witness: Witness::new(),\n        };\n\n        let recipient_output = TxOut {\n            value: Amount::from_sat(amount_sat),\n            script_pubkey: ScriptBuf::new(),\n        };\n\n        let mut outputs = vec![recipient_output];\n\n        // Add change output if needed\n        if change_sat \u003e 0 {\n            outputs.push(TxOut {\n                value: Amount::from_sat(change_sat),\n                script_pubkey: ScriptBuf::new(),\n            });\n        }\n\n        let tx = Transaction {\n            version: Version::TWO,\n            lock_time: LockTime::ZERO,\n            input: vec![input],\n            output: outputs,\n        };\n\n        let sighash = sha256::Hash::hash(\u0026serialize(\u0026tx));\n        Ok((tx, sighash.to_byte_array()))\n    }\n}\n\n#[derive(Debug)]\npub struct PendingSpend {\n    pub tx: Transaction,\n}\n\nimpl NodeState {\n    pub fn get_frost_public_key(\u0026self) -\u003e Option\u003cString\u003e {\n        self.dkg_state.pubkey_package.as_ref().map(|p| {\n            format!(\"{:?}\", p.verifying_key())\n                .replace(\"VerifyingKey(\", \"\")\n                .replace(\")\", \"\")\n                .replace(\"\\\\\", \"\")\n                .replace(\"\\\"\", \"\")\n        })\n    }\n\n    pub fn frost_signature_to_bitcoin(\n        frost_sig: \u0026frost::Signature,\n    ) -\u003e Result\u003cbitcoin::secp256k1::schnorr::Signature, String\u003e {\n        let sig_bytes = frost_sig\n            .serialize()\n            .map_err(|e| format!(\"Serialize frost sig: {}\", e))?;\n\n        let schnorr_bytes = match sig_bytes.len() {\n            64 =\u003e sig_bytes,\n            65 =\u003e sig_bytes[..64].to_vec(),\n            _ =\u003e return Err(format!(\"Unsupported signature len {}\", sig_bytes.len())),\n        };\n\n        bitcoin::secp256k1::schnorr::Signature::from_slice(\u0026schnorr_bytes)\n            .map_err(|e| format!(\"Parse schnorr sig: {}\", e))\n    }\n\n    pub fn start_spend_request(\u0026mut self, amount_sat: u64) -\u003e Option\u003cString\u003e {\n        info!(\" Creating spend request for {} sat\", amount_sat);\n        match self.wallet.create_spend(amount_sat) {\n            Ok((tx, sighash)) =\u003e {\n                let sighash_hex = hex::encode(sighash);\n                match self.start_signing_session(\u0026sighash_hex) {\n                    Ok(_) =\u003e (),\n                    Err(e) =\u003e {\n                        error!(\" Failed to start signing session: {}\", e);\n                        return None;\n                    }\n                }\n\n                if let Some(active) = \u0026self.active_signing {\n                    self.pending_spends\n                        .insert(active.sign_id, crate::wallet::PendingSpend { tx });\n                    info!(\" Spend request prepared (session id {})\", active.sign_id);\n\n                    Some(hex::encode(sighash))\n                } else {\n                    error!(\" Failed to start signing session\");\n                    None\n                }\n            }\n            Err(e) =\u003e {\n                error!(\" Failed to create spend transaction: {}\", e);\n                None\n            }\n        }\n    }\n}\n","traces":[{"line":30,"address":[5358528],"length":1,"stats":{"Line":0}},{"line":31,"address":[5358536],"length":1,"stats":{"Line":0}},{"line":36,"address":[5359638,5359632,5358560],"length":1,"stats":{"Line":0}},{"line":38,"address":[5359619,5358629,5358893,5358587,5359172,5359416],"length":1,"stats":{"Line":0}},{"line":67,"address":[5361924,5361830,5359664],"length":1,"stats":{"Line":0}},{"line":68,"address":[5359707,5359895],"length":1,"stats":{"Line":0}},{"line":71,"address":[7856336,7856354],"length":1,"stats":{"Line":0}},{"line":72,"address":[7856384],"length":1,"stats":{"Line":0}},{"line":73,"address":[7856396],"length":1,"stats":{"Line":0}},{"line":76,"address":[10555608],"length":1,"stats":{"Line":0}},{"line":77,"address":[5360122,5359958,5360027],"length":1,"stats":{"Line":0}},{"line":80,"address":[5360061],"length":1,"stats":{"Line":0}},{"line":81,"address":[5360115],"length":1,"stats":{"Line":0}},{"line":83,"address":[5360150],"length":1,"stats":{"Line":0}},{"line":87,"address":[5360346],"length":1,"stats":{"Line":0}},{"line":88,"address":[5360416],"length":1,"stats":{"Line":0}},{"line":91,"address":[5360486,5360544],"length":1,"stats":{"Line":0}},{"line":94,"address":[5360745],"length":1,"stats":{"Line":0}},{"line":95,"address":[5360858],"length":1,"stats":{"Line":0}},{"line":96,"address":[5360781],"length":1,"stats":{"Line":0}},{"line":97,"address":[5360846],"length":1,"stats":{"Line":0}},{"line":104,"address":[5360937,5360761],"length":1,"stats":{"Line":0}},{"line":108,"address":[5361300,5361368],"length":1,"stats":{"Line":0}},{"line":109,"address":[10557170],"length":1,"stats":{"Line":0}},{"line":119,"address":[8834560],"length":1,"stats":{"Line":0}},{"line":120,"address":[7856432,7857178,7857172],"length":1,"stats":{"Line":0}},{"line":121,"address":[7856470,7857054,7856810,7856683,7856934],"length":1,"stats":{"Line":0}},{"line":125,"address":[7856756,7857091,7856880,7856629,7856998],"length":1,"stats":{"Line":0}},{"line":129,"address":[8834640,8835276,8835490],"length":1,"stats":{"Line":0}},{"line":132,"address":[8834780,8834665],"length":1,"stats":{"Line":0}},{"line":134,"address":[8834741],"length":1,"stats":{"Line":0}},{"line":136,"address":[8834865,8834932],"length":1,"stats":{"Line":0}},{"line":137,"address":[8834977],"length":1,"stats":{"Line":0}},{"line":138,"address":[11833494,11833570],"length":1,"stats":{"Line":0}},{"line":139,"address":[8834953,8835287],"length":1,"stats":{"Line":0}},{"line":142,"address":[11833532,11833652],"length":1,"stats":{"Line":0}},{"line":143,"address":[10005080,10005056],"length":1,"stats":{"Line":0}},{"line":146,"address":[8839578,8839572,8835520],"length":1,"stats":{"Line":0}},{"line":147,"address":[11834314,11834047],"length":1,"stats":{"Line":0}},{"line":148,"address":[8835759],"length":1,"stats":{"Line":0}},{"line":149,"address":[8836333],"length":1,"stats":{"Line":0}},{"line":150,"address":[11834918],"length":1,"stats":{"Line":0}},{"line":151,"address":[11835026,11835114],"length":1,"stats":{"Line":0}},{"line":153,"address":[8836681],"length":1,"stats":{"Line":0}},{"line":154,"address":[8838782,8836713,8839044],"length":1,"stats":{"Line":0}},{"line":155,"address":[8839023],"length":1,"stats":{"Line":0}},{"line":159,"address":[8838237,8836752],"length":1,"stats":{"Line":0}},{"line":160,"address":[8836833,8836999],"length":1,"stats":{"Line":0}},{"line":161,"address":[8837045,8836840],"length":1,"stats":{"Line":0}},{"line":162,"address":[8837410,8837052],"length":1,"stats":{"Line":0}},{"line":164,"address":[8837352,8837887],"length":1,"stats":{"Line":0}},{"line":166,"address":[8837951,8837006,8838242],"length":1,"stats":{"Line":0}},{"line":167,"address":[8838224],"length":1,"stats":{"Line":0}},{"line":170,"address":[8836270],"length":1,"stats":{"Line":0}},{"line":171,"address":[8839921,8836302,8839658],"length":1,"stats":{"Line":0}},{"line":172,"address":[8839889],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":56}]};
    </script>
    <script crossorigin>/** @license React v16.13.1
 * react.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
'use strict';(function(d,r){"object"===typeof exports&&"undefined"!==typeof module?r(exports):"function"===typeof define&&define.amd?define(["exports"],r):(d=d||self,r(d.React={}))})(this,function(d){function r(a){for(var b="https://reactjs.org/docs/error-decoder.html?invariant="+a,c=1;c<arguments.length;c++)b+="&args[]="+encodeURIComponent(arguments[c]);return"Minified React error #"+a+"; visit "+b+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}
function w(a,b,c){this.props=a;this.context=b;this.refs=ba;this.updater=c||ca}function da(){}function L(a,b,c){this.props=a;this.context=b;this.refs=ba;this.updater=c||ca}function ea(a,b,c){var g,e={},fa=null,d=null;if(null!=b)for(g in void 0!==b.ref&&(d=b.ref),void 0!==b.key&&(fa=""+b.key),b)ha.call(b,g)&&!ia.hasOwnProperty(g)&&(e[g]=b[g]);var h=arguments.length-2;if(1===h)e.children=c;else if(1<h){for(var k=Array(h),f=0;f<h;f++)k[f]=arguments[f+2];e.children=k}if(a&&a.defaultProps)for(g in h=a.defaultProps,
h)void 0===e[g]&&(e[g]=h[g]);return{$$typeof:x,type:a,key:fa,ref:d,props:e,_owner:M.current}}function va(a,b){return{$$typeof:x,type:a.type,key:b,ref:a.ref,props:a.props,_owner:a._owner}}function N(a){return"object"===typeof a&&null!==a&&a.$$typeof===x}function wa(a){var b={"=":"=0",":":"=2"};return"$"+(""+a).replace(/[=:]/g,function(a){return b[a]})}function ja(a,b,c,g){if(C.length){var e=C.pop();e.result=a;e.keyPrefix=b;e.func=c;e.context=g;e.count=0;return e}return{result:a,keyPrefix:b,func:c,
context:g,count:0}}function ka(a){a.result=null;a.keyPrefix=null;a.func=null;a.context=null;a.count=0;10>C.length&&C.push(a)}function O(a,b,c,g){var e=typeof a;if("undefined"===e||"boolean"===e)a=null;var d=!1;if(null===a)d=!0;else switch(e){case "string":case "number":d=!0;break;case "object":switch(a.$$typeof){case x:case xa:d=!0}}if(d)return c(g,a,""===b?"."+P(a,0):b),1;d=0;b=""===b?".":b+":";if(Array.isArray(a))for(var f=0;f<a.length;f++){e=a[f];var h=b+P(e,f);d+=O(e,h,c,g)}else if(null===a||
"object"!==typeof a?h=null:(h=la&&a[la]||a["@@iterator"],h="function"===typeof h?h:null),"function"===typeof h)for(a=h.call(a),f=0;!(e=a.next()).done;)e=e.value,h=b+P(e,f++),d+=O(e,h,c,g);else if("object"===e)throw c=""+a,Error(r(31,"[object Object]"===c?"object with keys {"+Object.keys(a).join(", ")+"}":c,""));return d}function Q(a,b,c){return null==a?0:O(a,"",b,c)}function P(a,b){return"object"===typeof a&&null!==a&&null!=a.key?wa(a.key):b.toString(36)}function ya(a,b,c){a.func.call(a.context,b,
a.count++)}function za(a,b,c){var g=a.result,e=a.keyPrefix;a=a.func.call(a.context,b,a.count++);Array.isArray(a)?R(a,g,c,function(a){return a}):null!=a&&(N(a)&&(a=va(a,e+(!a.key||b&&b.key===a.key?"":(""+a.key).replace(ma,"$&/")+"/")+c)),g.push(a))}function R(a,b,c,g,e){var d="";null!=c&&(d=(""+c).replace(ma,"$&/")+"/");b=ja(b,d,g,e);Q(a,za,b);ka(b)}function t(){var a=na.current;if(null===a)throw Error(r(321));return a}function S(a,b){var c=a.length;a.push(b);a:for(;;){var g=c-1>>>1,e=a[g];if(void 0!==
e&&0<D(e,b))a[g]=b,a[c]=e,c=g;else break a}}function n(a){a=a[0];return void 0===a?null:a}function E(a){var b=a[0];if(void 0!==b){var c=a.pop();if(c!==b){a[0]=c;a:for(var g=0,e=a.length;g<e;){var d=2*(g+1)-1,f=a[d],h=d+1,k=a[h];if(void 0!==f&&0>D(f,c))void 0!==k&&0>D(k,f)?(a[g]=k,a[h]=c,g=h):(a[g]=f,a[d]=c,g=d);else if(void 0!==k&&0>D(k,c))a[g]=k,a[h]=c,g=h;else break a}}return b}return null}function D(a,b){var c=a.sortIndex-b.sortIndex;return 0!==c?c:a.id-b.id}function F(a){for(var b=n(u);null!==
b;){if(null===b.callback)E(u);else if(b.startTime<=a)E(u),b.sortIndex=b.expirationTime,S(p,b);else break;b=n(u)}}function T(a){y=!1;F(a);if(!v)if(null!==n(p))v=!0,z(U);else{var b=n(u);null!==b&&G(T,b.startTime-a)}}function U(a,b){v=!1;y&&(y=!1,V());H=!0;var c=m;try{F(b);for(l=n(p);null!==l&&(!(l.expirationTime>b)||a&&!W());){var g=l.callback;if(null!==g){l.callback=null;m=l.priorityLevel;var e=g(l.expirationTime<=b);b=q();"function"===typeof e?l.callback=e:l===n(p)&&E(p);F(b)}else E(p);l=n(p)}if(null!==
l)var d=!0;else{var f=n(u);null!==f&&G(T,f.startTime-b);d=!1}return d}finally{l=null,m=c,H=!1}}function oa(a){switch(a){case 1:return-1;case 2:return 250;case 5:return 1073741823;case 4:return 1E4;default:return 5E3}}var f="function"===typeof Symbol&&Symbol.for,x=f?Symbol.for("react.element"):60103,xa=f?Symbol.for("react.portal"):60106,Aa=f?Symbol.for("react.fragment"):60107,Ba=f?Symbol.for("react.strict_mode"):60108,Ca=f?Symbol.for("react.profiler"):60114,Da=f?Symbol.for("react.provider"):60109,
Ea=f?Symbol.for("react.context"):60110,Fa=f?Symbol.for("react.forward_ref"):60112,Ga=f?Symbol.for("react.suspense"):60113,Ha=f?Symbol.for("react.memo"):60115,Ia=f?Symbol.for("react.lazy"):60116,la="function"===typeof Symbol&&Symbol.iterator,pa=Object.getOwnPropertySymbols,Ja=Object.prototype.hasOwnProperty,Ka=Object.prototype.propertyIsEnumerable,I=function(){try{if(!Object.assign)return!1;var a=new String("abc");a[5]="de";if("5"===Object.getOwnPropertyNames(a)[0])return!1;var b={};for(a=0;10>a;a++)b["_"+
String.fromCharCode(a)]=a;if("0123456789"!==Object.getOwnPropertyNames(b).map(function(a){return b[a]}).join(""))return!1;var c={};"abcdefghijklmnopqrst".split("").forEach(function(a){c[a]=a});return"abcdefghijklmnopqrst"!==Object.keys(Object.assign({},c)).join("")?!1:!0}catch(g){return!1}}()?Object.assign:function(a,b){if(null===a||void 0===a)throw new TypeError("Object.assign cannot be called with null or undefined");var c=Object(a);for(var g,e=1;e<arguments.length;e++){var d=Object(arguments[e]);
for(var f in d)Ja.call(d,f)&&(c[f]=d[f]);if(pa){g=pa(d);for(var h=0;h<g.length;h++)Ka.call(d,g[h])&&(c[g[h]]=d[g[h]])}}return c},ca={isMounted:function(a){return!1},enqueueForceUpdate:function(a,b,c){},enqueueReplaceState:function(a,b,c,d){},enqueueSetState:function(a,b,c,d){}},ba={};w.prototype.isReactComponent={};w.prototype.setState=function(a,b){if("object"!==typeof a&&"function"!==typeof a&&null!=a)throw Error(r(85));this.updater.enqueueSetState(this,a,b,"setState")};w.prototype.forceUpdate=
function(a){this.updater.enqueueForceUpdate(this,a,"forceUpdate")};da.prototype=w.prototype;f=L.prototype=new da;f.constructor=L;I(f,w.prototype);f.isPureReactComponent=!0;var M={current:null},ha=Object.prototype.hasOwnProperty,ia={key:!0,ref:!0,__self:!0,__source:!0},ma=/\/+/g,C=[],na={current:null},X;if("undefined"===typeof window||"function"!==typeof MessageChannel){var A=null,qa=null,ra=function(){if(null!==A)try{var a=q();A(!0,a);A=null}catch(b){throw setTimeout(ra,0),b;}},La=Date.now();var q=
function(){return Date.now()-La};var z=function(a){null!==A?setTimeout(z,0,a):(A=a,setTimeout(ra,0))};var G=function(a,b){qa=setTimeout(a,b)};var V=function(){clearTimeout(qa)};var W=function(){return!1};f=X=function(){}}else{var Y=window.performance,sa=window.Date,Ma=window.setTimeout,Na=window.clearTimeout;"undefined"!==typeof console&&(f=window.cancelAnimationFrame,"function"!==typeof window.requestAnimationFrame&&console.error("This browser doesn't support requestAnimationFrame. Make sure that you load a polyfill in older browsers. https://fb.me/react-polyfills"),
"function"!==typeof f&&console.error("This browser doesn't support cancelAnimationFrame. Make sure that you load a polyfill in older browsers. https://fb.me/react-polyfills"));if("object"===typeof Y&&"function"===typeof Y.now)q=function(){return Y.now()};else{var Oa=sa.now();q=function(){return sa.now()-Oa}}var J=!1,K=null,Z=-1,ta=5,ua=0;W=function(){return q()>=ua};f=function(){};X=function(a){0>a||125<a?console.error("forceFrameRate takes a positive int between 0 and 125, forcing framerates higher than 125 fps is not unsupported"):
ta=0<a?Math.floor(1E3/a):5};var B=new MessageChannel,aa=B.port2;B.port1.onmessage=function(){if(null!==K){var a=q();ua=a+ta;try{K(!0,a)?aa.postMessage(null):(J=!1,K=null)}catch(b){throw aa.postMessage(null),b;}}else J=!1};z=function(a){K=a;J||(J=!0,aa.postMessage(null))};G=function(a,b){Z=Ma(function(){a(q())},b)};V=function(){Na(Z);Z=-1}}var p=[],u=[],Pa=1,l=null,m=3,H=!1,v=!1,y=!1,Qa=0;B={ReactCurrentDispatcher:na,ReactCurrentOwner:M,IsSomeRendererActing:{current:!1},assign:I};I(B,{Scheduler:{__proto__:null,
unstable_ImmediatePriority:1,unstable_UserBlockingPriority:2,unstable_NormalPriority:3,unstable_IdlePriority:5,unstable_LowPriority:4,unstable_runWithPriority:function(a,b){switch(a){case 1:case 2:case 3:case 4:case 5:break;default:a=3}var c=m;m=a;try{return b()}finally{m=c}},unstable_next:function(a){switch(m){case 1:case 2:case 3:var b=3;break;default:b=m}var c=m;m=b;try{return a()}finally{m=c}},unstable_scheduleCallback:function(a,b,c){var d=q();if("object"===typeof c&&null!==c){var e=c.delay;
e="number"===typeof e&&0<e?d+e:d;c="number"===typeof c.timeout?c.timeout:oa(a)}else c=oa(a),e=d;c=e+c;a={id:Pa++,callback:b,priorityLevel:a,startTime:e,expirationTime:c,sortIndex:-1};e>d?(a.sortIndex=e,S(u,a),null===n(p)&&a===n(u)&&(y?V():y=!0,G(T,e-d))):(a.sortIndex=c,S(p,a),v||H||(v=!0,z(U)));return a},unstable_cancelCallback:function(a){a.callback=null},unstable_wrapCallback:function(a){var b=m;return function(){var c=m;m=b;try{return a.apply(this,arguments)}finally{m=c}}},unstable_getCurrentPriorityLevel:function(){return m},
unstable_shouldYield:function(){var a=q();F(a);var b=n(p);return b!==l&&null!==l&&null!==b&&null!==b.callback&&b.startTime<=a&&b.expirationTime<l.expirationTime||W()},unstable_requestPaint:f,unstable_continueExecution:function(){v||H||(v=!0,z(U))},unstable_pauseExecution:function(){},unstable_getFirstCallbackNode:function(){return n(p)},get unstable_now(){return q},get unstable_forceFrameRate(){return X},unstable_Profiling:null},SchedulerTracing:{__proto__:null,__interactionsRef:null,__subscriberRef:null,
unstable_clear:function(a){return a()},unstable_getCurrent:function(){return null},unstable_getThreadID:function(){return++Qa},unstable_trace:function(a,b,c){return c()},unstable_wrap:function(a){return a},unstable_subscribe:function(a){},unstable_unsubscribe:function(a){}}});d.Children={map:function(a,b,c){if(null==a)return a;var d=[];R(a,d,null,b,c);return d},forEach:function(a,b,c){if(null==a)return a;b=ja(null,null,b,c);Q(a,ya,b);ka(b)},count:function(a){return Q(a,function(){return null},null)},
toArray:function(a){var b=[];R(a,b,null,function(a){return a});return b},only:function(a){if(!N(a))throw Error(r(143));return a}};d.Component=w;d.Fragment=Aa;d.Profiler=Ca;d.PureComponent=L;d.StrictMode=Ba;d.Suspense=Ga;d.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=B;d.cloneElement=function(a,b,c){if(null===a||void 0===a)throw Error(r(267,a));var d=I({},a.props),e=a.key,f=a.ref,m=a._owner;if(null!=b){void 0!==b.ref&&(f=b.ref,m=M.current);void 0!==b.key&&(e=""+b.key);if(a.type&&a.type.defaultProps)var h=
a.type.defaultProps;for(k in b)ha.call(b,k)&&!ia.hasOwnProperty(k)&&(d[k]=void 0===b[k]&&void 0!==h?h[k]:b[k])}var k=arguments.length-2;if(1===k)d.children=c;else if(1<k){h=Array(k);for(var l=0;l<k;l++)h[l]=arguments[l+2];d.children=h}return{$$typeof:x,type:a.type,key:e,ref:f,props:d,_owner:m}};d.createContext=function(a,b){void 0===b&&(b=null);a={$$typeof:Ea,_calculateChangedBits:b,_currentValue:a,_currentValue2:a,_threadCount:0,Provider:null,Consumer:null};a.Provider={$$typeof:Da,_context:a};return a.Consumer=
a};d.createElement=ea;d.createFactory=function(a){var b=ea.bind(null,a);b.type=a;return b};d.createRef=function(){return{current:null}};d.forwardRef=function(a){return{$$typeof:Fa,render:a}};d.isValidElement=N;d.lazy=function(a){return{$$typeof:Ia,_ctor:a,_status:-1,_result:null}};d.memo=function(a,b){return{$$typeof:Ha,type:a,compare:void 0===b?null:b}};d.useCallback=function(a,b){return t().useCallback(a,b)};d.useContext=function(a,b){return t().useContext(a,b)};d.useDebugValue=function(a,b){};
d.useEffect=function(a,b){return t().useEffect(a,b)};d.useImperativeHandle=function(a,b,c){return t().useImperativeHandle(a,b,c)};d.useLayoutEffect=function(a,b){return t().useLayoutEffect(a,b)};d.useMemo=function(a,b){return t().useMemo(a,b)};d.useReducer=function(a,b,c){return t().useReducer(a,b,c)};d.useRef=function(a){return t().useRef(a)};d.useState=function(a){return t().useState(a)};d.version="16.13.1"});
</script>
    <script crossorigin>/** @license React v16.13.1
 * react-dom.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
/*
 Modernizr 3.0.0pre (Custom Build) | MIT
*/
'use strict';(function(I,ea){"object"===typeof exports&&"undefined"!==typeof module?ea(exports,require("react")):"function"===typeof define&&define.amd?define(["exports","react"],ea):(I=I||self,ea(I.ReactDOM={},I.React))})(this,function(I,ea){function k(a){for(var b="https://reactjs.org/docs/error-decoder.html?invariant="+a,c=1;c<arguments.length;c++)b+="&args[]="+encodeURIComponent(arguments[c]);return"Minified React error #"+a+"; visit "+b+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}
function ji(a,b,c,d,e,f,g,h,m){yb=!1;gc=null;ki.apply(li,arguments)}function mi(a,b,c,d,e,f,g,h,m){ji.apply(this,arguments);if(yb){if(yb){var n=gc;yb=!1;gc=null}else throw Error(k(198));hc||(hc=!0,pd=n)}}function lf(a,b,c){var d=a.type||"unknown-event";a.currentTarget=mf(c);mi(d,b,void 0,a);a.currentTarget=null}function nf(){if(ic)for(var a in cb){var b=cb[a],c=ic.indexOf(a);if(!(-1<c))throw Error(k(96,a));if(!jc[c]){if(!b.extractEvents)throw Error(k(97,a));jc[c]=b;c=b.eventTypes;for(var d in c){var e=
void 0;var f=c[d],g=b,h=d;if(qd.hasOwnProperty(h))throw Error(k(99,h));qd[h]=f;var m=f.phasedRegistrationNames;if(m){for(e in m)m.hasOwnProperty(e)&&of(m[e],g,h);e=!0}else f.registrationName?(of(f.registrationName,g,h),e=!0):e=!1;if(!e)throw Error(k(98,d,a));}}}}function of(a,b,c){if(db[a])throw Error(k(100,a));db[a]=b;rd[a]=b.eventTypes[c].dependencies}function pf(a){var b=!1,c;for(c in a)if(a.hasOwnProperty(c)){var d=a[c];if(!cb.hasOwnProperty(c)||cb[c]!==d){if(cb[c])throw Error(k(102,c));cb[c]=
d;b=!0}}b&&nf()}function qf(a){if(a=rf(a)){if("function"!==typeof sd)throw Error(k(280));var b=a.stateNode;b&&(b=td(b),sd(a.stateNode,a.type,b))}}function sf(a){eb?fb?fb.push(a):fb=[a]:eb=a}function tf(){if(eb){var a=eb,b=fb;fb=eb=null;qf(a);if(b)for(a=0;a<b.length;a++)qf(b[a])}}function ud(){if(null!==eb||null!==fb)vd(),tf()}function uf(a,b,c){if(wd)return a(b,c);wd=!0;try{return vf(a,b,c)}finally{wd=!1,ud()}}function ni(a){if(wf.call(xf,a))return!0;if(wf.call(yf,a))return!1;if(oi.test(a))return xf[a]=
!0;yf[a]=!0;return!1}function pi(a,b,c,d){if(null!==c&&0===c.type)return!1;switch(typeof b){case "function":case "symbol":return!0;case "boolean":if(d)return!1;if(null!==c)return!c.acceptsBooleans;a=a.toLowerCase().slice(0,5);return"data-"!==a&&"aria-"!==a;default:return!1}}function qi(a,b,c,d){if(null===b||"undefined"===typeof b||pi(a,b,c,d))return!0;if(d)return!1;if(null!==c)switch(c.type){case 3:return!b;case 4:return!1===b;case 5:return isNaN(b);case 6:return isNaN(b)||1>b}return!1}function L(a,
b,c,d,e,f){this.acceptsBooleans=2===b||3===b||4===b;this.attributeName=d;this.attributeNamespace=e;this.mustUseProperty=c;this.propertyName=a;this.type=b;this.sanitizeURL=f}function xd(a,b,c,d){var e=E.hasOwnProperty(b)?E[b]:null;var f=null!==e?0===e.type:d?!1:!(2<b.length)||"o"!==b[0]&&"O"!==b[0]||"n"!==b[1]&&"N"!==b[1]?!1:!0;f||(qi(b,c,e,d)&&(c=null),d||null===e?ni(b)&&(null===c?a.removeAttribute(b):a.setAttribute(b,""+c)):e.mustUseProperty?a[e.propertyName]=null===c?3===e.type?!1:"":c:(b=e.attributeName,
d=e.attributeNamespace,null===c?a.removeAttribute(b):(e=e.type,c=3===e||4===e&&!0===c?"":""+c,d?a.setAttributeNS(d,b,c):a.setAttribute(b,c))))}function zb(a){if(null===a||"object"!==typeof a)return null;a=zf&&a[zf]||a["@@iterator"];return"function"===typeof a?a:null}function ri(a){if(-1===a._status){a._status=0;var b=a._ctor;b=b();a._result=b;b.then(function(b){0===a._status&&(b=b.default,a._status=1,a._result=b)},function(b){0===a._status&&(a._status=2,a._result=b)})}}function na(a){if(null==a)return null;
if("function"===typeof a)return a.displayName||a.name||null;if("string"===typeof a)return a;switch(a){case Ma:return"Fragment";case gb:return"Portal";case kc:return"Profiler";case Af:return"StrictMode";case lc:return"Suspense";case yd:return"SuspenseList"}if("object"===typeof a)switch(a.$$typeof){case Bf:return"Context.Consumer";case Cf:return"Context.Provider";case zd:var b=a.render;b=b.displayName||b.name||"";return a.displayName||(""!==b?"ForwardRef("+b+")":"ForwardRef");case Ad:return na(a.type);
case Df:return na(a.render);case Ef:if(a=1===a._status?a._result:null)return na(a)}return null}function Bd(a){var b="";do{a:switch(a.tag){case 3:case 4:case 6:case 7:case 10:case 9:var c="";break a;default:var d=a._debugOwner,e=a._debugSource,f=na(a.type);c=null;d&&(c=na(d.type));d=f;f="";e?f=" (at "+e.fileName.replace(si,"")+":"+e.lineNumber+")":c&&(f=" (created by "+c+")");c="\n    in "+(d||"Unknown")+f}b+=c;a=a.return}while(a);return b}function va(a){switch(typeof a){case "boolean":case "number":case "object":case "string":case "undefined":return a;
default:return""}}function Ff(a){var b=a.type;return(a=a.nodeName)&&"input"===a.toLowerCase()&&("checkbox"===b||"radio"===b)}function ti(a){var b=Ff(a)?"checked":"value",c=Object.getOwnPropertyDescriptor(a.constructor.prototype,b),d=""+a[b];if(!a.hasOwnProperty(b)&&"undefined"!==typeof c&&"function"===typeof c.get&&"function"===typeof c.set){var e=c.get,f=c.set;Object.defineProperty(a,b,{configurable:!0,get:function(){return e.call(this)},set:function(a){d=""+a;f.call(this,a)}});Object.defineProperty(a,
b,{enumerable:c.enumerable});return{getValue:function(){return d},setValue:function(a){d=""+a},stopTracking:function(){a._valueTracker=null;delete a[b]}}}}function mc(a){a._valueTracker||(a._valueTracker=ti(a))}function Gf(a){if(!a)return!1;var b=a._valueTracker;if(!b)return!0;var c=b.getValue();var d="";a&&(d=Ff(a)?a.checked?"true":"false":a.value);a=d;return a!==c?(b.setValue(a),!0):!1}function Cd(a,b){var c=b.checked;return M({},b,{defaultChecked:void 0,defaultValue:void 0,value:void 0,checked:null!=
c?c:a._wrapperState.initialChecked})}function Hf(a,b){var c=null==b.defaultValue?"":b.defaultValue,d=null!=b.checked?b.checked:b.defaultChecked;c=va(null!=b.value?b.value:c);a._wrapperState={initialChecked:d,initialValue:c,controlled:"checkbox"===b.type||"radio"===b.type?null!=b.checked:null!=b.value}}function If(a,b){b=b.checked;null!=b&&xd(a,"checked",b,!1)}function Dd(a,b){If(a,b);var c=va(b.value),d=b.type;if(null!=c)if("number"===d){if(0===c&&""===a.value||a.value!=c)a.value=""+c}else a.value!==
""+c&&(a.value=""+c);else if("submit"===d||"reset"===d){a.removeAttribute("value");return}b.hasOwnProperty("value")?Ed(a,b.type,c):b.hasOwnProperty("defaultValue")&&Ed(a,b.type,va(b.defaultValue));null==b.checked&&null!=b.defaultChecked&&(a.defaultChecked=!!b.defaultChecked)}function Jf(a,b,c){if(b.hasOwnProperty("value")||b.hasOwnProperty("defaultValue")){var d=b.type;if(!("submit"!==d&&"reset"!==d||void 0!==b.value&&null!==b.value))return;b=""+a._wrapperState.initialValue;c||b===a.value||(a.value=
b);a.defaultValue=b}c=a.name;""!==c&&(a.name="");a.defaultChecked=!!a._wrapperState.initialChecked;""!==c&&(a.name=c)}function Ed(a,b,c){if("number"!==b||a.ownerDocument.activeElement!==a)null==c?a.defaultValue=""+a._wrapperState.initialValue:a.defaultValue!==""+c&&(a.defaultValue=""+c)}function ui(a){var b="";ea.Children.forEach(a,function(a){null!=a&&(b+=a)});return b}function Fd(a,b){a=M({children:void 0},b);if(b=ui(b.children))a.children=b;return a}function hb(a,b,c,d){a=a.options;if(b){b={};
for(var e=0;e<c.length;e++)b["$"+c[e]]=!0;for(c=0;c<a.length;c++)e=b.hasOwnProperty("$"+a[c].value),a[c].selected!==e&&(a[c].selected=e),e&&d&&(a[c].defaultSelected=!0)}else{c=""+va(c);b=null;for(e=0;e<a.length;e++){if(a[e].value===c){a[e].selected=!0;d&&(a[e].defaultSelected=!0);return}null!==b||a[e].disabled||(b=a[e])}null!==b&&(b.selected=!0)}}function Gd(a,b){if(null!=b.dangerouslySetInnerHTML)throw Error(k(91));return M({},b,{value:void 0,defaultValue:void 0,children:""+a._wrapperState.initialValue})}
function Kf(a,b){var c=b.value;if(null==c){c=b.children;b=b.defaultValue;if(null!=c){if(null!=b)throw Error(k(92));if(Array.isArray(c)){if(!(1>=c.length))throw Error(k(93));c=c[0]}b=c}null==b&&(b="");c=b}a._wrapperState={initialValue:va(c)}}function Lf(a,b){var c=va(b.value),d=va(b.defaultValue);null!=c&&(c=""+c,c!==a.value&&(a.value=c),null==b.defaultValue&&a.defaultValue!==c&&(a.defaultValue=c));null!=d&&(a.defaultValue=""+d)}function Mf(a,b){b=a.textContent;b===a._wrapperState.initialValue&&""!==
b&&null!==b&&(a.value=b)}function Nf(a){switch(a){case "svg":return"http://www.w3.org/2000/svg";case "math":return"http://www.w3.org/1998/Math/MathML";default:return"http://www.w3.org/1999/xhtml"}}function Hd(a,b){return null==a||"http://www.w3.org/1999/xhtml"===a?Nf(b):"http://www.w3.org/2000/svg"===a&&"foreignObject"===b?"http://www.w3.org/1999/xhtml":a}function nc(a,b){var c={};c[a.toLowerCase()]=b.toLowerCase();c["Webkit"+a]="webkit"+b;c["Moz"+a]="moz"+b;return c}function oc(a){if(Id[a])return Id[a];
if(!ib[a])return a;var b=ib[a],c;for(c in b)if(b.hasOwnProperty(c)&&c in Of)return Id[a]=b[c];return a}function Jd(a){var b=Pf.get(a);void 0===b&&(b=new Map,Pf.set(a,b));return b}function Na(a){var b=a,c=a;if(a.alternate)for(;b.return;)b=b.return;else{a=b;do b=a,0!==(b.effectTag&1026)&&(c=b.return),a=b.return;while(a)}return 3===b.tag?c:null}function Qf(a){if(13===a.tag){var b=a.memoizedState;null===b&&(a=a.alternate,null!==a&&(b=a.memoizedState));if(null!==b)return b.dehydrated}return null}function Rf(a){if(Na(a)!==
a)throw Error(k(188));}function vi(a){var b=a.alternate;if(!b){b=Na(a);if(null===b)throw Error(k(188));return b!==a?null:a}for(var c=a,d=b;;){var e=c.return;if(null===e)break;var f=e.alternate;if(null===f){d=e.return;if(null!==d){c=d;continue}break}if(e.child===f.child){for(f=e.child;f;){if(f===c)return Rf(e),a;if(f===d)return Rf(e),b;f=f.sibling}throw Error(k(188));}if(c.return!==d.return)c=e,d=f;else{for(var g=!1,h=e.child;h;){if(h===c){g=!0;c=e;d=f;break}if(h===d){g=!0;d=e;c=f;break}h=h.sibling}if(!g){for(h=
f.child;h;){if(h===c){g=!0;c=f;d=e;break}if(h===d){g=!0;d=f;c=e;break}h=h.sibling}if(!g)throw Error(k(189));}}if(c.alternate!==d)throw Error(k(190));}if(3!==c.tag)throw Error(k(188));return c.stateNode.current===c?a:b}function Sf(a){a=vi(a);if(!a)return null;for(var b=a;;){if(5===b.tag||6===b.tag)return b;if(b.child)b.child.return=b,b=b.child;else{if(b===a)break;for(;!b.sibling;){if(!b.return||b.return===a)return null;b=b.return}b.sibling.return=b.return;b=b.sibling}}return null}function jb(a,b){if(null==
b)throw Error(k(30));if(null==a)return b;if(Array.isArray(a)){if(Array.isArray(b))return a.push.apply(a,b),a;a.push(b);return a}return Array.isArray(b)?[a].concat(b):[a,b]}function Kd(a,b,c){Array.isArray(a)?a.forEach(b,c):a&&b.call(c,a)}function pc(a){null!==a&&(Ab=jb(Ab,a));a=Ab;Ab=null;if(a){Kd(a,wi);if(Ab)throw Error(k(95));if(hc)throw a=pd,hc=!1,pd=null,a;}}function Ld(a){a=a.target||a.srcElement||window;a.correspondingUseElement&&(a=a.correspondingUseElement);return 3===a.nodeType?a.parentNode:
a}function Tf(a){if(!wa)return!1;a="on"+a;var b=a in document;b||(b=document.createElement("div"),b.setAttribute(a,"return;"),b="function"===typeof b[a]);return b}function Uf(a){a.topLevelType=null;a.nativeEvent=null;a.targetInst=null;a.ancestors.length=0;10>qc.length&&qc.push(a)}function Vf(a,b,c,d){if(qc.length){var e=qc.pop();e.topLevelType=a;e.eventSystemFlags=d;e.nativeEvent=b;e.targetInst=c;return e}return{topLevelType:a,eventSystemFlags:d,nativeEvent:b,targetInst:c,ancestors:[]}}function Wf(a){var b=
a.targetInst,c=b;do{if(!c){a.ancestors.push(c);break}var d=c;if(3===d.tag)d=d.stateNode.containerInfo;else{for(;d.return;)d=d.return;d=3!==d.tag?null:d.stateNode.containerInfo}if(!d)break;b=c.tag;5!==b&&6!==b||a.ancestors.push(c);c=Bb(d)}while(c);for(c=0;c<a.ancestors.length;c++){b=a.ancestors[c];var e=Ld(a.nativeEvent);d=a.topLevelType;var f=a.nativeEvent,g=a.eventSystemFlags;0===c&&(g|=64);for(var h=null,m=0;m<jc.length;m++){var n=jc[m];n&&(n=n.extractEvents(d,b,f,e,g))&&(h=jb(h,n))}pc(h)}}function Md(a,
b,c){if(!c.has(a)){switch(a){case "scroll":Cb(b,"scroll",!0);break;case "focus":case "blur":Cb(b,"focus",!0);Cb(b,"blur",!0);c.set("blur",null);c.set("focus",null);break;case "cancel":case "close":Tf(a)&&Cb(b,a,!0);break;case "invalid":case "submit":case "reset":break;default:-1===Db.indexOf(a)&&w(a,b)}c.set(a,null)}}function xi(a,b){var c=Jd(b);Nd.forEach(function(a){Md(a,b,c)});yi.forEach(function(a){Md(a,b,c)})}function Od(a,b,c,d,e){return{blockedOn:a,topLevelType:b,eventSystemFlags:c|32,nativeEvent:e,
container:d}}function Xf(a,b){switch(a){case "focus":case "blur":xa=null;break;case "dragenter":case "dragleave":ya=null;break;case "mouseover":case "mouseout":za=null;break;case "pointerover":case "pointerout":Eb.delete(b.pointerId);break;case "gotpointercapture":case "lostpointercapture":Fb.delete(b.pointerId)}}function Gb(a,b,c,d,e,f){if(null===a||a.nativeEvent!==f)return a=Od(b,c,d,e,f),null!==b&&(b=Hb(b),null!==b&&Yf(b)),a;a.eventSystemFlags|=d;return a}function zi(a,b,c,d,e){switch(b){case "focus":return xa=
Gb(xa,a,b,c,d,e),!0;case "dragenter":return ya=Gb(ya,a,b,c,d,e),!0;case "mouseover":return za=Gb(za,a,b,c,d,e),!0;case "pointerover":var f=e.pointerId;Eb.set(f,Gb(Eb.get(f)||null,a,b,c,d,e));return!0;case "gotpointercapture":return f=e.pointerId,Fb.set(f,Gb(Fb.get(f)||null,a,b,c,d,e)),!0}return!1}function Ai(a){var b=Bb(a.target);if(null!==b){var c=Na(b);if(null!==c)if(b=c.tag,13===b){if(b=Qf(c),null!==b){a.blockedOn=b;Pd(a.priority,function(){Bi(c)});return}}else if(3===b&&c.stateNode.hydrate){a.blockedOn=
3===c.tag?c.stateNode.containerInfo:null;return}}a.blockedOn=null}function rc(a){if(null!==a.blockedOn)return!1;var b=Qd(a.topLevelType,a.eventSystemFlags,a.container,a.nativeEvent);if(null!==b){var c=Hb(b);null!==c&&Yf(c);a.blockedOn=b;return!1}return!0}function Zf(a,b,c){rc(a)&&c.delete(b)}function Ci(){for(Rd=!1;0<fa.length;){var a=fa[0];if(null!==a.blockedOn){a=Hb(a.blockedOn);null!==a&&Di(a);break}var b=Qd(a.topLevelType,a.eventSystemFlags,a.container,a.nativeEvent);null!==b?a.blockedOn=b:fa.shift()}null!==
xa&&rc(xa)&&(xa=null);null!==ya&&rc(ya)&&(ya=null);null!==za&&rc(za)&&(za=null);Eb.forEach(Zf);Fb.forEach(Zf)}function Ib(a,b){a.blockedOn===b&&(a.blockedOn=null,Rd||(Rd=!0,$f(ag,Ci)))}function bg(a){if(0<fa.length){Ib(fa[0],a);for(var b=1;b<fa.length;b++){var c=fa[b];c.blockedOn===a&&(c.blockedOn=null)}}null!==xa&&Ib(xa,a);null!==ya&&Ib(ya,a);null!==za&&Ib(za,a);b=function(b){return Ib(b,a)};Eb.forEach(b);Fb.forEach(b);for(b=0;b<Jb.length;b++)c=Jb[b],c.blockedOn===a&&(c.blockedOn=null);for(;0<Jb.length&&
(b=Jb[0],null===b.blockedOn);)Ai(b),null===b.blockedOn&&Jb.shift()}function Sd(a,b){for(var c=0;c<a.length;c+=2){var d=a[c],e=a[c+1],f="on"+(e[0].toUpperCase()+e.slice(1));f={phasedRegistrationNames:{bubbled:f,captured:f+"Capture"},dependencies:[d],eventPriority:b};Td.set(d,b);cg.set(d,f);dg[e]=f}}function w(a,b){Cb(b,a,!1)}function Cb(a,b,c){var d=Td.get(b);switch(void 0===d?2:d){case 0:d=Ei.bind(null,b,1,a);break;case 1:d=Fi.bind(null,b,1,a);break;default:d=sc.bind(null,b,1,a)}c?a.addEventListener(b,
d,!0):a.addEventListener(b,d,!1)}function Ei(a,b,c,d){Oa||vd();var e=sc,f=Oa;Oa=!0;try{eg(e,a,b,c,d)}finally{(Oa=f)||ud()}}function Fi(a,b,c,d){Gi(Hi,sc.bind(null,a,b,c,d))}function sc(a,b,c,d){if(tc)if(0<fa.length&&-1<Nd.indexOf(a))a=Od(null,a,b,c,d),fa.push(a);else{var e=Qd(a,b,c,d);if(null===e)Xf(a,d);else if(-1<Nd.indexOf(a))a=Od(e,a,b,c,d),fa.push(a);else if(!zi(e,a,b,c,d)){Xf(a,d);a=Vf(a,d,null,b);try{uf(Wf,a)}finally{Uf(a)}}}}function Qd(a,b,c,d){c=Ld(d);c=Bb(c);if(null!==c){var e=Na(c);if(null===
e)c=null;else{var f=e.tag;if(13===f){c=Qf(e);if(null!==c)return c;c=null}else if(3===f){if(e.stateNode.hydrate)return 3===e.tag?e.stateNode.containerInfo:null;c=null}else e!==c&&(c=null)}}a=Vf(a,d,c,b);try{uf(Wf,a)}finally{Uf(a)}return null}function fg(a,b,c){return null==b||"boolean"===typeof b||""===b?"":c||"number"!==typeof b||0===b||Kb.hasOwnProperty(a)&&Kb[a]?(""+b).trim():b+"px"}function gg(a,b){a=a.style;for(var c in b)if(b.hasOwnProperty(c)){var d=0===c.indexOf("--"),e=fg(c,b[c],d);"float"===
c&&(c="cssFloat");d?a.setProperty(c,e):a[c]=e}}function Ud(a,b){if(b){if(Ii[a]&&(null!=b.children||null!=b.dangerouslySetInnerHTML))throw Error(k(137,a,""));if(null!=b.dangerouslySetInnerHTML){if(null!=b.children)throw Error(k(60));if(!("object"===typeof b.dangerouslySetInnerHTML&&"__html"in b.dangerouslySetInnerHTML))throw Error(k(61));}if(null!=b.style&&"object"!==typeof b.style)throw Error(k(62,""));}}function Vd(a,b){if(-1===a.indexOf("-"))return"string"===typeof b.is;switch(a){case "annotation-xml":case "color-profile":case "font-face":case "font-face-src":case "font-face-uri":case "font-face-format":case "font-face-name":case "missing-glyph":return!1;
default:return!0}}function oa(a,b){a=9===a.nodeType||11===a.nodeType?a:a.ownerDocument;var c=Jd(a);b=rd[b];for(var d=0;d<b.length;d++)Md(b[d],a,c)}function uc(){}function Wd(a){a=a||("undefined"!==typeof document?document:void 0);if("undefined"===typeof a)return null;try{return a.activeElement||a.body}catch(b){return a.body}}function hg(a){for(;a&&a.firstChild;)a=a.firstChild;return a}function ig(a,b){var c=hg(a);a=0;for(var d;c;){if(3===c.nodeType){d=a+c.textContent.length;if(a<=b&&d>=b)return{node:c,
offset:b-a};a=d}a:{for(;c;){if(c.nextSibling){c=c.nextSibling;break a}c=c.parentNode}c=void 0}c=hg(c)}}function jg(a,b){return a&&b?a===b?!0:a&&3===a.nodeType?!1:b&&3===b.nodeType?jg(a,b.parentNode):"contains"in a?a.contains(b):a.compareDocumentPosition?!!(a.compareDocumentPosition(b)&16):!1:!1}function kg(){for(var a=window,b=Wd();b instanceof a.HTMLIFrameElement;){try{var c="string"===typeof b.contentWindow.location.href}catch(d){c=!1}if(c)a=b.contentWindow;else break;b=Wd(a.document)}return b}
function Xd(a){var b=a&&a.nodeName&&a.nodeName.toLowerCase();return b&&("input"===b&&("text"===a.type||"search"===a.type||"tel"===a.type||"url"===a.type||"password"===a.type)||"textarea"===b||"true"===a.contentEditable)}function lg(a,b){switch(a){case "button":case "input":case "select":case "textarea":return!!b.autoFocus}return!1}function Yd(a,b){return"textarea"===a||"option"===a||"noscript"===a||"string"===typeof b.children||"number"===typeof b.children||"object"===typeof b.dangerouslySetInnerHTML&&
null!==b.dangerouslySetInnerHTML&&null!=b.dangerouslySetInnerHTML.__html}function kb(a){for(;null!=a;a=a.nextSibling){var b=a.nodeType;if(1===b||3===b)break}return a}function mg(a){a=a.previousSibling;for(var b=0;a;){if(8===a.nodeType){var c=a.data;if(c===ng||c===Zd||c===$d){if(0===b)return a;b--}else c===og&&b++}a=a.previousSibling}return null}function Bb(a){var b=a[Aa];if(b)return b;for(var c=a.parentNode;c;){if(b=c[Lb]||c[Aa]){c=b.alternate;if(null!==b.child||null!==c&&null!==c.child)for(a=mg(a);null!==
a;){if(c=a[Aa])return c;a=mg(a)}return b}a=c;c=a.parentNode}return null}function Hb(a){a=a[Aa]||a[Lb];return!a||5!==a.tag&&6!==a.tag&&13!==a.tag&&3!==a.tag?null:a}function Pa(a){if(5===a.tag||6===a.tag)return a.stateNode;throw Error(k(33));}function ae(a){return a[vc]||null}function pa(a){do a=a.return;while(a&&5!==a.tag);return a?a:null}function pg(a,b){var c=a.stateNode;if(!c)return null;var d=td(c);if(!d)return null;c=d[b];a:switch(b){case "onClick":case "onClickCapture":case "onDoubleClick":case "onDoubleClickCapture":case "onMouseDown":case "onMouseDownCapture":case "onMouseMove":case "onMouseMoveCapture":case "onMouseUp":case "onMouseUpCapture":case "onMouseEnter":(d=
!d.disabled)||(a=a.type,d=!("button"===a||"input"===a||"select"===a||"textarea"===a));a=!d;break a;default:a=!1}if(a)return null;if(c&&"function"!==typeof c)throw Error(k(231,b,typeof c));return c}function qg(a,b,c){if(b=pg(a,c.dispatchConfig.phasedRegistrationNames[b]))c._dispatchListeners=jb(c._dispatchListeners,b),c._dispatchInstances=jb(c._dispatchInstances,a)}function Ji(a){if(a&&a.dispatchConfig.phasedRegistrationNames){for(var b=a._targetInst,c=[];b;)c.push(b),b=pa(b);for(b=c.length;0<b--;)qg(c[b],
"captured",a);for(b=0;b<c.length;b++)qg(c[b],"bubbled",a)}}function be(a,b,c){a&&c&&c.dispatchConfig.registrationName&&(b=pg(a,c.dispatchConfig.registrationName))&&(c._dispatchListeners=jb(c._dispatchListeners,b),c._dispatchInstances=jb(c._dispatchInstances,a))}function Ki(a){a&&a.dispatchConfig.registrationName&&be(a._targetInst,null,a)}function lb(a){Kd(a,Ji)}function rg(){if(wc)return wc;var a,b=ce,c=b.length,d,e="value"in Ba?Ba.value:Ba.textContent,f=e.length;for(a=0;a<c&&b[a]===e[a];a++);var g=
c-a;for(d=1;d<=g&&b[c-d]===e[f-d];d++);return wc=e.slice(a,1<d?1-d:void 0)}function xc(){return!0}function yc(){return!1}function R(a,b,c,d){this.dispatchConfig=a;this._targetInst=b;this.nativeEvent=c;a=this.constructor.Interface;for(var e in a)a.hasOwnProperty(e)&&((b=a[e])?this[e]=b(c):"target"===e?this.target=d:this[e]=c[e]);this.isDefaultPrevented=(null!=c.defaultPrevented?c.defaultPrevented:!1===c.returnValue)?xc:yc;this.isPropagationStopped=yc;return this}function Li(a,b,c,d){if(this.eventPool.length){var e=
this.eventPool.pop();this.call(e,a,b,c,d);return e}return new this(a,b,c,d)}function Mi(a){if(!(a instanceof this))throw Error(k(279));a.destructor();10>this.eventPool.length&&this.eventPool.push(a)}function sg(a){a.eventPool=[];a.getPooled=Li;a.release=Mi}function tg(a,b){switch(a){case "keyup":return-1!==Ni.indexOf(b.keyCode);case "keydown":return 229!==b.keyCode;case "keypress":case "mousedown":case "blur":return!0;default:return!1}}function ug(a){a=a.detail;return"object"===typeof a&&"data"in
a?a.data:null}function Oi(a,b){switch(a){case "compositionend":return ug(b);case "keypress":if(32!==b.which)return null;vg=!0;return wg;case "textInput":return a=b.data,a===wg&&vg?null:a;default:return null}}function Pi(a,b){if(mb)return"compositionend"===a||!de&&tg(a,b)?(a=rg(),wc=ce=Ba=null,mb=!1,a):null;switch(a){case "paste":return null;case "keypress":if(!(b.ctrlKey||b.altKey||b.metaKey)||b.ctrlKey&&b.altKey){if(b.char&&1<b.char.length)return b.char;if(b.which)return String.fromCharCode(b.which)}return null;
case "compositionend":return xg&&"ko"!==b.locale?null:b.data;default:return null}}function yg(a){var b=a&&a.nodeName&&a.nodeName.toLowerCase();return"input"===b?!!Qi[a.type]:"textarea"===b?!0:!1}function zg(a,b,c){a=R.getPooled(Ag.change,a,b,c);a.type="change";sf(c);lb(a);return a}function Ri(a){pc(a)}function zc(a){var b=Pa(a);if(Gf(b))return a}function Si(a,b){if("change"===a)return b}function Bg(){Mb&&(Mb.detachEvent("onpropertychange",Cg),Nb=Mb=null)}function Cg(a){if("value"===a.propertyName&&
zc(Nb))if(a=zg(Nb,a,Ld(a)),Oa)pc(a);else{Oa=!0;try{ee(Ri,a)}finally{Oa=!1,ud()}}}function Ti(a,b,c){"focus"===a?(Bg(),Mb=b,Nb=c,Mb.attachEvent("onpropertychange",Cg)):"blur"===a&&Bg()}function Ui(a,b){if("selectionchange"===a||"keyup"===a||"keydown"===a)return zc(Nb)}function Vi(a,b){if("click"===a)return zc(b)}function Wi(a,b){if("input"===a||"change"===a)return zc(b)}function Xi(a){var b=this.nativeEvent;return b.getModifierState?b.getModifierState(a):(a=Yi[a])?!!b[a]:!1}function fe(a){return Xi}
function Zi(a,b){return a===b&&(0!==a||1/a===1/b)||a!==a&&b!==b}function Ob(a,b){if(Qa(a,b))return!0;if("object"!==typeof a||null===a||"object"!==typeof b||null===b)return!1;var c=Object.keys(a),d=Object.keys(b);if(c.length!==d.length)return!1;for(d=0;d<c.length;d++)if(!$i.call(b,c[d])||!Qa(a[c[d]],b[c[d]]))return!1;return!0}function Dg(a,b){var c=b.window===b?b.document:9===b.nodeType?b:b.ownerDocument;if(ge||null==nb||nb!==Wd(c))return null;c=nb;"selectionStart"in c&&Xd(c)?c={start:c.selectionStart,
end:c.selectionEnd}:(c=(c.ownerDocument&&c.ownerDocument.defaultView||window).getSelection(),c={anchorNode:c.anchorNode,anchorOffset:c.anchorOffset,focusNode:c.focusNode,focusOffset:c.focusOffset});return Pb&&Ob(Pb,c)?null:(Pb=c,a=R.getPooled(Eg.select,he,a,b),a.type="select",a.target=nb,lb(a),a)}function Ac(a){var b=a.keyCode;"charCode"in a?(a=a.charCode,0===a&&13===b&&(a=13)):a=b;10===a&&(a=13);return 32<=a||13===a?a:0}function q(a,b){0>ob||(a.current=ie[ob],ie[ob]=null,ob--)}function y(a,b,c){ob++;
ie[ob]=a.current;a.current=b}function pb(a,b){var c=a.type.contextTypes;if(!c)return Ca;var d=a.stateNode;if(d&&d.__reactInternalMemoizedUnmaskedChildContext===b)return d.__reactInternalMemoizedMaskedChildContext;var e={},f;for(f in c)e[f]=b[f];d&&(a=a.stateNode,a.__reactInternalMemoizedUnmaskedChildContext=b,a.__reactInternalMemoizedMaskedChildContext=e);return e}function N(a){a=a.childContextTypes;return null!==a&&void 0!==a}function Fg(a,b,c){if(B.current!==Ca)throw Error(k(168));y(B,b);y(G,c)}
function Gg(a,b,c){var d=a.stateNode;a=b.childContextTypes;if("function"!==typeof d.getChildContext)return c;d=d.getChildContext();for(var e in d)if(!(e in a))throw Error(k(108,na(b)||"Unknown",e));return M({},c,{},d)}function Bc(a){a=(a=a.stateNode)&&a.__reactInternalMemoizedMergedChildContext||Ca;Ra=B.current;y(B,a);y(G,G.current);return!0}function Hg(a,b,c){var d=a.stateNode;if(!d)throw Error(k(169));c?(a=Gg(a,b,Ra),d.__reactInternalMemoizedMergedChildContext=a,q(G),q(B),y(B,a)):q(G);y(G,c)}function Cc(){switch(aj()){case Dc:return 99;
case Ig:return 98;case Jg:return 97;case Kg:return 96;case Lg:return 95;default:throw Error(k(332));}}function Mg(a){switch(a){case 99:return Dc;case 98:return Ig;case 97:return Jg;case 96:return Kg;case 95:return Lg;default:throw Error(k(332));}}function Da(a,b){a=Mg(a);return bj(a,b)}function Ng(a,b,c){a=Mg(a);return je(a,b,c)}function Og(a){null===qa?(qa=[a],Ec=je(Dc,Pg)):qa.push(a);return Qg}function ha(){if(null!==Ec){var a=Ec;Ec=null;Rg(a)}Pg()}function Pg(){if(!ke&&null!==qa){ke=!0;var a=0;
try{var b=qa;Da(99,function(){for(;a<b.length;a++){var c=b[a];do c=c(!0);while(null!==c)}});qa=null}catch(c){throw null!==qa&&(qa=qa.slice(a+1)),je(Dc,ha),c;}finally{ke=!1}}}function Fc(a,b,c){c/=10;return 1073741821-(((1073741821-a+b/10)/c|0)+1)*c}function aa(a,b){if(a&&a.defaultProps){b=M({},b);a=a.defaultProps;for(var c in a)void 0===b[c]&&(b[c]=a[c])}return b}function le(){Gc=qb=Hc=null}function me(a){var b=Ic.current;q(Ic);a.type._context._currentValue=b}function Sg(a,b){for(;null!==a;){var c=
a.alternate;if(a.childExpirationTime<b)a.childExpirationTime=b,null!==c&&c.childExpirationTime<b&&(c.childExpirationTime=b);else if(null!==c&&c.childExpirationTime<b)c.childExpirationTime=b;else break;a=a.return}}function rb(a,b){Hc=a;Gc=qb=null;a=a.dependencies;null!==a&&null!==a.firstContext&&(a.expirationTime>=b&&(ia=!0),a.firstContext=null)}function W(a,b){if(Gc!==a&&!1!==b&&0!==b){if("number"!==typeof b||1073741823===b)Gc=a,b=1073741823;b={context:a,observedBits:b,next:null};if(null===qb){if(null===
Hc)throw Error(k(308));qb=b;Hc.dependencies={expirationTime:0,firstContext:b,responders:null}}else qb=qb.next=b}return a._currentValue}function ne(a){a.updateQueue={baseState:a.memoizedState,baseQueue:null,shared:{pending:null},effects:null}}function oe(a,b){a=a.updateQueue;b.updateQueue===a&&(b.updateQueue={baseState:a.baseState,baseQueue:a.baseQueue,shared:a.shared,effects:a.effects})}function Ea(a,b){a={expirationTime:a,suspenseConfig:b,tag:Tg,payload:null,callback:null,next:null};return a.next=
a}function Fa(a,b){a=a.updateQueue;if(null!==a){a=a.shared;var c=a.pending;null===c?b.next=b:(b.next=c.next,c.next=b);a.pending=b}}function Ug(a,b){var c=a.alternate;null!==c&&oe(c,a);a=a.updateQueue;c=a.baseQueue;null===c?(a.baseQueue=b.next=b,b.next=b):(b.next=c.next,c.next=b)}function Qb(a,b,c,d){var e=a.updateQueue;Ga=!1;var f=e.baseQueue,g=e.shared.pending;if(null!==g){if(null!==f){var h=f.next;f.next=g.next;g.next=h}f=g;e.shared.pending=null;h=a.alternate;null!==h&&(h=h.updateQueue,null!==h&&
(h.baseQueue=g))}if(null!==f){h=f.next;var m=e.baseState,n=0,k=null,ba=null,l=null;if(null!==h){var p=h;do{g=p.expirationTime;if(g<d){var t={expirationTime:p.expirationTime,suspenseConfig:p.suspenseConfig,tag:p.tag,payload:p.payload,callback:p.callback,next:null};null===l?(ba=l=t,k=m):l=l.next=t;g>n&&(n=g)}else{null!==l&&(l=l.next={expirationTime:1073741823,suspenseConfig:p.suspenseConfig,tag:p.tag,payload:p.payload,callback:p.callback,next:null});Vg(g,p.suspenseConfig);a:{var q=a,r=p;g=b;t=c;switch(r.tag){case 1:q=
r.payload;if("function"===typeof q){m=q.call(t,m,g);break a}m=q;break a;case 3:q.effectTag=q.effectTag&-4097|64;case Tg:q=r.payload;g="function"===typeof q?q.call(t,m,g):q;if(null===g||void 0===g)break a;m=M({},m,g);break a;case Jc:Ga=!0}}null!==p.callback&&(a.effectTag|=32,g=e.effects,null===g?e.effects=[p]:g.push(p))}p=p.next;if(null===p||p===h)if(g=e.shared.pending,null===g)break;else p=f.next=g.next,g.next=h,e.baseQueue=f=g,e.shared.pending=null}while(1)}null===l?k=m:l.next=ba;e.baseState=k;e.baseQueue=
l;Kc(n);a.expirationTime=n;a.memoizedState=m}}function Wg(a,b,c){a=b.effects;b.effects=null;if(null!==a)for(b=0;b<a.length;b++){var d=a[b],e=d.callback;if(null!==e){d.callback=null;d=e;e=c;if("function"!==typeof d)throw Error(k(191,d));d.call(e)}}}function Lc(a,b,c,d){b=a.memoizedState;c=c(d,b);c=null===c||void 0===c?b:M({},b,c);a.memoizedState=c;0===a.expirationTime&&(a.updateQueue.baseState=c)}function Xg(a,b,c,d,e,f,g){a=a.stateNode;return"function"===typeof a.shouldComponentUpdate?a.shouldComponentUpdate(d,
f,g):b.prototype&&b.prototype.isPureReactComponent?!Ob(c,d)||!Ob(e,f):!0}function Yg(a,b,c){var d=!1,e=Ca;var f=b.contextType;"object"===typeof f&&null!==f?f=W(f):(e=N(b)?Ra:B.current,d=b.contextTypes,f=(d=null!==d&&void 0!==d)?pb(a,e):Ca);b=new b(c,f);a.memoizedState=null!==b.state&&void 0!==b.state?b.state:null;b.updater=Mc;a.stateNode=b;b._reactInternalFiber=a;d&&(a=a.stateNode,a.__reactInternalMemoizedUnmaskedChildContext=e,a.__reactInternalMemoizedMaskedChildContext=f);return b}function Zg(a,
b,c,d){a=b.state;"function"===typeof b.componentWillReceiveProps&&b.componentWillReceiveProps(c,d);"function"===typeof b.UNSAFE_componentWillReceiveProps&&b.UNSAFE_componentWillReceiveProps(c,d);b.state!==a&&Mc.enqueueReplaceState(b,b.state,null)}function pe(a,b,c,d){var e=a.stateNode;e.props=c;e.state=a.memoizedState;e.refs=$g;ne(a);var f=b.contextType;"object"===typeof f&&null!==f?e.context=W(f):(f=N(b)?Ra:B.current,e.context=pb(a,f));Qb(a,c,e,d);e.state=a.memoizedState;f=b.getDerivedStateFromProps;
"function"===typeof f&&(Lc(a,b,f,c),e.state=a.memoizedState);"function"===typeof b.getDerivedStateFromProps||"function"===typeof e.getSnapshotBeforeUpdate||"function"!==typeof e.UNSAFE_componentWillMount&&"function"!==typeof e.componentWillMount||(b=e.state,"function"===typeof e.componentWillMount&&e.componentWillMount(),"function"===typeof e.UNSAFE_componentWillMount&&e.UNSAFE_componentWillMount(),b!==e.state&&Mc.enqueueReplaceState(e,e.state,null),Qb(a,c,e,d),e.state=a.memoizedState);"function"===
typeof e.componentDidMount&&(a.effectTag|=4)}function Rb(a,b,c){a=c.ref;if(null!==a&&"function"!==typeof a&&"object"!==typeof a){if(c._owner){c=c._owner;if(c){if(1!==c.tag)throw Error(k(309));var d=c.stateNode}if(!d)throw Error(k(147,a));var e=""+a;if(null!==b&&null!==b.ref&&"function"===typeof b.ref&&b.ref._stringRef===e)return b.ref;b=function(a){var b=d.refs;b===$g&&(b=d.refs={});null===a?delete b[e]:b[e]=a};b._stringRef=e;return b}if("string"!==typeof a)throw Error(k(284));if(!c._owner)throw Error(k(290,
a));}return a}function Nc(a,b){if("textarea"!==a.type)throw Error(k(31,"[object Object]"===Object.prototype.toString.call(b)?"object with keys {"+Object.keys(b).join(", ")+"}":b,""));}function ah(a){function b(b,c){if(a){var d=b.lastEffect;null!==d?(d.nextEffect=c,b.lastEffect=c):b.firstEffect=b.lastEffect=c;c.nextEffect=null;c.effectTag=8}}function c(c,d){if(!a)return null;for(;null!==d;)b(c,d),d=d.sibling;return null}function d(a,b){for(a=new Map;null!==b;)null!==b.key?a.set(b.key,b):a.set(b.index,
b),b=b.sibling;return a}function e(a,b){a=Sa(a,b);a.index=0;a.sibling=null;return a}function f(b,c,d){b.index=d;if(!a)return c;d=b.alternate;if(null!==d)return d=d.index,d<c?(b.effectTag=2,c):d;b.effectTag=2;return c}function g(b){a&&null===b.alternate&&(b.effectTag=2);return b}function h(a,b,c,d){if(null===b||6!==b.tag)return b=qe(c,a.mode,d),b.return=a,b;b=e(b,c);b.return=a;return b}function m(a,b,c,d){if(null!==b&&b.elementType===c.type)return d=e(b,c.props),d.ref=Rb(a,b,c),d.return=a,d;d=Oc(c.type,
c.key,c.props,null,a.mode,d);d.ref=Rb(a,b,c);d.return=a;return d}function n(a,b,c,d){if(null===b||4!==b.tag||b.stateNode.containerInfo!==c.containerInfo||b.stateNode.implementation!==c.implementation)return b=re(c,a.mode,d),b.return=a,b;b=e(b,c.children||[]);b.return=a;return b}function l(a,b,c,d,f){if(null===b||7!==b.tag)return b=Ha(c,a.mode,d,f),b.return=a,b;b=e(b,c);b.return=a;return b}function ba(a,b,c){if("string"===typeof b||"number"===typeof b)return b=qe(""+b,a.mode,c),b.return=a,b;if("object"===
typeof b&&null!==b){switch(b.$$typeof){case Pc:return c=Oc(b.type,b.key,b.props,null,a.mode,c),c.ref=Rb(a,null,b),c.return=a,c;case gb:return b=re(b,a.mode,c),b.return=a,b}if(Qc(b)||zb(b))return b=Ha(b,a.mode,c,null),b.return=a,b;Nc(a,b)}return null}function p(a,b,c,d){var e=null!==b?b.key:null;if("string"===typeof c||"number"===typeof c)return null!==e?null:h(a,b,""+c,d);if("object"===typeof c&&null!==c){switch(c.$$typeof){case Pc:return c.key===e?c.type===Ma?l(a,b,c.props.children,d,e):m(a,b,c,
d):null;case gb:return c.key===e?n(a,b,c,d):null}if(Qc(c)||zb(c))return null!==e?null:l(a,b,c,d,null);Nc(a,c)}return null}function t(a,b,c,d,e){if("string"===typeof d||"number"===typeof d)return a=a.get(c)||null,h(b,a,""+d,e);if("object"===typeof d&&null!==d){switch(d.$$typeof){case Pc:return a=a.get(null===d.key?c:d.key)||null,d.type===Ma?l(b,a,d.props.children,e,d.key):m(b,a,d,e);case gb:return a=a.get(null===d.key?c:d.key)||null,n(b,a,d,e)}if(Qc(d)||zb(d))return a=a.get(c)||null,l(b,a,d,e,null);
Nc(b,d)}return null}function q(e,g,h,m){for(var n=null,k=null,l=g,r=g=0,C=null;null!==l&&r<h.length;r++){l.index>r?(C=l,l=null):C=l.sibling;var O=p(e,l,h[r],m);if(null===O){null===l&&(l=C);break}a&&l&&null===O.alternate&&b(e,l);g=f(O,g,r);null===k?n=O:k.sibling=O;k=O;l=C}if(r===h.length)return c(e,l),n;if(null===l){for(;r<h.length;r++)l=ba(e,h[r],m),null!==l&&(g=f(l,g,r),null===k?n=l:k.sibling=l,k=l);return n}for(l=d(e,l);r<h.length;r++)C=t(l,e,r,h[r],m),null!==C&&(a&&null!==C.alternate&&l.delete(null===
C.key?r:C.key),g=f(C,g,r),null===k?n=C:k.sibling=C,k=C);a&&l.forEach(function(a){return b(e,a)});return n}function w(e,g,h,n){var m=zb(h);if("function"!==typeof m)throw Error(k(150));h=m.call(h);if(null==h)throw Error(k(151));for(var l=m=null,r=g,C=g=0,O=null,v=h.next();null!==r&&!v.done;C++,v=h.next()){r.index>C?(O=r,r=null):O=r.sibling;var q=p(e,r,v.value,n);if(null===q){null===r&&(r=O);break}a&&r&&null===q.alternate&&b(e,r);g=f(q,g,C);null===l?m=q:l.sibling=q;l=q;r=O}if(v.done)return c(e,r),m;
if(null===r){for(;!v.done;C++,v=h.next())v=ba(e,v.value,n),null!==v&&(g=f(v,g,C),null===l?m=v:l.sibling=v,l=v);return m}for(r=d(e,r);!v.done;C++,v=h.next())v=t(r,e,C,v.value,n),null!==v&&(a&&null!==v.alternate&&r.delete(null===v.key?C:v.key),g=f(v,g,C),null===l?m=v:l.sibling=v,l=v);a&&r.forEach(function(a){return b(e,a)});return m}return function(a,d,f,h){var m="object"===typeof f&&null!==f&&f.type===Ma&&null===f.key;m&&(f=f.props.children);var n="object"===typeof f&&null!==f;if(n)switch(f.$$typeof){case Pc:a:{n=
f.key;for(m=d;null!==m;){if(m.key===n){switch(m.tag){case 7:if(f.type===Ma){c(a,m.sibling);d=e(m,f.props.children);d.return=a;a=d;break a}break;default:if(m.elementType===f.type){c(a,m.sibling);d=e(m,f.props);d.ref=Rb(a,m,f);d.return=a;a=d;break a}}c(a,m);break}else b(a,m);m=m.sibling}f.type===Ma?(d=Ha(f.props.children,a.mode,h,f.key),d.return=a,a=d):(h=Oc(f.type,f.key,f.props,null,a.mode,h),h.ref=Rb(a,d,f),h.return=a,a=h)}return g(a);case gb:a:{for(m=f.key;null!==d;){if(d.key===m)if(4===d.tag&&d.stateNode.containerInfo===
f.containerInfo&&d.stateNode.implementation===f.implementation){c(a,d.sibling);d=e(d,f.children||[]);d.return=a;a=d;break a}else{c(a,d);break}else b(a,d);d=d.sibling}d=re(f,a.mode,h);d.return=a;a=d}return g(a)}if("string"===typeof f||"number"===typeof f)return f=""+f,null!==d&&6===d.tag?(c(a,d.sibling),d=e(d,f),d.return=a,a=d):(c(a,d),d=qe(f,a.mode,h),d.return=a,a=d),g(a);if(Qc(f))return q(a,d,f,h);if(zb(f))return w(a,d,f,h);n&&Nc(a,f);if("undefined"===typeof f&&!m)switch(a.tag){case 1:case 0:throw a=
a.type,Error(k(152,a.displayName||a.name||"Component"));}return c(a,d)}}function Ta(a){if(a===Sb)throw Error(k(174));return a}function se(a,b){y(Tb,b);y(Ub,a);y(ja,Sb);a=b.nodeType;switch(a){case 9:case 11:b=(b=b.documentElement)?b.namespaceURI:Hd(null,"");break;default:a=8===a?b.parentNode:b,b=a.namespaceURI||null,a=a.tagName,b=Hd(b,a)}q(ja);y(ja,b)}function tb(a){q(ja);q(Ub);q(Tb)}function bh(a){Ta(Tb.current);var b=Ta(ja.current);var c=Hd(b,a.type);b!==c&&(y(Ub,a),y(ja,c))}function te(a){Ub.current===
a&&(q(ja),q(Ub))}function Rc(a){for(var b=a;null!==b;){if(13===b.tag){var c=b.memoizedState;if(null!==c&&(c=c.dehydrated,null===c||c.data===$d||c.data===Zd))return b}else if(19===b.tag&&void 0!==b.memoizedProps.revealOrder){if(0!==(b.effectTag&64))return b}else if(null!==b.child){b.child.return=b;b=b.child;continue}if(b===a)break;for(;null===b.sibling;){if(null===b.return||b.return===a)return null;b=b.return}b.sibling.return=b.return;b=b.sibling}return null}function ue(a,b){return{responder:a,props:b}}
function S(){throw Error(k(321));}function ve(a,b){if(null===b)return!1;for(var c=0;c<b.length&&c<a.length;c++)if(!Qa(a[c],b[c]))return!1;return!0}function we(a,b,c,d,e,f){Ia=f;z=b;b.memoizedState=null;b.updateQueue=null;b.expirationTime=0;Sc.current=null===a||null===a.memoizedState?dj:ej;a=c(d,e);if(b.expirationTime===Ia){f=0;do{b.expirationTime=0;if(!(25>f))throw Error(k(301));f+=1;J=K=null;b.updateQueue=null;Sc.current=fj;a=c(d,e)}while(b.expirationTime===Ia)}Sc.current=Tc;b=null!==K&&null!==K.next;
Ia=0;J=K=z=null;Uc=!1;if(b)throw Error(k(300));return a}function ub(){var a={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};null===J?z.memoizedState=J=a:J=J.next=a;return J}function vb(){if(null===K){var a=z.alternate;a=null!==a?a.memoizedState:null}else a=K.next;var b=null===J?z.memoizedState:J.next;if(null!==b)J=b,K=a;else{if(null===a)throw Error(k(310));K=a;a={memoizedState:K.memoizedState,baseState:K.baseState,baseQueue:K.baseQueue,queue:K.queue,next:null};null===J?z.memoizedState=
J=a:J=J.next=a}return J}function Ua(a,b){return"function"===typeof b?b(a):b}function Vc(a,b,c){b=vb();c=b.queue;if(null===c)throw Error(k(311));c.lastRenderedReducer=a;var d=K,e=d.baseQueue,f=c.pending;if(null!==f){if(null!==e){var g=e.next;e.next=f.next;f.next=g}d.baseQueue=e=f;c.pending=null}if(null!==e){e=e.next;d=d.baseState;var h=g=f=null,m=e;do{var n=m.expirationTime;if(n<Ia){var l={expirationTime:m.expirationTime,suspenseConfig:m.suspenseConfig,action:m.action,eagerReducer:m.eagerReducer,eagerState:m.eagerState,
next:null};null===h?(g=h=l,f=d):h=h.next=l;n>z.expirationTime&&(z.expirationTime=n,Kc(n))}else null!==h&&(h=h.next={expirationTime:1073741823,suspenseConfig:m.suspenseConfig,action:m.action,eagerReducer:m.eagerReducer,eagerState:m.eagerState,next:null}),Vg(n,m.suspenseConfig),d=m.eagerReducer===a?m.eagerState:a(d,m.action);m=m.next}while(null!==m&&m!==e);null===h?f=d:h.next=g;Qa(d,b.memoizedState)||(ia=!0);b.memoizedState=d;b.baseState=f;b.baseQueue=h;c.lastRenderedState=d}return[b.memoizedState,
c.dispatch]}function Wc(a,b,c){b=vb();c=b.queue;if(null===c)throw Error(k(311));c.lastRenderedReducer=a;var d=c.dispatch,e=c.pending,f=b.memoizedState;if(null!==e){c.pending=null;var g=e=e.next;do f=a(f,g.action),g=g.next;while(g!==e);Qa(f,b.memoizedState)||(ia=!0);b.memoizedState=f;null===b.baseQueue&&(b.baseState=f);c.lastRenderedState=f}return[f,d]}function xe(a){var b=ub();"function"===typeof a&&(a=a());b.memoizedState=b.baseState=a;a=b.queue={pending:null,dispatch:null,lastRenderedReducer:Ua,
lastRenderedState:a};a=a.dispatch=ch.bind(null,z,a);return[b.memoizedState,a]}function ye(a,b,c,d){a={tag:a,create:b,destroy:c,deps:d,next:null};b=z.updateQueue;null===b?(b={lastEffect:null},z.updateQueue=b,b.lastEffect=a.next=a):(c=b.lastEffect,null===c?b.lastEffect=a.next=a:(d=c.next,c.next=a,a.next=d,b.lastEffect=a));return a}function dh(a){return vb().memoizedState}function ze(a,b,c,d){var e=ub();z.effectTag|=a;e.memoizedState=ye(1|b,c,void 0,void 0===d?null:d)}function Ae(a,b,c,d){var e=vb();
d=void 0===d?null:d;var f=void 0;if(null!==K){var g=K.memoizedState;f=g.destroy;if(null!==d&&ve(d,g.deps)){ye(b,c,f,d);return}}z.effectTag|=a;e.memoizedState=ye(1|b,c,f,d)}function eh(a,b){return ze(516,4,a,b)}function Xc(a,b){return Ae(516,4,a,b)}function fh(a,b){return Ae(4,2,a,b)}function gh(a,b){if("function"===typeof b)return a=a(),b(a),function(){b(null)};if(null!==b&&void 0!==b)return a=a(),b.current=a,function(){b.current=null}}function hh(a,b,c){c=null!==c&&void 0!==c?c.concat([a]):null;
return Ae(4,2,gh.bind(null,b,a),c)}function Be(a,b){}function ih(a,b){ub().memoizedState=[a,void 0===b?null:b];return a}function Yc(a,b){var c=vb();b=void 0===b?null:b;var d=c.memoizedState;if(null!==d&&null!==b&&ve(b,d[1]))return d[0];c.memoizedState=[a,b];return a}function jh(a,b){var c=vb();b=void 0===b?null:b;var d=c.memoizedState;if(null!==d&&null!==b&&ve(b,d[1]))return d[0];a=a();c.memoizedState=[a,b];return a}function Ce(a,b,c){var d=Cc();Da(98>d?98:d,function(){a(!0)});Da(97<d?97:d,function(){var d=
X.suspense;X.suspense=void 0===b?null:b;try{a(!1),c()}finally{X.suspense=d}})}function ch(a,b,c){var d=ka(),e=Vb.suspense;d=Va(d,a,e);e={expirationTime:d,suspenseConfig:e,action:c,eagerReducer:null,eagerState:null,next:null};var f=b.pending;null===f?e.next=e:(e.next=f.next,f.next=e);b.pending=e;f=a.alternate;if(a===z||null!==f&&f===z)Uc=!0,e.expirationTime=Ia,z.expirationTime=Ia;else{if(0===a.expirationTime&&(null===f||0===f.expirationTime)&&(f=b.lastRenderedReducer,null!==f))try{var g=b.lastRenderedState,
h=f(g,c);e.eagerReducer=f;e.eagerState=h;if(Qa(h,g))return}catch(m){}finally{}Ja(a,d)}}function kh(a,b){var c=la(5,null,null,0);c.elementType="DELETED";c.type="DELETED";c.stateNode=b;c.return=a;c.effectTag=8;null!==a.lastEffect?(a.lastEffect.nextEffect=c,a.lastEffect=c):a.firstEffect=a.lastEffect=c}function lh(a,b){switch(a.tag){case 5:var c=a.type;b=1!==b.nodeType||c.toLowerCase()!==b.nodeName.toLowerCase()?null:b;return null!==b?(a.stateNode=b,!0):!1;case 6:return b=""===a.pendingProps||3!==b.nodeType?
null:b,null!==b?(a.stateNode=b,!0):!1;case 13:return!1;default:return!1}}function De(a){if(Wa){var b=Ka;if(b){var c=b;if(!lh(a,b)){b=kb(c.nextSibling);if(!b||!lh(a,b)){a.effectTag=a.effectTag&-1025|2;Wa=!1;ra=a;return}kh(ra,c)}ra=a;Ka=kb(b.firstChild)}else a.effectTag=a.effectTag&-1025|2,Wa=!1,ra=a}}function mh(a){for(a=a.return;null!==a&&5!==a.tag&&3!==a.tag&&13!==a.tag;)a=a.return;ra=a}function Zc(a){if(a!==ra)return!1;if(!Wa)return mh(a),Wa=!0,!1;var b=a.type;if(5!==a.tag||"head"!==b&&"body"!==
b&&!Yd(b,a.memoizedProps))for(b=Ka;b;)kh(a,b),b=kb(b.nextSibling);mh(a);if(13===a.tag){a=a.memoizedState;a=null!==a?a.dehydrated:null;if(!a)throw Error(k(317));a:{a=a.nextSibling;for(b=0;a;){if(8===a.nodeType){var c=a.data;if(c===og){if(0===b){Ka=kb(a.nextSibling);break a}b--}else c!==ng&&c!==Zd&&c!==$d||b++}a=a.nextSibling}Ka=null}}else Ka=ra?kb(a.stateNode.nextSibling):null;return!0}function Ee(){Ka=ra=null;Wa=!1}function T(a,b,c,d){b.child=null===a?Fe(b,null,c,d):wb(b,a.child,c,d)}function nh(a,
b,c,d,e){c=c.render;var f=b.ref;rb(b,e);d=we(a,b,c,d,f,e);if(null!==a&&!ia)return b.updateQueue=a.updateQueue,b.effectTag&=-517,a.expirationTime<=e&&(a.expirationTime=0),sa(a,b,e);b.effectTag|=1;T(a,b,d,e);return b.child}function oh(a,b,c,d,e,f){if(null===a){var g=c.type;if("function"===typeof g&&!Ge(g)&&void 0===g.defaultProps&&null===c.compare&&void 0===c.defaultProps)return b.tag=15,b.type=g,ph(a,b,g,d,e,f);a=Oc(c.type,null,d,null,b.mode,f);a.ref=b.ref;a.return=b;return b.child=a}g=a.child;if(e<
f&&(e=g.memoizedProps,c=c.compare,c=null!==c?c:Ob,c(e,d)&&a.ref===b.ref))return sa(a,b,f);b.effectTag|=1;a=Sa(g,d);a.ref=b.ref;a.return=b;return b.child=a}function ph(a,b,c,d,e,f){return null!==a&&Ob(a.memoizedProps,d)&&a.ref===b.ref&&(ia=!1,e<f)?(b.expirationTime=a.expirationTime,sa(a,b,f)):He(a,b,c,d,f)}function qh(a,b){var c=b.ref;if(null===a&&null!==c||null!==a&&a.ref!==c)b.effectTag|=128}function He(a,b,c,d,e){var f=N(c)?Ra:B.current;f=pb(b,f);rb(b,e);c=we(a,b,c,d,f,e);if(null!==a&&!ia)return b.updateQueue=
a.updateQueue,b.effectTag&=-517,a.expirationTime<=e&&(a.expirationTime=0),sa(a,b,e);b.effectTag|=1;T(a,b,c,e);return b.child}function rh(a,b,c,d,e){if(N(c)){var f=!0;Bc(b)}else f=!1;rb(b,e);if(null===b.stateNode)null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2),Yg(b,c,d),pe(b,c,d,e),d=!0;else if(null===a){var g=b.stateNode,h=b.memoizedProps;g.props=h;var m=g.context,n=c.contextType;"object"===typeof n&&null!==n?n=W(n):(n=N(c)?Ra:B.current,n=pb(b,n));var l=c.getDerivedStateFromProps,k="function"===
typeof l||"function"===typeof g.getSnapshotBeforeUpdate;k||"function"!==typeof g.UNSAFE_componentWillReceiveProps&&"function"!==typeof g.componentWillReceiveProps||(h!==d||m!==n)&&Zg(b,g,d,n);Ga=!1;var p=b.memoizedState;g.state=p;Qb(b,d,g,e);m=b.memoizedState;h!==d||p!==m||G.current||Ga?("function"===typeof l&&(Lc(b,c,l,d),m=b.memoizedState),(h=Ga||Xg(b,c,h,d,p,m,n))?(k||"function"!==typeof g.UNSAFE_componentWillMount&&"function"!==typeof g.componentWillMount||("function"===typeof g.componentWillMount&&
g.componentWillMount(),"function"===typeof g.UNSAFE_componentWillMount&&g.UNSAFE_componentWillMount()),"function"===typeof g.componentDidMount&&(b.effectTag|=4)):("function"===typeof g.componentDidMount&&(b.effectTag|=4),b.memoizedProps=d,b.memoizedState=m),g.props=d,g.state=m,g.context=n,d=h):("function"===typeof g.componentDidMount&&(b.effectTag|=4),d=!1)}else g=b.stateNode,oe(a,b),h=b.memoizedProps,g.props=b.type===b.elementType?h:aa(b.type,h),m=g.context,n=c.contextType,"object"===typeof n&&null!==
n?n=W(n):(n=N(c)?Ra:B.current,n=pb(b,n)),l=c.getDerivedStateFromProps,(k="function"===typeof l||"function"===typeof g.getSnapshotBeforeUpdate)||"function"!==typeof g.UNSAFE_componentWillReceiveProps&&"function"!==typeof g.componentWillReceiveProps||(h!==d||m!==n)&&Zg(b,g,d,n),Ga=!1,m=b.memoizedState,g.state=m,Qb(b,d,g,e),p=b.memoizedState,h!==d||m!==p||G.current||Ga?("function"===typeof l&&(Lc(b,c,l,d),p=b.memoizedState),(l=Ga||Xg(b,c,h,d,m,p,n))?(k||"function"!==typeof g.UNSAFE_componentWillUpdate&&
"function"!==typeof g.componentWillUpdate||("function"===typeof g.componentWillUpdate&&g.componentWillUpdate(d,p,n),"function"===typeof g.UNSAFE_componentWillUpdate&&g.UNSAFE_componentWillUpdate(d,p,n)),"function"===typeof g.componentDidUpdate&&(b.effectTag|=4),"function"===typeof g.getSnapshotBeforeUpdate&&(b.effectTag|=256)):("function"!==typeof g.componentDidUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=4),"function"!==typeof g.getSnapshotBeforeUpdate||h===a.memoizedProps&&m===
a.memoizedState||(b.effectTag|=256),b.memoizedProps=d,b.memoizedState=p),g.props=d,g.state=p,g.context=n,d=l):("function"!==typeof g.componentDidUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=4),"function"!==typeof g.getSnapshotBeforeUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=256),d=!1);return Ie(a,b,c,d,f,e)}function Ie(a,b,c,d,e,f){qh(a,b);var g=0!==(b.effectTag&64);if(!d&&!g)return e&&Hg(b,c,!1),sa(a,b,f);d=b.stateNode;gj.current=b;var h=g&&"function"!==typeof c.getDerivedStateFromError?
null:d.render();b.effectTag|=1;null!==a&&g?(b.child=wb(b,a.child,null,f),b.child=wb(b,null,h,f)):T(a,b,h,f);b.memoizedState=d.state;e&&Hg(b,c,!0);return b.child}function sh(a){var b=a.stateNode;b.pendingContext?Fg(a,b.pendingContext,b.pendingContext!==b.context):b.context&&Fg(a,b.context,!1);se(a,b.containerInfo)}function th(a,b,c){var d=b.mode,e=b.pendingProps,f=D.current,g=!1,h;(h=0!==(b.effectTag&64))||(h=0!==(f&2)&&(null===a||null!==a.memoizedState));h?(g=!0,b.effectTag&=-65):null!==a&&null===
a.memoizedState||void 0===e.fallback||!0===e.unstable_avoidThisFallback||(f|=1);y(D,f&1);if(null===a){void 0!==e.fallback&&De(b);if(g){g=e.fallback;e=Ha(null,d,0,null);e.return=b;if(0===(b.mode&2))for(a=null!==b.memoizedState?b.child.child:b.child,e.child=a;null!==a;)a.return=e,a=a.sibling;c=Ha(g,d,c,null);c.return=b;e.sibling=c;b.memoizedState=Je;b.child=e;return c}d=e.children;b.memoizedState=null;return b.child=Fe(b,null,d,c)}if(null!==a.memoizedState){a=a.child;d=a.sibling;if(g){e=e.fallback;
c=Sa(a,a.pendingProps);c.return=b;if(0===(b.mode&2)&&(g=null!==b.memoizedState?b.child.child:b.child,g!==a.child))for(c.child=g;null!==g;)g.return=c,g=g.sibling;d=Sa(d,e);d.return=b;c.sibling=d;c.childExpirationTime=0;b.memoizedState=Je;b.child=c;return d}c=wb(b,a.child,e.children,c);b.memoizedState=null;return b.child=c}a=a.child;if(g){g=e.fallback;e=Ha(null,d,0,null);e.return=b;e.child=a;null!==a&&(a.return=e);if(0===(b.mode&2))for(a=null!==b.memoizedState?b.child.child:b.child,e.child=a;null!==
a;)a.return=e,a=a.sibling;c=Ha(g,d,c,null);c.return=b;e.sibling=c;c.effectTag|=2;e.childExpirationTime=0;b.memoizedState=Je;b.child=e;return c}b.memoizedState=null;return b.child=wb(b,a,e.children,c)}function uh(a,b){a.expirationTime<b&&(a.expirationTime=b);var c=a.alternate;null!==c&&c.expirationTime<b&&(c.expirationTime=b);Sg(a.return,b)}function Ke(a,b,c,d,e,f){var g=a.memoizedState;null===g?a.memoizedState={isBackwards:b,rendering:null,renderingStartTime:0,last:d,tail:c,tailExpiration:0,tailMode:e,
lastEffect:f}:(g.isBackwards=b,g.rendering=null,g.renderingStartTime=0,g.last=d,g.tail=c,g.tailExpiration=0,g.tailMode=e,g.lastEffect=f)}function vh(a,b,c){var d=b.pendingProps,e=d.revealOrder,f=d.tail;T(a,b,d.children,c);d=D.current;if(0!==(d&2))d=d&1|2,b.effectTag|=64;else{if(null!==a&&0!==(a.effectTag&64))a:for(a=b.child;null!==a;){if(13===a.tag)null!==a.memoizedState&&uh(a,c);else if(19===a.tag)uh(a,c);else if(null!==a.child){a.child.return=a;a=a.child;continue}if(a===b)break a;for(;null===a.sibling;){if(null===
a.return||a.return===b)break a;a=a.return}a.sibling.return=a.return;a=a.sibling}d&=1}y(D,d);if(0===(b.mode&2))b.memoizedState=null;else switch(e){case "forwards":c=b.child;for(e=null;null!==c;)a=c.alternate,null!==a&&null===Rc(a)&&(e=c),c=c.sibling;c=e;null===c?(e=b.child,b.child=null):(e=c.sibling,c.sibling=null);Ke(b,!1,e,c,f,b.lastEffect);break;case "backwards":c=null;e=b.child;for(b.child=null;null!==e;){a=e.alternate;if(null!==a&&null===Rc(a)){b.child=e;break}a=e.sibling;e.sibling=c;c=e;e=a}Ke(b,
!0,c,null,f,b.lastEffect);break;case "together":Ke(b,!1,null,null,void 0,b.lastEffect);break;default:b.memoizedState=null}return b.child}function sa(a,b,c){null!==a&&(b.dependencies=a.dependencies);var d=b.expirationTime;0!==d&&Kc(d);if(b.childExpirationTime<c)return null;if(null!==a&&b.child!==a.child)throw Error(k(153));if(null!==b.child){a=b.child;c=Sa(a,a.pendingProps);b.child=c;for(c.return=b;null!==a.sibling;)a=a.sibling,c=c.sibling=Sa(a,a.pendingProps),c.return=b;c.sibling=null}return b.child}
function $c(a,b){switch(a.tailMode){case "hidden":b=a.tail;for(var c=null;null!==b;)null!==b.alternate&&(c=b),b=b.sibling;null===c?a.tail=null:c.sibling=null;break;case "collapsed":c=a.tail;for(var d=null;null!==c;)null!==c.alternate&&(d=c),c=c.sibling;null===d?b||null===a.tail?a.tail=null:a.tail.sibling=null:d.sibling=null}}function hj(a,b,c){var d=b.pendingProps;switch(b.tag){case 2:case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return null;case 1:return N(b.type)&&(q(G),q(B)),
null;case 3:return tb(),q(G),q(B),c=b.stateNode,c.pendingContext&&(c.context=c.pendingContext,c.pendingContext=null),null!==a&&null!==a.child||!Zc(b)||(b.effectTag|=4),wh(b),null;case 5:te(b);c=Ta(Tb.current);var e=b.type;if(null!==a&&null!=b.stateNode)ij(a,b,e,d,c),a.ref!==b.ref&&(b.effectTag|=128);else{if(!d){if(null===b.stateNode)throw Error(k(166));return null}a=Ta(ja.current);if(Zc(b)){d=b.stateNode;e=b.type;var f=b.memoizedProps;d[Aa]=b;d[vc]=f;switch(e){case "iframe":case "object":case "embed":w("load",
d);break;case "video":case "audio":for(a=0;a<Db.length;a++)w(Db[a],d);break;case "source":w("error",d);break;case "img":case "image":case "link":w("error",d);w("load",d);break;case "form":w("reset",d);w("submit",d);break;case "details":w("toggle",d);break;case "input":Hf(d,f);w("invalid",d);oa(c,"onChange");break;case "select":d._wrapperState={wasMultiple:!!f.multiple};w("invalid",d);oa(c,"onChange");break;case "textarea":Kf(d,f),w("invalid",d),oa(c,"onChange")}Ud(e,f);a=null;for(var g in f)if(f.hasOwnProperty(g)){var h=
f[g];"children"===g?"string"===typeof h?d.textContent!==h&&(a=["children",h]):"number"===typeof h&&d.textContent!==""+h&&(a=["children",""+h]):db.hasOwnProperty(g)&&null!=h&&oa(c,g)}switch(e){case "input":mc(d);Jf(d,f,!0);break;case "textarea":mc(d);Mf(d);break;case "select":case "option":break;default:"function"===typeof f.onClick&&(d.onclick=uc)}c=a;b.updateQueue=c;null!==c&&(b.effectTag|=4)}else{g=9===c.nodeType?c:c.ownerDocument;"http://www.w3.org/1999/xhtml"===a&&(a=Nf(e));"http://www.w3.org/1999/xhtml"===
a?"script"===e?(a=g.createElement("div"),a.innerHTML="<script>\x3c/script>",a=a.removeChild(a.firstChild)):"string"===typeof d.is?a=g.createElement(e,{is:d.is}):(a=g.createElement(e),"select"===e&&(g=a,d.multiple?g.multiple=!0:d.size&&(g.size=d.size))):a=g.createElementNS(a,e);a[Aa]=b;a[vc]=d;jj(a,b,!1,!1);b.stateNode=a;g=Vd(e,d);switch(e){case "iframe":case "object":case "embed":w("load",a);h=d;break;case "video":case "audio":for(h=0;h<Db.length;h++)w(Db[h],a);h=d;break;case "source":w("error",a);
h=d;break;case "img":case "image":case "link":w("error",a);w("load",a);h=d;break;case "form":w("reset",a);w("submit",a);h=d;break;case "details":w("toggle",a);h=d;break;case "input":Hf(a,d);h=Cd(a,d);w("invalid",a);oa(c,"onChange");break;case "option":h=Fd(a,d);break;case "select":a._wrapperState={wasMultiple:!!d.multiple};h=M({},d,{value:void 0});w("invalid",a);oa(c,"onChange");break;case "textarea":Kf(a,d);h=Gd(a,d);w("invalid",a);oa(c,"onChange");break;default:h=d}Ud(e,h);var m=h;for(f in m)if(m.hasOwnProperty(f)){var n=
m[f];"style"===f?gg(a,n):"dangerouslySetInnerHTML"===f?(n=n?n.__html:void 0,null!=n&&xh(a,n)):"children"===f?"string"===typeof n?("textarea"!==e||""!==n)&&Wb(a,n):"number"===typeof n&&Wb(a,""+n):"suppressContentEditableWarning"!==f&&"suppressHydrationWarning"!==f&&"autoFocus"!==f&&(db.hasOwnProperty(f)?null!=n&&oa(c,f):null!=n&&xd(a,f,n,g))}switch(e){case "input":mc(a);Jf(a,d,!1);break;case "textarea":mc(a);Mf(a);break;case "option":null!=d.value&&a.setAttribute("value",""+va(d.value));break;case "select":a.multiple=
!!d.multiple;c=d.value;null!=c?hb(a,!!d.multiple,c,!1):null!=d.defaultValue&&hb(a,!!d.multiple,d.defaultValue,!0);break;default:"function"===typeof h.onClick&&(a.onclick=uc)}lg(e,d)&&(b.effectTag|=4)}null!==b.ref&&(b.effectTag|=128)}return null;case 6:if(a&&null!=b.stateNode)kj(a,b,a.memoizedProps,d);else{if("string"!==typeof d&&null===b.stateNode)throw Error(k(166));c=Ta(Tb.current);Ta(ja.current);Zc(b)?(c=b.stateNode,d=b.memoizedProps,c[Aa]=b,c.nodeValue!==d&&(b.effectTag|=4)):(c=(9===c.nodeType?
c:c.ownerDocument).createTextNode(d),c[Aa]=b,b.stateNode=c)}return null;case 13:q(D);d=b.memoizedState;if(0!==(b.effectTag&64))return b.expirationTime=c,b;c=null!==d;d=!1;null===a?void 0!==b.memoizedProps.fallback&&Zc(b):(e=a.memoizedState,d=null!==e,c||null===e||(e=a.child.sibling,null!==e&&(f=b.firstEffect,null!==f?(b.firstEffect=e,e.nextEffect=f):(b.firstEffect=b.lastEffect=e,e.nextEffect=null),e.effectTag=8)));if(c&&!d&&0!==(b.mode&2))if(null===a&&!0!==b.memoizedProps.unstable_avoidThisFallback||
0!==(D.current&1))F===Xa&&(F=ad);else{if(F===Xa||F===ad)F=bd;0!==Xb&&null!==U&&(Ya(U,P),yh(U,Xb))}if(c||d)b.effectTag|=4;return null;case 4:return tb(),wh(b),null;case 10:return me(b),null;case 17:return N(b.type)&&(q(G),q(B)),null;case 19:q(D);d=b.memoizedState;if(null===d)return null;e=0!==(b.effectTag&64);f=d.rendering;if(null===f)if(e)$c(d,!1);else{if(F!==Xa||null!==a&&0!==(a.effectTag&64))for(f=b.child;null!==f;){a=Rc(f);if(null!==a){b.effectTag|=64;$c(d,!1);e=a.updateQueue;null!==e&&(b.updateQueue=
e,b.effectTag|=4);null===d.lastEffect&&(b.firstEffect=null);b.lastEffect=d.lastEffect;for(d=b.child;null!==d;)e=d,f=c,e.effectTag&=2,e.nextEffect=null,e.firstEffect=null,e.lastEffect=null,a=e.alternate,null===a?(e.childExpirationTime=0,e.expirationTime=f,e.child=null,e.memoizedProps=null,e.memoizedState=null,e.updateQueue=null,e.dependencies=null):(e.childExpirationTime=a.childExpirationTime,e.expirationTime=a.expirationTime,e.child=a.child,e.memoizedProps=a.memoizedProps,e.memoizedState=a.memoizedState,
e.updateQueue=a.updateQueue,f=a.dependencies,e.dependencies=null===f?null:{expirationTime:f.expirationTime,firstContext:f.firstContext,responders:f.responders}),d=d.sibling;y(D,D.current&1|2);return b.child}f=f.sibling}}else{if(!e)if(a=Rc(f),null!==a){if(b.effectTag|=64,e=!0,c=a.updateQueue,null!==c&&(b.updateQueue=c,b.effectTag|=4),$c(d,!0),null===d.tail&&"hidden"===d.tailMode&&!f.alternate)return b=b.lastEffect=d.lastEffect,null!==b&&(b.nextEffect=null),null}else 2*Y()-d.renderingStartTime>d.tailExpiration&&
1<c&&(b.effectTag|=64,e=!0,$c(d,!1),b.expirationTime=b.childExpirationTime=c-1);d.isBackwards?(f.sibling=b.child,b.child=f):(c=d.last,null!==c?c.sibling=f:b.child=f,d.last=f)}return null!==d.tail?(0===d.tailExpiration&&(d.tailExpiration=Y()+500),c=d.tail,d.rendering=c,d.tail=c.sibling,d.lastEffect=b.lastEffect,d.renderingStartTime=Y(),c.sibling=null,b=D.current,y(D,e?b&1|2:b&1),c):null}throw Error(k(156,b.tag));}function lj(a,b){switch(a.tag){case 1:return N(a.type)&&(q(G),q(B)),b=a.effectTag,b&4096?
(a.effectTag=b&-4097|64,a):null;case 3:tb();q(G);q(B);b=a.effectTag;if(0!==(b&64))throw Error(k(285));a.effectTag=b&-4097|64;return a;case 5:return te(a),null;case 13:return q(D),b=a.effectTag,b&4096?(a.effectTag=b&-4097|64,a):null;case 19:return q(D),null;case 4:return tb(),null;case 10:return me(a),null;default:return null}}function Le(a,b){return{value:a,source:b,stack:Bd(b)}}function Me(a,b){var c=b.source,d=b.stack;null===d&&null!==c&&(d=Bd(c));null!==c&&na(c.type);b=b.value;null!==a&&1===a.tag&&
na(a.type);try{console.error(b)}catch(e){setTimeout(function(){throw e;})}}function mj(a,b){try{b.props=a.memoizedProps,b.state=a.memoizedState,b.componentWillUnmount()}catch(c){Za(a,c)}}function zh(a){var b=a.ref;if(null!==b)if("function"===typeof b)try{b(null)}catch(c){Za(a,c)}else b.current=null}function nj(a,b){switch(b.tag){case 0:case 11:case 15:case 22:return;case 1:if(b.effectTag&256&&null!==a){var c=a.memoizedProps,d=a.memoizedState;a=b.stateNode;b=a.getSnapshotBeforeUpdate(b.elementType===
b.type?c:aa(b.type,c),d);a.__reactInternalSnapshotBeforeUpdate=b}return;case 3:case 5:case 6:case 4:case 17:return}throw Error(k(163));}function Ah(a,b){b=b.updateQueue;b=null!==b?b.lastEffect:null;if(null!==b){var c=b=b.next;do{if((c.tag&a)===a){var d=c.destroy;c.destroy=void 0;void 0!==d&&d()}c=c.next}while(c!==b)}}function Bh(a,b){b=b.updateQueue;b=null!==b?b.lastEffect:null;if(null!==b){var c=b=b.next;do{if((c.tag&a)===a){var d=c.create;c.destroy=d()}c=c.next}while(c!==b)}}function oj(a,b,c,d){switch(c.tag){case 0:case 11:case 15:case 22:Bh(3,
c);return;case 1:a=c.stateNode;c.effectTag&4&&(null===b?a.componentDidMount():(d=c.elementType===c.type?b.memoizedProps:aa(c.type,b.memoizedProps),a.componentDidUpdate(d,b.memoizedState,a.__reactInternalSnapshotBeforeUpdate)));b=c.updateQueue;null!==b&&Wg(c,b,a);return;case 3:b=c.updateQueue;if(null!==b){a=null;if(null!==c.child)switch(c.child.tag){case 5:a=c.child.stateNode;break;case 1:a=c.child.stateNode}Wg(c,b,a)}return;case 5:a=c.stateNode;null===b&&c.effectTag&4&&lg(c.type,c.memoizedProps)&&
a.focus();return;case 6:return;case 4:return;case 12:return;case 13:null===c.memoizedState&&(c=c.alternate,null!==c&&(c=c.memoizedState,null!==c&&(c=c.dehydrated,null!==c&&bg(c))));return;case 19:case 17:case 20:case 21:return}throw Error(k(163));}function Ch(a,b,c){"function"===typeof Ne&&Ne(b);switch(b.tag){case 0:case 11:case 14:case 15:case 22:a=b.updateQueue;if(null!==a&&(a=a.lastEffect,null!==a)){var d=a.next;Da(97<c?97:c,function(){var a=d;do{var c=a.destroy;if(void 0!==c){var g=b;try{c()}catch(h){Za(g,
h)}}a=a.next}while(a!==d)})}break;case 1:zh(b);c=b.stateNode;"function"===typeof c.componentWillUnmount&&mj(b,c);break;case 5:zh(b);break;case 4:Dh(a,b,c)}}function Eh(a){var b=a.alternate;a.return=null;a.child=null;a.memoizedState=null;a.updateQueue=null;a.dependencies=null;a.alternate=null;a.firstEffect=null;a.lastEffect=null;a.pendingProps=null;a.memoizedProps=null;a.stateNode=null;null!==b&&Eh(b)}function Fh(a){return 5===a.tag||3===a.tag||4===a.tag}function Gh(a){a:{for(var b=a.return;null!==
b;){if(Fh(b)){var c=b;break a}b=b.return}throw Error(k(160));}b=c.stateNode;switch(c.tag){case 5:var d=!1;break;case 3:b=b.containerInfo;d=!0;break;case 4:b=b.containerInfo;d=!0;break;default:throw Error(k(161));}c.effectTag&16&&(Wb(b,""),c.effectTag&=-17);a:b:for(c=a;;){for(;null===c.sibling;){if(null===c.return||Fh(c.return)){c=null;break a}c=c.return}c.sibling.return=c.return;for(c=c.sibling;5!==c.tag&&6!==c.tag&&18!==c.tag;){if(c.effectTag&2)continue b;if(null===c.child||4===c.tag)continue b;
else c.child.return=c,c=c.child}if(!(c.effectTag&2)){c=c.stateNode;break a}}d?Oe(a,c,b):Pe(a,c,b)}function Oe(a,b,c){var d=a.tag,e=5===d||6===d;if(e)a=e?a.stateNode:a.stateNode.instance,b?8===c.nodeType?c.parentNode.insertBefore(a,b):c.insertBefore(a,b):(8===c.nodeType?(b=c.parentNode,b.insertBefore(a,c)):(b=c,b.appendChild(a)),c=c._reactRootContainer,null!==c&&void 0!==c||null!==b.onclick||(b.onclick=uc));else if(4!==d&&(a=a.child,null!==a))for(Oe(a,b,c),a=a.sibling;null!==a;)Oe(a,b,c),a=a.sibling}
function Pe(a,b,c){var d=a.tag,e=5===d||6===d;if(e)a=e?a.stateNode:a.stateNode.instance,b?c.insertBefore(a,b):c.appendChild(a);else if(4!==d&&(a=a.child,null!==a))for(Pe(a,b,c),a=a.sibling;null!==a;)Pe(a,b,c),a=a.sibling}function Dh(a,b,c){for(var d=b,e=!1,f,g;;){if(!e){e=d.return;a:for(;;){if(null===e)throw Error(k(160));f=e.stateNode;switch(e.tag){case 5:g=!1;break a;case 3:f=f.containerInfo;g=!0;break a;case 4:f=f.containerInfo;g=!0;break a}e=e.return}e=!0}if(5===d.tag||6===d.tag){a:for(var h=
a,m=d,n=c,l=m;;)if(Ch(h,l,n),null!==l.child&&4!==l.tag)l.child.return=l,l=l.child;else{if(l===m)break a;for(;null===l.sibling;){if(null===l.return||l.return===m)break a;l=l.return}l.sibling.return=l.return;l=l.sibling}g?(h=f,m=d.stateNode,8===h.nodeType?h.parentNode.removeChild(m):h.removeChild(m)):f.removeChild(d.stateNode)}else if(4===d.tag){if(null!==d.child){f=d.stateNode.containerInfo;g=!0;d.child.return=d;d=d.child;continue}}else if(Ch(a,d,c),null!==d.child){d.child.return=d;d=d.child;continue}if(d===
b)break;for(;null===d.sibling;){if(null===d.return||d.return===b)return;d=d.return;4===d.tag&&(e=!1)}d.sibling.return=d.return;d=d.sibling}}function Qe(a,b){switch(b.tag){case 0:case 11:case 14:case 15:case 22:Ah(3,b);return;case 1:return;case 5:var c=b.stateNode;if(null!=c){var d=b.memoizedProps,e=null!==a?a.memoizedProps:d;a=b.type;var f=b.updateQueue;b.updateQueue=null;if(null!==f){c[vc]=d;"input"===a&&"radio"===d.type&&null!=d.name&&If(c,d);Vd(a,e);b=Vd(a,d);for(e=0;e<f.length;e+=2){var g=f[e],
h=f[e+1];"style"===g?gg(c,h):"dangerouslySetInnerHTML"===g?xh(c,h):"children"===g?Wb(c,h):xd(c,g,h,b)}switch(a){case "input":Dd(c,d);break;case "textarea":Lf(c,d);break;case "select":b=c._wrapperState.wasMultiple,c._wrapperState.wasMultiple=!!d.multiple,a=d.value,null!=a?hb(c,!!d.multiple,a,!1):b!==!!d.multiple&&(null!=d.defaultValue?hb(c,!!d.multiple,d.defaultValue,!0):hb(c,!!d.multiple,d.multiple?[]:"",!1))}}}return;case 6:if(null===b.stateNode)throw Error(k(162));b.stateNode.nodeValue=b.memoizedProps;
return;case 3:b=b.stateNode;b.hydrate&&(b.hydrate=!1,bg(b.containerInfo));return;case 12:return;case 13:c=b;null===b.memoizedState?d=!1:(d=!0,c=b.child,Re=Y());if(null!==c)a:for(a=c;;){if(5===a.tag)f=a.stateNode,d?(f=f.style,"function"===typeof f.setProperty?f.setProperty("display","none","important"):f.display="none"):(f=a.stateNode,e=a.memoizedProps.style,e=void 0!==e&&null!==e&&e.hasOwnProperty("display")?e.display:null,f.style.display=fg("display",e));else if(6===a.tag)a.stateNode.nodeValue=d?
"":a.memoizedProps;else if(13===a.tag&&null!==a.memoizedState&&null===a.memoizedState.dehydrated){f=a.child.sibling;f.return=a;a=f;continue}else if(null!==a.child){a.child.return=a;a=a.child;continue}if(a===c)break;for(;null===a.sibling;){if(null===a.return||a.return===c)break a;a=a.return}a.sibling.return=a.return;a=a.sibling}Hh(b);return;case 19:Hh(b);return;case 17:return}throw Error(k(163));}function Hh(a){var b=a.updateQueue;if(null!==b){a.updateQueue=null;var c=a.stateNode;null===c&&(c=a.stateNode=
new pj);b.forEach(function(b){var d=qj.bind(null,a,b);c.has(b)||(c.add(b),b.then(d,d))})}}function Ih(a,b,c){c=Ea(c,null);c.tag=3;c.payload={element:null};var d=b.value;c.callback=function(){cd||(cd=!0,Se=d);Me(a,b)};return c}function Jh(a,b,c){c=Ea(c,null);c.tag=3;var d=a.type.getDerivedStateFromError;if("function"===typeof d){var e=b.value;c.payload=function(){Me(a,b);return d(e)}}var f=a.stateNode;null!==f&&"function"===typeof f.componentDidCatch&&(c.callback=function(){"function"!==typeof d&&
(null===La?La=new Set([this]):La.add(this),Me(a,b));var c=b.stack;this.componentDidCatch(b.value,{componentStack:null!==c?c:""})});return c}function ka(){return(p&(ca|ma))!==H?1073741821-(Y()/10|0):0!==dd?dd:dd=1073741821-(Y()/10|0)}function Va(a,b,c){b=b.mode;if(0===(b&2))return 1073741823;var d=Cc();if(0===(b&4))return 99===d?1073741823:1073741822;if((p&ca)!==H)return P;if(null!==c)a=Fc(a,c.timeoutMs|0||5E3,250);else switch(d){case 99:a=1073741823;break;case 98:a=Fc(a,150,100);break;case 97:case 96:a=
Fc(a,5E3,250);break;case 95:a=2;break;default:throw Error(k(326));}null!==U&&a===P&&--a;return a}function ed(a,b){a.expirationTime<b&&(a.expirationTime=b);var c=a.alternate;null!==c&&c.expirationTime<b&&(c.expirationTime=b);var d=a.return,e=null;if(null===d&&3===a.tag)e=a.stateNode;else for(;null!==d;){c=d.alternate;d.childExpirationTime<b&&(d.childExpirationTime=b);null!==c&&c.childExpirationTime<b&&(c.childExpirationTime=b);if(null===d.return&&3===d.tag){e=d.stateNode;break}d=d.return}null!==e&&
(U===e&&(Kc(b),F===bd&&Ya(e,P)),yh(e,b));return e}function fd(a){var b=a.lastExpiredTime;if(0!==b)return b;b=a.firstPendingTime;if(!Kh(a,b))return b;var c=a.lastPingedTime;a=a.nextKnownPendingLevel;a=c>a?c:a;return 2>=a&&b!==a?0:a}function V(a){if(0!==a.lastExpiredTime)a.callbackExpirationTime=1073741823,a.callbackPriority=99,a.callbackNode=Og(Te.bind(null,a));else{var b=fd(a),c=a.callbackNode;if(0===b)null!==c&&(a.callbackNode=null,a.callbackExpirationTime=0,a.callbackPriority=90);else{var d=ka();
1073741823===b?d=99:1===b||2===b?d=95:(d=10*(1073741821-b)-10*(1073741821-d),d=0>=d?99:250>=d?98:5250>=d?97:95);if(null!==c){var e=a.callbackPriority;if(a.callbackExpirationTime===b&&e>=d)return;c!==Qg&&Rg(c)}a.callbackExpirationTime=b;a.callbackPriority=d;b=1073741823===b?Og(Te.bind(null,a)):Ng(d,Lh.bind(null,a),{timeout:10*(1073741821-b)-Y()});a.callbackNode=b}}}function Lh(a,b){dd=0;if(b)return b=ka(),Ue(a,b),V(a),null;var c=fd(a);if(0!==c){b=a.callbackNode;if((p&(ca|ma))!==H)throw Error(k(327));
xb();a===U&&c===P||$a(a,c);if(null!==t){var d=p;p|=ca;var e=Mh();do try{rj();break}catch(h){Nh(a,h)}while(1);le();p=d;gd.current=e;if(F===hd)throw b=id,$a(a,c),Ya(a,c),V(a),b;if(null===t)switch(e=a.finishedWork=a.current.alternate,a.finishedExpirationTime=c,d=F,U=null,d){case Xa:case hd:throw Error(k(345));case Oh:Ue(a,2<c?2:c);break;case ad:Ya(a,c);d=a.lastSuspendedTime;c===d&&(a.nextKnownPendingLevel=Ve(e));if(1073741823===ta&&(e=Re+Ph-Y(),10<e)){if(jd){var f=a.lastPingedTime;if(0===f||f>=c){a.lastPingedTime=
c;$a(a,c);break}}f=fd(a);if(0!==f&&f!==c)break;if(0!==d&&d!==c){a.lastPingedTime=d;break}a.timeoutHandle=We(ab.bind(null,a),e);break}ab(a);break;case bd:Ya(a,c);d=a.lastSuspendedTime;c===d&&(a.nextKnownPendingLevel=Ve(e));if(jd&&(e=a.lastPingedTime,0===e||e>=c)){a.lastPingedTime=c;$a(a,c);break}e=fd(a);if(0!==e&&e!==c)break;if(0!==d&&d!==c){a.lastPingedTime=d;break}1073741823!==Yb?d=10*(1073741821-Yb)-Y():1073741823===ta?d=0:(d=10*(1073741821-ta)-5E3,e=Y(),c=10*(1073741821-c)-e,d=e-d,0>d&&(d=0),d=
(120>d?120:480>d?480:1080>d?1080:1920>d?1920:3E3>d?3E3:4320>d?4320:1960*sj(d/1960))-d,c<d&&(d=c));if(10<d){a.timeoutHandle=We(ab.bind(null,a),d);break}ab(a);break;case Xe:if(1073741823!==ta&&null!==kd){f=ta;var g=kd;d=g.busyMinDurationMs|0;0>=d?d=0:(e=g.busyDelayMs|0,f=Y()-(10*(1073741821-f)-(g.timeoutMs|0||5E3)),d=f<=e?0:e+d-f);if(10<d){Ya(a,c);a.timeoutHandle=We(ab.bind(null,a),d);break}}ab(a);break;default:throw Error(k(329));}V(a);if(a.callbackNode===b)return Lh.bind(null,a)}}return null}function Te(a){var b=
a.lastExpiredTime;b=0!==b?b:1073741823;if((p&(ca|ma))!==H)throw Error(k(327));xb();a===U&&b===P||$a(a,b);if(null!==t){var c=p;p|=ca;var d=Mh();do try{tj();break}catch(e){Nh(a,e)}while(1);le();p=c;gd.current=d;if(F===hd)throw c=id,$a(a,b),Ya(a,b),V(a),c;if(null!==t)throw Error(k(261));a.finishedWork=a.current.alternate;a.finishedExpirationTime=b;U=null;ab(a);V(a)}return null}function uj(){if(null!==bb){var a=bb;bb=null;a.forEach(function(a,c){Ue(c,a);V(c)});ha()}}function Qh(a,b){var c=p;p|=1;try{return a(b)}finally{p=
c,p===H&&ha()}}function Rh(a,b){var c=p;p&=-2;p|=Ye;try{return a(b)}finally{p=c,p===H&&ha()}}function $a(a,b){a.finishedWork=null;a.finishedExpirationTime=0;var c=a.timeoutHandle;-1!==c&&(a.timeoutHandle=-1,vj(c));if(null!==t)for(c=t.return;null!==c;){var d=c;switch(d.tag){case 1:d=d.type.childContextTypes;null!==d&&void 0!==d&&(q(G),q(B));break;case 3:tb();q(G);q(B);break;case 5:te(d);break;case 4:tb();break;case 13:q(D);break;case 19:q(D);break;case 10:me(d)}c=c.return}U=a;t=Sa(a.current,null);
P=b;F=Xa;id=null;Yb=ta=1073741823;kd=null;Xb=0;jd=!1}function Nh(a,b){do{try{le();Sc.current=Tc;if(Uc)for(var c=z.memoizedState;null!==c;){var d=c.queue;null!==d&&(d.pending=null);c=c.next}Ia=0;J=K=z=null;Uc=!1;if(null===t||null===t.return)return F=hd,id=b,t=null;a:{var e=a,f=t.return,g=t,h=b;b=P;g.effectTag|=2048;g.firstEffect=g.lastEffect=null;if(null!==h&&"object"===typeof h&&"function"===typeof h.then){var m=h;if(0===(g.mode&2)){var n=g.alternate;n?(g.updateQueue=n.updateQueue,g.memoizedState=
n.memoizedState,g.expirationTime=n.expirationTime):(g.updateQueue=null,g.memoizedState=null)}var l=0!==(D.current&1),k=f;do{var p;if(p=13===k.tag){var q=k.memoizedState;if(null!==q)p=null!==q.dehydrated?!0:!1;else{var w=k.memoizedProps;p=void 0===w.fallback?!1:!0!==w.unstable_avoidThisFallback?!0:l?!1:!0}}if(p){var y=k.updateQueue;if(null===y){var r=new Set;r.add(m);k.updateQueue=r}else y.add(m);if(0===(k.mode&2)){k.effectTag|=64;g.effectTag&=-2981;if(1===g.tag)if(null===g.alternate)g.tag=17;else{var O=
Ea(1073741823,null);O.tag=Jc;Fa(g,O)}g.expirationTime=1073741823;break a}h=void 0;g=b;var v=e.pingCache;null===v?(v=e.pingCache=new wj,h=new Set,v.set(m,h)):(h=v.get(m),void 0===h&&(h=new Set,v.set(m,h)));if(!h.has(g)){h.add(g);var x=xj.bind(null,e,m,g);m.then(x,x)}k.effectTag|=4096;k.expirationTime=b;break a}k=k.return}while(null!==k);h=Error((na(g.type)||"A React component")+" suspended while rendering, but no fallback UI was specified.\n\nAdd a <Suspense fallback=...> component higher in the tree to provide a loading indicator or placeholder to display."+
Bd(g))}F!==Xe&&(F=Oh);h=Le(h,g);k=f;do{switch(k.tag){case 3:m=h;k.effectTag|=4096;k.expirationTime=b;var A=Ih(k,m,b);Ug(k,A);break a;case 1:m=h;var u=k.type,B=k.stateNode;if(0===(k.effectTag&64)&&("function"===typeof u.getDerivedStateFromError||null!==B&&"function"===typeof B.componentDidCatch&&(null===La||!La.has(B)))){k.effectTag|=4096;k.expirationTime=b;var H=Jh(k,m,b);Ug(k,H);break a}}k=k.return}while(null!==k)}t=Sh(t)}catch(cj){b=cj;continue}break}while(1)}function Mh(a){a=gd.current;gd.current=
Tc;return null===a?Tc:a}function Vg(a,b){a<ta&&2<a&&(ta=a);null!==b&&a<Yb&&2<a&&(Yb=a,kd=b)}function Kc(a){a>Xb&&(Xb=a)}function tj(){for(;null!==t;)t=Th(t)}function rj(){for(;null!==t&&!yj();)t=Th(t)}function Th(a){var b=zj(a.alternate,a,P);a.memoizedProps=a.pendingProps;null===b&&(b=Sh(a));Uh.current=null;return b}function Sh(a){t=a;do{var b=t.alternate;a=t.return;if(0===(t.effectTag&2048)){b=hj(b,t,P);if(1===P||1!==t.childExpirationTime){for(var c=0,d=t.child;null!==d;){var e=d.expirationTime,
f=d.childExpirationTime;e>c&&(c=e);f>c&&(c=f);d=d.sibling}t.childExpirationTime=c}if(null!==b)return b;null!==a&&0===(a.effectTag&2048)&&(null===a.firstEffect&&(a.firstEffect=t.firstEffect),null!==t.lastEffect&&(null!==a.lastEffect&&(a.lastEffect.nextEffect=t.firstEffect),a.lastEffect=t.lastEffect),1<t.effectTag&&(null!==a.lastEffect?a.lastEffect.nextEffect=t:a.firstEffect=t,a.lastEffect=t))}else{b=lj(t);if(null!==b)return b.effectTag&=2047,b;null!==a&&(a.firstEffect=a.lastEffect=null,a.effectTag|=
2048)}b=t.sibling;if(null!==b)return b;t=a}while(null!==t);F===Xa&&(F=Xe);return null}function Ve(a){var b=a.expirationTime;a=a.childExpirationTime;return b>a?b:a}function ab(a){var b=Cc();Da(99,Aj.bind(null,a,b));return null}function Aj(a,b){do xb();while(null!==Zb);if((p&(ca|ma))!==H)throw Error(k(327));var c=a.finishedWork,d=a.finishedExpirationTime;if(null===c)return null;a.finishedWork=null;a.finishedExpirationTime=0;if(c===a.current)throw Error(k(177));a.callbackNode=null;a.callbackExpirationTime=
0;a.callbackPriority=90;a.nextKnownPendingLevel=0;var e=Ve(c);a.firstPendingTime=e;d<=a.lastSuspendedTime?a.firstSuspendedTime=a.lastSuspendedTime=a.nextKnownPendingLevel=0:d<=a.firstSuspendedTime&&(a.firstSuspendedTime=d-1);d<=a.lastPingedTime&&(a.lastPingedTime=0);d<=a.lastExpiredTime&&(a.lastExpiredTime=0);a===U&&(t=U=null,P=0);1<c.effectTag?null!==c.lastEffect?(c.lastEffect.nextEffect=c,e=c.firstEffect):e=c:e=c.firstEffect;if(null!==e){var f=p;p|=ma;Uh.current=null;Ze=tc;var g=kg();if(Xd(g)){if("selectionStart"in
g)var h={start:g.selectionStart,end:g.selectionEnd};else a:{h=(h=g.ownerDocument)&&h.defaultView||window;var m=h.getSelection&&h.getSelection();if(m&&0!==m.rangeCount){h=m.anchorNode;var n=m.anchorOffset,q=m.focusNode;m=m.focusOffset;try{h.nodeType,q.nodeType}catch(sb){h=null;break a}var ba=0,w=-1,y=-1,B=0,D=0,r=g,z=null;b:for(;;){for(var v;;){r!==h||0!==n&&3!==r.nodeType||(w=ba+n);r!==q||0!==m&&3!==r.nodeType||(y=ba+m);3===r.nodeType&&(ba+=r.nodeValue.length);if(null===(v=r.firstChild))break;z=r;
r=v}for(;;){if(r===g)break b;z===h&&++B===n&&(w=ba);z===q&&++D===m&&(y=ba);if(null!==(v=r.nextSibling))break;r=z;z=r.parentNode}r=v}h=-1===w||-1===y?null:{start:w,end:y}}else h=null}h=h||{start:0,end:0}}else h=null;$e={activeElementDetached:null,focusedElem:g,selectionRange:h};tc=!1;l=e;do try{Bj()}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);l=e;do try{for(g=a,h=b;null!==l;){var x=l.effectTag;x&16&&Wb(l.stateNode,"");if(x&128){var A=l.alternate;if(null!==A){var u=
A.ref;null!==u&&("function"===typeof u?u(null):u.current=null)}}switch(x&1038){case 2:Gh(l);l.effectTag&=-3;break;case 6:Gh(l);l.effectTag&=-3;Qe(l.alternate,l);break;case 1024:l.effectTag&=-1025;break;case 1028:l.effectTag&=-1025;Qe(l.alternate,l);break;case 4:Qe(l.alternate,l);break;case 8:n=l,Dh(g,n,h),Eh(n)}l=l.nextEffect}}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);u=$e;A=kg();x=u.focusedElem;h=u.selectionRange;if(A!==x&&x&&x.ownerDocument&&jg(x.ownerDocument.documentElement,
x)){null!==h&&Xd(x)&&(A=h.start,u=h.end,void 0===u&&(u=A),"selectionStart"in x?(x.selectionStart=A,x.selectionEnd=Math.min(u,x.value.length)):(u=(A=x.ownerDocument||document)&&A.defaultView||window,u.getSelection&&(u=u.getSelection(),n=x.textContent.length,g=Math.min(h.start,n),h=void 0===h.end?g:Math.min(h.end,n),!u.extend&&g>h&&(n=h,h=g,g=n),n=ig(x,g),q=ig(x,h),n&&q&&(1!==u.rangeCount||u.anchorNode!==n.node||u.anchorOffset!==n.offset||u.focusNode!==q.node||u.focusOffset!==q.offset)&&(A=A.createRange(),
A.setStart(n.node,n.offset),u.removeAllRanges(),g>h?(u.addRange(A),u.extend(q.node,q.offset)):(A.setEnd(q.node,q.offset),u.addRange(A))))));A=[];for(u=x;u=u.parentNode;)1===u.nodeType&&A.push({element:u,left:u.scrollLeft,top:u.scrollTop});"function"===typeof x.focus&&x.focus();for(x=0;x<A.length;x++)u=A[x],u.element.scrollLeft=u.left,u.element.scrollTop=u.top}tc=!!Ze;$e=Ze=null;a.current=c;l=e;do try{for(x=a;null!==l;){var F=l.effectTag;F&36&&oj(x,l.alternate,l);if(F&128){A=void 0;var E=l.ref;if(null!==
E){var G=l.stateNode;switch(l.tag){case 5:A=G;break;default:A=G}"function"===typeof E?E(A):E.current=A}}l=l.nextEffect}}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);l=null;Cj();p=f}else a.current=c;if(ld)ld=!1,Zb=a,$b=b;else for(l=e;null!==l;)b=l.nextEffect,l.nextEffect=null,l=b;b=a.firstPendingTime;0===b&&(La=null);1073741823===b?a===af?ac++:(ac=0,af=a):ac=0;"function"===typeof bf&&bf(c.stateNode,d);V(a);if(cd)throw cd=!1,a=Se,Se=null,a;if((p&Ye)!==H)return null;
ha();return null}function Bj(){for(;null!==l;){var a=l.effectTag;0!==(a&256)&&nj(l.alternate,l);0===(a&512)||ld||(ld=!0,Ng(97,function(){xb();return null}));l=l.nextEffect}}function xb(){if(90!==$b){var a=97<$b?97:$b;$b=90;return Da(a,Dj)}}function Dj(){if(null===Zb)return!1;var a=Zb;Zb=null;if((p&(ca|ma))!==H)throw Error(k(331));var b=p;p|=ma;for(a=a.current.firstEffect;null!==a;){try{var c=a;if(0!==(c.effectTag&512))switch(c.tag){case 0:case 11:case 15:case 22:Ah(5,c),Bh(5,c)}}catch(d){if(null===
a)throw Error(k(330));Za(a,d)}c=a.nextEffect;a.nextEffect=null;a=c}p=b;ha();return!0}function Vh(a,b,c){b=Le(c,b);b=Ih(a,b,1073741823);Fa(a,b);a=ed(a,1073741823);null!==a&&V(a)}function Za(a,b){if(3===a.tag)Vh(a,a,b);else for(var c=a.return;null!==c;){if(3===c.tag){Vh(c,a,b);break}else if(1===c.tag){var d=c.stateNode;if("function"===typeof c.type.getDerivedStateFromError||"function"===typeof d.componentDidCatch&&(null===La||!La.has(d))){a=Le(b,a);a=Jh(c,a,1073741823);Fa(c,a);c=ed(c,1073741823);null!==
c&&V(c);break}}c=c.return}}function xj(a,b,c){var d=a.pingCache;null!==d&&d.delete(b);U===a&&P===c?F===bd||F===ad&&1073741823===ta&&Y()-Re<Ph?$a(a,P):jd=!0:Kh(a,c)&&(b=a.lastPingedTime,0!==b&&b<c||(a.lastPingedTime=c,V(a)))}function qj(a,b){var c=a.stateNode;null!==c&&c.delete(b);b=0;0===b&&(b=ka(),b=Va(b,a,null));a=ed(a,b);null!==a&&V(a)}function Ej(a){if("undefined"===typeof __REACT_DEVTOOLS_GLOBAL_HOOK__)return!1;var b=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(b.isDisabled||!b.supportsFiber)return!0;try{var c=
b.inject(a);bf=function(a,e){try{b.onCommitFiberRoot(c,a,void 0,64===(a.current.effectTag&64))}catch(f){}};Ne=function(a){try{b.onCommitFiberUnmount(c,a)}catch(e){}}}catch(d){}return!0}function Fj(a,b,c,d){this.tag=a;this.key=c;this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null;this.index=0;this.ref=null;this.pendingProps=b;this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null;this.mode=d;this.effectTag=0;this.lastEffect=this.firstEffect=this.nextEffect=
null;this.childExpirationTime=this.expirationTime=0;this.alternate=null}function Ge(a){a=a.prototype;return!(!a||!a.isReactComponent)}function Gj(a){if("function"===typeof a)return Ge(a)?1:0;if(void 0!==a&&null!==a){a=a.$$typeof;if(a===zd)return 11;if(a===Ad)return 14}return 2}function Sa(a,b){var c=a.alternate;null===c?(c=la(a.tag,b,a.key,a.mode),c.elementType=a.elementType,c.type=a.type,c.stateNode=a.stateNode,c.alternate=a,a.alternate=c):(c.pendingProps=b,c.effectTag=0,c.nextEffect=null,c.firstEffect=
null,c.lastEffect=null);c.childExpirationTime=a.childExpirationTime;c.expirationTime=a.expirationTime;c.child=a.child;c.memoizedProps=a.memoizedProps;c.memoizedState=a.memoizedState;c.updateQueue=a.updateQueue;b=a.dependencies;c.dependencies=null===b?null:{expirationTime:b.expirationTime,firstContext:b.firstContext,responders:b.responders};c.sibling=a.sibling;c.index=a.index;c.ref=a.ref;return c}function Oc(a,b,c,d,e,f){var g=2;d=a;if("function"===typeof a)Ge(a)&&(g=1);else if("string"===typeof a)g=
5;else a:switch(a){case Ma:return Ha(c.children,e,f,b);case Hj:g=8;e|=7;break;case Af:g=8;e|=1;break;case kc:return a=la(12,c,b,e|8),a.elementType=kc,a.type=kc,a.expirationTime=f,a;case lc:return a=la(13,c,b,e),a.type=lc,a.elementType=lc,a.expirationTime=f,a;case yd:return a=la(19,c,b,e),a.elementType=yd,a.expirationTime=f,a;default:if("object"===typeof a&&null!==a)switch(a.$$typeof){case Cf:g=10;break a;case Bf:g=9;break a;case zd:g=11;break a;case Ad:g=14;break a;case Ef:g=16;d=null;break a;case Df:g=
22;break a}throw Error(k(130,null==a?a:typeof a,""));}b=la(g,c,b,e);b.elementType=a;b.type=d;b.expirationTime=f;return b}function Ha(a,b,c,d){a=la(7,a,d,b);a.expirationTime=c;return a}function qe(a,b,c){a=la(6,a,null,b);a.expirationTime=c;return a}function re(a,b,c){b=la(4,null!==a.children?a.children:[],a.key,b);b.expirationTime=c;b.stateNode={containerInfo:a.containerInfo,pendingChildren:null,implementation:a.implementation};return b}function Ij(a,b,c){this.tag=b;this.current=null;this.containerInfo=
a;this.pingCache=this.pendingChildren=null;this.finishedExpirationTime=0;this.finishedWork=null;this.timeoutHandle=-1;this.pendingContext=this.context=null;this.hydrate=c;this.callbackNode=null;this.callbackPriority=90;this.lastExpiredTime=this.lastPingedTime=this.nextKnownPendingLevel=this.lastSuspendedTime=this.firstSuspendedTime=this.firstPendingTime=0}function Kh(a,b){var c=a.firstSuspendedTime;a=a.lastSuspendedTime;return 0!==c&&c>=b&&a<=b}function Ya(a,b){var c=a.firstSuspendedTime,d=a.lastSuspendedTime;
c<b&&(a.firstSuspendedTime=b);if(d>b||0===c)a.lastSuspendedTime=b;b<=a.lastPingedTime&&(a.lastPingedTime=0);b<=a.lastExpiredTime&&(a.lastExpiredTime=0)}function yh(a,b){b>a.firstPendingTime&&(a.firstPendingTime=b);var c=a.firstSuspendedTime;0!==c&&(b>=c?a.firstSuspendedTime=a.lastSuspendedTime=a.nextKnownPendingLevel=0:b>=a.lastSuspendedTime&&(a.lastSuspendedTime=b+1),b>a.nextKnownPendingLevel&&(a.nextKnownPendingLevel=b))}function Ue(a,b){var c=a.lastExpiredTime;if(0===c||c>b)a.lastExpiredTime=b}
function md(a,b,c,d){var e=b.current,f=ka(),g=Vb.suspense;f=Va(f,e,g);a:if(c){c=c._reactInternalFiber;b:{if(Na(c)!==c||1!==c.tag)throw Error(k(170));var h=c;do{switch(h.tag){case 3:h=h.stateNode.context;break b;case 1:if(N(h.type)){h=h.stateNode.__reactInternalMemoizedMergedChildContext;break b}}h=h.return}while(null!==h);throw Error(k(171));}if(1===c.tag){var m=c.type;if(N(m)){c=Gg(c,m,h);break a}}c=h}else c=Ca;null===b.context?b.context=c:b.pendingContext=c;b=Ea(f,g);b.payload={element:a};d=void 0===
d?null:d;null!==d&&(b.callback=d);Fa(e,b);Ja(e,f);return f}function cf(a){a=a.current;if(!a.child)return null;switch(a.child.tag){case 5:return a.child.stateNode;default:return a.child.stateNode}}function Wh(a,b){a=a.memoizedState;null!==a&&null!==a.dehydrated&&a.retryTime<b&&(a.retryTime=b)}function df(a,b){Wh(a,b);(a=a.alternate)&&Wh(a,b)}function ef(a,b,c){c=null!=c&&!0===c.hydrate;var d=new Ij(a,b,c),e=la(3,null,null,2===b?7:1===b?3:0);d.current=e;e.stateNode=d;ne(e);a[Lb]=d.current;c&&0!==b&&
xi(a,9===a.nodeType?a:a.ownerDocument);this._internalRoot=d}function bc(a){return!(!a||1!==a.nodeType&&9!==a.nodeType&&11!==a.nodeType&&(8!==a.nodeType||" react-mount-point-unstable "!==a.nodeValue))}function Jj(a,b){b||(b=a?9===a.nodeType?a.documentElement:a.firstChild:null,b=!(!b||1!==b.nodeType||!b.hasAttribute("data-reactroot")));if(!b)for(var c;c=a.lastChild;)a.removeChild(c);return new ef(a,0,b?{hydrate:!0}:void 0)}function nd(a,b,c,d,e){var f=c._reactRootContainer;if(f){var g=f._internalRoot;
if("function"===typeof e){var h=e;e=function(){var a=cf(g);h.call(a)}}md(b,g,a,e)}else{f=c._reactRootContainer=Jj(c,d);g=f._internalRoot;if("function"===typeof e){var m=e;e=function(){var a=cf(g);m.call(a)}}Rh(function(){md(b,g,a,e)})}return cf(g)}function Kj(a,b,c){var d=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null;return{$$typeof:gb,key:null==d?null:""+d,children:a,containerInfo:b,implementation:c}}function Xh(a,b){var c=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;
if(!bc(b))throw Error(k(200));return Kj(a,b,null,c)}if(!ea)throw Error(k(227));var ki=function(a,b,c,d,e,f,g,h,m){var n=Array.prototype.slice.call(arguments,3);try{b.apply(c,n)}catch(C){this.onError(C)}},yb=!1,gc=null,hc=!1,pd=null,li={onError:function(a){yb=!0;gc=a}},td=null,rf=null,mf=null,ic=null,cb={},jc=[],qd={},db={},rd={},wa=!("undefined"===typeof window||"undefined"===typeof window.document||"undefined"===typeof window.document.createElement),M=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.assign,
sd=null,eb=null,fb=null,ee=function(a,b){return a(b)},eg=function(a,b,c,d,e){return a(b,c,d,e)},vd=function(){},vf=ee,Oa=!1,wd=!1,Z=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.Scheduler,Lj=Z.unstable_cancelCallback,ff=Z.unstable_now,$f=Z.unstable_scheduleCallback,Mj=Z.unstable_shouldYield,Yh=Z.unstable_requestPaint,Pd=Z.unstable_runWithPriority,Nj=Z.unstable_getCurrentPriorityLevel,Oj=Z.unstable_ImmediatePriority,Zh=Z.unstable_UserBlockingPriority,ag=Z.unstable_NormalPriority,Pj=Z.unstable_LowPriority,
Qj=Z.unstable_IdlePriority,oi=/^[:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD][:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\-.0-9\u00B7\u0300-\u036F\u203F-\u2040]*$/,wf=Object.prototype.hasOwnProperty,yf={},xf={},E={};"children dangerouslySetInnerHTML defaultValue defaultChecked innerHTML suppressContentEditableWarning suppressHydrationWarning style".split(" ").forEach(function(a){E[a]=
new L(a,0,!1,a,null,!1)});[["acceptCharset","accept-charset"],["className","class"],["htmlFor","for"],["httpEquiv","http-equiv"]].forEach(function(a){var b=a[0];E[b]=new L(b,1,!1,a[1],null,!1)});["contentEditable","draggable","spellCheck","value"].forEach(function(a){E[a]=new L(a,2,!1,a.toLowerCase(),null,!1)});["autoReverse","externalResourcesRequired","focusable","preserveAlpha"].forEach(function(a){E[a]=new L(a,2,!1,a,null,!1)});"allowFullScreen async autoFocus autoPlay controls default defer disabled disablePictureInPicture formNoValidate hidden loop noModule noValidate open playsInline readOnly required reversed scoped seamless itemScope".split(" ").forEach(function(a){E[a]=
new L(a,3,!1,a.toLowerCase(),null,!1)});["checked","multiple","muted","selected"].forEach(function(a){E[a]=new L(a,3,!0,a,null,!1)});["capture","download"].forEach(function(a){E[a]=new L(a,4,!1,a,null,!1)});["cols","rows","size","span"].forEach(function(a){E[a]=new L(a,6,!1,a,null,!1)});["rowSpan","start"].forEach(function(a){E[a]=new L(a,5,!1,a.toLowerCase(),null,!1)});var gf=/[\-:]([a-z])/g,hf=function(a){return a[1].toUpperCase()};"accent-height alignment-baseline arabic-form baseline-shift cap-height clip-path clip-rule color-interpolation color-interpolation-filters color-profile color-rendering dominant-baseline enable-background fill-opacity fill-rule flood-color flood-opacity font-family font-size font-size-adjust font-stretch font-style font-variant font-weight glyph-name glyph-orientation-horizontal glyph-orientation-vertical horiz-adv-x horiz-origin-x image-rendering letter-spacing lighting-color marker-end marker-mid marker-start overline-position overline-thickness paint-order panose-1 pointer-events rendering-intent shape-rendering stop-color stop-opacity strikethrough-position strikethrough-thickness stroke-dasharray stroke-dashoffset stroke-linecap stroke-linejoin stroke-miterlimit stroke-opacity stroke-width text-anchor text-decoration text-rendering underline-position underline-thickness unicode-bidi unicode-range units-per-em v-alphabetic v-hanging v-ideographic v-mathematical vector-effect vert-adv-y vert-origin-x vert-origin-y word-spacing writing-mode xmlns:xlink x-height".split(" ").forEach(function(a){var b=
a.replace(gf,hf);E[b]=new L(b,1,!1,a,null,!1)});"xlink:actuate xlink:arcrole xlink:role xlink:show xlink:title xlink:type".split(" ").forEach(function(a){var b=a.replace(gf,hf);E[b]=new L(b,1,!1,a,"http://www.w3.org/1999/xlink",!1)});["xml:base","xml:lang","xml:space"].forEach(function(a){var b=a.replace(gf,hf);E[b]=new L(b,1,!1,a,"http://www.w3.org/XML/1998/namespace",!1)});["tabIndex","crossOrigin"].forEach(function(a){E[a]=new L(a,1,!1,a.toLowerCase(),null,!1)});E.xlinkHref=new L("xlinkHref",1,
!1,"xlink:href","http://www.w3.org/1999/xlink",!0);["src","href","action","formAction"].forEach(function(a){E[a]=new L(a,1,!1,a.toLowerCase(),null,!0)});var da=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED;da.hasOwnProperty("ReactCurrentDispatcher")||(da.ReactCurrentDispatcher={current:null});da.hasOwnProperty("ReactCurrentBatchConfig")||(da.ReactCurrentBatchConfig={suspense:null});var si=/^(.*)[\\\/]/,Q="function"===typeof Symbol&&Symbol.for,Pc=Q?Symbol.for("react.element"):60103,gb=Q?Symbol.for("react.portal"):
60106,Ma=Q?Symbol.for("react.fragment"):60107,Af=Q?Symbol.for("react.strict_mode"):60108,kc=Q?Symbol.for("react.profiler"):60114,Cf=Q?Symbol.for("react.provider"):60109,Bf=Q?Symbol.for("react.context"):60110,Hj=Q?Symbol.for("react.concurrent_mode"):60111,zd=Q?Symbol.for("react.forward_ref"):60112,lc=Q?Symbol.for("react.suspense"):60113,yd=Q?Symbol.for("react.suspense_list"):60120,Ad=Q?Symbol.for("react.memo"):60115,Ef=Q?Symbol.for("react.lazy"):60116,Df=Q?Symbol.for("react.block"):60121,zf="function"===
typeof Symbol&&Symbol.iterator,od,xh=function(a){return"undefined"!==typeof MSApp&&MSApp.execUnsafeLocalFunction?function(b,c,d,e){MSApp.execUnsafeLocalFunction(function(){return a(b,c,d,e)})}:a}(function(a,b){if("http://www.w3.org/2000/svg"!==a.namespaceURI||"innerHTML"in a)a.innerHTML=b;else{od=od||document.createElement("div");od.innerHTML="<svg>"+b.valueOf().toString()+"</svg>";for(b=od.firstChild;a.firstChild;)a.removeChild(a.firstChild);for(;b.firstChild;)a.appendChild(b.firstChild)}}),Wb=function(a,
b){if(b){var c=a.firstChild;if(c&&c===a.lastChild&&3===c.nodeType){c.nodeValue=b;return}}a.textContent=b},ib={animationend:nc("Animation","AnimationEnd"),animationiteration:nc("Animation","AnimationIteration"),animationstart:nc("Animation","AnimationStart"),transitionend:nc("Transition","TransitionEnd")},Id={},Of={};wa&&(Of=document.createElement("div").style,"AnimationEvent"in window||(delete ib.animationend.animation,delete ib.animationiteration.animation,delete ib.animationstart.animation),"TransitionEvent"in
window||delete ib.transitionend.transition);var $h=oc("animationend"),ai=oc("animationiteration"),bi=oc("animationstart"),ci=oc("transitionend"),Db="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),Pf=new ("function"===typeof WeakMap?WeakMap:Map),Ab=null,wi=function(a){if(a){var b=a._dispatchListeners,c=a._dispatchInstances;
if(Array.isArray(b))for(var d=0;d<b.length&&!a.isPropagationStopped();d++)lf(a,b[d],c[d]);else b&&lf(a,b,c);a._dispatchListeners=null;a._dispatchInstances=null;a.isPersistent()||a.constructor.release(a)}},qc=[],Rd=!1,fa=[],xa=null,ya=null,za=null,Eb=new Map,Fb=new Map,Jb=[],Nd="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput close cancel copy cut paste click change contextmenu reset submit".split(" "),
yi="focus blur dragenter dragleave mouseover mouseout pointerover pointerout gotpointercapture lostpointercapture".split(" "),dg={},cg=new Map,Td=new Map,Rj=["abort","abort",$h,"animationEnd",ai,"animationIteration",bi,"animationStart","canplay","canPlay","canplaythrough","canPlayThrough","durationchange","durationChange","emptied","emptied","encrypted","encrypted","ended","ended","error","error","gotpointercapture","gotPointerCapture","load","load","loadeddata","loadedData","loadedmetadata","loadedMetadata",
"loadstart","loadStart","lostpointercapture","lostPointerCapture","playing","playing","progress","progress","seeking","seeking","stalled","stalled","suspend","suspend","timeupdate","timeUpdate",ci,"transitionEnd","waiting","waiting"];Sd("blur blur cancel cancel click click close close contextmenu contextMenu copy copy cut cut auxclick auxClick dblclick doubleClick dragend dragEnd dragstart dragStart drop drop focus focus input input invalid invalid keydown keyDown keypress keyPress keyup keyUp mousedown mouseDown mouseup mouseUp paste paste pause pause play play pointercancel pointerCancel pointerdown pointerDown pointerup pointerUp ratechange rateChange reset reset seeked seeked submit submit touchcancel touchCancel touchend touchEnd touchstart touchStart volumechange volumeChange".split(" "),
0);Sd("drag drag dragenter dragEnter dragexit dragExit dragleave dragLeave dragover dragOver mousemove mouseMove mouseout mouseOut mouseover mouseOver pointermove pointerMove pointerout pointerOut pointerover pointerOver scroll scroll toggle toggle touchmove touchMove wheel wheel".split(" "),1);Sd(Rj,2);(function(a,b){for(var c=0;c<a.length;c++)Td.set(a[c],b)})("change selectionchange textInput compositionstart compositionend compositionupdate".split(" "),0);var Hi=Zh,Gi=Pd,tc=!0,Kb={animationIterationCount:!0,
borderImageOutset:!0,borderImageSlice:!0,borderImageWidth:!0,boxFlex:!0,boxFlexGroup:!0,boxOrdinalGroup:!0,columnCount:!0,columns:!0,flex:!0,flexGrow:!0,flexPositive:!0,flexShrink:!0,flexNegative:!0,flexOrder:!0,gridArea:!0,gridRow:!0,gridRowEnd:!0,gridRowSpan:!0,gridRowStart:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnSpan:!0,gridColumnStart:!0,fontWeight:!0,lineClamp:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,tabSize:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,
strokeDasharray:!0,strokeDashoffset:!0,strokeMiterlimit:!0,strokeOpacity:!0,strokeWidth:!0},Sj=["Webkit","ms","Moz","O"];Object.keys(Kb).forEach(function(a){Sj.forEach(function(b){b=b+a.charAt(0).toUpperCase()+a.substring(1);Kb[b]=Kb[a]})});var Ii=M({menuitem:!0},{area:!0,base:!0,br:!0,col:!0,embed:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0}),ng="$",og="/$",$d="$?",Zd="$!",Ze=null,$e=null,We="function"===typeof setTimeout?setTimeout:void 0,vj="function"===
typeof clearTimeout?clearTimeout:void 0,jf=Math.random().toString(36).slice(2),Aa="__reactInternalInstance$"+jf,vc="__reactEventHandlers$"+jf,Lb="__reactContainere$"+jf,Ba=null,ce=null,wc=null;M(R.prototype,{preventDefault:function(){this.defaultPrevented=!0;var a=this.nativeEvent;a&&(a.preventDefault?a.preventDefault():"unknown"!==typeof a.returnValue&&(a.returnValue=!1),this.isDefaultPrevented=xc)},stopPropagation:function(){var a=this.nativeEvent;a&&(a.stopPropagation?a.stopPropagation():"unknown"!==
typeof a.cancelBubble&&(a.cancelBubble=!0),this.isPropagationStopped=xc)},persist:function(){this.isPersistent=xc},isPersistent:yc,destructor:function(){var a=this.constructor.Interface,b;for(b in a)this[b]=null;this.nativeEvent=this._targetInst=this.dispatchConfig=null;this.isPropagationStopped=this.isDefaultPrevented=yc;this._dispatchInstances=this._dispatchListeners=null}});R.Interface={type:null,target:null,currentTarget:function(){return null},eventPhase:null,bubbles:null,cancelable:null,timeStamp:function(a){return a.timeStamp||
Date.now()},defaultPrevented:null,isTrusted:null};R.extend=function(a){function b(){return c.apply(this,arguments)}var c=this,d=function(){};d.prototype=c.prototype;d=new d;M(d,b.prototype);b.prototype=d;b.prototype.constructor=b;b.Interface=M({},c.Interface,a);b.extend=c.extend;sg(b);return b};sg(R);var Tj=R.extend({data:null}),Uj=R.extend({data:null}),Ni=[9,13,27,32],de=wa&&"CompositionEvent"in window,cc=null;wa&&"documentMode"in document&&(cc=document.documentMode);var Vj=wa&&"TextEvent"in window&&
!cc,xg=wa&&(!de||cc&&8<cc&&11>=cc),wg=String.fromCharCode(32),ua={beforeInput:{phasedRegistrationNames:{bubbled:"onBeforeInput",captured:"onBeforeInputCapture"},dependencies:["compositionend","keypress","textInput","paste"]},compositionEnd:{phasedRegistrationNames:{bubbled:"onCompositionEnd",captured:"onCompositionEndCapture"},dependencies:"blur compositionend keydown keypress keyup mousedown".split(" ")},compositionStart:{phasedRegistrationNames:{bubbled:"onCompositionStart",captured:"onCompositionStartCapture"},
dependencies:"blur compositionstart keydown keypress keyup mousedown".split(" ")},compositionUpdate:{phasedRegistrationNames:{bubbled:"onCompositionUpdate",captured:"onCompositionUpdateCapture"},dependencies:"blur compositionupdate keydown keypress keyup mousedown".split(" ")}},vg=!1,mb=!1,Wj={eventTypes:ua,extractEvents:function(a,b,c,d,e){var f;if(de)b:{switch(a){case "compositionstart":var g=ua.compositionStart;break b;case "compositionend":g=ua.compositionEnd;break b;case "compositionupdate":g=
ua.compositionUpdate;break b}g=void 0}else mb?tg(a,c)&&(g=ua.compositionEnd):"keydown"===a&&229===c.keyCode&&(g=ua.compositionStart);g?(xg&&"ko"!==c.locale&&(mb||g!==ua.compositionStart?g===ua.compositionEnd&&mb&&(f=rg()):(Ba=d,ce="value"in Ba?Ba.value:Ba.textContent,mb=!0)),e=Tj.getPooled(g,b,c,d),f?e.data=f:(f=ug(c),null!==f&&(e.data=f)),lb(e),f=e):f=null;(a=Vj?Oi(a,c):Pi(a,c))?(b=Uj.getPooled(ua.beforeInput,b,c,d),b.data=a,lb(b)):b=null;return null===f?b:null===b?f:[f,b]}},Qi={color:!0,date:!0,
datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0},Ag={change:{phasedRegistrationNames:{bubbled:"onChange",captured:"onChangeCapture"},dependencies:"blur change click focus input keydown keyup selectionchange".split(" ")}},Mb=null,Nb=null,kf=!1;wa&&(kf=Tf("input")&&(!document.documentMode||9<document.documentMode));var Xj={eventTypes:Ag,_isInputEventSupported:kf,extractEvents:function(a,b,c,d,e){e=b?Pa(b):window;var f=
e.nodeName&&e.nodeName.toLowerCase();if("select"===f||"input"===f&&"file"===e.type)var g=Si;else if(yg(e))if(kf)g=Wi;else{g=Ui;var h=Ti}else(f=e.nodeName)&&"input"===f.toLowerCase()&&("checkbox"===e.type||"radio"===e.type)&&(g=Vi);if(g&&(g=g(a,b)))return zg(g,c,d);h&&h(a,e,b);"blur"===a&&(a=e._wrapperState)&&a.controlled&&"number"===e.type&&Ed(e,"number",e.value)}},dc=R.extend({view:null,detail:null}),Yi={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"},di=0,ei=0,fi=!1,gi=!1,ec=dc.extend({screenX:null,
screenY:null,clientX:null,clientY:null,pageX:null,pageY:null,ctrlKey:null,shiftKey:null,altKey:null,metaKey:null,getModifierState:fe,button:null,buttons:null,relatedTarget:function(a){return a.relatedTarget||(a.fromElement===a.srcElement?a.toElement:a.fromElement)},movementX:function(a){if("movementX"in a)return a.movementX;var b=di;di=a.screenX;return fi?"mousemove"===a.type?a.screenX-b:0:(fi=!0,0)},movementY:function(a){if("movementY"in a)return a.movementY;var b=ei;ei=a.screenY;return gi?"mousemove"===
a.type?a.screenY-b:0:(gi=!0,0)}}),hi=ec.extend({pointerId:null,width:null,height:null,pressure:null,tangentialPressure:null,tiltX:null,tiltY:null,twist:null,pointerType:null,isPrimary:null}),fc={mouseEnter:{registrationName:"onMouseEnter",dependencies:["mouseout","mouseover"]},mouseLeave:{registrationName:"onMouseLeave",dependencies:["mouseout","mouseover"]},pointerEnter:{registrationName:"onPointerEnter",dependencies:["pointerout","pointerover"]},pointerLeave:{registrationName:"onPointerLeave",dependencies:["pointerout",
"pointerover"]}},Yj={eventTypes:fc,extractEvents:function(a,b,c,d,e){var f="mouseover"===a||"pointerover"===a,g="mouseout"===a||"pointerout"===a;if(f&&0===(e&32)&&(c.relatedTarget||c.fromElement)||!g&&!f)return null;f=d.window===d?d:(f=d.ownerDocument)?f.defaultView||f.parentWindow:window;if(g){if(g=b,b=(b=c.relatedTarget||c.toElement)?Bb(b):null,null!==b){var h=Na(b);if(b!==h||5!==b.tag&&6!==b.tag)b=null}}else g=null;if(g===b)return null;if("mouseout"===a||"mouseover"===a){var m=ec;var n=fc.mouseLeave;
var l=fc.mouseEnter;var k="mouse"}else if("pointerout"===a||"pointerover"===a)m=hi,n=fc.pointerLeave,l=fc.pointerEnter,k="pointer";a=null==g?f:Pa(g);f=null==b?f:Pa(b);n=m.getPooled(n,g,c,d);n.type=k+"leave";n.target=a;n.relatedTarget=f;c=m.getPooled(l,b,c,d);c.type=k+"enter";c.target=f;c.relatedTarget=a;d=g;k=b;if(d&&k)a:{m=d;l=k;g=0;for(a=m;a;a=pa(a))g++;a=0;for(b=l;b;b=pa(b))a++;for(;0<g-a;)m=pa(m),g--;for(;0<a-g;)l=pa(l),a--;for(;g--;){if(m===l||m===l.alternate)break a;m=pa(m);l=pa(l)}m=null}else m=
null;l=m;for(m=[];d&&d!==l;){g=d.alternate;if(null!==g&&g===l)break;m.push(d);d=pa(d)}for(d=[];k&&k!==l;){g=k.alternate;if(null!==g&&g===l)break;d.push(k);k=pa(k)}for(k=0;k<m.length;k++)be(m[k],"bubbled",n);for(k=d.length;0<k--;)be(d[k],"captured",c);return 0===(e&64)?[n]:[n,c]}},Qa="function"===typeof Object.is?Object.is:Zi,$i=Object.prototype.hasOwnProperty,Zj=wa&&"documentMode"in document&&11>=document.documentMode,Eg={select:{phasedRegistrationNames:{bubbled:"onSelect",captured:"onSelectCapture"},
dependencies:"blur contextmenu dragend focus keydown keyup mousedown mouseup selectionchange".split(" ")}},nb=null,he=null,Pb=null,ge=!1,ak={eventTypes:Eg,extractEvents:function(a,b,c,d,e,f){e=f||(d.window===d?d.document:9===d.nodeType?d:d.ownerDocument);if(!(f=!e)){a:{e=Jd(e);f=rd.onSelect;for(var g=0;g<f.length;g++)if(!e.has(f[g])){e=!1;break a}e=!0}f=!e}if(f)return null;e=b?Pa(b):window;switch(a){case "focus":if(yg(e)||"true"===e.contentEditable)nb=e,he=b,Pb=null;break;case "blur":Pb=he=nb=null;
break;case "mousedown":ge=!0;break;case "contextmenu":case "mouseup":case "dragend":return ge=!1,Dg(c,d);case "selectionchange":if(Zj)break;case "keydown":case "keyup":return Dg(c,d)}return null}},bk=R.extend({animationName:null,elapsedTime:null,pseudoElement:null}),ck=R.extend({clipboardData:function(a){return"clipboardData"in a?a.clipboardData:window.clipboardData}}),dk=dc.extend({relatedTarget:null}),ek={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",
Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},fk={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",
224:"Meta"},gk=dc.extend({key:function(a){if(a.key){var b=ek[a.key]||a.key;if("Unidentified"!==b)return b}return"keypress"===a.type?(a=Ac(a),13===a?"Enter":String.fromCharCode(a)):"keydown"===a.type||"keyup"===a.type?fk[a.keyCode]||"Unidentified":""},location:null,ctrlKey:null,shiftKey:null,altKey:null,metaKey:null,repeat:null,locale:null,getModifierState:fe,charCode:function(a){return"keypress"===a.type?Ac(a):0},keyCode:function(a){return"keydown"===a.type||"keyup"===a.type?a.keyCode:0},which:function(a){return"keypress"===
a.type?Ac(a):"keydown"===a.type||"keyup"===a.type?a.keyCode:0}}),hk=ec.extend({dataTransfer:null}),ik=dc.extend({touches:null,targetTouches:null,changedTouches:null,altKey:null,metaKey:null,ctrlKey:null,shiftKey:null,getModifierState:fe}),jk=R.extend({propertyName:null,elapsedTime:null,pseudoElement:null}),kk=ec.extend({deltaX:function(a){return"deltaX"in a?a.deltaX:"wheelDeltaX"in a?-a.wheelDeltaX:0},deltaY:function(a){return"deltaY"in a?a.deltaY:"wheelDeltaY"in a?-a.wheelDeltaY:"wheelDelta"in a?
-a.wheelDelta:0},deltaZ:null,deltaMode:null}),lk={eventTypes:dg,extractEvents:function(a,b,c,d,e){e=cg.get(a);if(!e)return null;switch(a){case "keypress":if(0===Ac(c))return null;case "keydown":case "keyup":a=gk;break;case "blur":case "focus":a=dk;break;case "click":if(2===c.button)return null;case "auxclick":case "dblclick":case "mousedown":case "mousemove":case "mouseup":case "mouseout":case "mouseover":case "contextmenu":a=ec;break;case "drag":case "dragend":case "dragenter":case "dragexit":case "dragleave":case "dragover":case "dragstart":case "drop":a=
hk;break;case "touchcancel":case "touchend":case "touchmove":case "touchstart":a=ik;break;case $h:case ai:case bi:a=bk;break;case ci:a=jk;break;case "scroll":a=dc;break;case "wheel":a=kk;break;case "copy":case "cut":case "paste":a=ck;break;case "gotpointercapture":case "lostpointercapture":case "pointercancel":case "pointerdown":case "pointermove":case "pointerout":case "pointerover":case "pointerup":a=hi;break;default:a=R}b=a.getPooled(e,b,c,d);lb(b);return b}};(function(a){if(ic)throw Error(k(101));
ic=Array.prototype.slice.call(a);nf()})("ResponderEventPlugin SimpleEventPlugin EnterLeaveEventPlugin ChangeEventPlugin SelectEventPlugin BeforeInputEventPlugin".split(" "));(function(a,b,c){td=a;rf=b;mf=c})(ae,Hb,Pa);pf({SimpleEventPlugin:lk,EnterLeaveEventPlugin:Yj,ChangeEventPlugin:Xj,SelectEventPlugin:ak,BeforeInputEventPlugin:Wj});var ie=[],ob=-1,Ca={},B={current:Ca},G={current:!1},Ra=Ca,bj=Pd,je=$f,Rg=Lj,aj=Nj,Dc=Oj,Ig=Zh,Jg=ag,Kg=Pj,Lg=Qj,Qg={},yj=Mj,Cj=void 0!==Yh?Yh:function(){},qa=null,
Ec=null,ke=!1,ii=ff(),Y=1E4>ii?ff:function(){return ff()-ii},Ic={current:null},Hc=null,qb=null,Gc=null,Tg=0,Jc=2,Ga=!1,Vb=da.ReactCurrentBatchConfig,$g=(new ea.Component).refs,Mc={isMounted:function(a){return(a=a._reactInternalFiber)?Na(a)===a:!1},enqueueSetState:function(a,b,c){a=a._reactInternalFiber;var d=ka(),e=Vb.suspense;d=Va(d,a,e);e=Ea(d,e);e.payload=b;void 0!==c&&null!==c&&(e.callback=c);Fa(a,e);Ja(a,d)},enqueueReplaceState:function(a,b,c){a=a._reactInternalFiber;var d=ka(),e=Vb.suspense;
d=Va(d,a,e);e=Ea(d,e);e.tag=1;e.payload=b;void 0!==c&&null!==c&&(e.callback=c);Fa(a,e);Ja(a,d)},enqueueForceUpdate:function(a,b){a=a._reactInternalFiber;var c=ka(),d=Vb.suspense;c=Va(c,a,d);d=Ea(c,d);d.tag=Jc;void 0!==b&&null!==b&&(d.callback=b);Fa(a,d);Ja(a,c)}},Qc=Array.isArray,wb=ah(!0),Fe=ah(!1),Sb={},ja={current:Sb},Ub={current:Sb},Tb={current:Sb},D={current:0},Sc=da.ReactCurrentDispatcher,X=da.ReactCurrentBatchConfig,Ia=0,z=null,K=null,J=null,Uc=!1,Tc={readContext:W,useCallback:S,useContext:S,
useEffect:S,useImperativeHandle:S,useLayoutEffect:S,useMemo:S,useReducer:S,useRef:S,useState:S,useDebugValue:S,useResponder:S,useDeferredValue:S,useTransition:S},dj={readContext:W,useCallback:ih,useContext:W,useEffect:eh,useImperativeHandle:function(a,b,c){c=null!==c&&void 0!==c?c.concat([a]):null;return ze(4,2,gh.bind(null,b,a),c)},useLayoutEffect:function(a,b){return ze(4,2,a,b)},useMemo:function(a,b){var c=ub();b=void 0===b?null:b;a=a();c.memoizedState=[a,b];return a},useReducer:function(a,b,c){var d=
ub();b=void 0!==c?c(b):b;d.memoizedState=d.baseState=b;a=d.queue={pending:null,dispatch:null,lastRenderedReducer:a,lastRenderedState:b};a=a.dispatch=ch.bind(null,z,a);return[d.memoizedState,a]},useRef:function(a){var b=ub();a={current:a};return b.memoizedState=a},useState:xe,useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=xe(a),d=c[0],e=c[1];eh(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=
xe(!1),c=b[0];b=b[1];return[ih(Ce.bind(null,b,a),[b,a]),c]}},ej={readContext:W,useCallback:Yc,useContext:W,useEffect:Xc,useImperativeHandle:hh,useLayoutEffect:fh,useMemo:jh,useReducer:Vc,useRef:dh,useState:function(a){return Vc(Ua)},useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=Vc(Ua),d=c[0],e=c[1];Xc(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=Vc(Ua),c=b[0];b=b[1];return[Yc(Ce.bind(null,
b,a),[b,a]),c]}},fj={readContext:W,useCallback:Yc,useContext:W,useEffect:Xc,useImperativeHandle:hh,useLayoutEffect:fh,useMemo:jh,useReducer:Wc,useRef:dh,useState:function(a){return Wc(Ua)},useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=Wc(Ua),d=c[0],e=c[1];Xc(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=Wc(Ua),c=b[0];b=b[1];return[Yc(Ce.bind(null,b,a),[b,a]),c]}},ra=null,Ka=null,Wa=
!1,gj=da.ReactCurrentOwner,ia=!1,Je={dehydrated:null,retryTime:0};var jj=function(a,b,c,d){for(c=b.child;null!==c;){if(5===c.tag||6===c.tag)a.appendChild(c.stateNode);else if(4!==c.tag&&null!==c.child){c.child.return=c;c=c.child;continue}if(c===b)break;for(;null===c.sibling;){if(null===c.return||c.return===b)return;c=c.return}c.sibling.return=c.return;c=c.sibling}};var wh=function(a){};var ij=function(a,b,c,d,e){var f=a.memoizedProps;if(f!==d){var g=b.stateNode;Ta(ja.current);a=null;switch(c){case "input":f=
Cd(g,f);d=Cd(g,d);a=[];break;case "option":f=Fd(g,f);d=Fd(g,d);a=[];break;case "select":f=M({},f,{value:void 0});d=M({},d,{value:void 0});a=[];break;case "textarea":f=Gd(g,f);d=Gd(g,d);a=[];break;default:"function"!==typeof f.onClick&&"function"===typeof d.onClick&&(g.onclick=uc)}Ud(c,d);var h,m;c=null;for(h in f)if(!d.hasOwnProperty(h)&&f.hasOwnProperty(h)&&null!=f[h])if("style"===h)for(m in g=f[h],g)g.hasOwnProperty(m)&&(c||(c={}),c[m]="");else"dangerouslySetInnerHTML"!==h&&"children"!==h&&"suppressContentEditableWarning"!==
h&&"suppressHydrationWarning"!==h&&"autoFocus"!==h&&(db.hasOwnProperty(h)?a||(a=[]):(a=a||[]).push(h,null));for(h in d){var k=d[h];g=null!=f?f[h]:void 0;if(d.hasOwnProperty(h)&&k!==g&&(null!=k||null!=g))if("style"===h)if(g){for(m in g)!g.hasOwnProperty(m)||k&&k.hasOwnProperty(m)||(c||(c={}),c[m]="");for(m in k)k.hasOwnProperty(m)&&g[m]!==k[m]&&(c||(c={}),c[m]=k[m])}else c||(a||(a=[]),a.push(h,c)),c=k;else"dangerouslySetInnerHTML"===h?(k=k?k.__html:void 0,g=g?g.__html:void 0,null!=k&&g!==k&&(a=a||
[]).push(h,k)):"children"===h?g===k||"string"!==typeof k&&"number"!==typeof k||(a=a||[]).push(h,""+k):"suppressContentEditableWarning"!==h&&"suppressHydrationWarning"!==h&&(db.hasOwnProperty(h)?(null!=k&&oa(e,h),a||g===k||(a=[])):(a=a||[]).push(h,k))}c&&(a=a||[]).push("style",c);e=a;if(b.updateQueue=e)b.effectTag|=4}};var kj=function(a,b,c,d){c!==d&&(b.effectTag|=4)};var pj="function"===typeof WeakSet?WeakSet:Set,wj="function"===typeof WeakMap?WeakMap:Map,sj=Math.ceil,gd=da.ReactCurrentDispatcher,
Uh=da.ReactCurrentOwner,H=0,Ye=8,ca=16,ma=32,Xa=0,hd=1,Oh=2,ad=3,bd=4,Xe=5,p=H,U=null,t=null,P=0,F=Xa,id=null,ta=1073741823,Yb=1073741823,kd=null,Xb=0,jd=!1,Re=0,Ph=500,l=null,cd=!1,Se=null,La=null,ld=!1,Zb=null,$b=90,bb=null,ac=0,af=null,dd=0,Ja=function(a,b){if(50<ac)throw ac=0,af=null,Error(k(185));a=ed(a,b);if(null!==a){var c=Cc();1073741823===b?(p&Ye)!==H&&(p&(ca|ma))===H?Te(a):(V(a),p===H&&ha()):V(a);(p&4)===H||98!==c&&99!==c||(null===bb?bb=new Map([[a,b]]):(c=bb.get(a),(void 0===c||c>b)&&bb.set(a,
b)))}};var zj=function(a,b,c){var d=b.expirationTime;if(null!==a){var e=b.pendingProps;if(a.memoizedProps!==e||G.current)ia=!0;else{if(d<c){ia=!1;switch(b.tag){case 3:sh(b);Ee();break;case 5:bh(b);if(b.mode&4&&1!==c&&e.hidden)return b.expirationTime=b.childExpirationTime=1,null;break;case 1:N(b.type)&&Bc(b);break;case 4:se(b,b.stateNode.containerInfo);break;case 10:d=b.memoizedProps.value;e=b.type._context;y(Ic,e._currentValue);e._currentValue=d;break;case 13:if(null!==b.memoizedState){d=b.child.childExpirationTime;
if(0!==d&&d>=c)return th(a,b,c);y(D,D.current&1);b=sa(a,b,c);return null!==b?b.sibling:null}y(D,D.current&1);break;case 19:d=b.childExpirationTime>=c;if(0!==(a.effectTag&64)){if(d)return vh(a,b,c);b.effectTag|=64}e=b.memoizedState;null!==e&&(e.rendering=null,e.tail=null);y(D,D.current);if(!d)return null}return sa(a,b,c)}ia=!1}}else ia=!1;b.expirationTime=0;switch(b.tag){case 2:d=b.type;null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2);a=b.pendingProps;e=pb(b,B.current);rb(b,c);e=we(null,
b,d,a,e,c);b.effectTag|=1;if("object"===typeof e&&null!==e&&"function"===typeof e.render&&void 0===e.$$typeof){b.tag=1;b.memoizedState=null;b.updateQueue=null;if(N(d)){var f=!0;Bc(b)}else f=!1;b.memoizedState=null!==e.state&&void 0!==e.state?e.state:null;ne(b);var g=d.getDerivedStateFromProps;"function"===typeof g&&Lc(b,d,g,a);e.updater=Mc;b.stateNode=e;e._reactInternalFiber=b;pe(b,d,a,c);b=Ie(null,b,d,!0,f,c)}else b.tag=0,T(null,b,e,c),b=b.child;return b;case 16:a:{e=b.elementType;null!==a&&(a.alternate=
null,b.alternate=null,b.effectTag|=2);a=b.pendingProps;ri(e);if(1!==e._status)throw e._result;e=e._result;b.type=e;f=b.tag=Gj(e);a=aa(e,a);switch(f){case 0:b=He(null,b,e,a,c);break a;case 1:b=rh(null,b,e,a,c);break a;case 11:b=nh(null,b,e,a,c);break a;case 14:b=oh(null,b,e,aa(e.type,a),d,c);break a}throw Error(k(306,e,""));}return b;case 0:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),He(a,b,d,e,c);case 1:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),rh(a,b,d,e,c);
case 3:sh(b);d=b.updateQueue;if(null===a||null===d)throw Error(k(282));d=b.pendingProps;e=b.memoizedState;e=null!==e?e.element:null;oe(a,b);Qb(b,d,null,c);d=b.memoizedState.element;if(d===e)Ee(),b=sa(a,b,c);else{if(e=b.stateNode.hydrate)Ka=kb(b.stateNode.containerInfo.firstChild),ra=b,e=Wa=!0;if(e)for(c=Fe(b,null,d,c),b.child=c;c;)c.effectTag=c.effectTag&-3|1024,c=c.sibling;else T(a,b,d,c),Ee();b=b.child}return b;case 5:return bh(b),null===a&&De(b),d=b.type,e=b.pendingProps,f=null!==a?a.memoizedProps:
null,g=e.children,Yd(d,e)?g=null:null!==f&&Yd(d,f)&&(b.effectTag|=16),qh(a,b),b.mode&4&&1!==c&&e.hidden?(b.expirationTime=b.childExpirationTime=1,b=null):(T(a,b,g,c),b=b.child),b;case 6:return null===a&&De(b),null;case 13:return th(a,b,c);case 4:return se(b,b.stateNode.containerInfo),d=b.pendingProps,null===a?b.child=wb(b,null,d,c):T(a,b,d,c),b.child;case 11:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),nh(a,b,d,e,c);case 7:return T(a,b,b.pendingProps,c),b.child;case 8:return T(a,
b,b.pendingProps.children,c),b.child;case 12:return T(a,b,b.pendingProps.children,c),b.child;case 10:a:{d=b.type._context;e=b.pendingProps;g=b.memoizedProps;f=e.value;var h=b.type._context;y(Ic,h._currentValue);h._currentValue=f;if(null!==g)if(h=g.value,f=Qa(h,f)?0:("function"===typeof d._calculateChangedBits?d._calculateChangedBits(h,f):1073741823)|0,0===f){if(g.children===e.children&&!G.current){b=sa(a,b,c);break a}}else for(h=b.child,null!==h&&(h.return=b);null!==h;){var m=h.dependencies;if(null!==
m){g=h.child;for(var l=m.firstContext;null!==l;){if(l.context===d&&0!==(l.observedBits&f)){1===h.tag&&(l=Ea(c,null),l.tag=Jc,Fa(h,l));h.expirationTime<c&&(h.expirationTime=c);l=h.alternate;null!==l&&l.expirationTime<c&&(l.expirationTime=c);Sg(h.return,c);m.expirationTime<c&&(m.expirationTime=c);break}l=l.next}}else g=10===h.tag?h.type===b.type?null:h.child:h.child;if(null!==g)g.return=h;else for(g=h;null!==g;){if(g===b){g=null;break}h=g.sibling;if(null!==h){h.return=g.return;g=h;break}g=g.return}h=
g}T(a,b,e.children,c);b=b.child}return b;case 9:return e=b.type,f=b.pendingProps,d=f.children,rb(b,c),e=W(e,f.unstable_observedBits),d=d(e),b.effectTag|=1,T(a,b,d,c),b.child;case 14:return e=b.type,f=aa(e,b.pendingProps),f=aa(e.type,f),oh(a,b,e,f,d,c);case 15:return ph(a,b,b.type,b.pendingProps,d,c);case 17:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2),b.tag=1,N(d)?(a=!0,Bc(b)):a=!1,rb(b,c),Yg(b,d,e),pe(b,d,e,c),Ie(null,
b,d,!0,a,c);case 19:return vh(a,b,c)}throw Error(k(156,b.tag));};var bf=null,Ne=null,la=function(a,b,c,d){return new Fj(a,b,c,d)};ef.prototype.render=function(a){md(a,this._internalRoot,null,null)};ef.prototype.unmount=function(){var a=this._internalRoot,b=a.containerInfo;md(null,a,null,function(){b[Lb]=null})};var Di=function(a){if(13===a.tag){var b=Fc(ka(),150,100);Ja(a,b);df(a,b)}};var Yf=function(a){13===a.tag&&(Ja(a,3),df(a,3))};var Bi=function(a){if(13===a.tag){var b=ka();b=Va(b,a,null);Ja(a,
b);df(a,b)}};sd=function(a,b,c){switch(b){case "input":Dd(a,c);b=c.name;if("radio"===c.type&&null!=b){for(c=a;c.parentNode;)c=c.parentNode;c=c.querySelectorAll("input[name="+JSON.stringify(""+b)+'][type="radio"]');for(b=0;b<c.length;b++){var d=c[b];if(d!==a&&d.form===a.form){var e=ae(d);if(!e)throw Error(k(90));Gf(d);Dd(d,e)}}}break;case "textarea":Lf(a,c);break;case "select":b=c.value,null!=b&&hb(a,!!c.multiple,b,!1)}};(function(a,b,c,d){ee=a;eg=b;vd=c;vf=d})(Qh,function(a,b,c,d,e){var f=p;p|=4;
try{return Da(98,a.bind(null,b,c,d,e))}finally{p=f,p===H&&ha()}},function(){(p&(1|ca|ma))===H&&(uj(),xb())},function(a,b){var c=p;p|=2;try{return a(b)}finally{p=c,p===H&&ha()}});var mk={Events:[Hb,Pa,ae,pf,qd,lb,function(a){Kd(a,Ki)},sf,tf,sc,pc,xb,{current:!1}]};(function(a){var b=a.findFiberByHostInstance;return Ej(M({},a,{overrideHookState:null,overrideProps:null,setSuspenseHandler:null,scheduleUpdate:null,currentDispatcherRef:da.ReactCurrentDispatcher,findHostInstanceByFiber:function(a){a=Sf(a);
return null===a?null:a.stateNode},findFiberByHostInstance:function(a){return b?b(a):null},findHostInstancesForRefresh:null,scheduleRefresh:null,scheduleRoot:null,setRefreshHandler:null,getCurrentFiber:null}))})({findFiberByHostInstance:Bb,bundleType:0,version:"16.13.1",rendererPackageName:"react-dom"});I.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=mk;I.createPortal=Xh;I.findDOMNode=function(a){if(null==a)return null;if(1===a.nodeType)return a;var b=a._reactInternalFiber;if(void 0===
b){if("function"===typeof a.render)throw Error(k(188));throw Error(k(268,Object.keys(a)));}a=Sf(b);a=null===a?null:a.stateNode;return a};I.flushSync=function(a,b){if((p&(ca|ma))!==H)throw Error(k(187));var c=p;p|=1;try{return Da(99,a.bind(null,b))}finally{p=c,ha()}};I.hydrate=function(a,b,c){if(!bc(b))throw Error(k(200));return nd(null,a,b,!0,c)};I.render=function(a,b,c){if(!bc(b))throw Error(k(200));return nd(null,a,b,!1,c)};I.unmountComponentAtNode=function(a){if(!bc(a))throw Error(k(40));return a._reactRootContainer?
(Rh(function(){nd(null,null,a,!1,function(){a._reactRootContainer=null;a[Lb]=null})}),!0):!1};I.unstable_batchedUpdates=Qh;I.unstable_createPortal=function(a,b){return Xh(a,b,2<arguments.length&&void 0!==arguments[2]?arguments[2]:null)};I.unstable_renderSubtreeIntoContainer=function(a,b,c,d){if(!bc(c))throw Error(k(200));if(null==a||void 0===a._reactInternalFiber)throw Error(k(38));return nd(a,b,c,!1,d)};I.version="16.13.1"});
</script>
    <script>const e = React.createElement;

function pathToString(path) {
  if (path[0] === '/') {
    return '/' + path.slice(1).join('/');
  } else {
    return path.join('/');
  }
}

function findCommonPath(files) {
  if (!files || !files.length) {
    return [];
  }

  function isPrefix(arr, prefix) {
    if (arr.length < prefix.length) {
      return false;
    }
    for (let i = prefix.length - 1; i >= 0; --i) {
      if (arr[i] !== prefix[i]) {
        return false;
      }
    }
    return true;
  }

  let commonPath = files[0].path.slice(0, -1);
  while (commonPath.length) {
    if (files.every(file => isPrefix(file.path, commonPath))) {
      break;
    }
    commonPath.pop();
  }
  return commonPath;
}

function findFolders(files) {
  if (!files || !files.length) {
    return [];
  }

  let folders = files.filter(file => file.path.length > 1).map(file => file.path[0]);
  folders = [...new Set(folders)]; // unique
  folders.sort();

  folders = folders.map(folder => {
    let filesInFolder = files
      .filter(file => file.path[0] === folder)
      .map(file => ({
        ...file,
        path: file.path.slice(1),
        parent: [...file.parent, file.path[0]],
      }));

    const children = findFolders(filesInFolder); // recursion

    return {
      is_folder: true,
      path: [folder],
      parent: files[0].parent,
      children,
      covered: children.reduce((sum, file) => sum + file.covered, 0),
      coverable: children.reduce((sum, file) => sum + file.coverable, 0),
      prevRun: {
        covered: children.reduce((sum, file) => sum + file.prevRun.covered, 0),
        coverable: children.reduce((sum, file) => sum + file.prevRun.coverable, 0),
      }
    };
  });

  return [
    ...folders,
    ...files.filter(file => file.path.length === 1),
  ];
}

class App extends React.Component {
  constructor(...args) {
    super(...args);

    this.state = {
      current: [],
    };
  }

  componentDidMount() {
    this.updateStateFromLocation();
    window.addEventListener("hashchange", () => this.updateStateFromLocation(), false);
  }

  updateStateFromLocation() {
    if (window.location.hash.length > 1) {
      const current = window.location.hash.substr(1).split('/');
      this.setState({current});
    } else {
      this.setState({current: []});
    }
  }

  getCurrentPath() {
    let file = this.props.root;
    let path = [file];
    for (let p of this.state.current) {
      file = file.children.find(file => file.path[0] === p);
      if (!file) {
        return path;
      }
      path.push(file);
    }
    return path;
  }

  render() {
    const path = this.getCurrentPath();
    const file = path[path.length - 1];

    let w = null;
    if (file.is_folder) {
      w = e(FilesList, {
        folder: file,
        onSelectFile: this.selectFile.bind(this),
        onBack: path.length > 1 ? this.back.bind(this) : null,
      });
    } else {
      w = e(DisplayFile, {
        file,
        onBack: this.back.bind(this),
      });
    }

    return e('div', {className: 'app'}, w);
  }

  selectFile(file) {
    this.setState(({current}) => {
      return {current: [...current, file.path[0]]};
    }, () => this.updateHash());
  }

  back(file) {
    this.setState(({current}) => {
      return {current: current.slice(0, current.length - 1)};
    }, () => this.updateHash());
  }

  updateHash() {
    if (!this.state.current || !this.state.current.length) {
      window.location = '#';
    } else {
      window.location = '#' + this.state.current.join('/');
    }
  }
}

function FilesList({folder, onSelectFile, onBack}) {
  let files = folder.children;
  return e('div', {className: 'display-folder'},
    e(FileHeader, {file: folder, onBack}),
    e('table', {className: 'files-list'},
      e('thead', {className: 'files-list__head'},
        e('tr', null,
          e('th', null, "Path"),
          e('th', null, "Coverage")
        )
      ),
      e('tbody', {className: 'files-list__body'},
        files.map(file => e(File, {file, onClick: onSelectFile}))
      )
    )
  );
}

function File({file, onClick}) {
  const coverage = file.coverable ? file.covered / file.coverable * 100 : -1;
  const coverageDelta = file.prevRun &&
    (file.covered / file.coverable * 100 - file.prevRun.covered / file.prevRun.coverable * 100);

  return e('tr', {
      className: 'files-list__file'
        + (coverage >= 0 && coverage < 50 ? ' files-list__file_low': '')
        + (coverage >= 50 && coverage < 80 ? ' files-list__file_medium': '')
        + (coverage >= 80 ? ' files-list__file_high': '')
        + (file.is_folder ? ' files-list__file_folder': ''),
      onClick: () => onClick(file),
    },
    e('td', null, e('a', null, pathToString(file.path))),
    e('td', null,
      file.covered + ' / ' + file.coverable +
      (coverage >= 0 ? ' (' + coverage.toFixed(2) + '%)' : ''),
      e('span', {title: 'Change from the previous run'},
        (coverageDelta ? ` (${coverageDelta > 0 ? '+' : ''}${coverageDelta.toFixed(2)}%)` : ''))
    )
  );
}

function DisplayFile({file, onBack}) {
  return e('div', {className: 'display-file'},
    e(FileHeader, {file, onBack}),
    e(FileContent, {file})
  );
}

function FileHeader({file, onBack}) {
  const coverage = file.covered / file.coverable * 100;
  const coverageDelta = file.prevRun && (coverage - file.prevRun.covered / file.prevRun.coverable * 100);

  return e('div', {className: 'file-header'},
    onBack ? e('a', {className: 'file-header__back', onClick: onBack}, 'Back') : null,
    e('div', {className: 'file-header__name'}, pathToString([...file.parent, ...file.path])),
    e('div', {className: 'file-header__stat'},
      'Covered: ' + file.covered + ' of ' + file.coverable +
      (file.coverable ? ' (' + coverage.toFixed(2) + '%)' : ''),
      e('span', {title: 'Change from the previous run'},
        (coverageDelta ? ` (${coverageDelta > 0 ? '+' : ''}${coverageDelta.toFixed(2)}%)` : ''))
    )
  );
}

function FileContent({file}) {
  return e('pre', {className: 'file-content'},
    file.content.split(/\r?\n/).map((line, index) => {
      const trace = file.traces.find(trace => trace.line === index + 1);
      const covered = trace && trace.stats.Line;
      const uncovered = trace && !trace.stats.Line;
      return e('code', {
          className: 'code-line'
            + (covered ? ' code-line_covered' : '')
            + (uncovered ? ' code-line_uncovered' : ''),
          title: trace ? JSON.stringify(trace.stats, null, 2) : null,
        }, line);
    })
  );
}

(function(){
  const commonPath = findCommonPath(data.files);
  const prevFilesMap = new Map();

  previousData && previousData.files.forEach((file) => {
    const path = file.path.slice(commonPath.length).join('/');
    prevFilesMap.set(path, file);
  });

  const files = data.files.map((file) => {
    const path = file.path.slice(commonPath.length);
    const { covered = 0, coverable = 0 } = prevFilesMap.get(path.join('/')) || {};
    return {
      ...file,
      path,
      parent: commonPath,
      prevRun: { covered, coverable },
    };
  });

  const children = findFolders(files);

  const root = {
    is_folder: true,
    children,
    path: commonPath,
    parent: [],
    covered: children.reduce((sum, file) => sum + file.covered, 0),
    coverable: children.reduce((sum, file) => sum + file.coverable, 0),
    prevRun: {
      covered: children.reduce((sum, file) => sum + file.prevRun.covered, 0),
      coverable: children.reduce((sum, file) => sum + file.prevRun.coverable, 0),
    }
  };

  ReactDOM.render(e(App, {root, prevFilesMap}), document.getElementById('root'));
}());
</script>
</body>
</html>